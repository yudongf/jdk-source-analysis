<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="keywords" content="Java,JDK,Java source,Collection,ArrayList,Map,List,HashMap,ArrayDeque,Deque,Set,HashSet,LinkedList,Queue,TreeMap,TreeSet,Vector,Stack">
<meta name="author" content="Dç“œå“¥">
<meta name="copyright" content="Apache-2.0">
<title>JDK æºç åˆ†æ</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<link rel="stylesheet" href="assets/css/asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>p>code{color: #d14 !important;background-color: #f5f5f5 !important;border: 1px solid #e1e1e8;white-space: nowrap;border-radius: 3px;}</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>JDK æºç åˆ†æ</h1>
<div class="details">
<span id="author" class="author">Dç“œå“¥</span><br>
<span id="email" class="email"><a href="https://www.diguage.com" class="bare">https://www.diguage.com</a></span><br>
<span id="revdate">2020-06-10</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_å‰è¨€jdk_stl_æºç åˆ†æè®¡åˆ’">å‰è¨€ï¼šJDK &amp; STL æºç åˆ†æè®¡åˆ’</a></li>
<li><a href="#_é›†åˆç±»æ¦‚è¿°">1. é›†åˆç±»æ¦‚è¿°</a></li>
<li><a href="#_è¿­ä»£å™¨_iterator_enumeration_spliterator_ä¸_iterable">2. è¿­ä»£å™¨ Iteratorã€ Enumerationã€ Spliterator ä¸ Iterable</a></li>
<li><a href="#_collection">3. Collection</a></li>
<li><a href="#_abstractcollection">4. AbstractCollection</a></li>
<li><a href="#_list">5. List</a></li>
<li><a href="#_abstractlist">6. AbstractList</a></li>
<li><a href="#_abstractsequentiallist">7. AbstractSequentialList</a></li>
<li><a href="#_arraylist">8. <code>ArrayList</code></a></li>
<li><a href="#_linkedlist">9. LinkedList</a></li>
<li><a href="#_stack">10. Stack</a></li>
<li><a href="#_vector">11. Vector</a></li>
<li><a href="#_set">12. Set</a></li>
<li><a href="#_abstractset">13. AbstractSet</a></li>
<li><a href="#_sortedset">14. SortedSet</a></li>
<li><a href="#_navigableset">15. NavigableSet</a></li>
<li><a href="#_hashset">16. HashSet</a></li>
<li><a href="#_treeset">17. TreeSet</a></li>
<li><a href="#_linkedhashset">18. LinkedHashSet</a></li>
<li><a href="#_bitset">19. BitSet</a></li>
<li><a href="#_enumset">20. EnumSet</a></li>
<li><a href="#_map">21. Map</a></li>
<li><a href="#_sortedmap">22. SortedMap</a></li>
<li><a href="#_navigablemap">23. NavigableMap</a></li>
<li><a href="#_abstractmap">24. AbstractMap</a></li>
<li><a href="#_hashmap">25. HashMap</a></li>
<li><a href="#_treemap">26. TreeMap</a></li>
<li><a href="#_linkedhashmap">27. LinkedHashMap</a></li>
<li><a href="#_dictionary">28. Dictionary</a></li>
<li><a href="#_hashtable">29. Hashtable</a></li>
<li><a href="#_enummap">30. EnumMap</a></li>
<li><a href="#_weakhashmap">31. WeakHashMap</a></li>
<li><a href="#_identityhashmap">32. IdentityHashMap</a></li>
<li><a href="#_queue">33. Queue</a></li>
<li><a href="#_deque">34. Deque</a></li>
<li><a href="#_abstractqueue">35. AbstractQueue</a></li>
<li><a href="#_arraydeque">36. ArrayDeque</a></li>
<li><a href="#_priorityqueue">37. PriorityQueue</a></li>
<li><a href="#_å·¥å…·ç±»_arrays">38. å·¥å…·ç±» <code>Arrays</code></a></li>
<li><a href="#_å·¥å…·ç±»_collections">39. å·¥å…·ç±» <code>Collections</code></a></li>
<li><a href="#_å¹¶å‘åº“æ¦‚è¿°">40. å¹¶å‘åº“æ¦‚è¿°</a></li>
<li><a href="#_thread">41. Thread</a></li>
<li><a href="#_locksupport">42. LockSupport</a></li>
<li><a href="#_abstractqueuedsynchronizer">43. AbstractQueuedSynchronizer</a></li>
<li><a href="#_reentrantlock">44. ReentrantLock</a></li>
<li><a href="#_reentrantreadwritelock">45. ReentrantReadWriteLock</a></li>
<li><a href="#_stampedlock">46. StampedLock</a></li>
<li><a href="#_semaphore">47. Semaphore</a></li>
<li><a href="#_countdownlatch">48. CountDownLatch</a></li>
<li><a href="#_cyclicbarrier">49. CyclicBarrier</a></li>
<li><a href="#_phaser">50. Phaser</a></li>
<li><a href="#_exchanger">51. Exchanger</a></li>
<li><a href="#_threadlocal">52. ThreadLocal</a></li>
<li><a href="#_atomicinteger">53. AtomicInteger</a></li>
<li><a href="#_longadder">54. LongAdder</a></li>
<li><a href="#_juc_åŒ…åŸºç¡€ç±»åˆ†æ">55. JUC åŒ…åŸºç¡€ç±»åˆ†æ</a></li>
<li><a href="#_futuretask">56. FutureTask</a></li>
<li><a href="#_completablefuture">57. CompletableFuture</a></li>
<li><a href="#_threadpoolexecutor_æºç åˆ†æ">58. ThreadPoolExecutor æºç åˆ†æ</a></li>
<li><a href="#_forkjointask">59. ForkJoinTask</a></li>
<li><a href="#_forkjoinpool">60. ForkJoinPool</a></li>
<li><a href="#_concurrenthashmap">61. <code>ConcurrentHashMap</code></a></li>
<li><a href="#_concurrentskiplistmap">62. <code>ConcurrentSkipListMap</code></a></li>
<li><a href="#_copyonwritearraylist">63. CopyOnWriteArrayList</a></li>
<li><a href="#_concurrentlinkedqueue">64. ConcurrentLinkedQueue</a></li>
<li><a href="#_arrayblockingqueue">65. ArrayBlockingQueue</a></li>
<li><a href="#_linkedblockingqueue">66. LinkedBlockingQueue</a></li>
<li><a href="#_priorityblockingqueue">67. PriorityBlockingQueue</a></li>
<li><a href="#_delayqueue">68. DelayQueue</a></li>
<li><a href="#_classloader">69. ClassLoader</a></li>
<li><a href="#_field">70. Field</a></li>
<li><a href="#_proxy">71. Proxy</a></li>
<li><a href="#_serversocket">72. ServerSocket</a></li>
<li><a href="#_serviceloader">73. <code>ServiceLoader</code></a></li>
<li><a href="#_netty">74. Netty</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_å‰è¨€jdk_stl_æºç åˆ†æè®¡åˆ’"><a class="anchor" href="#_å‰è¨€jdk_stl_æºç åˆ†æè®¡åˆ’"></a>å‰è¨€ï¼šJDK &amp; STL æºç åˆ†æè®¡åˆ’</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ä¸ºäº†å­¦å¥½æ•°æ®ç»“æ„ä»¥åŠç›¸å…³ç®—æ³•ï¼ŒåŒæ—¶ä¹Ÿä¸ºäº†æ›´å¥½åœ°ç†è§£ JDK çš„åº•å±‚å®ç°ï¼Œè®¡åˆ’å¯¹ JDK é›†åˆç±»çš„æºç åšä¸€ä¸ªç³»ç»Ÿçš„é˜…è¯»åˆ†æã€‚</p>
</div>
<div class="paragraph">
<p>æ¬¢è¿éšæ—¶æäº¤ PR æˆ– Issueã€‚å»ºäº†ä¸€ä¸ª Gitter èŠå¤©å®¤ï¼Œç‚¹å‡»å›¾æ ‡åŠ å…¥ï¼š <a href="https://gitter.im/source-analysis/community?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge"><span class="image"><img src="https://badges.gitter.im/source-analysis/community.svg" alt="community"></span></a>ã€‚</p>
</div>
<div class="paragraph">
<p>æµè§ˆè¯·ç‚¹å‡»ï¼š <a href="https://diguage.github.io/jdk-source-analysis/">JDK æºç åˆ†æ</a>ã€‚</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
æœ¬æ–‡æ¡£åŸºäº <strong>OpenJDK 11.0.6 2020-01-14 LTS</strong> çš„ä»£ç å¼€å±•åˆ†æï¼Œè¯· PR çš„å°ä¼™ä¼´ä½¿ç”¨ç›¸åŒçš„ JDKã€‚è°¢è°¢ï¼
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_å‹æƒ…æ”¯æŒ"><a class="anchor" href="#_å‹æƒ…æ”¯æŒ"></a>å‹æƒ…æ”¯æŒ</h3>
<div class="paragraph">
<p>å¦‚æœæ‚¨è§‰å¾—è¿™ä¸ªç¬”è®°å¯¹æ‚¨æœ‰æ‰€å¸®åŠ©ï¼Œçœ‹åœ¨Dç“œå“¥ç å­—çš„è¾›è‹¦ä¸Šï¼Œè¯·å‹æƒ…æ”¯æŒä¸€ä¸‹ï¼ŒDç“œå“¥æ„Ÿæ¿€ä¸å°½ï¼ŒğŸ˜œ</p>
</div>
<table class="tableblock frame-none grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="image"><img src="./images/alipay.png" alt="æ”¯ä»˜å®" width="45%" title="æ”¯ä»˜å®"></span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="image"><img src="./images/wxpay.png" alt="å¾®ä¿¡" width="45%" title="å¾®ä¿¡"></span></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_å®˜ç½‘åŠç‰ˆæœ¬åº“"><a class="anchor" href="#_å®˜ç½‘åŠç‰ˆæœ¬åº“"></a>å®˜ç½‘åŠç‰ˆæœ¬åº“</h3>
<div class="paragraph">
<p>æœ¬æ–‡æ¡£çš„ç‰ˆæœ¬åº“æ‰˜ç®¡åœ¨ Github ä¸Šï¼Œå¦å¤–å•ç‹¬å‘å¸ƒã€‚</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">â€œåœ°ç“œå“¥â€åšå®¢ç½‘</dt>
<dd>
<p><a href="https://www.diguage.com/" class="bare" target="_blank" rel="noopener">https://www.diguage.com/</a> ã€‚Dç“œå“¥çš„ä¸ªäººåšå®¢ã€‚æ¬¢è¿å…‰ä¸´ï¼Œä¸è¿‡ï¼Œå†…å®¹å¾ˆæ‚ä¹±ï¼Œè¯·è§è°…ã€‚ä¸è§è°…ï¼Œä½ æ¥æ‰“æˆ‘å•Šï¼ŒğŸ˜‚ğŸ˜‚</p>
</dd>
<dt class="hdlist1">æœ¬æ–‡æ¡£å®˜ç½‘</dt>
<dd>
<p><a href="https://diguage.github.io/jdk-source-analysis/" class="bare" target="_blank" rel="noopener">https://diguage.github.io/jdk-source-analysis/</a> ã€‚ä¸ºäº†æ–¹ä¾¿é˜…è¯»ï¼Œè¿™é‡Œå±•ç¤ºäº†å¤„ç†å¥½çš„æ–‡æ¡£ã€‚é˜…è¯»è¯·ç‚¹å‡»è¿™ä¸ªç½‘å€ã€‚</p>
</dd>
<dt class="hdlist1">æœ¬æ–‡æ¡£ç‰ˆæœ¬åº“</dt>
<dd>
<p><a href="https://github.com/diguage/jdk-source-analysis" class="bare" target="_blank" rel="noopener">https://github.com/diguage/jdk-source-analysis</a> ã€‚æ¬¢è¿å¤§å®¶å‘é€ PRã€‚</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_æ€»ä½“æ€è·¯"><a class="anchor" href="#_æ€»ä½“æ€è·¯"></a>æ€»ä½“æ€è·¯</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>å­¦ä¹ åŸºæœ¬çš„æ•°æ®ç»“æ„è®¤è¯†ã€‚å…µé©¬æœªåŠ¨ç²®è‰å…ˆè¡Œã€‚å…ˆæŠŠåŸºç¡€ç†è®ºææ¸…æ¥šã€‚</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>å­¦Javaçš„ï¼Œå¯ä»¥ä»ä¸‹é¢ä¸¤æœ¬ä¹¦ä¸­é€‰ä¸€æœ¬ï¼š</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p><a href="https://book.douban.com/subject/26745780/">æ•°æ®ç»“æ„ä¸ç®—æ³•åˆ†æ</a>&#8201;&#8212;&#8201;è¿™æœ¬ä¹¦çš„ä¼˜ç‚¹åœ¨äºå’Œ Java JDK çš„é›†åˆç±»å¾ˆè´´è¿‘ã€‚</p>
</li>
<li>
<p><a href="https://book.douban.com/subject/19952400/">ç®—æ³•ï¼ˆç¬¬4ç‰ˆï¼‰</a>&#8201;&#8212;&#8201;è¿™æœ¬ä¹¦èƒœåœ¨å›¾å¾ˆå¤šã€‚</p>
</li>
</ol>
</div>
</li>
<li>
<p>å­¦ C/C++ çš„ï¼Œå¯ä»¥çœ‹ä¸‹é¢è¿™å¥—ä¹¦ï¼š</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p><a href="https://book.douban.com/subject/4065258/">ç®—æ³•ï¼šCè¯­è¨€å®ç° (ç¬¬1ï½4éƒ¨åˆ†)</a></p>
</li>
<li>
<p><a href="https://book.douban.com/subject/4191525/">ç®—æ³•ï¼šCè¯­è¨€å®ç° ï¼ˆç¬¬5éƒ¨åˆ†ï¼‰</a></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>è‡ªå·±å®ç°ä¸€éåŸºæœ¬çš„æ•°æ®ç»“æ„ï¼›</p>
</li>
<li>
<p>é˜…è¯» JDK æˆ– STL æºç ï¼Œåšå­¦ä¹ ç¬”è®°ã€‚</p>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
å¯¹æ¯”ä¸€ä¸‹è‡ªå·±çš„å®ç°å’Œè¿™äº›ç»å…¸ä»£ç çš„å®ç°ï¼Œæ€»ç»“è‡ªå·±å·®è·ï¼Œæé«˜è‡ªå·±çš„ç¼–ç èƒ½åŠ›ã€‚
</td>
</tr>
</table>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><a href="https://book.douban.com/subject/1110934/">STLæºç å‰–æ </a>&#8201;&#8212;&#8201;é˜…è¯»æºç æ—¶ï¼Œå»ºè®®å‚è€ƒä¸€ä¸‹æœ¬ä¹¦çš„å†…å®¹ã€‚</p>
</li>
<li>
<p>å»ºè®®æŠŠç½‘ä¸Šçš„æºç åˆ†æç¬”è®°éƒ½çœ‹ä¸€çœ‹ï¼Œå–é•¿è¡¥çŸ­ï¼Œè¡¥å……è‡ªå·±çš„åˆ†æã€‚</p>
</li>
<li>
<p>å»ºè®®æŠŠç½‘ä¸Šç›¸å…³é¢è¯•é¢˜ä¹Ÿçœ‹ä¸€çœ‹ï¼Œæ£€éªŒè‡ªå·±çš„å­¦ä¹ æˆæœã€‚</p>
</li>
</ol>
</div>
</li>
<li>
<p>ç›¸å…³è”çš„ LeetCode ä¸Šçš„é¢˜éƒ½åˆ·æ‰ã€‚</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>è¿˜æœ‰ä¸¤ä¸ªæƒ³æ³•ï¼š</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>å¯ä»¥æŠŠ Redis çš„å®ç°ä¹Ÿè¿‡ä¸€ä¸‹ï¼ŒRedis å®ç°ä¹Ÿæœ‰å¾ˆå¤šä¸é”™çš„æ€è·¯ã€‚æ¯•ç«Ÿ Redis æ˜¯ç›®å‰æœ€å¸¸ç”¨çš„ç¼“å­˜è§£å†³æ–¹æ¡ˆã€‚</p>
</li>
<li>
<p>Java ä¸­æœ‰å¾ˆå¤šé’ˆå¯¹é›†åˆç±»åšæ‰©å±•çš„åº“ï¼Œå¯ä»¥ä¸€å¹¶å­¦äº†ï¼Œè¿™æ ·å°±èƒ½æ›´æ¸…æ¥šäº†è§£ Java JDK å®ç°çš„ä¸è¶³ï¼Œå¼€é˜”è‡ªå·±çš„çœ¼ç•Œï¼š</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><a href="https://github.com/google/guava">google/guava: Google core libraries for Java</a></p>
</li>
<li>
<p><a href="https://commons.apache.org/proper/commons-collections/">Apache Commons Collections</a></p>
</li>
<li>
<p><a href="https://www.eclipse.org/collections/">Eclipse Collections - Features you want with the collections you need.</a></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_jdk_é›†åˆç±»"><a class="anchor" href="#_jdk_é›†åˆç±»"></a>JDK é›†åˆç±»</h3>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>Base + Iterator</strong></dt>
<dd>
<p>ä»£ç æ€»è¡Œæ•°ï¼š 103 + 135 + 302 + 195 + 838 + 127 + 734 + 480 = 2914 è¡Œï¼Œé¢„è®¡ 5 ä¸ªå°æ—¶ã€‚</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>java.lang.Iterable</code></p>
</li>
<li>
<p><code>java.util.Iterator</code></p>
</li>
<li>
<p><code>java.util.PrimitiveIterator</code></p>
</li>
<li>
<p><code>java.util.ListIterator</code></p>
</li>
<li>
<p><code>java.util.Spliterator</code></p>
</li>
<li>
<p><code>java.util.Enumeration</code></p>
</li>
<li>
<p><code>java.util.Collection</code></p>
</li>
<li>
<p><code>java.util.AbstractCollection</code></p>
</li>
</ol>
</div>
</dd>
<dt class="hdlist1"><strong>List</strong></dt>
<dd>
<p>ä»£ç æ€»è¡Œæ•°ï¼š 1063 + 942 + 253 + 1266 + 1509 + 141 + 1759 = 6933 è¡Œï¼Œé¢„è®¡ 12 ä¸ªå°æ—¶ã€‚</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>java.util.List</code></p>
</li>
<li>
<p><code>java.util.AbstractList</code></p>
</li>
<li>
<p><code>java.util.AbstractSequentialList</code></p>
</li>
<li>
<p><code>java.util.LinkedList</code></p>
</li>
<li>
<p><code>java.util.Vector</code></p>
</li>
<li>
<p><code>java.util.Stack</code></p>
</li>
<li>
<p><code>java.util.ArrayList</code></p>
</li>
</ol>
</div>
</dd>
<dt class="hdlist1"><strong>Queue</strong></dt>
<dd>
<p>ä»£ç æ€»è¡Œæ•°ï¼š 212 + 616 + 192 + 1233 + 987 = 3240 è¡Œï¼Œé¢„è®¡ 6 ä¸ªå°æ—¶ã€‚</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>java.util.Queue</code></p>
</li>
<li>
<p><code>java.util.Deque</code></p>
</li>
<li>
<p><code>java.util.AbstractQueue</code></p>
</li>
<li>
<p><code>java.util.ArrayDeque</code></p>
</li>
<li>
<p><code>java.util.PriorityQueue</code></p>
</li>
</ol>
</div>
</dd>
<dt class="hdlist1"><strong>Set</strong></dt>
<dd>
<p>ä»£ç æ€»è¡Œæ•°ï¼š 732 + 186 + 264 + 491 + 323 + 361 + 560 + 195 + 1395 = 4507 è¡Œï¼Œé¢„è®¡ 8 ä¸ªå°æ—¶ã€‚</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>java.util.Set</code></p>
</li>
<li>
<p><code>java.util.AbstractSet</code></p>
</li>
<li>
<p><code>java.util.SortedSet</code></p>
</li>
<li>
<p><code>java.util.EnumSet</code></p>
</li>
<li>
<p><code>java.util.NavigableSet</code></p>
</li>
<li>
<p><code>java.util.HashSet</code></p>
</li>
<li>
<p><code>java.util.TreeSet</code></p>
</li>
<li>
<p><code>java.util.LinkedHashSet</code></p>
</li>
<li>
<p><code>java.util.BitSet</code></p>
</li>
</ol>
</div>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/java.util.Collection.png" alt="java.util.Collection">
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>Map</strong></dt>
<dd>
<p>ä»£ç æ€»è¡Œæ•°ï¼š 1687 + 284 + 424 + 857 + 3012 + 1339 + 812 + 1600 + 756 + 2444 + 155 + 1521 = 14891 è¡Œï¼Œé¢„è®¡ 28 ä¸ªå°æ—¶ã€‚</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>java.util.Map</code></p>
</li>
<li>
<p><code>java.util.SortedMap</code></p>
</li>
<li>
<p><code>java.util.NavigableMap</code></p>
</li>
<li>
<p><code>java.util.AbstractMap</code></p>
</li>
<li>
<p><code>java.util.TreeMap</code></p>
</li>
<li>
<p><code>java.util.WeakHashMap</code></p>
</li>
<li>
<p><code>java.util.EnumMap</code></p>
</li>
<li>
<p><code>java.util.IdentityHashMap</code></p>
</li>
<li>
<p><code>java.util.LinkedHashMap</code></p>
</li>
<li>
<p><code>java.util.HashMap</code></p>
</li>
<li>
<p><code>java.util.Dictionary</code></p>
</li>
<li>
<p><code>java.util.Hashtable</code></p>
</li>
</ol>
</div>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/java.util.Map.png" alt="java.util.Map">
</div>
</div>
<div class="paragraph">
<p>æ¥å¼ æ€»ä½“ç»“æ„å›¾ï¼š</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/jdk-collection-classes.png" alt="jdk collection classes">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
è¿™é‡Œæ²¡æœ‰åŒ…å«å¹¶å‘ç›¸å…³çš„é›†åˆç±»ã€‚è¿™å—å†…å®¹æ”¾åˆ°å¹¶å‘ä¸­ä¸€èµ·æã€‚
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_é›†åˆç±»æ¦‚è¿°"><a class="anchor" href="#_é›†åˆç±»æ¦‚è¿°"></a>1. é›†åˆç±»æ¦‚è¿°</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="./images/java-collections-overview.png" alt="java collections overview">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_è¿­ä»£å™¨_iterator_enumeration_spliterator_ä¸_iterable"><a class="anchor" href="#_è¿­ä»£å™¨_iterator_enumeration_spliterator_ä¸_iterable"></a>2. è¿­ä»£å™¨ Iteratorã€ Enumerationã€ Spliterator ä¸ Iterable</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_æ¶‰åŠä»£ç "><a class="anchor" href="#_æ¶‰åŠä»£ç "></a>2.1. æ¶‰åŠä»£ç </h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>java.util.Iterator</code></p>
</li>
<li>
<p><code>java.util.PrimitiveIterator</code></p>
</li>
<li>
<p><code>java.util.ListIterator</code></p>
</li>
<li>
<p><code>java.util.Spliterator</code></p>
</li>
<li>
<p><code>java.util.Enumeration</code></p>
</li>
<li>
<p><code>java.lang.Iterable</code></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_è¿­ä»£å™¨æ¨¡å¼"><a class="anchor" href="#_è¿­ä»£å™¨æ¨¡å¼"></a>2.2. è¿­ä»£å™¨æ¨¡å¼</h3>
<div class="paragraph">
<p>åœ¨è¿›è¡Œä»£ç åˆ†æä¹‹å‰ï¼ŒDç“œå“¥æƒ³å…ˆæ¥è®²è§£ä¸€ä¸‹è®¾è®¡æ¨¡å¼ã€‚ç„¶åç»“åˆ Java ä¸­ <code>Iterator</code> å’Œ <code>Iteratable</code> ï¼Œå…·ä½“åˆ†æä¸€ä¸‹è¿­ä»£å™¨åœ¨ Java ä¸­çš„å®ç°ã€‚</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="dlist">
<dl>
<dt class="hdlist1">è¿­ä»£å™¨æ¨¡å¼ï¼ˆIteratorï¼‰</dt>
<dd>
<p>æä¾›ä¸€ç§æ–¹æ³•é¡ºåºè®¿é—®ä¸€ä¸ªèšåˆå¯¹è±¡ä¸­å„ä¸ªå…ƒç´ ï¼Œè€Œä¸æ˜¯æš´éœ²è¯¥å¯¹è±¡çš„å†…éƒ¨è¡¨ç¤ºã€‚</p>
</dd>
</dl>
</div>
</blockquote>
<div class="attribution">
&#8212; Erich Gammaã€Richard Helmã€Ralph Johnsonã€John Vlissides<br>
<cite>ã€Šè®¾è®¡æ¨¡å¼ã€‹</cite>
</div>
</div>
<div class="paragraph">
<p>ç±»å›¾å¦‚ä¸‹ï¼š</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./diag-385192af6c09bbf6ba3775ed995deb6d.svg" alt="diag 385192af6c09bbf6ba3775ed995deb6d" width="100%" height="491">
</div>
</div>
<div class="paragraph">
<p>å½“éœ€è¦è®¿é—®ä¸€ä¸ªèšé›†å¯¹è±¡ï¼Œè€Œä¸”ä¸ç®¡è¿™äº›å¯¹è±¡æ˜¯ä»€ä¹ˆéƒ½éœ€è¦éå†çš„æ—¶å€™ï¼Œå°±åº”è¯¥è€ƒè™‘ç”¨è¿­ä»£å™¨æ¨¡å¼ã€‚</p>
</div>
<div class="paragraph">
<p>å½“éœ€è¦å¯¹èšé›†æœ‰å¤šç§æ–¹å¼éå†æ—¶ï¼Œå¯ä»¥è€ƒè™‘ç”¨è¿­ä»£å™¨æ¨¡å¼ã€‚</p>
</div>
<div class="paragraph">
<p>ä¸ºéå†ä¸åŒçš„èšé›†ç»“æ„æä¾›å¦‚å¼€å§‹ã€ä¸‹ä¸€ä¸ªã€æ˜¯å¦ç»“æŸã€å½“å‰å“ªä¸€é¡¹ç­‰ç»Ÿä¸€çš„æ¥å£ã€‚</p>
</div>
<div class="paragraph">
<p>å°½ç®¡æˆ‘ä»¬ä¸éœ€è¦æ˜¾å¼çš„å¼•ç”¨è¿­ä»£å™¨ï¼Œä½†ç³»ç»Ÿæœ¬èº«è¿˜æ˜¯é€šè¿‡è¿­ä»£å™¨æ¥å®ç°éå†çš„ã€‚æ€»åœ°æ¥è¯´ï¼Œè¿­ä»£å™¨ï¼ˆ<code>Iterator</code>ï¼‰æ¨¡å¼å°±æ˜¯åˆ†ç¦»äº†é›†åˆå¯¹è±¡çš„éå†è¡Œä¸ºï¼ŒæŠ½è±¡å‡ºä¸€ä¸ªè¿­ä»£å™¨ç±»æ¥è´Ÿè´£ï¼Œè¿™æ ·æ—¢å¯ä»¥åšåˆ°ä¸æš´éœ²é›†åˆçš„å†…éƒ¨ç»“æ„ï¼Œåˆå¯è®©å¤–éƒ¨ä»£ç é€æ˜åœ°è®¿é—®é›†åˆå†…éƒ¨çš„æ•°æ®ã€‚</p>
</div>
<div class="paragraph">
<p>è¯·é—®ï¼š Java ä¸­æ˜¯å¦‚ä½•åº”ç”¨è¿­ä»£å™¨æ¨¡å¼å‘¢ï¼Ÿ</p>
</div>
</div>
<div class="sect2">
<h3 id="_iterator"><a class="anchor" href="#_iterator"></a>2.3. <code>Iterator</code></h3>
<div class="paragraph">
<p>ä»ä¸Šé¢çš„è®¾è®¡æ¨¡å¼å¯ä»¥çœ‹å‡ºï¼Œè¿­ä»£å™¨æ¨¡å¼å°±æ˜¯ä¸ºäº†éå†ä¸åŒçš„èšé›†ç»“æ„æä¾›è¯¸å¦‚å¼€å§‹ã€ä¸‹ä¸€ä¸ªã€æ˜¯å¦ç»“æŸã€å½“å‰å…ƒç´ ç­‰å¸¸è§æ“ä½œçš„ç»Ÿä¸€æ¥å£ã€‚æ¥çœ‹çœ‹ Java é›†åˆç±»æ˜¯å¦‚ä½•æç‚¼æ¥å£çš„ã€‚</p>
</div>
<div class="listingblock">
<div class="title">java.util.Iterator</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kt">boolean</span> <span class="nf">hasNext</span><span class="o">();</span>

    <span class="no">E</span> <span class="nf">next</span><span class="o">();</span>

    <span class="k">default</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">UnsupportedOperationException</span><span class="o">(</span><span class="s">"remove"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * @since 1.8
     */</span>
    <span class="k">default</span> <span class="kt">void</span> <span class="nf">forEachRemaining</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">action</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">hasNext</span><span class="o">())</span>
            <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">next</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ä»ä¸Šè¿°ä»£ç ä¸­ï¼Œå¯ä»¥çœ‹å‡º Java æå–äº† <code>boolean hasNext()</code>ã€ <code>E next()</code>ã€ <code>void remove()</code> ç­‰ä¸‰ä¸ªæ“ä½œæ–¹æ³•ï¼›åœ¨ Java 8 ä¸­ï¼Œä¸ºäº†æ”¯æŒ Stream APIï¼Œæœ‰å¢åŠ äº† <code>void forEachRemaining(Consumer&lt;? super E&gt; action)</code> æ–¹æ³•ã€‚</p>
</div>
<div class="paragraph">
<p>è¿™é‡Œå¤šæ‰¯ä¸€å¥ï¼ŒJava åœ¨ 1.2 ä»¥å‰è¿­ä»£å™¨æ˜¯é€šè¿‡å¦å¤–ä¸€ä¸ªæ¥å£å®ç°çš„ï¼š</p>
</div>
<div class="listingblock">
<div class="title">java.util.Enumeration</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Enumeration</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kt">boolean</span> <span class="nf">hasMoreElements</span><span class="o">();</span>

    <span class="no">E</span> <span class="nf">nextElement</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ä¸ä¸Šé¢çš„ <code>java.util.Iterator</code> å¯¹æ¯”å¯ä»¥çœ‹å‡ºï¼Œä¸¤è€…å·®åˆ«ä¸å¤§ã€‚é‚£ä¸ºä»€ä¹ˆ Java åœ¨å·²æœ‰ <code>java.util.Iterator</code> æ¥å£çš„æƒ…å†µä¸‹ï¼Œè¿˜è¦æ¨å‡º <code>java.util.Enumeration</code> æ¥å£å‘¢ï¼Ÿåœ¨ <code>java.util.Iterator</code> æ¥å£çš„ JavaDoc ä¸­ç»™å‡ºäº†å¦‚ä¸‹ç†ç”±ï¼š</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Iterators allow the caller to remove elements from the underlying collection during the iteration with well-defined semantics.</p>
</li>
<li>
<p>Method names have been improved.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œåœ¨ Java 8 ä¹‹å‰ï¼Œæ¥å£ä¸­çš„æ–¹æ³•ä¸èƒ½æœ‰ä»»ä½•å®ç°ã€‚æ‰€ä»¥ï¼Œä¸ºäº†ä¿æŒå…¼å®¹æ€§ï¼Œä¸èƒ½åœ¨å·²æœ‰æ¥å£ä¸­å¢åŠ æ–¹æ³•ã€‚åªèƒ½å¦èµ·ç‚‰ç¶ï¼ŒæŠŠâ€œæ´â€è¡¥ä¸Šã€‚è¿™ä¹Ÿå°±ä¸éš¾ç†è§£ï¼Œä¸ºä»€ä¹ˆåˆæå‡ºäº†ä¸ª <code>java.util.Iterator</code>ã€‚</p>
</div>
<div class="paragraph">
<p>è¿™é‡Œå†å¤šæä¸€å¥ï¼Œéœ€è¦å¢åŠ è‡ªå®šä¹‰çš„è¿­ä»£å™¨å®ç°æ—¶ï¼Œè¯·ä¼˜å…ˆé€‰æ‹© <code>java.util.Iterator</code>ã€‚</p>
</div>
<div class="paragraph">
<p>è¯·é—®ï¼šæ—¢ç„¶æœ‰è¿­ä»£å™¨æ¥å£å®šä¹‰äº†ï¼Œé‚£ä¹ˆ Java åˆæ˜¯å¦‚ä½•ç”Ÿæˆè¿­ä»£å™¨å®ä¾‹å‘¢ï¼Ÿ</p>
</div>
</div>
<div class="sect2">
<h3 id="_iterable"><a class="anchor" href="#_iterable"></a>2.4. <code>Iterable</code></h3>
<div class="paragraph">
<p>æ—¢ç„¶è¿­ä»£å™¨å¯ä»¥æŠ½è±¡æˆä¸€ä¸ªå…¬å…±çš„æ¥å£ï¼Œé‚£ä¹ˆç”Ÿæˆè¿­ä»£å™¨å®ä¾‹çš„è¿™ä¸ªæ“ä½œï¼Œä¹Ÿå¯ä»¥æŠ½è±¡æˆä¸€ä¸ªæ¥å£ã€‚ Java ä¹Ÿç¡®å®æ˜¯è¿™æ ·åšçš„ï¼š</p>
</div>
<div class="listingblock">
<div class="title">java.lang.Iterable</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Iterable</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">iterator</span><span class="o">();</span>

    <span class="cm">/**
     * @since 1.8
     */</span>
    <span class="k">default</span> <span class="kt">void</span> <span class="nf">forEach</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">T</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">action</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="no">T</span> <span class="n">t</span> <span class="o">:</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * @since 1.8
     */</span>
    <span class="k">default</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">spliterator</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Spliterators</span><span class="o">.</span><span class="na">spliteratorUnknownSize</span><span class="o">(</span><span class="n">iterator</span><span class="o">(),</span> <span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ä»ç±»çš„å®šä¹‰ä¸­ï¼Œå¯ä»¥çœ‹åˆ° <code>java.lang.Iterable</code> æä¾›äº† <code>iterator()</code>ï¼Œç”¨äºåˆ›å»º <code>java.util.Iterator</code> ç¤ºä¾‹å¯¹è±¡ã€‚</p>
</div>
<div class="paragraph">
<p>åœ¨ Java 8 ä¸­ï¼Œä¸ºäº†æ”¯æŒ Lambda è¡¨è¾¾å¼å’Œ Stream APIï¼Œåˆå¢åŠ äº† <code>forEach(Consumer&lt;? super T&gt; action)</code> å’Œ <code>spliterator()</code> æ–¹æ³•ã€‚</p>
</div>
<div class="paragraph">
<p>åœ¨æ€è€ƒå®ç°åŸç†çš„è¿‡ç¨‹ä¸­ï¼ŒDç“œå“¥çªç„¶æƒ³åˆ°ï¼Œ<code>java.lang.Iterable</code> å°±æ˜¯ä¸€ä¸ªå·¥å‚æ–¹æ³•æ¨¡å¼çš„åº”ç”¨ã€‚æ¥åˆ†æä¸€ä¸‹ï¼š</p>
</div>
</div>
<div class="sect2">
<h3 id="_å·¥å‚æ–¹æ³•æ¨¡å¼"><a class="anchor" href="#_å·¥å‚æ–¹æ³•æ¨¡å¼"></a>2.5. å·¥å‚æ–¹æ³•æ¨¡å¼</h3>
<div class="paragraph">
<p>å…ˆæ¥çœ‹çœ‹å·¥å‚æ–¹æ³•æ¨¡å¼çš„å®šä¹‰ï¼š</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="dlist">
<dl>
<dt class="hdlist1">å·¥å‚æ–¹æ³•æ¨¡å¼ï¼ˆFactory Methodï¼‰</dt>
<dd>
<p>å®šä¹‰ä¸€ä¸ªç”¨äºåˆ›å»ºå¯¹è±¡çš„æ¥å£ï¼Œè®©å­ç±»å†³å®šå®ä¾‹åŒ–å“ªä¸€ä¸ªç±»ã€‚å·¥å‚æ–¹æ³•ä½¿ä¸€ä¸ªç±»çš„å®ä¾‹åŒ–å»¶è¿Ÿåˆ°å…¶å­ç±»ã€‚</p>
</dd>
</dl>
</div>
</blockquote>
<div class="attribution">
&#8212; Erich Gammaã€Richard Helmã€Ralph Johnsonã€John Vlissides<br>
<cite>ã€Šè®¾è®¡æ¨¡å¼ã€‹</cite>
</div>
</div>
<div class="paragraph">
<p>ç±»å›¾å¦‚ä¸‹ï¼š</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./diag-b91e0a8e1dbd3f3053e51b7170fa5378.svg" alt="diag b91e0a8e1dbd3f3053e51b7170fa5378" width="100%" height="380">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.lang.Iterable</code> å°±ç›¸å½“äº <code>Factory</code> æ¥å£ï¼Œä¹Ÿå°±æ˜¯å·¥å‚ï¼›</p>
</li>
<li>
<p><code>java.util.Iterator</code> å°±ç›¸å½“äºå·¥å‚ç”Ÿæˆçš„äº§å“ <code>Product</code>ï¼›</p>
</li>
<li>
<p><code>iterator()</code> æ–¹æ³•å°±æ˜¯å·¥å‚æ–¹æ³• <code>factoryMethod()</code>ï¼›</p>
</li>
<li>
<p><code>java.lang.Iterable</code> å’Œ <code>java.util.Iterator</code> å­ç±»ï¼Œéƒ½æ”¾åœ¨äº†å„ä¸ªé›†åˆç±»ä¸­æ¥å…·ä½“å®ç°ã€‚</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>åœ¨å„ä¸ªèšé›†ç±»ä¸­ï¼Œå»å®ç° <code>java.lang.Iterable</code> æ¥å£ï¼Œç„¶åæ ¹æ®èšé›†ç±»çš„æƒ…å†µï¼Œè¿”å›å¯¹åº”çš„ <code>java.util.Iterator</code> å…·ä½“ç±»å¯¹è±¡å³å¯ã€‚</p>
</div>
<div class="paragraph">
<p>ç»†å¿ƒçš„ç«¥é‹ï¼Œå¯èƒ½å‘ç°è¿˜æœ‰ä¸ªç±»ä¼¼è¿­ä»£å™¨çš„ç±» <code>Spliterator</code>ã€‚è¿™æ˜¯ä¸ªä»€ä¹ˆç±»ï¼Ÿä¸ºå•¥è¦å¢åŠ ç›¸å…³çš„æ¥å£å‘¢ï¼Ÿ</p>
</div>
</div>
<div class="sect2">
<h3 id="_spliterator"><a class="anchor" href="#_spliterator"></a>2.6. <code>Spliterator</code></h3>

</div>
<div class="sect2">
<h3 id="ListIterator"><a class="anchor" href="#ListIterator"></a>2.7. <code>ListIterator</code></h3>
<div class="paragraph">
<p><code>java.util.Iterator</code> æ˜¯é’ˆå¯¹æ•´ä¸ªé›†åˆç±»æŠ½è±¡å‡ºæ¥çš„é€šç”¨è¿­ä»£å™¨ã€‚ä½†æ˜¯ï¼Œå¯ä»¥æ€è€ƒä¸€ä¸‹ï¼Œå¯¹äº <code>java.util.List</code> æ˜¯ä¸æ˜¯å¯ä»¥æœ‰æ›´å¥‘åˆçš„è¿­ä»£å™¨ï¼Ÿ</p>
</div>
<div class="paragraph">
<p>å…³äºè¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆï¼ŒJDK ç»™å‡ºäº†è‡ªå·±çš„ç­”æ¡ˆï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ListIterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="c1">// Query Operations</span>

    <span class="kt">boolean</span> <span class="nf">hasNext</span><span class="o">();</span>

    <span class="no">E</span> <span class="nf">next</span><span class="o">();</span>

    <span class="kt">boolean</span> <span class="nf">hasPrevious</span><span class="o">();</span>

    <span class="no">E</span> <span class="nf">previous</span><span class="o">();</span>

    <span class="kt">int</span> <span class="nf">nextIndex</span><span class="o">();</span>

    <span class="kt">int</span> <span class="nf">previousIndex</span><span class="o">();</span>


    <span class="c1">// Modification Operations</span>

    <span class="kt">void</span> <span class="nf">remove</span><span class="o">();</span>

    <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">);</span>

    <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ç”±äº <code>List</code> æ˜¯æœ‰åºçš„ï¼Œä»ä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ‰€ä»¥ï¼Œ<code>ListIterator</code> åœ¨ <code>Iterator</code> åŸºç¡€ä¹‹ä¸Šï¼Œå¢åŠ äº†è·å‰åå…ƒç´ ç›¸å…³çš„æ–¹æ³•ï¼›åŒæ—¶ï¼Œè¿˜å¢åŠ äº†ä¿®æ”¹ç›¸å…³çš„æ“ä½œæ–¹æ³•ã€‚</p>
</div>
<div class="paragraph">
<p>å› ä¸ºå¢åŠ äº† <code>hasPrevious()</code> å’Œ <code>previous()</code>ï¼Œé‚£ä¹ˆ <code>ListIterator</code> å°±æœ‰äº†åŒå‘éå†çš„èƒ½åŠ›ï¼šæ—¢å¯ä»¥åƒä¼ ç»Ÿè¿­ä»£å™¨é‚£æ ·ï¼Œä»å‰å‘åéå†ï¼›åˆå¯ä»¥é€†å‘ï¼Œä»åæƒ³å‰éå†ã€‚è¿™æ ·åœ¨æŸäº›åœºæ™¯ä¸‹å°±ä¼šç‰¹åˆ«æ–¹ä¾¿ã€‚</p>
</div>
</div>
<div class="sect2">
<h3 id="_å‚è€ƒèµ„æ–™"><a class="anchor" href="#_å‚è€ƒèµ„æ–™"></a>2.8. å‚è€ƒèµ„æ–™</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.journaldev.com/13457/java-listiterator">Java ListIterator - ListIterator in Java - JournalDev</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_collection"><a class="anchor" href="#_collection"></a>3. Collection</h2>
<div class="sectionbody">
<div class="paragraph">
<p>æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æ€è€ƒä¸€ä¸‹ï¼šå¦‚æœè®©ä½ è®¾è®¡ JDK é›†åˆæ¡†æ¶ï¼Œä½ ä¼šæ€ä¹ˆè®¾è®¡ï¼Ÿè¯´çš„æ›´å…·ä½“ä¸€äº›ï¼Œç°åœ¨éœ€è¦ä¸€ä¸ªå¯ä»¥åŒ…å«é‡å¤å¯¹è±¡çš„ <code>Aggregation</code> é›†åˆï¼Œè¯·é—®æ€ä¹ˆè®¾è®¡ï¼Ÿ</p>
</div>
<div class="paragraph">
<p>å¯ä»¥å…ˆè®¾æƒ³ä¸€ä¸‹ï¼Œæœ‰å“ªäº›æ“ä½œï¼Ÿ</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>æ·»åŠ å…ƒç´  <code>add()</code></p>
</li>
<li>
<p>åˆ é™¤å…ƒç´  <code>remove()</code></p>
</li>
<li>
<p>æ˜¯å¦åŒ…å«å…ƒç´  <code>boolean contain(Element e)</code></p>
</li>
<li>
<p>åˆ—è¡¨å¤§å° <code>int size()</code></p>
</li>
<li>
<p>æ·»åŠ æ•´ä¸ª <code>Bag</code> å…ƒç´  <code>addAll(Aggregation aggregation)</code></p>
</li>
<li>
<p>æ¸…ç©º <code>clear()</code></p>
</li>
<li>
<p>è¿­ä»£å™¨ <code>Iterator&lt;T&gt; iterator()</code></p>
</li>
<li>
<p>å’Œæ•°ç»„äº’æ“ä½œï¼š <code>toArray()</code> å’Œ <code>addAll(T[] array)</code></p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">java.util.Collection</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">Iterable</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="c1">// Query Operations</span>

    <span class="kt">int</span> <span class="nf">size</span><span class="o">();</span>

    <span class="kt">boolean</span> <span class="nf">isEmpty</span><span class="o">();</span>

    <span class="kt">boolean</span> <span class="nf">contains</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">);</span>

    <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">iterator</span><span class="o">();</span>

    <span class="nc">Object</span><span class="o">[]</span> <span class="nf">toArray</span><span class="o">();</span>

    <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span><span class="o">[]</span> <span class="nf">toArray</span><span class="o">(</span><span class="no">T</span><span class="o">[]</span> <span class="n">a</span><span class="o">);</span>

    <span class="c1">// Modification Operations</span>

    <span class="kt">boolean</span> <span class="nf">add</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">);</span>

    <span class="kt">boolean</span> <span class="nf">remove</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">);</span>


    <span class="c1">// Bulk Operations</span>

    <span class="kt">boolean</span> <span class="nf">containsAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">);</span>

    <span class="kt">boolean</span> <span class="nf">addAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">);</span>

    <span class="kt">boolean</span> <span class="nf">removeAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">);</span>

    <span class="cm">/**
     * @since 1.8
     */</span>
    <span class="k">default</span> <span class="kt">boolean</span> <span class="nf">removeIf</span><span class="o">(</span><span class="nc">Predicate</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">filter</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">filter</span><span class="o">);</span>
        <span class="kt">boolean</span> <span class="n">removed</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">each</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">each</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">filter</span><span class="o">.</span><span class="na">test</span><span class="o">(</span><span class="n">each</span><span class="o">.</span><span class="na">next</span><span class="o">()))</span> <span class="o">{</span>
                <span class="n">each</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
                <span class="n">removed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">removed</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kt">boolean</span> <span class="nf">retainAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">);</span>

    <span class="kt">void</span> <span class="nf">clear</span><span class="o">();</span>


    <span class="c1">// Comparison and hashing</span>

    <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">);</span>

    <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">();</span>

    <span class="cm">/**
     * @since 1.8
     */</span>
    <span class="nd">@Override</span>
    <span class="k">default</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">spliterator</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Spliterators</span><span class="o">.</span><span class="na">spliterator</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * @since 1.8
     */</span>
    <span class="k">default</span> <span class="nc">Stream</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">stream</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">StreamSupport</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">spliterator</span><span class="o">(),</span> <span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * @since 1.8
     */</span>
    <span class="k">default</span> <span class="nc">Stream</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">parallelStream</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">StreamSupport</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">spliterator</span><span class="o">(),</span> <span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_abstractcollection"><a class="anchor" href="#_abstractcollection"></a>4. AbstractCollection</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_list"><a class="anchor" href="#_list"></a>5. List</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_abstractlist"><a class="anchor" href="#_abstractlist"></a>6. AbstractList</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_abstractsequentiallist"><a class="anchor" href="#_abstractsequentiallist"></a>7. AbstractSequentialList</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_ç±»å›¾"><a class="anchor" href="#_ç±»å›¾"></a>7.1. ç±»å›¾</h3>
<div class="paragraph">
<p>å…ˆæ¥çœ‹ä¸€ä¸‹ <code>AbstractSequentialList</code> çš„ç±»å›¾ï¼š</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./diag-346d181908abb44f7df9c91523871a60.svg" alt="diag 346d181908abb44f7df9c91523871a60" width="100%" height="519">
</div>
</div>
<div class="paragraph">
<p><code>AbstractSequentialList</code> æ˜¯ <a href="#"><code>java.util.LinkedList</code></a> çš„çˆ¶ç±»ï¼Œä¸»è¦æ˜¯åŸºäº <a href="#ListIterator"><code>java.util.ListIterator</code></a> å®ç°äº†</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>get(int index)</code></p>
</li>
<li>
<p><code>set(int index, E element)</code></p>
</li>
<li>
<p><code>add(int index, E element)</code></p>
</li>
<li>
<p><code>remove(int index)</code></p>
</li>
<li>
<p><code>addAll(int index, Collection&lt;? extends E&gt; c)</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ç­‰ä¸å…·ä½“åæ ‡ç›¸å…³çš„éšæœºè®¿é—® List çš„æ–¹æ³•ã€‚</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_arraylist"><a class="anchor" href="#_arraylist"></a>8. <code>ArrayList</code></h2>
<div class="sectionbody">
<div class="paragraph">
<p>å¯¹äºæ¯ç§æŠ½è±¡æ•°æ®ç±»å‹å¹¶ä¸å­˜åœ¨ä»€ä¹ˆæ³•åˆ™æ¥å‘Šè¯‰æˆ‘ä»¬å¿…é¡»è¦æœ‰å“ªäº›æ“ä½œï¼Œè¿™æ˜¯ä¸€ä¸ªè®¾è®¡å†³ç­–ã€‚--ã€Šæ•°æ®ç»“æ„ä¸ç®—æ³•åˆ†æã€‹</p>
</div>
<div class="sect2">
<h3 id="_ç±»å›¾_2"><a class="anchor" href="#_ç±»å›¾_2"></a>8.1. ç±»å›¾</h3>
<div class="paragraph">
<p>å…ˆæ¥çœ‹ä¸€ä¸‹ <code>ArrayList</code> çš„ç±»å›¾ï¼š</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./diag-e5444ec6a2cc3781e161e5f5824005be.svg" alt="diag e5444ec6a2cc3781e161e5f5824005be" width="100%" height="499">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>æ”¯æŒæ³›å‹ï¼Œç»§æ‰¿äº† <code>AbstractList</code>ï¼Œå®ç°äº† <code>List</code> æ¥å£ã€‚</p>
</li>
<li>
<p><code>RandomAccess</code> ç”¨æ¥è¡¨æ˜å…¶æ”¯æŒå¿«é€Ÿï¼ˆé€šå¸¸æ˜¯å›ºå®šæ—¶é—´ï¼‰éšæœºè®¿é—®ã€‚åœ¨ <code>Collections.binarySearch()</code> æ–¹æ³•ä¸­ï¼Œå®ƒè¦åˆ¤æ–­ä¼ å…¥çš„list æ˜¯å¦ <code>RamdomAccess</code> çš„å®ä¾‹ï¼Œå¦‚æœæ˜¯ï¼Œè°ƒç”¨ <code>Collections.indexedBinarySearch(list, key)</code> æ–¹æ³•ï¼Œå¦‚æœä¸æ˜¯ï¼Œé‚£ä¹ˆè°ƒç”¨ <code>Collections.iteratorBinarySearch(list, key)</code> æ–¹æ³•ã€‚</p>
</li>
<li>
<p><code>Cloneable</code> å¯ä»¥è°ƒç”¨ <code>Object.clone()</code> æ–¹æ³•è¿”å›è¯¥å¯¹è±¡çš„æµ…æ‹·è´ã€‚</p>
</li>
<li>
<p><code>Serializable</code> æ­¤ç±»å¯è¢«åºåˆ—åŒ–</p>
</li>
</ul>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>ä¸ºä»€ä¹ˆè¿˜è¦å†æ¬¡å®ç° <code>List</code> æ¥å£ï¼Ÿï¼ˆå…¶çˆ¶ç±»å·²ç»å®ç°æ­¤æ¥å£éƒ¨åˆ†æ–¹æ³•ï¼š <code>AbstractList</code> å®ç° <code>List</code> æ¥å£ä¸­é™¤ <code>size()</code> , <code>get(int index)</code> ä¹‹å¤–çš„æ‰€æœ‰å‡½æ•°ï¼‰ã€‚</p>
</div>
</div>
</div>
<div class="paragraph">
<p><strong>æŠ½è±¡ç±»å®ç°æ¥å£ï¼Œå¯ä»¥ä¸çœŸæ­£å®ç°æ‰€æœ‰æ–¹æ³•ï¼ˆå¯ä»¥æŠ½è±¡å®ç°ï¼‰ã€‚</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="_åˆå§‹åŒ–"><a class="anchor" href="#_åˆå§‹åŒ–"></a>8.2. åˆå§‹åŒ–</h3>
<div class="paragraph">
<p>é¦–å…ˆï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ <code>ArrayList</code> çš„åˆå§‹åŒ–ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
</pre></td><td class="code"><pre><span class="cm">/**
 * Default initial capacity.
 */</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">DEFAULT_CAPACITY</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>

<span class="cm">/**
 * Shared empty array instance used for empty instances.
 */</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="no">EMPTY_ELEMENTDATA</span> <span class="o">=</span> <span class="o">{};</span>

<span class="cm">/**
 * Shared empty array instance used for default sized empty instances. We
 * distinguish this from EMPTY_ELEMENTDATA to know how much to inflate when
 * first element is added.
 */</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="no">DEFAULTCAPACITY_EMPTY_ELEMENTDATA</span> <span class="o">=</span> <span class="o">{};</span>

<span class="cm">/**
 * The array buffer into which the elements of the ArrayList are stored.
 * The capacity of the ArrayList is the length of this array buffer. Any
 * empty ArrayList with elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA
 * will be expanded to DEFAULT_CAPACITY when the first element is added.
 */</span>
<span class="kd">transient</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span><span class="o">;</span> <span class="c1">// non-private to simplify nested class access</span>

<span class="cm">/**
 * The size of the ArrayList (the number of elements it contains).
 *
 * @serial
 */</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">size</span><span class="o">;</span>

<span class="cm">/**
 * Constructs an empty list with the specified initial capacity.
 *
 * @param  initialCapacity  the initial capacity of the list
 * @throws IllegalArgumentException if the specified initial capacity
 *         is negative
 */</span>
<span class="kd">public</span> <span class="nf">ArrayList</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">initialCapacity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">elementData</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="n">initialCapacity</span><span class="o">];</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">initialCapacity</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">elementData</span> <span class="o">=</span> <span class="no">EMPTY_ELEMENTDATA</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Illegal Capacity: "</span><span class="o">+</span>
                                           <span class="n">initialCapacity</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="cm">/**
 * Constructs an empty list with an initial capacity of ten.
 */</span>
<span class="kd">public</span> <span class="nf">ArrayList</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">elementData</span> <span class="o">=</span> <span class="no">DEFAULTCAPACITY_EMPTY_ELEMENTDATA</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * Constructs a list containing the elements of the specified
 * collection, in the order they are returned by the collection's
 * iterator.
 *
 * @param c the collection whose elements are to be placed into this list
 * @throws NullPointerException if the specified collection is null
 */</span>
<span class="kd">public</span> <span class="nf">ArrayList</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">elementData</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">toArray</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">size</span> <span class="o">=</span> <span class="n">elementData</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// defend against c.toArray (incorrectly) not returning Object[]</span>
        <span class="c1">// (see e.g. https://bugs.openjdk.java.net/browse/JDK-6260652)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">elementData</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span> <span class="o">!=</span> <span class="nc">Object</span><span class="o">[].</span><span class="na">class</span><span class="o">)</span>
            <span class="n">elementData</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">elementData</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[].</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c1">// replace with empty array.</span>
        <span class="k">this</span><span class="o">.</span><span class="na">elementData</span> <span class="o">=</span> <span class="no">EMPTY_ELEMENTDATA</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ä»ä¸Šè¿°ä»£ç ä¸­å¯ä»¥çŒœæµ‹ï¼Œ<strong><code>ArrayList</code> å†…éƒ¨ä½¿ç”¨æ•°ç»„æ¥ä¿å­˜å…ƒç´ çš„ï¼Œå¹¶ä¸”ä½¿ç”¨ä¸€ä¸ªæ•´å‹ <code>int</code> å˜é‡æ¥ä¿å­˜é•¿åº¦ã€‚</strong></p>
</div>
<div class="paragraph">
<p><code>ArrayList</code> åˆå§‹åŒ–å·¥ä½œåˆ†ä¸‰ç§æƒ…å†µï¼š</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>æ— å‚æ„é€ å‡½æ•°åˆå§‹åŒ–æ—¶ï¼Œç›´æ¥å°†å†…éƒ¨æ•°ç»„åˆå§‹åŒ–ä¸º <code>DEFAULTCAPACITY_EMPTY_ELEMENTDATA</code>ã€‚åœ¨ç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ æ—¶ï¼Œå†åˆå§‹åŒ–ä¸ºé»˜è®¤å®¹é‡æ˜¯ <code>10</code> çš„æ•°ç»„ã€‚</p>
</li>
<li>
<p>æŒ‡å®šå®¹é‡å¤§å°è¿›è¡Œåˆå§‹åŒ–æ—¶ï¼Œå®¹é‡å¤§äº <code>0</code> åˆ™åˆå§‹åŒ–ä¸ºæŒ‡å®šå®¹é‡çš„æ•°ç»„ï¼›å¦‚æœç­‰äº <code>0</code> åˆ™åˆå§‹åŒ–ä¸ºé»˜è®¤ç©ºæ•°ç»„ <code>EMPTY_ELEMENTDATA</code>ã€‚å¦åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</p>
</li>
<li>
<p>å¦‚æœä½¿ç”¨ <code>Collection</code> å®ä¾‹æ¥åˆå§‹åŒ–ï¼Œä¸ä¸ºç©ºåˆ™å°†è°ƒç”¨ <code>toArray()</code> æ–¹æ³•æ¥åˆå§‹åŒ– <code>elementData</code>ï¼›å¦‚æœä¸ºç©ºåˆ™åˆå§‹åŒ–ä¸ºé»˜è®¤ç©ºæ•°ç»„ <code>EMPTY_ELEMENTDATA</code>ã€‚</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_æ·»åŠ å…ƒç´ "><a class="anchor" href="#_æ·»åŠ å…ƒç´ "></a>8.3. æ·»åŠ å…ƒç´ </h3>
<div class="paragraph">
<p>åœ¨è¿›è¡Œæ­£å¸¸æµ‹è¯•å‰ï¼Œå…ˆå±•ç¤ºä¸€ä¸‹"é€è§†" <code>ArrayList</code> çš„å·¥å…·ç±»ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Objects</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-03-03 11:10
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ArrayListBaseTest</span> <span class="o">{</span>
    <span class="cm">/**
     * é€šè¿‡åå°„æŸ¥çœ‹ {@link ArrayList} çš„å†…éƒ¨å±æ€§
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">xray</span><span class="o">(</span><span class="nc">ArrayList</span> <span class="n">list</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Class</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">list</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Field</span> <span class="n">elementData</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"elementData"</span><span class="o">);</span>
            <span class="n">elementData</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="nc">Object</span><span class="o">[]</span> <span class="n">objects</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Object</span><span class="o">[])</span> <span class="n">elementData</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>
            <span class="nc">Field</span> <span class="n">sizeField</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"size"</span><span class="o">);</span>
            <span class="n">sizeField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

            <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">objects</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">nonNull</span><span class="o">(</span><span class="n">objects</span><span class="o">[</span><span class="n">i</span><span class="o">]))</span> <span class="o">{</span>
                    <span class="o">++</span><span class="n">size</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"length = "</span> <span class="o">+</span> <span class="n">objects</span><span class="o">.</span><span class="na">length</span>
                    <span class="o">+</span> <span class="s">", size = "</span> <span class="o">+</span> <span class="n">sizeField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">list</span><span class="o">)</span>
                    <span class="o">+</span> <span class="s">", arraySize = "</span> <span class="o">+</span> <span class="n">size</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>æ­£å¼æµ‹è¯•ï¼šå°†åˆå§‹åŒ–é•¿åº¦è®¾ç½®ä¸º <code>8</code>ï¼ŒåŒæ—¶å°†æ·»åŠ å…ƒç´ çš„ä¸ªæ•°è®¾ç½®ä¸º <code>8 * 2</code> æ¥æ–¹ä¾¿è§‚å¯Ÿæ•°ç»„å¢é•¿æƒ…å†µã€‚é€šè¿‡ä¸Šè¿°çš„å·¥å…·æ–¹æ³•ï¼Œå¯ä»¥å°† <code>ArrayList</code> å†…éƒ¨çš„æ•°æ®è¿›ä¸€æ­¥å±•ç¤ºå‡ºæ¥ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testAddAtTail</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">initialCapacity</span> <span class="o">=</span> <span class="mi">8</span><span class="o">;</span>
        <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">integers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">initialCapacity</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">initialCapacity</span> <span class="o">*</span> <span class="mi">2</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">xray</span><span class="o">(</span><span class="n">integers</span><span class="o">);</span>
            <span class="n">integers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>JDK ç›¸å…³æºä»£ç ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
</pre></td><td class="code"><pre><span class="cm">/**
 * Increases the capacity to ensure that it can hold at least the
 * number of elements specified by the minimum capacity argument.
 *
 * @param minCapacity the desired minimum capacity
 * @throws OutOfMemoryError if minCapacity is less than zero
 */</span>
<span class="kd">private</span> <span class="nc">Object</span><span class="o">[]</span> <span class="nf">grow</span><span class="o">(</span><span class="kt">int</span> <span class="n">minCapacity</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">elementData</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">elementData</span><span class="o">,</span>
                                       <span class="n">newCapacity</span><span class="o">(</span><span class="n">minCapacity</span><span class="o">));</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="nc">Object</span><span class="o">[]</span> <span class="nf">grow</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">grow</span><span class="o">(</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
<span class="o">}</span>

<span class="cm">/**
 * Returns a capacity at least as large as the given minimum capacity.
 * Returns the current capacity increased by 50% if that suffices.
 * Will not return a capacity greater than MAX_ARRAY_SIZE unless
 * the given minimum capacity is greater than MAX_ARRAY_SIZE.
 *
 * @param minCapacity the desired minimum capacity
 * @throws OutOfMemoryError if minCapacity is less than zero
 */</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="nf">newCapacity</span><span class="o">(</span><span class="kt">int</span> <span class="n">minCapacity</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// overflow-conscious code</span>
    <span class="kt">int</span> <span class="n">oldCapacity</span> <span class="o">=</span> <span class="n">elementData</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">newCapacity</span> <span class="o">=</span> <span class="n">oldCapacity</span> <span class="o">+</span> <span class="o">(</span><span class="n">oldCapacity</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">newCapacity</span> <span class="o">-</span> <span class="n">minCapacity</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">elementData</span> <span class="o">==</span> <span class="no">DEFAULTCAPACITY_EMPTY_ELEMENTDATA</span><span class="o">)</span>
            <span class="k">return</span> <span class="nc">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="no">DEFAULT_CAPACITY</span><span class="o">,</span> <span class="n">minCapacity</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">minCapacity</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="c1">// overflow</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">OutOfMemoryError</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">minCapacity</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">newCapacity</span> <span class="o">-</span> <span class="no">MAX_ARRAY_SIZE</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span>
        <span class="o">?</span> <span class="n">newCapacity</span>
        <span class="o">:</span> <span class="n">hugeCapacity</span><span class="o">(</span><span class="n">minCapacity</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">hugeCapacity</span><span class="o">(</span><span class="kt">int</span> <span class="n">minCapacity</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">minCapacity</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="c1">// overflow</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">OutOfMemoryError</span><span class="o">();</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">minCapacity</span> <span class="o">&gt;</span> <span class="no">MAX_ARRAY_SIZE</span><span class="o">)</span>
        <span class="o">?</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span>
        <span class="o">:</span> <span class="no">MAX_ARRAY_SIZE</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * This helper method split out from add(E) to keep method
 * bytecode size under 35 (the -XX:MaxInlineSize default value),
 * which helps when add(E) is called in a C1-compiled loop.
 */</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span><span class="o">,</span> <span class="kt">int</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">elementData</span><span class="o">.</span><span class="na">length</span><span class="o">)</span>
        <span class="n">elementData</span> <span class="o">=</span> <span class="n">grow</span><span class="o">();</span>
    <span class="n">elementData</span><span class="o">[</span><span class="n">s</span><span class="o">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * Appends the specified element to the end of this list.
 *
 * @param e element to be appended to this list
 * @return {@code true} (as specified by {@link Collection#add})
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">add</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">modCount</span><span class="o">++;</span>
    <span class="n">add</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="n">elementData</span><span class="o">,</span> <span class="n">size</span><span class="o">);</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ç»è¿‡æµ‹è¯•å‘ç°ï¼Œ<code>ArrayList</code> æ˜¯åœ¨å®¹é‡è¾¾åˆ°æ•°ç»„é•¿åº¦ä¹‹åï¼Œå†æ¬¡æ·»åŠ æ‰ä¼šæ‰©å®¹ï¼Œæ‰©å®¹é•¿åº¦ä¸º <code>int newCapacity = oldCapacity + (oldCapacity &gt;&gt; 1)</code>ï¼Œæœ€å°ä¸ºåŸå§‹é•¿åº¦ï¼Œæœ€å¤§ä¸èƒ½è¶…è¿‡ <code>int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8</code>ã€‚</p>
</div>
<div class="paragraph">
<p>ä¹‹æ‰€ä»¥æœ€å¤§é•¿åº¦ä¸º <code>Integer.MAX_VALUE</code> å‡å» <code>8</code>ï¼Œæ–‡æ¡£è§£é‡Šæ˜¯å› ä¸ºæŸäº› VM ä¿ç•™æ•°ç»„å¤´éƒ¨ç”¨äºå­˜å‚¨ä¸€äº› header wordsã€‚ä½†æ˜¯åœ¨ <code>hugeCapacity(int minCapacity)</code> æ–¹æ³•ä¸­ï¼Œåœ¨æœ€å°å®¹é‡å¤§äº <code>MAX_ARRAY_SIZE</code>ï¼Œåˆå¯ä»¥è¿”å› <code>Integer.MAX_VALUE</code>ã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testAddAtHeader</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">initialCapacity</span> <span class="o">=</span> <span class="mi">8</span><span class="o">;</span>
        <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">integers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">initialCapacity</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">initialCapacity</span> <span class="o">*</span> <span class="mi">2</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">xray</span><span class="o">(</span><span class="n">integers</span><span class="o">);</span>
            <span class="n">integers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="code"><pre><span class="cm">/**
 * Inserts the specified element at the specified position in this
 * list. Shifts the element currently at that position (if any) and
 * any subsequent elements to the right (adds one to their indices).
 *
 * @param index index at which the specified element is to be inserted
 * @param element element to be inserted
 * @throws IndexOutOfBoundsException {@inheritDoc}
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="no">E</span> <span class="n">element</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">rangeCheckForAdd</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
    <span class="n">modCount</span><span class="o">++;</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">s</span><span class="o">;</span>
    <span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">s</span> <span class="o">=</span> <span class="n">size</span><span class="o">)</span> <span class="o">==</span> <span class="o">(</span><span class="n">elementData</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">).</span><span class="na">length</span><span class="o">)</span>
        <span class="n">elementData</span> <span class="o">=</span> <span class="n">grow</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">elementData</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span>
                     <span class="n">elementData</span><span class="o">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span>
                     <span class="n">s</span> <span class="o">-</span> <span class="n">index</span><span class="o">);</span>
    <span class="n">elementData</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="n">element</span><span class="o">;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * A version of rangeCheck used by add and addAll.
 */</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">rangeCheckForAdd</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">size</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span><span class="n">outOfBoundsMsg</span><span class="o">(</span><span class="n">index</span><span class="o">));</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ä»è¿™é‡Œçœ‹å‡ºï¼Œåœ¨å¤´éƒ¨æ’å…¥æ·»åŠ å…ƒç´ ï¼Œå®é™…å°±æ˜¯å°†æŒ‡å®šåæ ‡ä½ç½®ä»¥åŠå³ä¾§æ‰€æœ‰å…ƒç´ å‘åç§»åŠ¨ä¸€ä½ï¼Œè…¾å‡ºç©ºé—´å­˜æ”¾æ–°å…ƒç´ ã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
</pre></td><td class="code"><pre><span class="cm">/**
 * Appends all of the elements in the specified collection to the end of
 * this list, in the order that they are returned by the
 * specified collection's Iterator.  The behavior of this operation is
 * undefined if the specified collection is modified while the operation
 * is in progress.  (This implies that the behavior of this call is
 * undefined if the specified collection is this list, and this
 * list is nonempty.)
 *
 * @param c collection containing elements to be added to this list
 * @return {@code true} if this list changed as a result of the call
 * @throws NullPointerException if the specified collection is null
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">addAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Object</span><span class="o">[]</span> <span class="n">a</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">toArray</span><span class="o">();</span>
    <span class="n">modCount</span><span class="o">++;</span>
    <span class="kt">int</span> <span class="n">numNew</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">numNew</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">s</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">numNew</span> <span class="o">&gt;</span> <span class="o">(</span><span class="n">elementData</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">).</span><span class="na">length</span> <span class="o">-</span> <span class="o">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">size</span><span class="o">))</span>
        <span class="n">elementData</span> <span class="o">=</span> <span class="n">grow</span><span class="o">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">numNew</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">elementData</span><span class="o">,</span> <span class="n">s</span><span class="o">,</span> <span class="n">numNew</span><span class="o">);</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">numNew</span><span class="o">;</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * Inserts all of the elements in the specified collection into this
 * list, starting at the specified position.  Shifts the element
 * currently at that position (if any) and any subsequent elements to
 * the right (increases their indices).  The new elements will appear
 * in the list in the order that they are returned by the
 * specified collection's iterator.
 *
 * @param index index at which to insert the first element from the
 *              specified collection
 * @param c collection containing elements to be added to this list
 * @return {@code true} if this list changed as a result of the call
 * @throws IndexOutOfBoundsException {@inheritDoc}
 * @throws NullPointerException if the specified collection is null
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">addAll</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">rangeCheckForAdd</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>

    <span class="nc">Object</span><span class="o">[]</span> <span class="n">a</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">toArray</span><span class="o">();</span>
    <span class="n">modCount</span><span class="o">++;</span>
    <span class="kt">int</span> <span class="n">numNew</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">numNew</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">s</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">numNew</span> <span class="o">&gt;</span> <span class="o">(</span><span class="n">elementData</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">).</span><span class="na">length</span> <span class="o">-</span> <span class="o">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">size</span><span class="o">))</span>
        <span class="n">elementData</span> <span class="o">=</span> <span class="n">grow</span><span class="o">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">numNew</span><span class="o">);</span>

    <span class="kt">int</span> <span class="n">numMoved</span> <span class="o">=</span> <span class="n">s</span> <span class="o">-</span> <span class="n">index</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">numMoved</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">elementData</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span>
                         <span class="n">elementData</span><span class="o">,</span> <span class="n">index</span> <span class="o">+</span> <span class="n">numNew</span><span class="o">,</span>
                         <span class="n">numMoved</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">elementData</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span> <span class="n">numNew</span><span class="o">);</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">numNew</span><span class="o">;</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>å‘ <code>ArrayList</code> ä¸­æ·»åŠ é›†åˆå®ä¾‹ï¼Œåˆ™æ˜¯é›†åˆç¤ºä¾‹è½¬åŒ–æˆæ•°ç»„ï¼Œç„¶ååˆ©ç”¨æ•°ç»„æ‹·è´çš„æ–¹å¼æ¥é«˜æ•ˆå®Œæˆæ·»åŠ å·¥ä½œã€‚</p>
</div>
</div>
<div class="sect2">
<h3 id="_åˆ é™¤å…ƒç´ "><a class="anchor" href="#_åˆ é™¤å…ƒç´ "></a>8.4. åˆ é™¤å…ƒç´ </h3>

</div>
<div class="sect2">
<h3 id="_æµ‹è¯•éå†é€Ÿåº¦"><a class="anchor" href="#_æµ‹è¯•éå†é€Ÿåº¦"></a>8.5. æµ‹è¯•éå†é€Ÿåº¦</h3>
<div class="paragraph">
<p><code>ArrayList</code> çš„éå†æ–¹å¼æœ‰å¦‚ä¸‹å‡ ç§ï¼š</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>æ ‡å‡†è¿­ä»£å™¨æ–¹å¼</p>
</li>
<li>
<p>å¤–éƒ¨ <code>for</code> å¾ªç¯ + <code>get(index)</code></p>
</li>
<li>
<p><code>forEach(lambda)</code> æ–¹æ³•</p>
</li>
<li>
<p><code>for(E e: arrayList)</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>åŸºå‡†æµ‹è¯•å½“ç„¶é Java Microbenchmark Harness è«å±äº†ã€‚ç›´æ¥ä¸Šä»£ç ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.openjdk.jmh.annotations.*</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Iterator</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-03-03 13:09
 */</span>
<span class="nd">@BenchmarkMode</span><span class="o">(</span><span class="nc">Mode</span><span class="o">.</span><span class="na">Throughput</span><span class="o">)</span>
<span class="nd">@Warmup</span><span class="o">(</span><span class="n">iterations</span> <span class="o">=</span> <span class="mi">3</span><span class="o">)</span>
<span class="nd">@State</span><span class="o">(</span><span class="nc">Scope</span><span class="o">.</span><span class="na">Benchmark</span><span class="o">)</span>
<span class="nd">@Threads</span><span class="o">(</span><span class="mi">8</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ArrayListIteratorSpeedTest</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">arrayList</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="nd">@Setup</span><span class="o">(</span><span class="nc">Level</span><span class="o">.</span><span class="na">Iteration</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">capacity</span> <span class="o">=</span> <span class="mi">1_000_000</span><span class="o">;</span>
        <span class="n">arrayList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">capacity</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">capacity</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">arrayList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Benchmark</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testIterator</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Integer</span> <span class="n">iteratorValue</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">arrayList</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">iterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">iteratorValue</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Benchmark</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testRandomAccess</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Integer</span> <span class="n">randomAccessValue</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">arrayList</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">randomAccessValue</span> <span class="o">=</span> <span class="n">arrayList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Benchmark</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testForEachLambda</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">arrayList</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="k">this</span><span class="o">::</span><span class="n">devnull</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">devnull</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Integer</span> <span class="n">forEachLambdaValue</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Benchmark</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testForEach</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Integer</span> <span class="n">forEachValue</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Integer</span> <span class="n">integer</span> <span class="o">:</span> <span class="n">arrayList</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">forEachValue</span> <span class="o">=</span> <span class="n">integer</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre></pre>
</div>
</div>
<div class="paragraph">
<p>åœ¨ä»£ç ä¸­ï¼Œå¸¸å¸¸çœ‹åˆ° <code>modCount</code> å±æ€§ï¼Œè¿™ä¸ªå±æ€§æ˜¯ä» <code>AbstractList</code> ç»§æ‰¿åˆ°çš„ä¸€ä¸ªé‡è¦å±æ€§ã€‚ è¿™ä¸ªå±æ€§ç”¨äºåœ¨ä½¿ç”¨è¿­ä»£å™¨ï¼ˆ<code>ListIterator</code>ï¼Œ<code>Iterator</code>ï¼‰éå†çš„æ—¶å€™ï¼Œç”¨æ¥æ£€æŸ¥åˆ—è¡¨ä¸­çš„å…ƒç´ æ˜¯å¦å‘ç”Ÿç»“æ„æ€§å˜åŒ–ï¼ˆåˆ—è¡¨å…ƒç´ æ•°é‡å‘ç”Ÿæ”¹å˜ï¼‰äº†ï¼Œä¸»è¦åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹éœ€è¦ä½¿ç”¨ï¼Œé˜²æ­¢ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨è¿­ä»£éå†ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†è¿™ä¸ªåˆ—è¡¨çš„ç»“æ„ã€‚<code>ArrayList</code> æ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼Œå¤šçº¿ç¨‹åŒæ—¶ä¿®æ”¹ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚<code>writeObject</code>ï¼ˆåºåˆ—åŒ–æ—¶ï¼‰ï¼Œä¹Ÿå¯èƒ½ä¼šæŠ›å‡ºæ­¤å¼‚å¸¸ã€‚</p>
</div>
<div class="paragraph">
<p>æ£€æŸ¥åˆ°ä¿®æ”¹ä¸ä¸€è‡´å°±æŠ›å‡ºå¼‚å¸¸æ˜¯ fail-fast æœºåˆ¶ï¼Œæ˜¯ Java é›†åˆ(Collection)ä¸­çš„ä¸€ç§é”™è¯¯æœºåˆ¶ã€‚å®ƒåªèƒ½è¢«ç”¨æ¥æ£€æµ‹é”™è¯¯ï¼Œå› ä¸ºJDKå¹¶ä¸ä¿è¯ fail-fast æœºåˆ¶ä¸€å®šä¼šå‘ç”Ÿã€‚å¦‚æœå‘ç”Ÿ fail-fastï¼Œåˆ™æ¨èä½¿ç”¨ <code>JUC</code> ä¸­å¯¹åº”çš„ç±»ã€‚</p>
</div>
<div class="paragraph">
<p>ç®€å•æ¥è¯´ï¼ŒJava çš„åºåˆ—åŒ–æœºåˆ¶æ˜¯é€šè¿‡åœ¨è¿è¡Œæ—¶åˆ¤æ–­ç±»çš„ <code>serialVersionUID</code> æ¥éªŒè¯ç‰ˆæœ¬ä¸€è‡´æ€§çš„ã€‚åœ¨è¿›è¡Œååºåˆ—åŒ–æ—¶ï¼ŒJVMä¼šæŠŠä¼ æ¥çš„å­—èŠ‚æµä¸­çš„ <code>serialVersionUID</code> ä¸æœ¬åœ°ç›¸åº”å®ä½“ï¼ˆç±»ï¼‰çš„ <code>serialVersionUID</code> è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœç›¸åŒå°±è®¤ä¸ºæ˜¯ä¸€è‡´çš„ï¼Œå¯ä»¥è¿›è¡Œååºåˆ—åŒ–ï¼Œå¦åˆ™å°±ä¼šå‡ºç°åºåˆ—åŒ–ç‰ˆæœ¬ä¸ä¸€è‡´çš„å¼‚å¸¸ã€‚(InvalidCastException)</p>
</div>
<div class="paragraph">
<p><code>serialVersionUID</code> æœ‰ä¸¤ç§æ˜¾ç¤ºçš„ç”Ÿæˆæ–¹å¼ï¼š</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ä¸€ä¸ªæ˜¯é»˜è®¤çš„Lç±»å‹æ•°å­—ï¼Œæ¯”å¦‚ï¼šprivate static final long serialVersionUID = 1L;</p>
</li>
<li>
<p>ä¸€ä¸ªæ˜¯æ ¹æ®ç±»åã€æ¥å£åã€æˆå‘˜æ–¹æ³•åŠå±æ€§ç­‰æ¥ç”Ÿæˆä¸€ä¸ª64ä½çš„å“ˆå¸Œå­—æ®µã€‚</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>å½“å®ç° <code>java.io.Serializable</code> æ¥å£çš„å®ä½“ï¼ˆç±»ï¼‰æ²¡æœ‰æ˜¾å¼åœ°å®šä¹‰ä¸€ä¸ªåä¸º <code>serialVersionUID</code>ï¼Œç±»å‹ä¸º <code>long</code> çš„å˜é‡æ—¶ï¼ŒJavaåºåˆ—åŒ–æœºåˆ¶ä¼šæ ¹æ®ç¼–è¯‘çš„class(å®ƒé€šè¿‡ç±»åï¼Œæ–¹æ³•åç­‰è¯¸å¤šå› ç´ ç»è¿‡è®¡ç®—è€Œå¾—ï¼Œç†è®ºä¸Šæ˜¯ä¸€ä¸€æ˜ å°„çš„å…³ç³»ï¼Œä¹Ÿå°±æ˜¯å”¯ä¸€çš„)è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª <code>serialVersionUID</code> ä½œåºåˆ—åŒ–ç‰ˆæœ¬æ¯”è¾ƒç”¨ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœclassæ–‡ä»¶(ç±»å,æ–¹æ³•æ˜ç­‰)æ²¡æœ‰å‘ç”Ÿå˜åŒ–(å¢åŠ ç©ºæ ¼,æ¢è¡Œ,å¢åŠ æ³¨é‡Š,ç­‰ç­‰)ï¼Œå°±ç®—å†ç¼–è¯‘å¤šæ¬¡ï¼Œ<code>serialVersionUID</code> ä¹Ÿä¸ä¼šå˜åŒ–çš„.</p>
</div>
<div class="paragraph">
<p>å¦‚æœæˆ‘ä»¬ä¸å¸Œæœ›é€šè¿‡ç¼–è¯‘æ¥å¼ºåˆ¶åˆ’åˆ†è½¯ä»¶ç‰ˆæœ¬ï¼Œå³å®ç°åºåˆ—åŒ–æ¥å£çš„å®ä½“èƒ½å¤Ÿå…¼å®¹å…ˆå‰ç‰ˆæœ¬ï¼Œæœªä½œæ›´æ”¹çš„ç±»ï¼Œå°±éœ€è¦æ˜¾å¼åœ°å®šä¹‰ä¸€ä¸ªåä¸º <code>serialVersionUID</code>ï¼Œç±»å‹ä¸º <code>long</code> çš„å˜é‡ï¼Œä¸ä¿®æ”¹è¿™ä¸ªå˜é‡å€¼çš„åºåˆ—åŒ–å®ä½“éƒ½å¯ä»¥ç›¸äº’è¿›è¡Œä¸²è¡ŒåŒ–å’Œåä¸²è¡ŒåŒ–ã€‚</p>
</div>
<div class="paragraph">
<p>3.è§‚å¯Ÿ3ä¸¤ä¸ªé‡è¦å±æ€§
å…³é”®å­— transientï¼ˆç¬æ€ï¼‰è¢«æ ‡è®°ä¸ºtransientçš„å±æ€§åœ¨å¯¹è±¡è¢«åºåˆ—åŒ–çš„æ—¶å€™ä¸ä¼šè¢«ä¿å­˜ã€‚
why?
å‡å¦‚elementDataçš„é•¿åº¦ä¸º10ï¼Œè€Œå…¶ä¸­åªæœ‰5ä¸ªå…ƒç´ ï¼Œé‚£ä¹ˆåœ¨åºåˆ—åŒ–çš„æ—¶å€™åªéœ€è¦å­˜å‚¨5ä¸ªå…ƒç´ ï¼Œè€Œæ•°ç»„ä¸­åé¢5ä¸ªå…ƒç´ æ˜¯ä¸éœ€è¦å­˜å‚¨çš„ã€‚äºæ˜¯å°†elementDataå®šä¹‰ä¸ºtransientï¼Œé¿å…äº†Javaè‡ªå¸¦çš„åºåˆ—åŒ–æœºåˆ¶ï¼Œå¹¶å®šä¹‰äº†ä¸¤ä¸ªæ–¹æ³•ï¼Œå®ç°äº†è‡ªå·±å¯æ§åˆ¶çš„åºåˆ—åŒ–æ“ä½œã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="c1">//æ›´æ–°</span>
<span class="kd">public</span> <span class="no">E</span> <span class="nf">set</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="no">E</span> <span class="n">element</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">rangeCheck</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>

	<span class="no">E</span> <span class="n">oldValue</span> <span class="o">=</span> <span class="n">elementData</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
	<span class="n">elementData</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="n">element</span><span class="o">;</span>
	<span class="k">return</span> <span class="n">oldValue</span><span class="o">;</span>
<span class="o">}</span>
<span class="c1">//æŸ¥æ‰¾</span>

<span class="kd">public</span> <span class="no">E</span> <span class="nf">get</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">rangeCheck</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>

	<span class="k">return</span> <span class="nf">elementData</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">//æ˜¯å¦åŒ…å«</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">contains</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">return</span> <span class="nf">indexOf</span><span class="o">(</span><span class="n">o</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">int</span> <span class="nf">indexOf</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]==</span><span class="kc">null</span><span class="o">)</span>
				<span class="k">return</span> <span class="n">i</span><span class="o">;</span>
	<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]))</span>
				<span class="k">return</span> <span class="n">i</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
<span class="o">}</span>
<span class="c1">//åå‘æŸ¥æ‰¾</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="nf">lastIndexOf</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">--)</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]==</span><span class="kc">null</span><span class="o">)</span>
				<span class="k">return</span> <span class="n">i</span><span class="o">;</span>
	<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">--)</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]))</span>
				<span class="k">return</span> <span class="n">i</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
<span class="o">}</span>
<span class="c1">//å®¹é‡åˆ¤æ–­</span>

<span class="kd">public</span> <span class="kt">int</span> <span class="nf">size</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">size</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isEmpty</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>1.æµ…å…‹éš†ï¼ˆshallow cloneï¼‰</p>
</div>
<div class="paragraph">
<p>è¢«å¤åˆ¶å¯¹è±¡çš„æ‰€æœ‰åŸºç¡€ç±»å‹å˜é‡ï¼ˆbyte,short,int,long,char,boolean,float,doubleï¼‰ä¸åŸæœ‰å¯¹è±¡ä¸­å˜é‡å…·æœ‰ç›¸åŒçš„å€¼ï¼Œä¿®æ”¹å…¶å€¼ä¸ä¼šå½±å“åŸå¯¹è±¡ï¼›è€Œå¤åˆ¶å¯¹è±¡ä¸­å¼•ç”¨ç±»å‹ï¼ˆæ•°ç»„ï¼Œç±»å¯¹è±¡ç­‰ï¼‰è¿˜æ˜¯æŒ‡å‘åŸæ¥å¯¹è±¡ï¼Œä¿®æ”¹å…¶å€¼ä¼šå½±å“åŸå¯¹è±¡ã€‚</p>
</div>
<div class="paragraph">
<p>2.æ·±å…‹éš†ï¼ˆdeep cloneï¼‰</p>
</div>
<div class="paragraph">
<p>è¢«å¤åˆ¶å¯¹è±¡çš„æ‰€æœ‰åŸºç¡€ç±»å‹å˜é‡ï¼ˆbyte,short,int,long,char,boolean,float,doubleï¼‰ä¸åŸæœ‰å¯¹è±¡ä¸­å˜é‡å…·æœ‰ç›¸åŒçš„å€¼ï¼Œä¿®æ”¹å…¶å€¼ä¸ä¼šå½±å“åŸå¯¹è±¡ï¼›å¹¶ä¸”å¤åˆ¶å¯¹è±¡ä¸­å¼•ç”¨ç±»å‹ï¼ˆæ•°ç»„ï¼Œç±»å¯¹è±¡ç­‰ï¼‰æŒ‡å‘è¢«å¤åˆ¶è¿‡çš„æ–°å¯¹è±¡ï¼Œä¿®æ”¹å…¶å€¼ä¸ä¼šå½±å“åŸå¯¹è±¡ã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="nc">Object</span> <span class="nf">clone</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">try</span> <span class="o">{</span>
		<span class="nc">ArrayList</span><span class="o">&lt;?&gt;</span> <span class="n">v</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ArrayList</span><span class="o">&lt;?&gt;)</span> <span class="kd">super</span><span class="o">.</span><span class="na">clone</span><span class="o">();</span>
		<span class="n">v</span><span class="o">.</span><span class="na">elementData</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">elementData</span><span class="o">,</span> <span class="n">size</span><span class="o">);</span>
		<span class="n">v</span><span class="o">.</span><span class="na">modCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
		<span class="k">return</span> <span class="n">v</span><span class="o">;</span>
	<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">CloneNotSupportedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// this shouldn't happen, since we are Cloneable</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">InternalError</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nc">Object</span><span class="o">[]</span> <span class="nf">toArray</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">elementData</span><span class="o">,</span> <span class="n">size</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
<span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span><span class="o">[]</span> <span class="nf">toArray</span><span class="o">(</span><span class="no">T</span><span class="o">[]</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">length</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">)</span>
		<span class="c1">// Make a new array of a's runtime type, but my contents:</span>
		<span class="k">return</span> <span class="o">(</span><span class="no">T</span><span class="o">[])</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">elementData</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">a</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
	<span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">elementData</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">a</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">size</span><span class="o">);</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="n">size</span><span class="o">)</span>
		<span class="n">a</span><span class="o">[</span><span class="n">size</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="k">return</span> <span class="n">a</span><span class="o">;</span>
<span class="o">}</span>

<span class="c1">// Positional Access Operations</span>
<span class="c1">//å¾—åˆ°æŒ‡å®šç´¢å¼•å¤„çš„å…ƒç´ </span>
<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
<span class="no">E</span> <span class="nf">elementData</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">return</span> <span class="o">(</span><span class="no">E</span><span class="o">)</span> <span class="n">elementData</span><span class="o">[</span><span class="n">index</span><span class="o">];</span>
<span class="o">}</span>
<span class="c1">//æ¸…ç©º</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">clear</span><span class="o">()</span> <span class="o">{</span>
	<span class="n">modCount</span><span class="o">++;</span>

	<span class="c1">// clear to let GC do its work</span>
	<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
		<span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="o">}</span>


<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">removeRange</span><span class="o">(</span><span class="kt">int</span> <span class="n">fromIndex</span><span class="o">,</span> <span class="kt">int</span> <span class="n">toIndex</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">modCount</span><span class="o">++;</span>
	<span class="kt">int</span> <span class="n">numMoved</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">toIndex</span><span class="o">;</span>
	<span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">elementData</span><span class="o">,</span> <span class="n">toIndex</span><span class="o">,</span> <span class="n">elementData</span><span class="o">,</span> <span class="n">fromIndex</span><span class="o">,</span>
					 <span class="n">numMoved</span><span class="o">);</span>

	<span class="c1">// clear to let GC do its work</span>
	<span class="kt">int</span> <span class="n">newSize</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="o">(</span><span class="n">toIndex</span><span class="o">-</span><span class="n">fromIndex</span><span class="o">);</span>
	<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">newSize</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
		<span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">newSize</span><span class="o">;</span>
<span class="o">}</span>

 <span class="c1">//æ£€æŸ¥æ•°å¦è¶…å‡ºæ•°ç»„é•¿åº¦ ç”¨äºæ·»åŠ å…ƒç´ æ—¶</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">rangeCheck</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="o">)</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span><span class="n">outOfBoundsMsg</span><span class="o">(</span><span class="n">index</span><span class="o">));</span>
<span class="o">}</span>
<span class="c1">//æ£€æŸ¥æ˜¯å¦æº¢å‡º</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">rangeCheckForAdd</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">size</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span><span class="n">outOfBoundsMsg</span><span class="o">(</span><span class="n">index</span><span class="o">));</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="nc">String</span> <span class="nf">outOfBoundsMsg</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">return</span> <span class="s">"Index: "</span><span class="o">+</span><span class="n">index</span><span class="o">+</span><span class="s">", Size: "</span><span class="o">+</span><span class="n">size</span><span class="o">;</span>
<span class="o">}</span>
<span class="c1">//åˆ é™¤æŒ‡å®šé›†åˆçš„å…ƒç´ </span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">removeAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
	<span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
	<span class="k">return</span> <span class="nf">batchRemove</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="o">}</span>
<span class="c1">//ä»…ä¿ç•™æŒ‡å®šé›†åˆçš„å…ƒç´ </span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">retainAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
	<span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
	<span class="k">return</span> <span class="nf">batchRemove</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
<span class="o">}</span>
<span class="o">*</span> <span class="nd">@param</span> <span class="n">complement</span> <span class="n">trueæ—¶ä»æ•°ç»„ä¿ç•™æŒ‡å®šé›†åˆä¸­å…ƒç´ çš„å€¼</span><span class="err">ï¼Œ</span><span class="n">ä¸ºfalseæ—¶ä»æ•°ç»„åˆ é™¤æŒ‡å®šé›†åˆä¸­å…ƒç´ çš„å€¼</span><span class="err">ã€‚</span>
<span class="o">*</span> <span class="nd">@return</span> <span class="n">æ•°ç»„ä¸­é‡å¤çš„å…ƒç´ éƒ½ä¼šè¢«åˆ é™¤</span><span class="o">(</span><span class="n">è€Œä¸æ˜¯ä»…åˆ é™¤ä¸€æ¬¡æˆ–å‡ æ¬¡</span><span class="o">)</span><span class="err">ï¼Œ</span><span class="n">æœ‰ä»»ä½•åˆ é™¤æ“ä½œéƒ½ä¼šè¿”å›true</span>
<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">batchRemove</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">complement</span><span class="o">)</span> <span class="o">{</span>
	<span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">w</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
	<span class="kt">boolean</span> <span class="n">modified</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
	<span class="k">try</span> <span class="o">{</span>
		<span class="k">for</span> <span class="o">(;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">r</span><span class="o">++)</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">elementData</span><span class="o">[</span><span class="n">r</span><span class="o">])</span> <span class="o">==</span> <span class="n">complement</span><span class="o">)</span>
				<span class="n">elementData</span><span class="o">[</span><span class="n">w</span><span class="o">++]</span> <span class="o">=</span> <span class="n">elementData</span><span class="o">[</span><span class="n">r</span><span class="o">];</span>
	<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
		<span class="c1">// Preserve behavioral compatibility with AbstractCollection,</span>
		<span class="c1">// even if c.contains() throws.</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">!=</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">elementData</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span>
							 <span class="n">elementData</span><span class="o">,</span> <span class="n">w</span><span class="o">,</span>
							 <span class="n">size</span> <span class="o">-</span> <span class="n">r</span><span class="o">);</span>
			<span class="n">w</span> <span class="o">+=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">r</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">w</span> <span class="o">!=</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// clear to let GC do its work</span>
			<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">w</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
				<span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
			<span class="n">modCount</span> <span class="o">+=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">w</span><span class="o">;</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">w</span><span class="o">;</span>
			<span class="n">modified</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="n">modified</span><span class="o">;</span>
<span class="o">}</span>
 <span class="c1">//ä¿å­˜æ•°ç»„å®ä¾‹çš„çŠ¶æ€åˆ°ä¸€ä¸ªæµï¼ˆå³å®ƒåºåˆ—åŒ–ï¼‰ã€‚å†™å…¥è¿‡ç¨‹æ•°ç»„è¢«æ›´æ”¹ä¼šæŠ›å‡ºå¼‚å¸¸</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">writeObject</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">ObjectOutputStream</span> <span class="n">s</span><span class="o">)</span>
	<span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span><span class="o">{</span>
	<span class="c1">// Write out element count, and any hidden stuff</span>
	<span class="kt">int</span> <span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>
	<span class="n">s</span><span class="o">.</span><span class="na">defaultWriteObject</span><span class="o">();</span>

	<span class="c1">// Write out size as capacity for behavioural compatibility with clone()</span>
	<span class="n">s</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">size</span><span class="o">);</span>

	<span class="c1">// Write out all elements in the proper order.</span>
	<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
		<span class="n">s</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
	<span class="o">}</span>

	<span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
<span class="c1">//ä¸Šé¢æ˜¯å†™ï¼Œè¿™ä¸ªå°±æ˜¯è¯»äº†ã€‚</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">readObject</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">ObjectInputStream</span> <span class="n">s</span><span class="o">)</span>
	<span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span><span class="o">,</span> <span class="nc">ClassNotFoundException</span> <span class="o">{</span>
	<span class="n">elementData</span> <span class="o">=</span> <span class="no">EMPTY_ELEMENTDATA</span><span class="o">;</span>

	<span class="c1">// Read in size, and any hidden stuff</span>
	<span class="n">s</span><span class="o">.</span><span class="na">defaultReadObject</span><span class="o">();</span>

	<span class="c1">// Read in capacity</span>
	<span class="n">s</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span> <span class="c1">// ignored</span>

	<span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// be like clone(), allocate array based upon size not capacity</span>
		<span class="n">ensureCapacityInternal</span><span class="o">(</span><span class="n">size</span><span class="o">);</span>

		<span class="nc">Object</span><span class="o">[]</span> <span class="n">a</span> <span class="o">=</span> <span class="n">elementData</span><span class="o">;</span>
		<span class="c1">// Read in all elements in the proper order.</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
			<span class="n">a</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nc">ListIterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">listIterator</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="n">size</span><span class="o">)</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span><span class="s">"Index: "</span><span class="o">+</span><span class="n">index</span><span class="o">);</span>
	<span class="k">return</span> <span class="k">new</span> <span class="nf">ListItr</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
<span class="o">}</span>
<span class="n">å®ç°Iterable</span>
<span class="kd">public</span> <span class="nc">ListIterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">listIterator</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="k">new</span> <span class="nf">ListItr</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
<span class="o">}</span>
<span class="n">å®ç°Iterable</span>
<span class="kd">public</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">iterator</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="k">new</span> <span class="nf">Itr</span><span class="o">();</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>//é€šç”¨çš„è¿­ä»£å™¨å®ç° è¿­ä»£å™¨ï¼ˆIteratorï¼‰æ¨¡å¼</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">private</span> <span class="kd">class</span> <span class="nc">Itr</span> <span class="kd">implements</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>
	<span class="kt">int</span> <span class="n">cursor</span><span class="o">;</span>       <span class="c1">// index of next element to return</span>
	<span class="kt">int</span> <span class="n">lastRet</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span> <span class="c1">// index of last element returned; -1 if no such</span>
	<span class="kt">int</span> <span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>

	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasNext</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">cursor</span> <span class="o">!=</span> <span class="n">size</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="no">E</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>
		<span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">elementData</span><span class="o">.</span><span class="na">length</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
		<span class="n">cursor</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
		<span class="k">return</span> <span class="o">(</span><span class="no">E</span><span class="o">)</span> <span class="n">elementData</span><span class="o">[</span><span class="n">lastRet</span> <span class="o">=</span> <span class="n">i</span><span class="o">];</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">lastRet</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">();</span>
		<span class="n">checkForComodification</span><span class="o">();</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">lastRet</span><span class="o">);</span>
			<span class="n">cursor</span> <span class="o">=</span> <span class="n">lastRet</span><span class="o">;</span>
			<span class="n">lastRet</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
			<span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IndexOutOfBoundsException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">forEachRemaining</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">consumer</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">consumer</span><span class="o">);</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">elementData</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="k">while</span> <span class="o">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="n">modCount</span> <span class="o">==</span> <span class="n">expectedModCount</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">consumer</span><span class="o">.</span><span class="na">accept</span><span class="o">((</span><span class="no">E</span><span class="o">)</span> <span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">++]);</span>
		<span class="o">}</span>
		<span class="c1">// update once at end of iteration to reduce heap write traffic</span>
		<span class="n">cursor</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
		<span class="n">lastRet</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">final</span> <span class="kt">void</span> <span class="nf">checkForComodification</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>å…¶ä¸­çš„ListItrç»§æ‰¿Itrï¼Œå®ç°äº†ListIteratoræ¥å£ï¼ŒåŒæ—¶é‡å†™äº†hasPrevious()ï¼ŒnextIndex()ï¼Œ previousIndex()ï¼Œprevious()ï¼Œset(E e)ï¼Œadd(E e)ç­‰æ–¹æ³•ï¼Œæ‰€ä»¥è¿™ä¹Ÿå¯ä»¥çœ‹å‡ºäº†Iteratorå’ŒListIteratorçš„åŒºåˆ«ï¼Œå°±æ˜¯ListIteratoråœ¨Iteratorçš„åŸºç¡€ä¸Šå¢åŠ äº†æ·»åŠ å¯¹è±¡ï¼Œä¿®æ”¹å¯¹è±¡ï¼Œé€†å‘éå†ç­‰æ–¹æ³•ï¼Œè¿™äº›æ˜¯Iteratorä¸èƒ½å®ç°çš„ã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">private</span> <span class="kd">class</span> <span class="nc">ListItr</span> <span class="kd">extends</span> <span class="nc">Itr</span> <span class="kd">implements</span> <span class="nc">ListIterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>
	<span class="nc">ListItr</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">();</span>
		<span class="n">cursor</span> <span class="o">=</span> <span class="n">index</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasPrevious</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">cursor</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">nextIndex</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">cursor</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">previousIndex</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">cursor</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="no">E</span> <span class="nf">previous</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">cursor</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>
		<span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">elementData</span><span class="o">.</span><span class="na">length</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
		<span class="n">cursor</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
		<span class="k">return</span> <span class="o">(</span><span class="no">E</span><span class="o">)</span> <span class="n">elementData</span><span class="o">[</span><span class="n">lastRet</span> <span class="o">=</span> <span class="n">i</span><span class="o">];</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">lastRet</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">();</span>
		<span class="n">checkForComodification</span><span class="o">();</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">lastRet</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IndexOutOfBoundsException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">checkForComodification</span><span class="o">();</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">;</span>
			<span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
			<span class="n">cursor</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
			<span class="n">lastRet</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
			<span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IndexOutOfBoundsException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
<span class="c1">//è¿”å›æŒ‡å®šèŒƒå›´çš„å­æ•°ç»„</span>
<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">subList</span><span class="o">(</span><span class="kt">int</span> <span class="n">fromIndex</span><span class="o">,</span> <span class="kt">int</span> <span class="n">toIndex</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">subListRangeCheck</span><span class="o">(</span><span class="n">fromIndex</span><span class="o">,</span> <span class="n">toIndex</span><span class="o">,</span> <span class="n">size</span><span class="o">);</span>
	<span class="k">return</span> <span class="k">new</span> <span class="nf">SubList</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">fromIndex</span><span class="o">,</span> <span class="n">toIndex</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">static</span> <span class="kt">void</span> <span class="nf">subListRangeCheck</span><span class="o">(</span><span class="kt">int</span> <span class="n">fromIndex</span><span class="o">,</span> <span class="kt">int</span> <span class="n">toIndex</span><span class="o">,</span> <span class="kt">int</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">fromIndex</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span><span class="s">"fromIndex = "</span> <span class="o">+</span> <span class="n">fromIndex</span><span class="o">);</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">toIndex</span> <span class="o">&gt;</span> <span class="n">size</span><span class="o">)</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span><span class="s">"toIndex = "</span> <span class="o">+</span> <span class="n">toIndex</span><span class="o">);</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">fromIndex</span> <span class="o">&gt;</span> <span class="n">toIndex</span><span class="o">)</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"fromIndex("</span> <span class="o">+</span> <span class="n">fromIndex</span> <span class="o">+</span>
										   <span class="s">") &gt; toIndex("</span> <span class="o">+</span> <span class="n">toIndex</span> <span class="o">+</span> <span class="s">")"</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>å…¶ä¸­çš„SubListç»§æ‰¿AbstractListï¼Œå®ç°äº†RandmAccessæ¥å£ï¼Œç±»å†…éƒ¨å®ç°äº†å¯¹å­åºåˆ—çš„å¢åˆ æ”¹æŸ¥ç­‰æ–¹æ³•ï¼Œä½†å®ƒåŒæ—¶ä¹Ÿå……åˆ†åˆ©ç”¨äº†å†…éƒ¨ç±»çš„ä¼˜ç‚¹ï¼Œå°±æ˜¯å…±äº«ArrayListçš„å…¨å±€å˜é‡ï¼Œä¾‹å¦‚æ£€æŸ¥å™¨å˜é‡modCountï¼Œæ•°ç»„elementDataç­‰ï¼Œæ‰€ä»¥SubListè¿›è¡Œçš„å¢åˆ æ”¹æŸ¥æ“ä½œéƒ½æ˜¯å¯¹ArrayListçš„æ•°ç»„è¿›è¡Œçš„ï¼Œå¹¶æ²¡æœ‰åˆ›å»ºæ–°çš„æ•°ç»„(ä¸æµªè´¹å†…å­˜èµ„æº)ã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">private</span> <span class="kd">class</span> <span class="nc">SubList</span> <span class="kd">extends</span> <span class="nc">AbstractList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">RandomAccess</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">AbstractList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">parent</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">parentOffset</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">offset</span><span class="o">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="o">;</span>

	<span class="nc">SubList</span><span class="o">(</span><span class="nc">AbstractList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">parent</span><span class="o">,</span>
			<span class="kt">int</span> <span class="n">offset</span><span class="o">,</span> <span class="kt">int</span> <span class="n">fromIndex</span><span class="o">,</span> <span class="kt">int</span> <span class="n">toIndex</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">parentOffset</span> <span class="o">=</span> <span class="n">fromIndex</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">fromIndex</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">size</span> <span class="o">=</span> <span class="n">toIndex</span> <span class="o">-</span> <span class="n">fromIndex</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">modCount</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="no">E</span> <span class="nf">set</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">rangeCheck</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="no">E</span> <span class="n">oldValue</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">index</span><span class="o">);</span>
		<span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">[</span><span class="n">offset</span> <span class="o">+</span> <span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
		<span class="k">return</span> <span class="n">oldValue</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="no">E</span> <span class="nf">get</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">rangeCheck</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="k">return</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">index</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">size</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">rangeCheckForAdd</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="n">parent</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">parentOffset</span> <span class="o">+</span> <span class="n">index</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">modCount</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">++;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="no">E</span> <span class="nf">remove</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">rangeCheck</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="no">E</span> <span class="n">result</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">parentOffset</span> <span class="o">+</span> <span class="n">index</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">modCount</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">--;</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">removeRange</span><span class="o">(</span><span class="kt">int</span> <span class="n">fromIndex</span><span class="o">,</span> <span class="kt">int</span> <span class="n">toIndex</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="n">parent</span><span class="o">.</span><span class="na">removeRange</span><span class="o">(</span><span class="n">parentOffset</span> <span class="o">+</span> <span class="n">fromIndex</span><span class="o">,</span>
						   <span class="n">parentOffset</span> <span class="o">+</span> <span class="n">toIndex</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">modCount</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">size</span> <span class="o">-=</span> <span class="n">toIndex</span> <span class="o">-</span> <span class="n">fromIndex</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">addAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">addAll</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">,</span> <span class="n">c</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">addAll</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">rangeCheckForAdd</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
		<span class="kt">int</span> <span class="n">cSize</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">cSize</span><span class="o">==</span><span class="mi">0</span><span class="o">)</span>
			<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>

		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="n">parent</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">parentOffset</span> <span class="o">+</span> <span class="n">index</span><span class="o">,</span> <span class="n">c</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">modCount</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">size</span> <span class="o">+=</span> <span class="n">cSize</span><span class="o">;</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">iterator</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">listIterator</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nc">ListIterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">listIterator</span><span class="o">(</span><span class="kd">final</span> <span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="n">rangeCheckForAdd</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">offset</span><span class="o">;</span>

		<span class="k">return</span> <span class="k">new</span> <span class="nc">ListIterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;()</span> <span class="o">{</span>
			<span class="kt">int</span> <span class="n">cursor</span> <span class="o">=</span> <span class="n">index</span><span class="o">;</span>
			<span class="kt">int</span> <span class="n">lastRet</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
			<span class="kt">int</span> <span class="n">expectedModCount</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>

			<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasNext</span><span class="o">()</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">cursor</span> <span class="o">!=</span> <span class="nc">SubList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
			<span class="o">}</span>

			<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
			<span class="kd">public</span> <span class="no">E</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span>
				<span class="n">checkForComodification</span><span class="o">();</span>
				<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">;</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="nc">SubList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">size</span><span class="o">)</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>
				<span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">;</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">elementData</span><span class="o">.</span><span class="na">length</span><span class="o">)</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
				<span class="n">cursor</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
				<span class="k">return</span> <span class="o">(</span><span class="no">E</span><span class="o">)</span> <span class="n">elementData</span><span class="o">[</span><span class="n">offset</span> <span class="o">+</span> <span class="o">(</span><span class="n">lastRet</span> <span class="o">=</span> <span class="n">i</span><span class="o">)];</span>
			<span class="o">}</span>

			<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasPrevious</span><span class="o">()</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">cursor</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">;</span>
			<span class="o">}</span>

			<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
			<span class="kd">public</span> <span class="no">E</span> <span class="nf">previous</span><span class="o">()</span> <span class="o">{</span>
				<span class="n">checkForComodification</span><span class="o">();</span>
				<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">cursor</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>
				<span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">;</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">elementData</span><span class="o">.</span><span class="na">length</span><span class="o">)</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
				<span class="n">cursor</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
				<span class="k">return</span> <span class="o">(</span><span class="no">E</span><span class="o">)</span> <span class="n">elementData</span><span class="o">[</span><span class="n">offset</span> <span class="o">+</span> <span class="o">(</span><span class="n">lastRet</span> <span class="o">=</span> <span class="n">i</span><span class="o">)];</span>
			<span class="o">}</span>

			<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">forEachRemaining</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">consumer</span><span class="o">)</span> <span class="o">{</span>
				<span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">consumer</span><span class="o">);</span>
				<span class="kd">final</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="nc">SubList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
				<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">;</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">return</span><span class="o">;</span>
				<span class="o">}</span>
				<span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">;</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">elementData</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
				<span class="o">}</span>
				<span class="k">while</span> <span class="o">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="n">modCount</span> <span class="o">==</span> <span class="n">expectedModCount</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">consumer</span><span class="o">.</span><span class="na">accept</span><span class="o">((</span><span class="no">E</span><span class="o">)</span> <span class="n">elementData</span><span class="o">[</span><span class="n">offset</span> <span class="o">+</span> <span class="o">(</span><span class="n">i</span><span class="o">++)]);</span>
				<span class="o">}</span>
				<span class="c1">// update once at end of iteration to reduce heap write traffic</span>
				<span class="n">lastRet</span> <span class="o">=</span> <span class="n">cursor</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
				<span class="n">checkForComodification</span><span class="o">();</span>
			<span class="o">}</span>

			<span class="kd">public</span> <span class="kt">int</span> <span class="nf">nextIndex</span><span class="o">()</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">cursor</span><span class="o">;</span>
			<span class="o">}</span>

			<span class="kd">public</span> <span class="kt">int</span> <span class="nf">previousIndex</span><span class="o">()</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">cursor</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
			<span class="o">}</span>

			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">()</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">lastRet</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">();</span>
				<span class="n">checkForComodification</span><span class="o">();</span>

				<span class="k">try</span> <span class="o">{</span>
					<span class="nc">SubList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">lastRet</span><span class="o">);</span>
					<span class="n">cursor</span> <span class="o">=</span> <span class="n">lastRet</span><span class="o">;</span>
					<span class="n">lastRet</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
					<span class="n">expectedModCount</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>
				<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IndexOutOfBoundsException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
				<span class="o">}</span>
			<span class="o">}</span>

			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">lastRet</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">();</span>
				<span class="n">checkForComodification</span><span class="o">();</span>

				<span class="k">try</span> <span class="o">{</span>
					<span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">lastRet</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
				<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IndexOutOfBoundsException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
				<span class="o">}</span>
			<span class="o">}</span>

			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">checkForComodification</span><span class="o">();</span>

				<span class="k">try</span> <span class="o">{</span>
					<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">;</span>
					<span class="nc">SubList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
					<span class="n">cursor</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
					<span class="n">lastRet</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
					<span class="n">expectedModCount</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>
				<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IndexOutOfBoundsException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
				<span class="o">}</span>
			<span class="o">}</span>

			<span class="kd">final</span> <span class="kt">void</span> <span class="nf">checkForComodification</span><span class="o">()</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">expectedModCount</span> <span class="o">!=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">modCount</span><span class="o">)</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
			<span class="o">}</span>
		<span class="o">};</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">subList</span><span class="o">(</span><span class="kt">int</span> <span class="n">fromIndex</span><span class="o">,</span> <span class="kt">int</span> <span class="n">toIndex</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">subListRangeCheck</span><span class="o">(</span><span class="n">fromIndex</span><span class="o">,</span> <span class="n">toIndex</span><span class="o">,</span> <span class="n">size</span><span class="o">);</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">SubList</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">offset</span><span class="o">,</span> <span class="n">fromIndex</span><span class="o">,</span> <span class="n">toIndex</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">rangeCheck</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span><span class="n">outOfBoundsMsg</span><span class="o">(</span><span class="n">index</span><span class="o">));</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">rangeCheckForAdd</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span><span class="n">outOfBoundsMsg</span><span class="o">(</span><span class="n">index</span><span class="o">));</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="nc">String</span> <span class="nf">outOfBoundsMsg</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="s">"Index: "</span><span class="o">+</span><span class="n">index</span><span class="o">+</span><span class="s">", Size: "</span><span class="o">+</span><span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">checkForComodification</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">modCount</span> <span class="o">!=</span> <span class="k">this</span><span class="o">.</span><span class="na">modCount</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">spliterator</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nc">ArrayListSpliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;(</span><span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">offset</span><span class="o">,</span>
										   <span class="n">offset</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">modCount</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="c1">//æŒ‰ç…§æ¯”è¾ƒå™¨çš„åˆ¤æ–­é€»è¾‘è¿›è¡Œæ’åº</span>
<span class="nd">@Override</span>
<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">sort</span><span class="o">(</span><span class="nc">Comparator</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
	<span class="kd">final</span> <span class="kt">int</span> <span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>
	<span class="nc">Arrays</span><span class="o">.</span><span class="na">sort</span><span class="o">((</span><span class="no">E</span><span class="o">[])</span> <span class="n">elementData</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">c</span><span class="o">);</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
	<span class="o">}</span>
	<span class="n">modCount</span><span class="o">++;</span>
<span class="o">}</span>
 <span class="n">ä»¥ä¸‹åŸºäº</span> <span class="mf">1.8</span><span class="err">ï¼Œ</span><span class="n">å’Œå‡½æ•°å¼ç¼–ç¨‹ç›¸å…³çš„æ–¹æ³•</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">forEach</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
	<span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">action</span><span class="o">);</span>
	<span class="kd">final</span> <span class="kt">int</span> <span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>
	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
	<span class="kd">final</span> <span class="no">E</span><span class="o">[]</span> <span class="n">elementData</span> <span class="o">=</span> <span class="o">(</span><span class="no">E</span><span class="o">[])</span> <span class="k">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">;</span>
	<span class="kd">final</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
	<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">modCount</span> <span class="o">==</span> <span class="n">expectedModCount</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
		<span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
	<span class="o">}</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">spliterator</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="k">new</span> <span class="nc">ArrayListSpliterator</span><span class="o">&lt;&gt;(</span><span class="k">this</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ArrayListSpliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>


	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">index</span><span class="o">;</span> <span class="c1">// current index, modified on advance/split</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">fence</span><span class="o">;</span> <span class="c1">// -1 until used; then one past last index</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">expectedModCount</span><span class="o">;</span> <span class="c1">// initialized when fence set</span>

	<span class="cm">/** Create new spliterator covering the given  range */</span>
	<span class="nc">ArrayListSpliterator</span><span class="o">(</span><span class="nc">ArrayList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">,</span> <span class="kt">int</span> <span class="n">origin</span><span class="o">,</span> <span class="kt">int</span> <span class="n">fence</span><span class="o">,</span>
						 <span class="kt">int</span> <span class="n">expectedModCount</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">list</span> <span class="o">=</span> <span class="n">list</span><span class="o">;</span> <span class="c1">// OK if null unless traversed</span>
		<span class="k">this</span><span class="o">.</span><span class="na">index</span> <span class="o">=</span> <span class="n">origin</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">fence</span> <span class="o">=</span> <span class="n">fence</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">expectedModCount</span> <span class="o">=</span> <span class="n">expectedModCount</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kt">int</span> <span class="nf">getFence</span><span class="o">()</span> <span class="o">{</span> <span class="c1">// initialize fence to size on first use</span>
		<span class="kt">int</span> <span class="n">hi</span><span class="o">;</span> <span class="c1">// (a specialized variant appears in method forEach)</span>
		<span class="nc">ArrayList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">lst</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">((</span><span class="n">hi</span> <span class="o">=</span> <span class="n">fence</span><span class="o">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">((</span><span class="n">lst</span> <span class="o">=</span> <span class="n">list</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
				<span class="n">hi</span> <span class="o">=</span> <span class="n">fence</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
			<span class="k">else</span> <span class="o">{</span>
				<span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">lst</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>
				<span class="n">hi</span> <span class="o">=</span> <span class="n">fence</span> <span class="o">=</span> <span class="n">lst</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">hi</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nc">ArrayListSpliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">trySplit</span><span class="o">()</span> <span class="o">{</span>
		<span class="kt">int</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">getFence</span><span class="o">(),</span> <span class="n">lo</span> <span class="o">=</span> <span class="n">index</span><span class="o">,</span> <span class="n">mid</span> <span class="o">=</span> <span class="o">(</span><span class="n">lo</span> <span class="o">+</span> <span class="n">hi</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">;</span>
		<span class="k">return</span> <span class="o">(</span><span class="n">lo</span> <span class="o">&gt;=</span> <span class="n">mid</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="c1">// divide range in half unless too small</span>
			<span class="k">new</span> <span class="nc">ArrayListSpliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;(</span><span class="n">list</span><span class="o">,</span> <span class="n">lo</span><span class="o">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">mid</span><span class="o">,</span>
										<span class="n">expectedModCount</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">tryAdvance</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">action</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
		<span class="kt">int</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">getFence</span><span class="o">(),</span> <span class="n">i</span> <span class="o">=</span> <span class="n">index</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">hi</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
			<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span> <span class="no">E</span> <span class="n">e</span> <span class="o">=</span> <span class="o">(</span><span class="no">E</span><span class="o">)</span><span class="n">list</span><span class="o">.</span><span class="na">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
			<span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">list</span><span class="o">.</span><span class="na">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
			<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">forEachRemaining</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="n">hi</span><span class="o">,</span> <span class="n">mc</span><span class="o">;</span> <span class="c1">// hoist accesses and checks from loop</span>
		<span class="nc">ArrayList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">lst</span><span class="o">;</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">a</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">action</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
		<span class="k">if</span> <span class="o">((</span><span class="n">lst</span> <span class="o">=</span> <span class="n">list</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">a</span> <span class="o">=</span> <span class="n">lst</span><span class="o">.</span><span class="na">elementData</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">((</span><span class="n">hi</span> <span class="o">=</span> <span class="n">fence</span><span class="o">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">mc</span> <span class="o">=</span> <span class="n">lst</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>
				<span class="n">hi</span> <span class="o">=</span> <span class="n">lst</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="k">else</span>
				<span class="n">mc</span> <span class="o">=</span> <span class="n">expectedModCount</span><span class="o">;</span>
			<span class="k">if</span> <span class="o">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">index</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">hi</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="n">a</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">for</span> <span class="o">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hi</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
					<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span> <span class="no">E</span> <span class="n">e</span> <span class="o">=</span> <span class="o">(</span><span class="no">E</span><span class="o">)</span> <span class="n">a</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
					<span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">lst</span><span class="o">.</span><span class="na">modCount</span> <span class="o">==</span> <span class="n">mc</span><span class="o">)</span>
					<span class="k">return</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">long</span> <span class="nf">estimateSize</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="o">(</span><span class="kt">long</span><span class="o">)</span> <span class="o">(</span><span class="n">getFence</span><span class="o">()</span> <span class="o">-</span> <span class="n">index</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">characteristics</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nc">Spliterator</span><span class="o">.</span><span class="na">ORDERED</span> <span class="o">|</span> <span class="nc">Spliterator</span><span class="o">.</span><span class="na">SIZED</span> <span class="o">|</span> <span class="nc">Spliterator</span><span class="o">.</span><span class="na">SUBSIZED</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">removeIf</span><span class="o">(</span><span class="nc">Predicate</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">filter</span><span class="o">)</span> <span class="o">{</span>
	<span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">filter</span><span class="o">);</span>
	<span class="c1">// figure out which elements are to be removed</span>
	<span class="c1">// any exception thrown from the filter predicate at this stage</span>
	<span class="c1">// will leave the collection unmodified</span>
	<span class="kt">int</span> <span class="n">removeCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
	<span class="kd">final</span> <span class="nc">BitSet</span> <span class="n">removeSet</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BitSet</span><span class="o">(</span><span class="n">size</span><span class="o">);</span>
	<span class="kd">final</span> <span class="kt">int</span> <span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>
	<span class="kd">final</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
	<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">modCount</span> <span class="o">==</span> <span class="n">expectedModCount</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
		<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
		<span class="kd">final</span> <span class="no">E</span> <span class="n">element</span> <span class="o">=</span> <span class="o">(</span><span class="no">E</span><span class="o">)</span> <span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">filter</span><span class="o">.</span><span class="na">test</span><span class="o">(</span><span class="n">element</span><span class="o">))</span> <span class="o">{</span>
			<span class="n">removeSet</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
			<span class="n">removeCount</span><span class="o">++;</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="c1">// shift surviving elements left over the spaces left by removed elements</span>
	<span class="kd">final</span> <span class="kt">boolean</span> <span class="n">anyToRemove</span> <span class="o">=</span> <span class="n">removeCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">;</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">anyToRemove</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">newSize</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">removeCount</span><span class="o">;</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">,</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="o">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">newSize</span><span class="o">);</span> <span class="n">i</span><span class="o">++,</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">removeSet</span><span class="o">.</span><span class="na">nextClearBit</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
			<span class="n">elementData</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
		<span class="o">}</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">k</span><span class="o">=</span><span class="n">newSize</span><span class="o">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">k</span><span class="o">++)</span> <span class="o">{</span>
			<span class="n">elementData</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>  <span class="c1">// Let gc do its work</span>
		<span class="o">}</span>
		<span class="k">this</span><span class="o">.</span><span class="na">size</span> <span class="o">=</span> <span class="n">newSize</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="n">modCount</span><span class="o">++;</span>
	<span class="o">}</span>

	<span class="k">return</span> <span class="n">anyToRemove</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">replaceAll</span><span class="o">(</span><span class="nc">UnaryOperator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">operator</span><span class="o">)</span> <span class="o">{</span>
	<span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">operator</span><span class="o">);</span>
	<span class="kd">final</span> <span class="kt">int</span> <span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>
	<span class="kd">final</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
	<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">modCount</span> <span class="o">==</span> <span class="n">expectedModCount</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
		<span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="na">apply</span><span class="o">((</span><span class="no">E</span><span class="o">)</span> <span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
	<span class="o">}</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
	<span class="o">}</span>
	<span class="n">modCount</span><span class="o">++;</span>
<span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>æ€»ç»“ï¼Œ
  	Listæ¥å£å¯è°ƒæ•´å¤§å°çš„æ•°ç»„å®ç°ã€‚å®ç°æ‰€æœ‰å¯é€‰çš„Listæ“ä½œï¼Œå¹¶å…è®¸æ‰€æœ‰å…ƒç´ ï¼ŒåŒ…æ‹¬nullï¼Œå…ƒç´ å¯é‡å¤ã€‚
  	é™¤äº†åˆ—è¡¨æ¥å£å¤–ï¼Œè¯¥ç±»æä¾›äº†ä¸€ç§æ–¹æ³•æ¥æ“ä½œè¯¥æ•°ç»„çš„å¤§å°æ¥å­˜å‚¨è¯¥åˆ—è¡¨ä¸­çš„æ•°ç»„çš„å¤§å°ã€‚</p>
</div>
<div class="literalblock">
<div class="content">
<pre>æ—¶é—´å¤æ‚åº¦ï¼š
æ–¹æ³•sizeã€isEmptyã€getã€setã€iteratorå’ŒlistIteratorçš„è°ƒç”¨æ˜¯å¸¸æ•°æ—¶é—´çš„ã€‚
	æ·»åŠ åˆ é™¤çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(N)ã€‚å…¶ä»–æ‰€æœ‰æ“ä½œä¹Ÿéƒ½æ˜¯çº¿æ€§æ—¶é—´å¤æ‚åº¦ã€‚</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>å®¹é‡ï¼š
	æ¯ä¸ªArrayListéƒ½æœ‰å®¹é‡ï¼Œå®¹é‡å¤§å°è‡³å°‘ä¸ºListå…ƒç´ çš„é•¿åº¦ï¼Œé»˜è®¤åˆå§‹åŒ–ä¸º10ã€‚
 å®¹é‡å¯ä»¥è‡ªåŠ¨å¢é•¿ã€‚
 å¦‚æœæå‰çŸ¥é“æ•°ç»„å…ƒç´ è¾ƒå¤šï¼Œå¯ä»¥åœ¨æ·»åŠ å…ƒç´ å‰é€šè¿‡è°ƒç”¨ensureCapacity()æ–¹æ³•æå‰å¢åŠ å®¹é‡ä»¥å‡å°åæœŸå®¹é‡è‡ªåŠ¨å¢é•¿çš„å¼€é”€ã€‚
 ä¹Ÿå¯ä»¥é€šè¿‡å¸¦åˆå§‹å®¹é‡çš„æ„é€ å™¨åˆå§‹åŒ–è¿™ä¸ªå®¹é‡ã€‚</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre> çº¿ç¨‹ä¸å®‰å…¨ï¼š
 	ArrayListä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚
 	å¦‚æœéœ€è¦åº”ç”¨åˆ°å¤šçº¿ç¨‹ä¸­ï¼Œéœ€è¦åœ¨å¤–éƒ¨åšåŒæ­¥ã€‚
**æŒ‡å¯¼æ„ä¹‰**
é‚£ç§éå†æ€§èƒ½æ›´ä¼˜ï¼Ÿåº”è¯¥ä½¿ç”¨å“ªç§éå†æ–¹å¼ï¼Ÿ
ã€Šç¼–å†™é«˜è´¨é‡ä»£ç ï¼šæ”¹å–„Javaç¨‹åºçš„151ä¸ªå»ºè®®ã€‹ä¸€ä¹¦è®¤ä¸ºä½¿ç”¨ä¼ ç»Ÿçš„ä¸‹æ ‡éå†æ˜¯ä¼˜äºå¢å¼ºå‹forå¾ªç¯çš„ï¼Œè€Œã€ŠEffective Javaä¸­æ–‡ç‰ˆ ç¬¬2ç‰ˆã€‹æ¨èçš„æ˜¯å¢å¼ºå‹forå¾ªç¯ï¼Œè¯´for-eachå¾ªç¯æ²¡æœ‰æ€§èƒ½æŸå¤±ã€‚ä½•è§£ï¼Ÿ
åœ¨ArrayListå¤§å°ä¸ºåä¸‡ä¹‹å‰ï¼Œäº”ç§éå†æ–¹å¼æ—¶é—´æ¶ˆè€—å‡ ä¹ä¸€æ ·
å³ä¾¿åœ¨åƒä¸‡å¤§å°çš„ArrayListä¸­ï¼Œå‡ ç§éå†æ–¹å¼ç›¸å·®ä¹Ÿä¸è¿‡50mså·¦å³ï¼ˆfor-eachå¾ªç¯è¾ƒå¤§ï¼‰ï¼Œä¸”åœ¨å¸¸ç”¨çš„åä¸‡å·¦å³æ—¶é—´å‡ ä¹ç›¸ç­‰ï¼Œè€ƒè™‘foreachç®€æ´çš„ä¼˜ç‚¹ï¼Œæˆ‘ä»¬å¤§å¯é€‰ç”¨foreachè¿™ç§ç®€ä¾¿æ–¹å¼è¿›è¡Œéå†ã€‚</pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/compareListLoop.png" alt="compareListLoop">
</div>
</div>
<div class="paragraph">
<p>è¿™æ˜¯å¯¹ArrayListæ•ˆç‡å½±å“æ¯”è¾ƒå¤§çš„ä¸€ä¸ªå› ç´ ã€‚
æ¯å½“æ‰§è¡ŒAddç­‰æ·»åŠ å…ƒç´ çš„æ–¹æ³•ï¼Œéƒ½ä¼šæ£€æŸ¥å†…éƒ¨æ•°ç»„çš„å®¹é‡æ˜¯å¦ä¸å¤Ÿäº†ï¼Œå¦‚æœæ˜¯ï¼Œå®ƒå°±ä¼šä»¥å½“å‰å®¹é‡ çš„ 1.5 å€æ¥é‡æ–°æ„å»ºä¸€ä¸ªæ•°ç»„ï¼Œå°†æ—§å…ƒç´ Copyåˆ°æ–°æ•°ç»„ä¸­ï¼Œç„¶åä¸¢å¼ƒæ—§æ•°ç»„ï¼Œåœ¨è¿™ä¸ªä¸´ç•Œç‚¹çš„æ‰©å®¹æ“ä½œï¼Œåº”è¯¥æ¥è¯´æ˜¯æ¯”è¾ƒå½±å“æ•ˆç‡çš„ã€‚ æ­£ç¡®çš„é¢„ä¼°å¯èƒ½çš„å…ƒç´ ï¼Œæ˜¯æé«˜ArrayListä½¿ç”¨æ•ˆç‡çš„é‡è¦é€”å¾„ã€‚</p>
</div>
</div>
<div class="sect2">
<h3 id="_é—®é¢˜"><a class="anchor" href="#_é—®é¢˜"></a>8.6. é—®é¢˜</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Java ä¸­æœ‰å¾ˆå¤šæ ‡è¯†ç±»çš„æ¥å£ã€‚è¿™äº›è¡¨ç¤ºç±»æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Ÿæ˜¯å¦åœ¨ Java è™šæ‹Ÿæœºä¸­å¯¹å…¶è¿›è¡Œäº†ç‰¹æ®Šå¤„ç†ï¼Ÿ</p>
</li>
<li>
<p>åœ¨å®ç° <code>java.io.Serializable</code> æ—¶ï¼Œå¦‚æœä¸å£°æ˜ <code>serialVersionUID</code> å˜é‡æ—¶ï¼Œæ˜¯å¦ä¼šç”Ÿæˆè¿™ä¸ªå€¼ï¼Ÿé»˜è®¤çš„å€¼æ˜¯ä»€ä¹ˆï¼Ÿåœ¨åºåˆ—åŒ–æ—¶ï¼Œæ˜¯å¦‚ä½•ä¿å­˜è¿™ä¸ªå€¼ï¼Ÿåœ¨ååºåˆ—åŒ–æ—¶ï¼Œå¦‚ä½•ä»å¯¹è±¡çš„å­—èŠ‚ç ä¸­è·å–è¿™ä¸ªå€¼ï¼Ÿæ¯”è¾ƒåï¼Œå¦‚æœä¸åŒåˆæ€ä¹ˆå¤„ç†çš„ï¼Ÿ</p>
</li>
<li>
<p>åœ¨ <code>ArrayList</code> ä¸­æœ‰ <code>writeObject(java.io.ObjectOutputStream s)</code> å’Œ <code>readObject(java.io.ObjectInputStream s)</code> æ–¹æ³•ã€‚åœ¨å•ä¾‹æ¨¡å¼ä¸­ï¼Œä¸ºäº†è§£å†³ååºåˆ—åŒ–çš„é—®é¢˜ï¼Œä¼šæ·»åŠ  <code>readResolve()</code> æ–¹æ³•ã€‚è¿™ä¸‰ä¸ªæ–¹æ³•æœ‰ä»€ä¹ˆç”¨ï¼Ÿä»€ä¹ˆæ—¶å€™è¢«ä»€ä¹ˆè°ƒç”¨ï¼Ÿè¢«ä»€ä¹ˆè°ƒç”¨ï¼Ÿè®¾ç½®æ–­ç‚¹è°ƒè¯•ä¸€ä¸‹ï¼Œçœ‹ <strong>è°ƒç”¨æ ˆ</strong>ã€‚</p>
</li>
<li>
<p>ArrayList åœ¨æ‰©å®¹æ—¶ï¼Œä½¿ç”¨çš„æ˜¯ <code>oldCapacity + (oldCapacity &gt;&gt; 1)</code>ï¼Œè¿™é‡Œ <code>oldCapacity &gt;&gt; 1</code> å°±æ˜¯ç›´æ¥ç§»ä½å°† oldCapacity çš„å€¼å‡åŠï¼Œå–åˆ°çš„å€¼å°±æ˜¯ oldCapacity/2 åçš„æœ€å¤§æ­£æ•´æ•°ã€‚</p>
</li>
<li>
<p>ArrayList ä¸­æœ‰ <code>rangeCheck(int index)</code> å’Œ <code>rangeCheckForAdd(int index)</code>ï¼ŒåŒºåˆ«å°±æ˜¯å‰è€…æ²¡æœ‰åšè´Ÿæ•°æ£€æŸ¥ã€‚ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ç§åŒºåˆ«ï¼Ÿä¸ºä»€ä¹ˆä¸æ£€æŸ¥è´Ÿæ•°ï¼Ÿå†ä¸ºä»€ä¹ˆä¸æ£€æŸ¥è´Ÿæ•°ä¸ºä»€ä¹ˆè¿˜èƒ½æŠ›å‡º <code>ArrayIndexOutOfBoundsException</code> å¼‚å¸¸ï¼Ÿï¼ˆæ–‡æ¡£ä¸­ï¼‰</p>
</li>
<li>
<p>ã€Šæ•°æ®ç»“æ„ä¸ç®—æ³•åˆ†æã€‹ ä¸­æåˆ° <code>Iterator</code> å’Œ <code>ListIterator</code> çš„åŒºåˆ«ä»¥åŠ <code>ListIterator</code> ä¸­ä¸€ä¸ªç‰¹æ®Šçš„ä½¿ç”¨ã€‚å†æ¬¡çœ‹ä¹¦æ¥ç¡®è®¤ä¸€ä¸‹ã€‚</p>
</li>
<li>
<p>é€šè¿‡æŒ‡ä»¤æ¥å¯¹æ¯” Iterat or å’Œ foreach ä¹‹é—´çš„æ€§èƒ½å·®å¼‚ã€‚</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_å‚è€ƒèµ„æ–™_2"><a class="anchor" href="#_å‚è€ƒèµ„æ–™_2"></a>8.7. å‚è€ƒèµ„æ–™</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://www.hollischuang.com/archives/1144">å•ä¾‹ä¸åºåˆ—åŒ–çš„é‚£äº›äº‹å„¿-HollisChuang&#8217;s Blog</a></p>
</li>
<li>
<p><a href="http://www.hollischuang.com/archives/197">æ·±åº¦åˆ†æJavaçš„æšä¸¾ç±»å‹â€”-æšä¸¾çš„çº¿ç¨‹å®‰å…¨æ€§åŠåºåˆ—åŒ–é—®é¢˜-HollisChuang&#8217;s Blog</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_linkedlist"><a class="anchor" href="#_linkedlist"></a>9. LinkedList</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>LinkedList</code> åº•å±‚ä½¿ç”¨çš„æ˜¯ åŒå‘é“¾è¡¨ æ•°æ®ç»“æ„ï¼ˆJDK1.6 ä¹‹å‰ä¸ºå¾ªç¯é“¾è¡¨ï¼ŒJDK1.7 å–æ¶ˆäº†å¾ªç¯ã€‚æ³¨æ„åŒå‘é“¾è¡¨å’ŒåŒå‘å¾ªç¯é“¾è¡¨çš„åŒºåˆ«ã€‚ï¼‰</p>
</div>
<div class="sect2">
<h3 id="_ç±»å›¾_3"><a class="anchor" href="#_ç±»å›¾_3"></a>9.1. ç±»å›¾</h3>
<div class="paragraph">
<p>å…ˆæ¥çœ‹ä¸€ä¸‹ <code>LinkedList</code> çš„ç±»å›¾ï¼š</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./diag-0a1a36b1bfc746ed88c5db48ad5ce645.svg" alt="diag 0a1a36b1bfc746ed88c5db48ad5ce645" width="100%" height="607">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_åˆå§‹åŒ–_2"><a class="anchor" href="#_åˆå§‹åŒ–_2"></a>9.2. åˆå§‹åŒ–</h3>
<div class="paragraph">
<p>å…ˆçœ‹çœ‹ <code>LinkedList</code> ä¸­å†…éƒ¨å±æ€§å’Œæ„é€ å‡½æ•°ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="code"><pre><span class="kd">transient</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

<span class="cm">/**
 * Pointer to first node.
 */</span>
<span class="kd">transient</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">first</span><span class="o">;</span>

<span class="cm">/**
 * Pointer to last node.
 */</span>
<span class="kd">transient</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">last</span><span class="o">;</span>

<span class="cm">/*
void dataStructureInvariants() {
    assert (size == 0)
        ? (first == null &amp;&amp; last == null)
        : (first.prev == null &amp;&amp; last.next == null);
}
*/</span>

<span class="cm">/**
 * Constructs an empty list.
 */</span>
<span class="kd">public</span> <span class="nf">LinkedList</span><span class="o">()</span> <span class="o">{</span>
<span class="o">}</span>

<span class="cm">/**
 * Constructs a list containing the elements of the specified
 * collection, in the order they are returned by the collection's
 * iterator.
 *
 * @param  c the collection whose elements are to be placed into this list
 * @throws NullPointerException if the specified collection is null
 */</span>
<span class="kd">public</span> <span class="nf">LinkedList</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">();</span>
    <span class="n">addAll</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="no">E</span> <span class="n">item</span><span class="o">;</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">;</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">prev</span><span class="o">;</span>

    <span class="nc">Node</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">prev</span><span class="o">,</span> <span class="no">E</span> <span class="n">element</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">item</span> <span class="o">=</span> <span class="n">element</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">prev</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ä»è¿™é‡Œä¸€çœ¼å³å¯çœ‹å‡ºå†…éƒ¨ä½¿ç”¨ä¸€ä¸ªåŒå‘é“¾è¡¨æ¥ä¿å­˜æ•°æ®ã€‚åˆå§‹åŒ–å·¥ä½œä¹ŸåŠå…¶å¹²å‡€ï¼Œä»€ä¹ˆä¹Ÿä¸å¹²ã€‚å¦å¤–ä¸€ä¸ªæ„é€ å‡½æ•°åé¢å†åˆ†æã€‚</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Dç“œå“¥è§‰å¾—ä½¿ç”¨åˆå§‹åŒ–çš„å¤´å°¾èŠ‚ç‚¹æ›´æ–¹ä¾¿ä»£ç ä¹¦å†™ï¼Œå°‘äº†å¾ˆå¤šç¹ççš„åˆ¤æ–­ã€‚
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_åˆ†æå·¥å…·"><a class="anchor" href="#_åˆ†æå·¥å…·"></a>9.3. åˆ†æå·¥å…·</h3>
<div class="paragraph">
<p>ä½¿ç”¨åå°„æ¥è·å–å†…éƒ¨å±æ€§ï¼Œç„¶ååšè¿›ä¸€æ­¥åˆ†æã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.LinkedList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Objects</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-03-03 16:16
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LinkedListBaseTest</span> <span class="o">{</span>
    <span class="cm">/**
     * ä½¿ç”¨åå°„è¯»å– LinkedList å†…éƒ¨å±æ€§
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">xray</span><span class="o">(</span><span class="nc">LinkedList</span><span class="o">&lt;?&gt;</span> <span class="n">list</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">LinkedList</span><span class="o">&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">list</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Field</span> <span class="n">nodeField</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"first"</span><span class="o">);</span>
            <span class="n">nodeField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="nc">Object</span> <span class="n">node</span> <span class="o">=</span> <span class="n">nodeField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"length="</span> <span class="o">+</span> <span class="n">length</span><span class="o">(</span><span class="n">node</span><span class="o">)</span> <span class="o">+</span> <span class="s">", size="</span> <span class="o">+</span> <span class="n">list</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">length</span><span class="o">(</span><span class="nc">Object</span> <span class="n">node</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">isNull</span><span class="o">(</span><span class="n">node</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">nodeClass</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
            <span class="nc">Field</span> <span class="n">nextField</span> <span class="o">=</span> <span class="n">nodeClass</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"next"</span><span class="o">);</span>
            <span class="n">nextField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="k">while</span> <span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">nonNull</span><span class="o">(</span><span class="n">node</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">nextField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
                <span class="n">result</span><span class="o">++;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_æ·»åŠ å…ƒç´ _2"><a class="anchor" href="#_æ·»åŠ å…ƒç´ _2"></a>9.4. æ·»åŠ å…ƒç´ </h3>
<div class="paragraph">
<p>æµ‹è¯•ä»£ç ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testAddAtTail</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">LinkedList</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedList</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">xray</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>
            <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>JDK æºç ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="code"><pre><span class="cm">/**
 * Links e as last element.
 */</span>
<span class="kt">void</span> <span class="nf">linkLast</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="n">last</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">newNode</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;&gt;(</span><span class="n">l</span><span class="o">,</span> <span class="n">e</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="n">last</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">l</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
        <span class="n">first</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
    <span class="k">else</span>
        <span class="n">l</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
    <span class="n">size</span><span class="o">++;</span>
    <span class="n">modCount</span><span class="o">++;</span>
<span class="o">}</span>

<span class="cm">/**
 * Appends the specified element to the end of this list.
 *
 * &lt;p&gt;This method is equivalent to {@link #addLast}.
 *
 * @param e element to be appended to this list
 * @return {@code true} (as specified by {@link Collection#add})
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">add</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">linkLast</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>å†æ¥çœ‹çœ‹ä»å¤´éƒ¨æ’å…¥å…ƒç´ ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testAddAtHeader</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">LinkedList</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedList</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">xray</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>
            <span class="n">list</span><span class="o">.</span><span class="na">addFirst</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>JDK æºç ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="code"><pre><span class="cm">/**
 * Links e as first element.
 */</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">linkFirst</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">newNode</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;&gt;(</span><span class="kc">null</span><span class="o">,</span> <span class="n">e</span><span class="o">,</span> <span class="n">f</span><span class="o">);</span>
    <span class="n">first</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
    <span class="k">else</span>
        <span class="n">f</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
    <span class="n">size</span><span class="o">++;</span>
    <span class="n">modCount</span><span class="o">++;</span>
<span class="o">}</span>

<span class="cm">/**
 * Inserts the specified element at the beginning of this list.
 *
 * @param e the element to add
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">addFirst</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">linkFirst</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ä»è¿™é‡Œå°±èƒ½çœ‹å‡ºï¼Œ<code>LinkedList</code> åœ¨ <code>add(e)</code>ã€<code>addLast(e)</code> æˆ–è€… <code>addFirst(e)</code> æ—¶ï¼Œéƒ½æ˜¯å¯¹é“¾è¡¨çš„é¦–å°¾è¿›è¡Œæ“ä½œï¼Œä¼šæ¯”è¾ƒé«˜æ•ˆã€‚</p>
</div>
</div>
<div class="sect2">
<h3 id="_redis_çš„_list"><a class="anchor" href="#_redis_çš„_list"></a>9.5. Redis çš„ List</h3>
<div class="paragraph">
<p>Redis åº•å±‚ä¹Ÿæœ‰å¾ˆå¤šåœ°æ–¹ä½¿ç”¨åˆ°é“¾è¡¨ï¼Œå¹¶ä¸”ä¹Ÿæ˜¯åŒå‘é“¾è¡¨ã€‚</p>
</div>
<div class="listingblock">
<div class="title">adlist.h</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="code"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="n">listNode</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">listNode</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">listNode</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">value</span><span class="p">;</span>
<span class="p">}</span> <span class="n">listNode</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">listIter</span> <span class="p">{</span>
    <span class="n">listNode</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">direction</span><span class="p">;</span>
<span class="p">}</span> <span class="n">listIter</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">list</span> <span class="p">{</span>
    <span class="n">listNode</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
    <span class="n">listNode</span> <span class="o">*</span><span class="n">tail</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">dup</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">free</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">match</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span> <span class="n">list</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Redis çš„é“¾è¡¨å®ç°ç‰¹ç‚¹æ˜¯ï¼š</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>åŒå‘ï¼šèŠ‚ç‚¹å¸¦æœ‰å‰åæŒ‡é’ˆï¼›</p>
</li>
<li>
<p>æ— ç¯ï¼šé¦–å°¾æ²¡æœ‰ç›¸è¿ï¼Œæ‰€ä»¥æ²¡æœ‰æ„æˆç¯çŠ¶ï¼›</p>
</li>
<li>
<p>é“¾è¡¨ä¿å­˜äº†é¦–å°¾æŒ‡é’ˆï¼›</p>
</li>
<li>
<p>å¤šæ€ï¼šå¯ä»¥ä¿å­˜ä¸åŒç±»å‹çš„å€¼ï¼Œè¿™é‡Œæˆä¸ºæ³›å‹ä¹Ÿè®¸æ›´ç¬¦åˆ Java ä¸­çš„è¯­ä¹‰ã€‚</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_redis_çš„_ziplist"><a class="anchor" href="#_redis_çš„_ziplist"></a>9.6. Redis çš„ ziplist</h3>
<div class="paragraph">
<p>Redis å®˜æ–¹åœ¨ ziplist.c æ–‡ä»¶çš„æ³¨é‡Šä¸­å¯¹ ziplist è¿›è¡Œäº†å®šä¹‰ï¼š</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The ziplist is a specially encoded dually linked list that is designed
to be very memory efficient. It stores both strings and integer values,
where integers are encoded as actual integers instead of a series of
characters. It allows push and pop operations on either side of the list
in O(1) time. However, because every operation requires a reallocation of
the memory used by the ziplist, the actual complexity is related to the
amount of memory used by the ziplist.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; redis/ziplist.c
</div>
</div>
<div class="paragraph">
<p>å°±æ˜¯è¯´ï¼Œziplist æ˜¯ä¸€ä¸ªç»è¿‡ç‰¹æ®Šç¼–ç çš„åŒå‘é“¾è¡¨ï¼Œå®ƒçš„è®¾è®¡ç›®æ ‡å°±æ˜¯ä¸ºäº†æé«˜å­˜å‚¨æ•ˆç‡ã€‚ziplist å¯ä»¥ç”¨äºå­˜å‚¨å­—ç¬¦ä¸²æˆ–æ•´æ•°ï¼Œå…¶ä¸­æ•´æ•°æ˜¯æŒ‰çœŸæ­£çš„äºŒè¿›åˆ¶è¡¨ç¤ºè¿›è¡Œç¼–ç çš„ï¼Œè€Œä¸æ˜¯ç¼–ç æˆå­—ç¬¦ä¸²åºåˆ—ã€‚å®ƒèƒ½ä»¥ O(1) çš„æ—¶é—´å¤æ‚åº¦åœ¨è¡¨çš„ä¸¤ç«¯æä¾› <code>push</code> å’Œ <code>pop</code> æ“ä½œã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="linenums">The general layout of the ziplist is as follows:

&lt;zlbytes&gt; &lt;zltail&gt; &lt;zllen&gt; &lt;entry&gt; &lt;entry&gt; ... &lt;entry&gt; &lt;zlend&gt;

NOTE: all fields are stored in little endian, if not specified otherwise.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>&lt;zlbytes&gt;</code>: 32bitï¼Œè¡¨ç¤ºziplistå ç”¨çš„å­—èŠ‚æ€»æ•°ï¼ˆä¹ŸåŒ…æ‹¬&lt;zlbytes&gt;æœ¬èº«å ç”¨çš„4ä¸ªå­—èŠ‚ï¼‰ã€‚</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>&lt;zltail&gt;</code>: 32bitï¼Œè¡¨ç¤ºziplistè¡¨ä¸­æœ€åä¸€é¡¹ï¼ˆentryï¼‰åœ¨ziplistä¸­çš„åç§»å­—èŠ‚æ•°ã€‚
<div class="paragraph">
<p><code>&lt;zltail&gt;</code> çš„å­˜åœ¨ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ‰¾åˆ°æœ€åä¸€é¡¹ï¼ˆä¸ç”¨éå†æ•´ä¸ªziplistï¼‰ï¼Œä»è€Œå¯ä»¥åœ¨ziplistå°¾ç«¯å¿«é€Ÿåœ°æ‰§è¡Œpushæˆ–popæ“ä½œã€‚</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>&lt;zllen&gt;</code>: 16bitï¼Œ è¡¨ç¤ºziplistä¸­æ•°æ®é¡¹ï¼ˆentryï¼‰çš„ä¸ªæ•°ã€‚zllenå­—æ®µå› ä¸ºåªæœ‰16bitï¼Œæ‰€ä»¥å¯ä»¥è¡¨è¾¾çš„æœ€å¤§å€¼ä¸º2^16-1ã€‚<code>&lt;zllen&gt;</code> ç­‰äº16bitå…¨ä¸º1çš„æƒ…å†µï¼Œé‚£ä¹ˆ <code>&lt;zllen&gt;</code> å°±ä¸è¡¨ç¤ºæ•°æ®é¡¹ä¸ªæ•°äº†ï¼Œè¿™æ—¶è¦æƒ³çŸ¥é“ ziplist ä¸­æ•°æ®é¡¹æ€»æ•°ï¼Œé‚£ä¹ˆå¿…é¡»å¯¹ziplistä»å¤´åˆ°å°¾éå†å„ä¸ªæ•°æ®é¡¹ï¼Œæ‰èƒ½è®¡æ•°å‡ºæ¥ã€‚</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>&lt;entry&gt;</code>: è¡¨ç¤ºçœŸæ­£å­˜æ”¾æ•°æ®çš„æ•°æ®é¡¹ï¼Œé•¿åº¦ä¸å®šã€‚ä¸€ä¸ªæ•°æ®é¡¹ï¼ˆentryï¼‰ä¹Ÿæœ‰å®ƒè‡ªå·±çš„å†…éƒ¨ç»“æ„ï¼Œè¿™ä¸ªç¨åå†è§£é‡Šã€‚</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>&lt;zlend&gt;</code>: ziplist æœ€å 1 ä¸ªå­—èŠ‚ï¼Œæ˜¯ä¸€ä¸ªç»“æŸæ ‡è®°ï¼Œå€¼å›ºå®šç­‰äº 255ã€‚</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>ziplist å°†è¡¨ä¸­æ¯ä¸€é¡¹å­˜æ”¾åœ¨å‰åè¿ç»­çš„åœ°å€ç©ºé—´å†…ï¼Œä¸€ä¸ªziplistæ•´ä½“å ç”¨ä¸€å¤§å—å†…å­˜ã€‚å®ƒæ˜¯ä¸€ä¸ªè¡¨ï¼ˆlistï¼‰ï¼Œä½†å…¶å®ä¸æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼ˆlinked listï¼‰ã€‚</p>
</div>
<div class="paragraph">
<p>ziplist ä¸ºäº†åœ¨ç»†èŠ‚ä¸ŠèŠ‚çœå†…å­˜ï¼Œå¯¹äºå€¼çš„å­˜å‚¨é‡‡ç”¨äº†å˜é•¿çš„ç¼–ç æ–¹å¼ã€‚</p>
</div>
<div class="paragraph">
<p>æ¯ä¸€ä¸ªæ•°æ®é¡¹&lt;entry&gt;çš„æ„æˆï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="linenums">&lt;prevlen&gt; &lt;encoding&gt; &lt;entry-data&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>&lt;prevlen&gt;</code>: è¡¨ç¤ºå‰ä¸€ä¸ªæ•°æ®é¡¹å ç”¨çš„æ€»å­—èŠ‚æ•°ã€‚
<div class="olist arabic">
<ol class="arabic">
<li>
<p>å¦‚æœå‰ä¸€ä¸ªæ•°æ®é¡¹å ç”¨å­—èŠ‚æ•°å°äº254ï¼Œé‚£ä¹ˆ <code>&lt;prevlen&gt;</code> å°±åªç”¨ä¸€ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºï¼Œè¿™ä¸ªå­—èŠ‚çš„å€¼å°±æ˜¯å‰ä¸€ä¸ªæ•°æ®é¡¹çš„å ç”¨å­—èŠ‚æ•°ï¼š <code>&lt;prevlen from 0 to 253&gt; &lt;encoding&gt; &lt;entry&gt;</code></p>
</li>
<li>
<p>å¦‚æœå‰ä¸€ä¸ªæ•°æ®é¡¹å ç”¨å­—èŠ‚æ•°å¤§äºç­‰äº254ï¼Œé‚£ä¹ˆ <code>&lt;prevlen&gt;</code> å°±ç”¨5ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºï¼Œå…¶ä¸­ç¬¬1ä¸ªå­—èŠ‚çš„å€¼æ˜¯254ï¼ˆä½œä¸ºè¿™ç§æƒ…å†µçš„ä¸€ä¸ªæ ‡è®°ï¼‰ï¼Œè€Œåé¢4ä¸ªå­—èŠ‚ç»„æˆä¸€ä¸ªæ•´å‹å€¼ï¼Œæ¥çœŸæ­£å­˜å‚¨å‰ä¸€ä¸ªæ•°æ®é¡¹çš„å ç”¨å­—èŠ‚æ•°</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>0xFE &lt;4 bytes unsigned little endian prevlen&gt; &lt;encoding&gt; &lt;entry&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>&lt;encoding&gt;</code>: è¡¨ç¤ºå½“å‰æ•°æ®é¡¹çš„ç±»å‹ï¼Œæ•´å‹æˆ–è€…å­—ç¬¦ä¸²ã€‚</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>&lt;entry-data&gt;</code>: æ•°æ®</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>å…³äº <code>&lt;encoding&gt; &lt;entry-data&gt;</code> çš„ç¼–ç ï¼Œç›´æ¥å¼•ç”¨å®˜æ–¹æ–‡æ¡£ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre> The encoding field of the entry depends on the content of the
 entry. When the entry is a string, the first 2 bits of the encoding first
 byte will hold the type of encoding used to store the length of the string,
 followed by the actual length of the string. When the entry is an integer
 the first 2 bits are both set to 1. The following 2 bits are used to specify
 what kind of integer will be stored after this header. An overview of the
 different types and encodings is as follows. The first byte is always enough
 to determine the kind of entry.

 |00pppppp| - 1 byte
      String value with length less than or equal to 63 bytes (6 bits).
      "pppppp" represents the unsigned 6 bit length.
 |01pppppp|qqqqqqqq| - 2 bytes
      String value with length less than or equal to 16383 bytes (14 bits).
      IMPORTANT: The 14 bit number is stored in big endian.
 |10000000|qqqqqqqq|rrrrrrrr|ssssssss|tttttttt| - 5 bytes
      String value with length greater than or equal to 16384 bytes.
      Only the 4 bytes following the first byte represents the length
      up to 32^2-1. The 6 lower bits of the first byte are not used and
      are set to zero.
      IMPORTANT: The 32 bit number is stored in big endian.
 |11000000| - 3 bytes
      Integer encoded as int16_t (2 bytes).
 |11010000| - 5 bytes
      Integer encoded as int32_t (4 bytes).
 |11100000| - 9 bytes
      Integer encoded as int64_t (8 bytes).
 |11110000| - 4 bytes
      Integer encoded as 24 bit signed (3 bytes).
 |11111110| - 2 bytes
      Integer encoded as 8 bit signed (1 byte).
 |1111xxxx| - (with xxxx between 0000 and 1101) immediate 4 bit integer.
      Unsigned integer from 0 to 12. The encoded value is actually from
      1 to 13 because 0000 and 1111 can not be used, so 1 should be
      subtracted from the encoded 4 bit value to obtain the right value.
 |11111111| - End of ziplist special entry.</pre>
</div>
</div>
<div class="paragraph">
<p>å¼•ç”¨åœ¨ç½‘ä¸Šæ‰¾çš„ä¾‹å­ï¼Œæ¥åšä¸ªè¯´æ˜ï¼š</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/redis-ziplist-sample.png" alt="redis ziplist sample">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>è¿™ä¸ªziplistä¸€å…±åŒ…å« 33 ä¸ªå­—èŠ‚ã€‚å­—èŠ‚ç¼–å·ä» <code>byte[0]</code> åˆ° <code>byte[32]</code>ã€‚å›¾ä¸­æ¯ä¸ªå­—èŠ‚çš„å€¼ä½¿ç”¨ 16 è¿›åˆ¶è¡¨ç¤ºã€‚</p>
</li>
<li>
<p>å¤´ 4 ä¸ªå­—èŠ‚ï¼ˆ<code>0x21000000</code>ï¼‰æ˜¯æŒ‰å°ç«¯ï¼ˆlittle endianï¼‰æ¨¡å¼å­˜å‚¨çš„ <code>&lt;zlbytes&gt;</code> å­—æ®µã€‚ä»€ä¹ˆæ˜¯å°ç«¯å‘¢ï¼Ÿå°±æ˜¯æŒ‡æ•°æ®çš„ä½å­—èŠ‚ä¿å­˜åœ¨å†…å­˜çš„ä½åœ°å€ä¸­ï¼ˆå‚è§ç»´åŸºç™¾ç§‘è¯æ¡ <a href="https://en.wikipedia.org/wiki/Endianness">Endianness</a>ï¼‰ã€‚å› æ­¤ï¼Œè¿™é‡Œ <code>&lt;zlbytes&gt;</code> çš„å€¼åº”è¯¥è§£ææˆ <code>0x00000021</code>ï¼Œç”¨åè¿›åˆ¶è¡¨ç¤ºæ­£å¥½å°±æ˜¯33ã€‚</p>
</li>
<li>
<p>æ¥ä¸‹æ¥ 4 ä¸ªå­—èŠ‚ï¼ˆ<code>byte[4..7]</code>ï¼‰æ˜¯ <code>&lt;zltail&gt;</code>ï¼Œç”¨å°ç«¯å­˜å‚¨æ¨¡å¼æ¥è§£é‡Šï¼Œå®ƒçš„å€¼æ˜¯ <code>0x0000001D</code>ï¼ˆå€¼ä¸º29ï¼‰ï¼Œè¡¨ç¤ºæœ€åä¸€ä¸ªæ•°æ®é¡¹åœ¨ <code>byte[29]</code> çš„ä½ç½®ï¼ˆé‚£ä¸ªæ•°æ®é¡¹ä¸º <code>0x05FE14</code>ï¼‰ã€‚</p>
</li>
<li>
<p>å†æ¥ä¸‹æ¥ 2 ä¸ªå­—èŠ‚ï¼ˆ<code>byte[8..9]</code>ï¼‰ï¼Œå€¼ä¸º <code>0x0004</code>ï¼Œè¡¨ç¤ºè¿™ä¸ª ziplist é‡Œä¸€å…±å­˜æœ‰4é¡¹æ•°æ®ã€‚</p>
</li>
<li>
<p>æ¥ä¸‹æ¥ 6 ä¸ªå­—èŠ‚ï¼ˆ<code>byte[10..15]</code>ï¼‰æ˜¯ç¬¬ 1 ä¸ªæ•°æ®é¡¹ã€‚å…¶ä¸­ï¼Œ<code>prevlen=0</code>ï¼Œå› ä¸ºå®ƒå‰é¢æ²¡æœ‰æ•°æ®é¡¹ï¼›<code>len=4</code>ï¼Œç›¸å½“äºå‰é¢å®šä¹‰çš„9ç§æƒ…å†µä¸­çš„ç¬¬1ç§ï¼Œè¡¨ç¤ºåé¢4ä¸ªå­—èŠ‚æŒ‰å­—ç¬¦ä¸²å­˜å‚¨æ•°æ®ï¼Œæ•°æ®çš„å€¼ä¸ºï¼š<code>name</code>ã€‚</p>
</li>
<li>
<p>æ¥ä¸‹æ¥ 8 ä¸ªå­—èŠ‚ï¼ˆ<code>byte[16..23]</code>ï¼‰æ˜¯ç¬¬ 2 ä¸ªæ•°æ®é¡¹ï¼Œä¸å‰é¢æ•°æ®é¡¹å­˜å‚¨æ ¼å¼ç±»ä¼¼ï¼Œå­˜å‚¨ 1 ä¸ªå­—ç¬¦ä¸²ï¼š<code>tielei</code>ã€‚</p>
</li>
<li>
<p>æ¥ä¸‹æ¥ 5 ä¸ªå­—èŠ‚ï¼ˆ<code>byte[24..28]</code>ï¼‰æ˜¯ç¬¬ 3 ä¸ªæ•°æ®é¡¹ï¼Œä¸å‰é¢æ•°æ®é¡¹å­˜å‚¨æ ¼å¼ç±»ä¼¼ï¼Œå­˜å‚¨ 1 ä¸ªå­—ç¬¦ä¸²ï¼š <code>age</code>ã€‚</p>
</li>
<li>
<p>æ¥ä¸‹æ¥3ä¸ªå­—èŠ‚ï¼ˆ<code>byte[29..31]</code>ï¼‰æ˜¯æœ€åä¸€ä¸ªæ•°æ®é¡¹ï¼Œå®ƒçš„æ ¼å¼ä¸å‰é¢çš„æ•°æ®é¡¹å­˜å‚¨æ ¼å¼ä¸å¤ªä¸€æ ·ã€‚å…¶ä¸­ï¼Œç¬¬ 1 ä¸ªå­—èŠ‚ <code>prevlen=5</code>ï¼Œè¡¨ç¤ºå‰ä¸€ä¸ªæ•°æ®é¡¹å ç”¨ 5 ä¸ªå­—èŠ‚ï¼›ç¬¬ 2 ä¸ªå­—èŠ‚ = <code>FE</code>ï¼Œç›¸å½“äºå‰é¢å®šä¹‰çš„9ç§æƒ…å†µä¸­çš„ç¬¬8ç§ï¼Œæ‰€ä»¥åé¢è¿˜æœ‰1ä¸ªå­—èŠ‚ç”¨æ¥è¡¨ç¤ºçœŸæ­£çš„æ•°æ®ï¼Œå¹¶ä¸”ä»¥æ•´æ•°è¡¨ç¤ºã€‚å®ƒçš„å€¼æ˜¯20ï¼ˆ0x14ï¼‰ã€‚</p>
</li>
<li>
<p>æœ€å1ä¸ªå­—èŠ‚ï¼ˆ<code>byte[32]</code>ï¼‰è¡¨ç¤º <code>&lt;zlend&gt;</code>ï¼Œæ˜¯å›ºå®šçš„å€¼255ï¼ˆ0xFFï¼‰ã€‚</p>
</li>
</ol>
</div>
<div class="sidebarblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>å¦‚ä½•åå‘è®¿é—® ziplist ï¼Ÿ</p>
</li>
<li>
<p>å¦‚ä½•ä» ziplist ä¸­åˆ é™¤æ•°æ®ï¼Ÿåˆ é™¤æ•°æ®åï¼Œå¯¹åº”ä½ç½®çš„ Bits ä½æ€ä¹ˆå¤„ç†ï¼Ÿ</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>Redis åœ¨ä¸‹é¢è¿™ä¸ªå‡ ä¸ªåœ°æ–¹ä½¿ç”¨äº† ziplistï¼š</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>åˆ—è¡¨é”®å€¼åŒ…å«å°‘äº†çš„åˆ—è¡¨é¡¹ï¼Œå¹¶ä¸”åˆ—è¡¨é¡¹åªæ˜¯æ•´æ•°æˆ–è€…çŸ­å°çš„å­—ç¬¦ä¸²æ—¶ã€‚ï¼ˆåœ¨æœ€æ–°ç‰ˆ Redis ä¸­æµ‹è¯•ï¼Œä½¿ç”¨çš„æ˜¯ quicklistï¼‰</p>
</li>
<li>
<p>åœ¨å“ˆå¸Œé”®å€¼åŒ…å«å°‘é‡é”®å€¼å¯¹ï¼Œå¹¶ä¸”æ¯ä¸ªé”®å€¼å¯¹åªåŒ…å«æ•´æ•°æˆ–çŸ­å°å­—ç¬¦ä¸²æ—¶ã€‚</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_redis_ä¸­çš„_quicklist"><a class="anchor" href="#_redis_ä¸­çš„_quicklist"></a>9.7. Redis ä¸­çš„ quicklist</h3>
<div class="paragraph">
<p>Redis å¯¹å¤–æš´éœ²çš„ list æ•°æ®ç±»å‹ï¼Œå®ƒåº•å±‚å®ç°æ‰€ä¾èµ–çš„å†…éƒ¨æ•°æ®ç»“æ„å°±æ˜¯ quicklistã€‚</p>
</div>
<div class="paragraph">
<p>list æ˜¯ä¸€ä¸ªèƒ½ç»´æŒæ•°æ®é¡¹å…ˆåé¡ºåºçš„åˆ—è¡¨ï¼ˆå„ä¸ªæ•°æ®é¡¹çš„å…ˆåé¡ºåºç”±æ’å…¥ä½ç½®å†³å®šï¼‰ï¼Œä¾¿äºåœ¨è¡¨çš„ä¸¤ç«¯è¿½åŠ å’Œåˆ é™¤æ•°æ®ï¼Œè€Œå¯¹äºä¸­é—´ä½ç½®çš„å­˜å–å…·æœ‰ O(N) çš„æ—¶é—´å¤æ‚åº¦ã€‚</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>quicklist.c - A doubly linked list of ziplists</p>
</div>
</blockquote>
<div class="attribution">
&#8212; redis/quicklist.c
</div>
</div>
<div class="paragraph">
<p>Redis åœ¨ <code>quicklist.c</code> å°±è¯´æ˜äº†ï¼Œquicklist æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œè€Œä¸”æ˜¯ä¸€ä¸ª ziplist çš„åŒå‘é“¾è¡¨ã€‚quicklist çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ª ziplistã€‚è¿™æ ·è®¾è®¡å¤§æ¦‚åˆæ˜¯ä¸€ä¸ªç©ºé—´å’Œæ—¶é—´çš„æŠ˜ä¸­ï¼š</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>åŒå‘é“¾è¡¨ä¾¿äºåœ¨è¡¨çš„ä¸¤ç«¯è¿›è¡Œ <code>push</code> å’Œ <code>pop</code> æ“ä½œï¼Œä½†æ˜¯å®ƒçš„å†…å­˜å¼€é”€æ¯”è¾ƒå¤§ã€‚é¦–å…ˆï¼Œå®ƒåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šé™¤äº†è¦ä¿å­˜æ•°æ®ä¹‹å¤–ï¼Œè¿˜è¦é¢å¤–ä¿å­˜ä¸¤ä¸ªæŒ‡é’ˆï¼›å…¶æ¬¡ï¼ŒåŒå‘é“¾è¡¨çš„å„ä¸ªèŠ‚ç‚¹æ˜¯å•ç‹¬çš„å†…å­˜å—ï¼Œåœ°å€ä¸è¿ç»­ï¼ŒèŠ‚ç‚¹å¤šäº†å®¹æ˜“äº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚</p>
</li>
<li>
<p>ziplist ç”±äºæ˜¯ä¸€æ•´å—è¿ç»­å†…å­˜ï¼Œæ‰€ä»¥å­˜å‚¨æ•ˆç‡å¾ˆé«˜ã€‚ä½†æ˜¯ï¼Œå®ƒä¸åˆ©äºä¿®æ”¹æ“ä½œï¼Œæ¯æ¬¡æ•°æ®å˜åŠ¨éƒ½ä¼šå¼•å‘ä¸€æ¬¡å†…å­˜çš„`realloc`ã€‚ç‰¹åˆ«æ˜¯å½“ ziplist é•¿åº¦å¾ˆé•¿çš„æ—¶å€™ï¼Œä¸€æ¬¡ realloc å¯èƒ½ä¼šå¯¼è‡´å¤§æ‰¹é‡çš„æ•°æ®æ‹·è´ï¼Œè¿›ä¸€æ­¥é™ä½æ€§èƒ½ã€‚</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>äºæ˜¯ï¼Œç»“åˆäº†åŒå‘é“¾è¡¨å’Œ ziplist çš„ä¼˜ç‚¹ï¼Œquicklist å°±åº”è¿è€Œç”Ÿäº†ã€‚</p>
</div>
<div class="paragraph">
<p>æ–°é—®é¢˜ï¼šåˆ°åº•ä¸€ä¸ª quicklist èŠ‚ç‚¹åŒ…å«å¤šé•¿çš„ ziplist åˆé€‚å‘¢ï¼Ÿ</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>æ¯ä¸ªquicklistèŠ‚ç‚¹ä¸Šçš„ziplistè¶ŠçŸ­ï¼Œåˆ™å†…å­˜ç¢ç‰‡è¶Šå¤šã€‚</p>
</li>
<li>
<p>æ¯ä¸ªquicklistèŠ‚ç‚¹ä¸Šçš„ziplistè¶Šé•¿ï¼Œåˆ™ä¸ºzipliståˆ†é…å¤§å—è¿ç»­å†…å­˜ç©ºé—´çš„éš¾åº¦å°±è¶Šå¤§ã€‚</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Redis æä¾›äº†ä¸€ä¸ªé…ç½®å‚æ•° <code>list-max-ziplist-size</code> è®©ä½¿ç”¨è€…å¯ä»¥æ¥æ ¹æ®è‡ªå·±çš„æƒ…å†µè¿›è¡Œè°ƒæ•´:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>list-max-ziplist-size -2</code></pre>
</div>
</div>
<div class="paragraph">
<p>è¿™ä¸ªå‚æ•°å¯æ­£å¯è´Ÿï¼š</p>
</div>
<div class="ulist">
<ul>
<li>
<p>å½“å–æ­£å€¼çš„æ—¶å€™ï¼Œè¡¨ç¤ºæŒ‰ç…§æ•°æ®é¡¹ä¸ªæ•°æ¥é™å®šæ¯ä¸ª quicklist èŠ‚ç‚¹ä¸Šçš„ ziplist é•¿åº¦ã€‚</p>
</li>
<li>
<p>å½“å–è´Ÿå€¼çš„æ—¶å€™ï¼Œè¡¨ç¤ºæŒ‰ç…§å ç”¨å­—èŠ‚æ•°æ¥é™å®šæ¯ä¸ª quicklist èŠ‚ç‚¹ä¸Šçš„ ziplist é•¿åº¦ã€‚è¿™æ—¶ï¼Œå®ƒåªèƒ½å– <code>-1</code> åˆ° <code>-5</code> è¿™äº”ä¸ªå€¼ï¼Œæ¯ä¸ªå€¼å«ä¹‰å¦‚ä¸‹ï¼š</p>
<div class="ulist">
<ul>
<li>
<p><code>-5</code>: æ¯ä¸ª quicklist èŠ‚ç‚¹ä¸Šçš„ ziplist å¤§å°ä¸èƒ½è¶…è¿‡ 64 Kbã€‚ï¼ˆæ³¨ï¼š1kb &#8658; 1024 bytesï¼‰</p>
</li>
<li>
<p><code>-4</code>: æ¯ä¸ª quicklist èŠ‚ç‚¹ä¸Šçš„ ziplist å¤§å°ä¸èƒ½è¶…è¿‡ 32 Kbã€‚</p>
</li>
<li>
<p><code>-3</code>: æ¯ä¸ª quicklist èŠ‚ç‚¹ä¸Šçš„ ziplist å¤§å°ä¸èƒ½è¶…è¿‡ 16 Kbã€‚</p>
</li>
<li>
<p><code>-2</code>: æ¯ä¸ª quicklist èŠ‚ç‚¹ä¸Šçš„ ziplist å¤§å°ä¸èƒ½è¶…è¿‡ 8 Kbã€‚ï¼ˆ-2æ˜¯Redisç»™å‡ºçš„é»˜è®¤å€¼ï¼‰</p>
</li>
<li>
<p><code>-1</code>: æ¯ä¸ª quicklist èŠ‚ç‚¹ä¸Šçš„ ziplist å¤§å°ä¸èƒ½è¶…è¿‡ 4 Kbã€‚</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>listçš„è®¾è®¡ç›®æ ‡æ˜¯èƒ½å¤Ÿç”¨æ¥å­˜å‚¨å¾ˆé•¿çš„æ•°æ®åˆ—è¡¨çš„ã€‚å½“åˆ—è¡¨å¾ˆé•¿çš„æ—¶å€™ï¼Œæœ€å®¹æ˜“è¢«è®¿é—®çš„å¾ˆå¯èƒ½æ˜¯ä¸¤ç«¯çš„æ•°æ®ï¼Œä¸­é—´çš„æ•°æ®è¢«è®¿é—®çš„é¢‘ç‡æ¯”è¾ƒä½ã€‚list è¿˜æä¾›äº†ä¸€ä¸ªé€‰é¡¹ï¼Œèƒ½å¤ŸæŠŠä¸­é—´çš„æ•°æ®èŠ‚ç‚¹è¿›è¡Œå‹ç¼©ï¼Œä»è€Œè¿›ä¸€æ­¥èŠ‚çœå†…å­˜ç©ºé—´ã€‚Redis çš„é…ç½®å‚æ•° <code>list-compress-depth</code> å°±æ˜¯ç”¨æ¥å®Œæˆè¿™ä¸ªè®¾ç½®çš„ã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>list-compress-depth 0 // 0 æ˜¯ç‰¹æ®Šå€¼ï¼Œè¡¨ç¤ºéƒ½ä¸å‹ç¼©ï¼Œé»˜è®¤å€¼ã€‚</code></pre>
</div>
</div>
<div class="paragraph">
<p>è¿™ä¸ªå‚æ•°è¡¨ç¤ºä¸€ä¸ªquicklistä¸¤ç«¯ä¸è¢«å‹ç¼©çš„èŠ‚ç‚¹ä¸ªæ•°ã€‚æ³¨ï¼šè¿™é‡Œçš„èŠ‚ç‚¹ä¸ªæ•°æ˜¯æŒ‡quickliståŒå‘é“¾è¡¨çš„èŠ‚ç‚¹ä¸ªæ•°ï¼Œè€Œä¸æ˜¯æŒ‡ziplisté‡Œé¢çš„æ•°æ®é¡¹ä¸ªæ•°ã€‚ä¸€ä¸ª quicklist èŠ‚ç‚¹ä¸Šçš„ ziplistï¼Œå¦‚æœè¢«å‹ç¼©ï¼Œå°±æ˜¯æ•´ä½“è¢«å‹ç¼©çš„ã€‚</p>
</div>
<div class="paragraph">
<p>Redis å¯¹äº quicklist å†…éƒ¨èŠ‚ç‚¹çš„å‹ç¼©ç®—æ³•ï¼Œé‡‡ç”¨çš„ <a href="https://en.wikipedia.org/wiki/LZ4_(compression_algorithm)">LZF</a> â€”â€”ä¸€ç§æ— æŸå‹ç¼©ç®—æ³•ã€‚</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>æ·»åŠ è¿‡ç¨‹ä¸­ï¼Œå¦‚ä½•å¤„ç†ä¸­é—´ä½ç½®çš„å‹ç¼©å·¥ä½œï¼Ÿ</p>
</li>
<li>
<p>å¤´éƒ¨æˆ–è€…å°¾éƒ¨åˆ é™¤ï¼Œå¯¼è‡´ quicklistNode çš„éå‹ç¼©èŠ‚ç‚¹ä¸ç¬¦åˆè®¾ç½®ï¼Œæ€ä¹ˆå¤„ç†ï¼Ÿ</p>
</li>
<li>
<p>å¦‚æœä¸­é—´åˆ é™¤ï¼ŒèŠ‚ç‚¹ä¸ºå‹ç¼©èŠ‚ç‚¹ï¼Œæ€ä¹ˆå¤„ç†ï¼Ÿ</p>
</li>
</ol>
</div>
</div>
</div>
<div class="listingblock">
<div class="title">quicklist.h</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
</pre></td><td class="code"><pre><span class="cm">/* Node, quicklist, and Iterator are the only data structures used currently. */</span>

<span class="cm">/* quicklistNode is a 32 byte struct describing a ziplist for a quicklist.
 * We use bit fields keep the quicklistNode at 32 bytes.
 * count: 16 bits, max 65536 (max zl bytes is 65k, so max count actually &lt; 32k).
 * encoding: 2 bits, RAW=1, LZF=2.
 * container: 2 bits, NONE=1, ZIPLIST=2.
 * recompress: 1 bit, bool, true if node is temporarry decompressed for usage.
 * attempted_compress: 1 bit, boolean, used for verifying during testing.
 * extra: 10 bits, free for future use; pads out the remainder of 32 bits */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">quicklistNode</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">quicklistNode</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">quicklistNode</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zl</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sz</span><span class="p">;</span>             <span class="cm">/* ziplist size in bytes */</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">:</span> <span class="mi">16</span><span class="p">;</span>     <span class="cm">/* count of items in ziplist */</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">encoding</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>   <span class="cm">/* RAW==1 or LZF==2 */</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">container</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>  <span class="cm">/* NONE==1 or ZIPLIST==2 */</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">recompress</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* was this node previous compressed? */</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">attempted_compress</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* node can't compress; too small */</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">extra</span> <span class="o">:</span> <span class="mi">10</span><span class="p">;</span> <span class="cm">/* more bits to steal for future usage */</span>
<span class="p">}</span> <span class="n">quicklistNode</span><span class="p">;</span>

<span class="cm">/* quicklistLZF is a 4+N byte struct holding 'sz' followed by 'compressed'.
 * 'sz' is byte length of 'compressed' field.
 * 'compressed' is LZF data with total (compressed) length 'sz'
 * NOTE: uncompressed length is stored in quicklistNode-&gt;sz.
 * When quicklistNode-&gt;zl is compressed, node-&gt;zl points to a quicklistLZF */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">quicklistLZF</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sz</span><span class="p">;</span> <span class="cm">/* LZF size in bytes*/</span>
    <span class="kt">char</span> <span class="n">compressed</span><span class="p">[];</span>
<span class="p">}</span> <span class="n">quicklistLZF</span><span class="p">;</span>

<span class="cm">/* Bookmarks are padded with realloc at the end of of the quicklist struct.
 * They should only be used for very big lists if thousands of nodes were the
 * excess memory usage is negligible, and there's a real need to iterate on them
 * in portions.
 * When not used, they don't add any memory overhead, but when used and then
 * deleted, some overhead remains (to avoid resonance).
 * The number of bookmarks used should be kept to minimum since it also adds
 * overhead on node deletion (searching for a bookmark to update). */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">quicklistBookmark</span> <span class="p">{</span>
    <span class="n">quicklistNode</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">}</span> <span class="n">quicklistBookmark</span><span class="p">;</span>

<span class="cm">/* quicklist is a 40 byte struct (on 64-bit systems) describing a quicklist.
 * 'count' is the number of total entries.
 * 'len' is the number of quicklist nodes.
 * 'compress' is: -1 if compression disabled, otherwise it's the number
 *                of quicklistNodes to leave uncompressed at ends of quicklist.
 * 'fill' is the user-requested (or default) fill factor.
 * 'bookmakrs are an optional feature that is used by realloc this struct,
 *      so that they don't consume memory when not used. */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">quicklist</span> <span class="p">{</span>
    <span class="n">quicklistNode</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
    <span class="n">quicklistNode</span> <span class="o">*</span><span class="n">tail</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span><span class="p">;</span>        <span class="cm">/* total count of all entries in all ziplists */</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">;</span>          <span class="cm">/* number of quicklistNodes */</span>
    <span class="kt">int</span> <span class="n">fill</span> <span class="o">:</span> <span class="n">QL_FILL_BITS</span><span class="p">;</span>              <span class="cm">/* fill factor for individual nodes */</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">compress</span> <span class="o">:</span> <span class="n">QL_COMP_BITS</span><span class="p">;</span> <span class="cm">/* depth of end nodes not to compress;0=off */</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bookmark_count</span><span class="o">:</span> <span class="n">QL_BM_BITS</span><span class="p">;</span>
    <span class="n">quicklistBookmark</span> <span class="n">bookmarks</span><span class="p">[];</span>
<span class="p">}</span> <span class="n">quicklist</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">quicklistIter</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">quicklist</span> <span class="o">*</span><span class="n">quicklist</span><span class="p">;</span>
    <span class="n">quicklistNode</span> <span class="o">*</span><span class="n">current</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zi</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span> <span class="cm">/* offset in current ziplist */</span>
    <span class="kt">int</span> <span class="n">direction</span><span class="p">;</span>
<span class="p">}</span> <span class="n">quicklistIter</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">quicklistEntry</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">quicklist</span> <span class="o">*</span><span class="n">quicklist</span><span class="p">;</span>
    <span class="n">quicklistNode</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zi</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">;</span>
    <span class="kt">long</span> <span class="kt">long</span> <span class="n">longval</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sz</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span> <span class="n">quicklistEntry</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/redis-quicklist-structure.png" alt="redis quicklist structure">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre>127.0.0.1:6379&gt; rpush numbers 1 3 5
<span class="o">(</span>integer<span class="o">)</span> 3
127.0.0.1:6379&gt; <span class="nb">type </span>numbers
list
127.0.0.1:6379&gt; OBJECT encoding numbers
<span class="s2">"quicklist"</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_å‚è€ƒèµ„æ–™_3"><a class="anchor" href="#_å‚è€ƒèµ„æ–™_3"></a>9.8. å‚è€ƒèµ„æ–™</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://zhangtielei.com/posts/blog-redis-ziplist.html">Rediså†…éƒ¨æ•°æ®ç»“æ„è¯¦è§£(4)â€”â€”ziplist</a></p>
</li>
<li>
<p><a href="http://zhangtielei.com/posts/blog-redis-quicklist.html">Rediså†…éƒ¨æ•°æ®ç»“æ„è¯¦è§£(5)â€”â€”quicklist</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>ArrayListæ›´é€‚åˆéšæœºè®¿é—®ï¼Œè€ŒLinkedListæ›´é€‚åˆæ’å…¥å’Œåˆ é™¤ã€‚</p>
</div>
<div class="ulist">
<ul>
<li>
<p>å¯¹add(E e)æ–¹æ³•çš„åˆ†æï¼Œå¯ä»¥å¾—çŸ¥LinkedListæ·»åŠ æ•°æ®çš„æ•ˆç‡é«˜ï¼›</p>
</li>
<li>
<p>å¯¹remove(int index)æ–¹æ³•çš„åˆ†æï¼Œå¯ä»¥äº†è§£åˆ°LinkedListåˆ é™¤æ•°æ®çš„æ•ˆç‡é«˜ï¼›</p>
</li>
<li>
<p>å¯¹get(int index),set(int index, E element)æ–¹æ³•çš„åˆ†æï¼Œå¯ä»¥çœ‹å‡ºLinkdedListæŸ¥è¯¢çš„æ•ˆç‡ä¸é«˜ï¼ˆéœ€è¦å®šä½ï¼Œæœ€å·®è¦éå†ä¸€åŠï¼‰ï¼›</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>æ ¸å¿ƒæ•°æ®ç»“æ„é€šè¿‡å†…éƒ¨ç±»ä½“ç°ï¼ŒNodeå°±æ˜¯å®é™…çš„ç»“ç‚¹ï¼Œå­˜æ”¾äº†ç»“ç‚¹å…ƒç´ å’Œå‰åç»“ç‚¹çš„å¼•ç”¨ã€‚</p>
</div>
<div class="paragraph">
<p>åœ¨1.7ä¹‹å‰LinkedListæ˜¯é€šè¿‡headerEntryå®ç°çš„ä¸€ä¸ªé¦–å°¾ç›¸è¿çš„å¾ªç¯é“¾è¡¨çš„ã€‚<br>
ä»1.7å¼€å§‹ï¼ŒLinkedListæ˜¯ä¸€ä¸ªNodeå®ç°çš„éå¾ªç¯é“¾è¡¨ã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="no">E</span> <span class="n">item</span><span class="o">;</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">;</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">prev</span><span class="o">;</span>

    <span class="nc">Node</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">prev</span><span class="o">,</span> <span class="no">E</span> <span class="n">element</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">item</span> <span class="o">=</span> <span class="n">element</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">prev</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>ä»£ç å¼€å§‹</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">java.util</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.function.Consumer</span><span class="o">;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ç±»çš„ç»§æ‰¿å…³ç³»"><a class="anchor" href="#_ç±»çš„ç»§æ‰¿å…³ç³»"></a>9.9. ç±»çš„ç»§æ‰¿å…³ç³»</h3>
<div class="imageblock">
<div class="content">
<img src="./images/DiagramForLinkedList.png" alt="DiagramForLinkedList">
</div>
</div>
<div class="paragraph">
<p>ç»§æ‰¿è‡ªAbstractSequentialListï¼Œä¸€ä¸ªLinkedListæŠ½è±¡çš„å®ç°ï¼›
é‡ç‚¹å…³æ³¨å®ç°äº†Dequeæ¥å£ã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LinkedList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span>
    <span class="kd">extends</span> <span class="nc">AbstractSequentialList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span>
    <span class="kd">implements</span> <span class="nc">List</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;,</span> <span class="nc">Deque</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;,</span> <span class="nc">Cloneable</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">Serializable</span>
<span class="o">{</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ç±»çš„å±æ€§"><a class="anchor" href="#_ç±»çš„å±æ€§"></a>9.10. ç±»çš„å±æ€§</h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">    <span class="c1">//å­˜å‚¨å…ƒç´ ä¸ªæ•°</span>
    <span class="kd">transient</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

    <span class="c1">//å­˜å‚¨å¤´ç»“ç‚¹</span>
    <span class="kd">transient</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">first</span><span class="o">;</span>

    <span class="c1">//å­˜å‚¨å°¾ç»“ç‚¹</span>
    <span class="kd">transient</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">last</span><span class="o">;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ç±»çš„æ„é€ å™¨"><a class="anchor" href="#_ç±»çš„æ„é€ å™¨"></a>9.11. ç±»çš„æ„é€ å™¨</h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">    <span class="c1">//æ— å‚æ„é€ å™¨</span>
    <span class="kd">public</span> <span class="nf">LinkedList</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="c1">//é€šè¿‡ä¸€ä¸ªé›†åˆåˆå§‹åŒ–LinkedListï¼Œå…ƒç´ é¡ºåºç”±è¿™ä¸ªé›†åˆçš„è¿­ä»£å™¨è¿”å›é¡ºåºå†³å®š</span>
    <span class="kd">public</span> <span class="nf">LinkedList</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//è°ƒç”¨æ— å‚æ„é€ å™¨</span>
        <span class="k">this</span><span class="o">();</span>
        <span class="c1">//æ·»åŠ å…ƒç´ </span>
        <span class="n">addAll</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
    <span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ç±»çš„æ–¹æ³•"><a class="anchor" href="#_ç±»çš„æ–¹æ³•"></a>9.12. ç±»çš„æ–¹æ³•</h3>
<div class="paragraph">
<p>ä¸»è¦çš„æ–¹æ³•çš„åŸºç¡€æ˜¯linkå’Œunlinkæ–¹æ³•ç»„,Node&lt;E&gt; node(int index)å®šä½æ–¹æ³•ï¼ˆå‡ä¸æ˜¯publicï¼‰</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/linkedlistæ’å…¥æ–°ç»“ç‚¹.png" alt="linkedlistæ’å…¥æ–°ç»“ç‚¹">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">    <span class="c1">//åœ¨æŒ‡å®šèŠ‚ç‚¹å‰æ’å…¥èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹succä¸èƒ½ä¸ºç©º</span>
    <span class="kt">void</span> <span class="nf">linkBefore</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">succ</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//è·å–succçš„å‰ç»“ç‚¹</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">succ</span><span class="o">.</span><span class="na">prev</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">newNode</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;&gt;(</span><span class="n">pred</span><span class="o">,</span> <span class="n">e</span><span class="o">,</span> <span class="n">succ</span><span class="o">);</span>
        <span class="n">succ</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">pred</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span><span class="c1">//å¦‚æœå‰ç»“ç‚¹ä¸ºç©º</span>
            <span class="n">first</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
        <span class="k">else</span>
            <span class="n">pred</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
        <span class="n">size</span><span class="o">++;</span>
        <span class="n">modCount</span><span class="o">++;</span>
    <span class="o">}</span>
    <span class="c1">//æŠŠå¯¹åº”å‚æ•°ä½œä¸ºç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå†…éƒ¨ä½¿ç”¨</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">linkFirst</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//è·å–å¤´ç»“ç‚¹</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
        <span class="c1">//å®šä¹‰æ–°ç»“ç‚¹</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">newNode</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;&gt;(</span><span class="kc">null</span><span class="o">,</span> <span class="n">e</span><span class="o">,</span> <span class="n">f</span><span class="o">);</span>
        <span class="n">first</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span><span class="c1">//å¤´ç»“ç‚¹ä¸ºnull</span>
            <span class="c1">// èµ‹å€¼å°¾ç»“ç‚¹ï¼ˆç»“æœåªæœ‰ä¸€ä¸ªå…ƒç´ ï¼‰</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
        <span class="k">else</span>
            <span class="c1">//æŠŠåŸæ¥çš„é¦–ç»“ç‚¹çš„å¼•ç”¨æŒ‡å‘è¿™ä¸ªæ–°åŠ çš„ç»“ç‚¹</span>
            <span class="n">f</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
        <span class="n">size</span><span class="o">++;</span>
        <span class="n">modCount</span><span class="o">++;</span>
        <span class="c1">//LinkedListä¹Ÿé‡‡ç”¨äº†â€œå¿«é€Ÿå¤±è´¥â€çš„æœºåˆ¶ï¼Œé€šè¿‡è®°å½•modCountå‚æ•°æ¥å®ç°ã€‚åœ¨é¢å¯¹å¹¶å‘çš„ä¿®æ”¹æ—¶ï¼Œ</span>
        <span class="c1">//è¿­ä»£å™¨å¾ˆå¿«å°±ä¼šå®Œå…¨å¤±è´¥ï¼Œè€Œä¸æ˜¯å†’ç€åœ¨å°†æ¥æŸä¸ªä¸ç¡®å®šæ—¶é—´å‘ç”Ÿä»»æ„ä¸ç¡®å®šè¡Œä¸ºçš„é£é™©ã€‚</span>

    <span class="o">}</span>

    <span class="c1">//æŠŠå¯¹åº”å‚æ•°ä½œä¸ºå°¾èŠ‚ç‚¹ï¼ˆå’Œå‰ä¸€ä¸ªæ–¹æ³•ç±»ä¼¼ï¼‰</span>
    <span class="kt">void</span> <span class="nf">linkLast</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// è·å–å°¾ç»“ç‚¹ï¼Œlä¸ºfinalç±»å‹ï¼Œä¸å¯æ›´æ”¹</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="n">last</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">newNode</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;&gt;(</span><span class="n">l</span><span class="o">,</span> <span class="n">e</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">l</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="n">first</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
        <span class="k">else</span>
            <span class="n">l</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
        <span class="n">size</span><span class="o">++;</span>
        <span class="n">modCount</span><span class="o">++;</span>
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/linkedliståˆ é™¤æŒ‡å®šçš„ç»“ç‚¹.png" alt="linkedliståˆ é™¤æŒ‡å®šçš„ç»“ç‚¹">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">      <span class="c1">//åˆ é™¤æŒ‡å®šèŠ‚ç‚¹å¹¶è¿”å›è¢«åˆ é™¤çš„å…ƒç´ å€¼</span>
      <span class="no">E</span> <span class="nf">unlink</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">// assert x != null;</span>
          <span class="kd">final</span> <span class="no">E</span> <span class="n">element</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
          <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">next</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
          <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">prev</span><span class="o">;</span>

          <span class="k">if</span> <span class="o">(</span><span class="n">prev</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">first</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
              <span class="n">prev</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
              <span class="n">x</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
          <span class="o">}</span>

          <span class="k">if</span> <span class="o">(</span><span class="n">next</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">last</span> <span class="o">=</span> <span class="n">prev</span><span class="o">;</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
              <span class="n">next</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">prev</span><span class="o">;</span>
              <span class="n">x</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
          <span class="o">}</span>

          <span class="n">x</span><span class="o">.</span><span class="na">item</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
          <span class="n">size</span><span class="o">--;</span>
          <span class="n">modCount</span><span class="o">++;</span>
          <span class="k">return</span> <span class="n">element</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="c1">//åˆ é™¤é¦–èŠ‚ç‚¹å¹¶è¿”å›åˆ é™¤å‰é¦–èŠ‚ç‚¹çš„å€¼ï¼Œå†…éƒ¨ä½¿ç”¨</span>
    <span class="kd">private</span> <span class="no">E</span> <span class="nf">unlinkFirst</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// assert f == first &amp;&amp; f != null;</span>
        <span class="kd">final</span> <span class="no">E</span> <span class="n">element</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">next</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
        <span class="n">f</span><span class="o">.</span><span class="na">item</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">f</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// help GC</span>
        <span class="n">first</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">next</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="n">last</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">else</span>
            <span class="n">next</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">size</span><span class="o">--;</span>
        <span class="n">modCount</span><span class="o">++;</span>
        <span class="k">return</span> <span class="n">element</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//åˆ é™¤å°¾èŠ‚ç‚¹å¹¶è¿”å›åˆ é™¤å‰å°¾èŠ‚ç‚¹çš„å€¼ï¼Œå†…éƒ¨ä½¿ç”¨</span>
    <span class="kd">private</span> <span class="no">E</span> <span class="nf">unlinkLast</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">l</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// assert l == last &amp;&amp; l != null;</span>
        <span class="kd">final</span> <span class="no">E</span> <span class="n">element</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="na">prev</span><span class="o">;</span>
        <span class="n">l</span><span class="o">.</span><span class="na">item</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">l</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// help GC</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">prev</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">prev</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="n">first</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">else</span>
            <span class="n">prev</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">size</span><span class="o">--;</span>
        <span class="n">modCount</span><span class="o">++;</span>
        <span class="k">return</span> <span class="n">element</span><span class="o">;</span>
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="c1">//è·å–ç¬¬ä¸€ä¸ªå…ƒç´ </span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">getFirst</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
    <span class="o">}</span>
<span class="c1">//è·å–æœ€åä¸€ä¸ªå…ƒç´ </span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">getLast</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="n">last</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">l</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
    <span class="o">}</span>

<span class="c1">//åˆ é™¤ç¬¬ä¸€ä¸ªå…ƒç´ å¹¶è¿”å›åˆ é™¤çš„å…ƒç´ </span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">removeFirst</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>
        <span class="k">return</span> <span class="nf">unlinkFirst</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
    <span class="o">}</span>
<span class="c1">//åˆ é™¤æœ€åä¸€ä¸ªå…ƒç´ å¹¶è¿”å›åˆ é™¤çš„å€¼</span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">removeLast</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="n">last</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">l</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>
        <span class="k">return</span> <span class="nf">unlinkLast</span><span class="o">(</span><span class="n">l</span><span class="o">);</span>
    <span class="o">}</span>
<span class="c1">//æ·»åŠ å…ƒç´ ä½œä¸ºç¬¬ä¸€ä¸ªå…ƒç´ </span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addFirst</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">linkFirst</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
 <span class="c1">//æ·»åŠ å…ƒç´ ä½œä¸ºæœ€åä¸€ä¸ªå…ƒç´ </span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addLast</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">linkLast</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
 <span class="c1">//æ£€æŸ¥æ˜¯å¦åŒ…å«æŸä¸ªå…ƒç´ ï¼Œè¿”å›bool</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">contains</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">indexOf</span><span class="o">(</span><span class="n">o</span><span class="o">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>
<span class="c1">//è¿”å›åˆ—è¡¨é•¿åº¦</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">size</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">size</span><span class="o">;</span>
    <span class="o">}</span>
<span class="c1">//æ·»åŠ ä¸€ä¸ªå…ƒç´ ï¼Œé»˜è®¤æ·»åŠ åˆ°æœ«å°¾ä½œä¸ºæœ€åä¸€ä¸ªå…ƒç´ </span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">add</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">linkLast</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="c1">//åˆ é™¤æŒ‡å®šå…ƒç´ ï¼Œé»˜è®¤ä»firstèŠ‚ç‚¹å¼€å§‹ï¼Œåˆ é™¤ç¬¬ä¸€æ¬¡å‡ºç°çš„é‚£ä¸ªå…ƒç´ ï¼ˆéœ€è¦è¿­ä»£ï¼‰</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">remove</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">item</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">unlink</span><span class="o">(</span><span class="n">x</span><span class="o">);</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">item</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">unlink</span><span class="o">(</span><span class="n">x</span><span class="o">);</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//æ·»åŠ æŒ‡å®šé›†åˆçš„å…ƒç´ åˆ°åˆ—è¡¨ï¼Œä»æœ€åå¼€å§‹æ·»åŠ </span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">addAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//è°ƒç”¨addAll(int index, Collection&lt;? extends E&gt; c)</span>
        <span class="k">return</span> <span class="nf">addAll</span><span class="o">(</span><span class="n">size</span><span class="o">,</span> <span class="n">c</span><span class="o">);</span>
    <span class="o">}</span>
   <span class="c1">//ä»æŒ‡å®šä½ç½®å¾€åè¿½åŠ ï¼Œindexå’Œä¹‹åçš„å…ƒç´ å‘åé¡ºå»¶</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">addAll</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">checkPositionIndex</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
        <span class="c1">//è½¬åŒ–æˆæ•°ç»„</span>
        <span class="nc">Object</span><span class="o">[]</span> <span class="n">a</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">toArray</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">numNew</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">numNew</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>

        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">pred</span><span class="o">,</span> <span class="n">succ</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">succ</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">last</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span><span class="c1">//å¦‚æœä¸æ˜¯ä»æœ«å°¾å¼€å§‹æ·»åŠ ï¼Œè·å–æ–°åŠ ä¸²çš„å‰åç»“ç‚¹</span>
            <span class="n">succ</span> <span class="o">=</span> <span class="n">node</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">succ</span><span class="o">.</span><span class="na">prev</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">//éå†æ•°ç»„å¹¶æ·»åŠ åˆ°åˆ—è¡¨ä¸­</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Object</span> <span class="n">o</span> <span class="o">:</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span>
            <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span> <span class="no">E</span> <span class="n">e</span> <span class="o">=</span> <span class="o">(</span><span class="no">E</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">newNode</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;&gt;(</span><span class="n">pred</span><span class="o">,</span> <span class="n">e</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">pred</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="n">first</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
            <span class="k">else</span>
                <span class="n">pred</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span><span class="c1">//å¦‚æœå­˜åœ¨å‰èŠ‚ç‚¹ï¼Œå‰èŠ‚ç‚¹ä¼šå‘åæŒ‡å‘æ–°åŠ çš„èŠ‚ç‚¹</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span><span class="c1">//æ–°åŠ çš„èŠ‚ç‚¹æˆä¸ºå‰ä¸€ä¸ªèŠ‚ç‚¹</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">succ</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">pred</span><span class="o">;</span><span class="c1">//å¦‚æœæ˜¯ä»æœ€åå¼€å§‹æ·»åŠ çš„ï¼Œåˆ™æœ€åæ·»åŠ çš„èŠ‚ç‚¹æˆä¸ºå°¾èŠ‚ç‚¹</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">pred</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">succ</span><span class="o">;</span><span class="c1">//å¦‚æœä¸æ˜¯ä»æœ€åå¼€å§‹æ·»åŠ çš„ï¼Œåˆ™æœ€åæ·»åŠ çš„èŠ‚ç‚¹å‘åæŒ‡å‘ä¹‹å‰å¾—åˆ°çš„åç»­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</span>
            <span class="n">succ</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">pred</span><span class="o">;</span><span class="c1">//åç»­çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¹Ÿåº”æ”¹ä¸ºå‘å‰æŒ‡å‘æœ€åä¸€ä¸ªæ·»åŠ çš„èŠ‚ç‚¹</span>
        <span class="o">}</span>

        <span class="n">size</span> <span class="o">+=</span> <span class="n">numNew</span><span class="o">;</span>
        <span class="n">modCount</span><span class="o">++;</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//æ¸…ç©ºè¡¨</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">clear</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//æ–¹ä¾¿gcå›æ”¶åƒåœ¾</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">next</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
            <span class="n">x</span><span class="o">.</span><span class="na">item</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">x</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">x</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">first</span> <span class="o">=</span> <span class="n">last</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">modCount</span><span class="o">++;</span>
    <span class="o">}</span>

    <span class="c1">//è·å–æŒ‡å®šç´¢å¼•çš„èŠ‚ç‚¹çš„å€¼</span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">get</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">checkElementIndex</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
        <span class="k">return</span> <span class="nf">node</span><span class="o">(</span><span class="n">index</span><span class="o">).</span><span class="na">item</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//ä¿®æ”¹æŒ‡å®šç´¢å¼•çš„å€¼å¹¶è¿”å›ä¹‹å‰çš„å€¼</span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">set</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="no">E</span> <span class="n">element</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">checkElementIndex</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">node</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
        <span class="no">E</span> <span class="n">oldVal</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
        <span class="c1">//åªæ˜¯æŠŠitemæ›¿æ¢æ‰</span>
        <span class="n">x</span><span class="o">.</span><span class="na">item</span> <span class="o">=</span> <span class="n">element</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">oldVal</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//åœ¨æŒ‡å®šä½ç½®åé¢æ·»åŠ å…ƒç´ </span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="no">E</span> <span class="n">element</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">checkPositionIndex</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">size</span><span class="o">)</span>
            <span class="n">linkLast</span><span class="o">(</span><span class="n">element</span><span class="o">);</span>
        <span class="k">else</span>
            <span class="nf">linkBefore</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="n">node</span><span class="o">(</span><span class="n">index</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="c1">//åˆ é™¤æŒ‡å®šä½ç½®çš„å…ƒç´ </span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">remove</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">checkElementIndex</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
        <span class="k">return</span> <span class="nf">unlink</span><span class="o">(</span><span class="n">node</span><span class="o">(</span><span class="n">index</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="c1">//æ£€æŸ¥ç´¢å¼•æ˜¯å¦è¶…å‡ºèŒƒå›´ï¼ˆcheckElementIndexè°ƒç”¨ï¼‰ï¼Œå› ä¸ºå…ƒç´ ç´¢å¼•æ˜¯0~size-1çš„ï¼Œæ‰€ä»¥indexå¿…é¡»æ»¡è¶³0&lt;=index&lt;size</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isElementIndex</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//æ£€æŸ¥ä½ç½®æ˜¯å¦è¶…å‡ºèŒƒå›´ï¼ˆcheckPositionIndexè°ƒç”¨ï¼‰ï¼Œindexå¿…é¡»åœ¨index~sizeä¹‹é—´ï¼ˆå«ï¼‰ï¼Œå¦‚æœè¶…å‡ºï¼Œè¿”å›false</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isPositionIndex</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">index</span> <span class="o">&lt;=</span> <span class="n">size</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//å¼‚å¸¸è¯¦æƒ…</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="nf">outOfBoundsMsg</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"Index: "</span><span class="o">+</span><span class="n">index</span><span class="o">+</span><span class="s">", Size: "</span><span class="o">+</span><span class="n">size</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//æ£€æŸ¥å…ƒç´ ç´¢å¼•æ˜¯å¦è¶…å‡ºèŒƒå›´ï¼ˆset,get,removeæ—¶æ£€æŸ¥ï¼‰ï¼Œè‹¥å·²è¶…å‡ºï¼Œå°±æŠ›å‡ºå¼‚å¸¸</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">checkElementIndex</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">isElementIndex</span><span class="o">(</span><span class="n">index</span><span class="o">))</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span><span class="n">outOfBoundsMsg</span><span class="o">(</span><span class="n">index</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="c1">//æ£€æŸ¥ä½ç½®æ˜¯å¦è¶…å‡ºèŒƒå›´ï¼ˆä¸ºæ·»åŠ å’Œè¿­ä»£æ£€æŸ¥ä½¿ç”¨ï¼‰ï¼Œè‹¥å·²è¶…å‡ºï¼Œå°±æŠ›å‡ºå¼‚å¸¸</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">checkPositionIndex</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">isPositionIndex</span><span class="o">(</span><span class="n">index</span><span class="o">))</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span><span class="n">outOfBoundsMsg</span><span class="o">(</span><span class="n">index</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="c1">//è·å–æŒ‡å®šä½ç½®çš„èŠ‚ç‚¹</span>
    <span class="c1">//è¯¥æ–¹æ³•è¿”å›åŒå‘é“¾è¡¨ä¸­æŒ‡å®šä½ç½®å¤„çš„èŠ‚ç‚¹ï¼Œè€Œé“¾è¡¨ä¸­æ˜¯æ²¡æœ‰ä¸‹æ ‡ç´¢å¼•çš„ï¼Œè¦æŒ‡å®šä½ç½®å‡ºçš„å…ƒç´ ï¼Œå°±è¦éå†è¯¥é“¾è¡¨ï¼Œä»æºç çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°è¿™é‡Œæœ‰ä¸€ä¸ªåŠ é€ŸåŠ¨ä½œã€‚</span>
    <span class="c1">//æºç ä¸­å…ˆå°†indexä¸é•¿åº¦sizeçš„ä¸€åŠæ¯”è¾ƒï¼Œå¦‚æœindex&lt;size/2ï¼Œå°±åªä»ä½ç½®0å¾€åéå†åˆ°ä½ç½®indexå¤„ï¼Œè€Œå¦‚æœindex&gt;size/2ï¼Œå°±åªä»ä½ç½®sizeå¾€å‰éå†åˆ°ä½ç½®indexå¤„ã€‚è¿™æ ·å¯ä»¥å‡å°‘ä¸€éƒ¨åˆ†ä¸å¿…è¦çš„éå†ã€‚</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">node</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// assert isElementIndex(index);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="o">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">index</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">last</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">index</span><span class="o">;</span> <span class="n">i</span><span class="o">--)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">prev</span><span class="o">;</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">//è·å–ç¬¬ä¸€ä¸ªæŒ‡å®šå…ƒç´ çš„ç´¢å¼•ä½ç½®å¹¶è¿”å›ç´¢å¼•ï¼Œä¸å­˜åœ¨å°±è¿”å›-1</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">indexOf</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">item</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="k">return</span> <span class="n">index</span><span class="o">;</span>
                <span class="n">index</span><span class="o">++;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">item</span><span class="o">))</span>
                    <span class="k">return</span> <span class="n">index</span><span class="o">;</span>
                <span class="n">index</span><span class="o">++;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//è·å–æœ€åä¸€ä¸ªæŒ‡å®šå…ƒç´ ç´¢å¼•çš„ç´¢å¼•å¹¶è¿”å›ç´¢å¼•ï¼Œä¸å­˜åœ¨å°±è¿”å›-1</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">lastIndexOf</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">size</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">last</span><span class="o">;</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">prev</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">index</span><span class="o">--;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">item</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="k">return</span> <span class="n">index</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">last</span><span class="o">;</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">prev</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">index</span><span class="o">--;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">item</span><span class="o">))</span>
                    <span class="k">return</span> <span class="n">index</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Queueæ“ä½œ</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">    <span class="c1">//æä¾›æ™®é€šé˜Ÿåˆ—å’ŒåŒç«¯é˜Ÿåˆ—çš„åŠŸèƒ½ï¼ŒFIFO</span>
     <span class="c1">//å‡ºé˜Ÿï¼ˆä»å‰ç«¯ï¼‰ï¼Œè·å¾—ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œä¸å­˜åœ¨ä¼šè¿”å›nullï¼Œä¸ä¼šåˆ é™¤å…ƒç´ ï¼ˆèŠ‚ç‚¹ï¼‰</span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">peek</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">f</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">f</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//å‡ºé˜Ÿï¼ˆä»å‰ç«¯ï¼‰ï¼Œä¸åˆ é™¤å…ƒç´ ï¼Œè‹¥ä¸ºnullä¼šæŠ›å‡ºå¼‚å¸¸è€Œä¸æ˜¯è¿”å›null</span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">element</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getFirst</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">//å‡ºé˜Ÿï¼ˆä»å‰ç«¯ï¼‰ï¼Œå¦‚æœä¸å­˜åœ¨ä¼šè¿”å›nullï¼Œå­˜åœ¨çš„è¯ä¼šè¿”å›å€¼å¹¶ç§»é™¤è¿™ä¸ªå…ƒç´ ï¼ˆèŠ‚ç‚¹ï¼‰</span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">poll</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">f</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">unlinkFirst</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//å‡ºé˜Ÿï¼ˆä»å‰ç«¯ï¼‰ï¼Œå¦‚æœä¸å­˜åœ¨ä¼šæŠ›å‡ºå¼‚å¸¸è€Œä¸æ˜¯è¿”å›nullï¼Œå­˜åœ¨çš„è¯ä¼šè¿”å›å€¼å¹¶ç§»é™¤è¿™ä¸ªå…ƒç´ ï¼ˆèŠ‚ç‚¹ï¼‰</span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">remove</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">removeFirst</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">//å…¥é˜Ÿï¼ˆä»åç«¯ï¼‰ï¼Œå§‹ç»ˆè¿”å›true</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">offer</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">add</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Dequeï¼ˆåŒç«¯é˜Ÿåˆ—ï¼‰æ“ä½œ</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">    <span class="c1">//å…¥é˜Ÿï¼ˆä»å‰ç«¯ï¼‰ï¼Œå§‹ç»ˆè¿”å›true</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">offerFirst</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">addFirst</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//å…¥é˜Ÿï¼ˆä»åç«¯ï¼‰ï¼Œå§‹ç»ˆè¿”å›true</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">offerLast</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">addLast</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//å‡ºé˜Ÿï¼ˆä»å‰ç«¯ï¼‰ï¼Œè·å¾—ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œä¸å­˜åœ¨ä¼šè¿”å›nullï¼Œä¸ä¼šåˆ é™¤å…ƒç´ ï¼ˆèŠ‚ç‚¹ï¼‰</span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">peekFirst</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">f</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">f</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
     <span class="o">}</span>
     <span class="c1">//å‡ºé˜Ÿï¼ˆä»åç«¯ï¼‰ï¼Œè·å¾—æœ€åä¸€ä¸ªå…ƒç´ ï¼Œä¸å­˜åœ¨ä¼šè¿”å›nullï¼Œä¸ä¼šåˆ é™¤å…ƒç´ ï¼ˆèŠ‚ç‚¹ï¼‰</span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">peekLast</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="n">last</span><span class="o">;</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">l</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">l</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//å‡ºé˜Ÿï¼ˆä»å‰ç«¯ï¼‰ï¼Œè·å¾—ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œä¸å­˜åœ¨ä¼šè¿”å›nullï¼Œä¼šåˆ é™¤å…ƒç´ ï¼ˆèŠ‚ç‚¹ï¼‰</span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">pollFirst</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">f</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">unlinkFirst</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//å‡ºé˜Ÿï¼ˆä»åç«¯ï¼‰ï¼Œè·å¾—æœ€åä¸€ä¸ªå…ƒç´ ï¼Œä¸å­˜åœ¨ä¼šè¿”å›nullï¼Œä¼šåˆ é™¤å…ƒç´ ï¼ˆèŠ‚ç‚¹ï¼‰</span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">pollLast</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="n">last</span><span class="o">;</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">l</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">unlinkLast</span><span class="o">(</span><span class="n">l</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//å…¥æ ˆï¼Œä»å‰é¢æ·»åŠ </span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">push</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">addFirst</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//å‡ºæ ˆï¼Œè¿”å›æ ˆé¡¶å…ƒç´ ï¼Œä»å‰é¢ç§»é™¤ï¼ˆä¼šåˆ é™¤ï¼‰</span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">pop</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">removeFirst</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">//åˆ é™¤åˆ—è¡¨ä¸­ç¬¬ä¸€å‡ºç°oçš„èŠ‚ç‚¹</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">removeFirstOccurrence</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">remove</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//é€†å‘æœç´¢ï¼Œåˆ é™¤ç¬¬ä¸€æ¬¡å‡ºç°oçš„èŠ‚ç‚¹</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">removeLastOccurrence</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">last</span><span class="o">;</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">prev</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">item</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">unlink</span><span class="o">(</span><span class="n">x</span><span class="o">);</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">last</span><span class="o">;</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">prev</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">item</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">unlink</span><span class="o">(</span><span class="n">x</span><span class="o">);</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre> é€šç”¨è¿­ä»£å™¨å®ç°  ç»§æ‰¿è‡ªAbstractSequentialListçš„æ–¹æ³•ï¼ŒAbstractSequentialListæŠ½è±¡ç±»ä¸­
 public Iterator&lt;E&gt; iterator() {
       return listIterator();
 }
é€šç”¨è¿­ä»£å™¨ä¸ArrayListä¸åŒï¼ŒArrayListè‡ªå·±å®ç°äº†Iteratorï¼Œè¯´æ˜linkedlistçš„è¿­ä»£å™¨å¤©ç”Ÿæ”¯æŒåå‘è¿­ä»£ã€‚</pre>
</div>
</div>
<div class="paragraph">
<p>ListIteratorè¿­ä»£å™¨å®ç°ä¸ArrayListç±»ä¼¼
å…¶ä¸­çš„ListItrç»§æ‰¿Itrï¼Œå®ç°äº†ListIteratoræ¥å£ï¼ŒåŒæ—¶é‡å†™äº†hasPrevious()ï¼ŒnextIndex()ï¼Œ previousIndex()ï¼Œprevious()ï¼Œset(E e)ï¼Œadd(E e)ç­‰æ–¹æ³•ï¼Œ
æ‰€ä»¥è¿™ä¹Ÿå¯ä»¥çœ‹å‡ºäº†Iteratorå’ŒListIteratorçš„åŒºåˆ«ï¼Œå°±æ˜¯ListIteratoråœ¨Iteratorçš„åŸºç¡€ä¸Šå¢åŠ äº†æ·»åŠ å¯¹è±¡ï¼Œä¿®æ”¹å¯¹è±¡ï¼Œ
é€†å‘éå†ç­‰æ–¹æ³•ã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">    <span class="kd">public</span> <span class="nc">ListIterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">listIterator</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">checkPositionIndex</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ListItr</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">ListItr</span> <span class="kd">implements</span> <span class="nc">ListIterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">lastReturned</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">nextIndex</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>

        <span class="nc">ListItr</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// assert isPositionIndex(index);</span>
            <span class="n">next</span> <span class="o">=</span> <span class="o">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">size</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">node</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
            <span class="n">nextIndex</span> <span class="o">=</span> <span class="n">index</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasNext</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">nextIndex</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="no">E</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">checkForComodification</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">hasNext</span><span class="o">())</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>

            <span class="n">lastReturned</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
            <span class="n">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
            <span class="n">nextIndex</span><span class="o">++;</span>
            <span class="k">return</span> <span class="n">lastReturned</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasPrevious</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">nextIndex</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="no">E</span> <span class="nf">previous</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">checkForComodification</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">hasPrevious</span><span class="o">())</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>

            <span class="n">lastReturned</span> <span class="o">=</span> <span class="n">next</span> <span class="o">=</span> <span class="o">(</span><span class="n">next</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">last</span> <span class="o">:</span> <span class="n">next</span><span class="o">.</span><span class="na">prev</span><span class="o">;</span>
            <span class="n">nextIndex</span><span class="o">--;</span>
            <span class="k">return</span> <span class="n">lastReturned</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">nextIndex</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">nextIndex</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">previousIndex</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">nextIndex</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">checkForComodification</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">lastReturned</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">();</span>

            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">lastNext</span> <span class="o">=</span> <span class="n">lastReturned</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
            <span class="n">unlink</span><span class="o">(</span><span class="n">lastReturned</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">next</span> <span class="o">==</span> <span class="n">lastReturned</span><span class="o">)</span>
                <span class="n">next</span> <span class="o">=</span> <span class="n">lastNext</span><span class="o">;</span>
            <span class="k">else</span>
                <span class="n">nextIndex</span><span class="o">--;</span>
            <span class="n">lastReturned</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">expectedModCount</span><span class="o">++;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">lastReturned</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">();</span>
            <span class="n">checkForComodification</span><span class="o">();</span>
            <span class="n">lastReturned</span><span class="o">.</span><span class="na">item</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">checkForComodification</span><span class="o">();</span>
            <span class="n">lastReturned</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">next</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="n">linkLast</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="k">else</span>
                <span class="nf">linkBefore</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="n">next</span><span class="o">);</span>
            <span class="n">nextIndex</span><span class="o">++;</span>
            <span class="n">expectedModCount</span><span class="o">++;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">forEachRemaining</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">action</span><span class="o">);</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">==</span> <span class="n">expectedModCount</span> <span class="o">&amp;&amp;</span> <span class="n">nextIndex</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">next</span><span class="o">.</span><span class="na">item</span><span class="o">);</span>
                <span class="n">lastReturned</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
                <span class="n">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                <span class="n">nextIndex</span><span class="o">++;</span>
            <span class="o">}</span>
            <span class="n">checkForComodification</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="kd">final</span> <span class="kt">void</span> <span class="nf">checkForComodification</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">    <span class="c1">//èŠ‚ç‚¹çš„æ•°æ®ç»“æ„å†…éƒ¨ç±»ï¼ŒåŒ…å«å‰åèŠ‚ç‚¹çš„å¼•ç”¨å’Œå½“å‰èŠ‚ç‚¹</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="no">E</span> <span class="n">item</span><span class="o">;</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">;</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">prev</span><span class="o">;</span>

        <span class="nc">Node</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">prev</span><span class="o">,</span> <span class="no">E</span> <span class="n">element</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">item</span> <span class="o">=</span> <span class="n">element</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">prev</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">    <span class="c1">//åå‘è¿­ä»£å™¨ï¼ˆå®ç°Dequeæ¥å£ï¼‰</span>
    <span class="c1">//Dequeæ¥å£å®šä¹‰çš„æ–¹æ³•ï¼Œå®ç°Iteratoræ¥å£ï¼Œç”¨listIteratorè¿­ä»£å™¨è¿”å›ä¸€ä¸ªè¿­ä»£åœ¨æ­¤åŒç«¯é˜Ÿåˆ—é€†å‘é¡ºåºçš„å…ƒç´ </span>
    <span class="kd">public</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">descendingIterator</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">DescendingIterator</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">//</span>
    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">DescendingIterator</span> <span class="kd">implements</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ListItr</span> <span class="n">itr</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ListItr</span><span class="o">(</span><span class="n">size</span><span class="o">());</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasNext</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">itr</span><span class="o">.</span><span class="na">hasPrevious</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="no">E</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">itr</span><span class="o">.</span><span class="na">previous</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">itr</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">LinkedList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">superClone</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">(</span><span class="nc">LinkedList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;)</span> <span class="kd">super</span><span class="o">.</span><span class="na">clone</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">CloneNotSupportedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">InternalError</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">//ä¸ArrayListä¸€æ ·éƒ½æ˜¯è°ƒç”¨superã€‚clone()</span>
    <span class="c1">//protected native Object clone() throws CloneNotSupportedException;</span>
    <span class="c1">//è¢«å¤åˆ¶å¯¹è±¡çš„æ‰€æœ‰å˜é‡éƒ½å«æœ‰ä¸åŸæ¥çš„å¯¹è±¡ç›¸åŒçš„å€¼ï¼Œè€Œæ‰€æœ‰çš„å¯¹å…¶ä»–å¯¹è±¡çš„å¼•ç”¨ä»ç„¶æŒ‡å‘åŸæ¥çš„å¯¹è±¡ã€‚</span>
    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">clone</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">LinkedList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">clone</span> <span class="o">=</span> <span class="n">superClone</span><span class="o">();</span>

        <span class="c1">// Put clone into "virgin" state</span>
        <span class="n">clone</span><span class="o">.</span><span class="na">first</span> <span class="o">=</span> <span class="n">clone</span><span class="o">.</span><span class="na">last</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">clone</span><span class="o">.</span><span class="na">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">clone</span><span class="o">.</span><span class="na">modCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

        <span class="c1">// Initialize clone with our elements</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">next</span><span class="o">)</span>
            <span class="n">clone</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">item</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">clone</span><span class="o">;</span>
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>è½¬æ¢æˆæ•°ç»„</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">    <span class="kd">public</span> <span class="nc">Object</span><span class="o">[]</span> <span class="nf">toArray</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Object</span><span class="o">[]</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="n">size</span><span class="o">];</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">next</span><span class="o">)</span>
            <span class="n">result</span><span class="o">[</span><span class="n">i</span><span class="o">++]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
    <span class="c1">//å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œå°±é»˜è®¤ç”Ÿæˆä¸€ä¸ªObjectæ•°ç»„ï¼Œå¦‚æœç»™äº†Tç±»å‹ï¼Œå°±å°†èŠ‚ç‚¹å†…å®¹æ”¾å…¥aæ•°ç»„ï¼Œ</span>
    <span class="c1">//å¦‚æœaçš„é•¿åº¦å°äºé“¾è¡¨ï¼Œå°±ä½¿ç”¨åå°„ç”Ÿæˆä¸€ä¸ªé“¾è¡¨å¤§å°çš„æ•°ç»„ï¼Œè¿™ä¸ªæ—¶å€™ç”±äºç±»å‹æ˜¯Tï¼Œæ‰€ä»¥æ— æ³•ç›´æ¥å®ä¾‹åŒ–ã€‚</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span><span class="o">[]</span> <span class="nf">toArray</span><span class="o">(</span><span class="no">T</span><span class="o">[]</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">length</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="o">(</span><span class="no">T</span><span class="o">[])</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">.</span><span class="na">Array</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span>
                                <span class="n">a</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getComponentType</span><span class="o">(),</span> <span class="n">size</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="nc">Object</span><span class="o">[]</span> <span class="n">result</span> <span class="o">=</span> <span class="n">a</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">next</span><span class="o">)</span>
            <span class="n">result</span><span class="o">[</span><span class="n">i</span><span class="o">++]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="n">size</span><span class="o">)</span>
            <span class="n">a</span><span class="o">[</span><span class="n">size</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">return</span> <span class="n">a</span><span class="o">;</span>
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>å¦‚æœå£°æ˜è¯¥æ–¹æ³•ï¼Œå®ƒå°†ä¼šè¢«ObjectOutputStreamè°ƒç”¨è€Œä¸æ˜¯é»˜è®¤çš„åºåˆ—åŒ–è¿›ç¨‹ã€‚å¦‚æœä½ æ˜¯ç¬¬ä¸€æ¬¡çœ‹è§å®ƒï¼Œ
ä½ ä¼šå¾ˆæƒŠå¥‡å°½ç®¡å®ƒä»¬è¢«å¤–éƒ¨ç±»è°ƒç”¨ä½†äº‹å®ä¸Šè¿™æ˜¯ä¸¤ä¸ªprivateçš„æ–¹æ³•ã€‚å¹¶ä¸”å®ƒä»¬æ—¢ä¸å­˜åœ¨äºjava.lang.Objectï¼Œä¹Ÿæ²¡æœ‰åœ¨Serializableä¸­å£°æ˜ã€‚
é‚£ä¹ˆObjectOutputStreamå¦‚ä½•ä½¿ç”¨å®ƒä»¬çš„å‘¢ï¼Ÿè¿™ä¸ªå—ï¼ŒObjectOutputStreamä½¿ç”¨äº†åå°„æ¥å¯»æ‰¾æ˜¯å¦å£°æ˜äº†è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚
å› ä¸ºObjectOutputStreamä½¿ç”¨getPrivateMethodï¼Œæ‰€ä»¥è¿™äº›æ–¹æ³•ä¸å¾—ä¸è¢«å£°æ˜ä¸ºpriateä»¥è‡³äºä¾›ObjectOutputStreamæ¥ä½¿ç”¨ã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">876323262645176354L</span><span class="o">;</span>
    <span class="c1">//å®šä¹‰äº†è‡ªå·±çš„åºåˆ—åŒ–æ–¹æ³•ï¼Œé€šè¿‡åå°„è°ƒç”¨</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">writeObject</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">ObjectOutputStream</span> <span class="n">s</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
        <span class="c1">// Write out any hidden serialization magic</span>
        <span class="n">s</span><span class="o">.</span><span class="na">defaultWriteObject</span><span class="o">();</span>

        <span class="c1">// Write out size</span>
        <span class="n">s</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">size</span><span class="o">);</span>

        <span class="c1">// Write out all elements in the proper order.</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">next</span><span class="o">)</span>
            <span class="n">s</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">item</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">readObject</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">ObjectInputStream</span> <span class="n">s</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span><span class="o">,</span> <span class="nc">ClassNotFoundException</span> <span class="o">{</span>
        <span class="c1">// Read in any hidden serialization magic</span>
        <span class="n">s</span><span class="o">.</span><span class="na">defaultReadObject</span><span class="o">();</span>

        <span class="c1">// Read in size</span>
        <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>

        <span class="c1">// Read in all elements in the proper order.</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
            <span class="n">linkLast</span><span class="o">((</span><span class="no">E</span><span class="o">)</span><span class="n">s</span><span class="o">.</span><span class="na">readObject</span><span class="o">());</span>
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">    <span class="c1">//ä»¥ä¸‹å…³äº1.8å‡½æ•°å¼ç¼–ç¨‹</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">spliterator</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">LLSpliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;(</span><span class="k">this</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">LLSpliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">BATCH_UNIT</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="o">;</span>  <span class="c1">// batch array size increment</span>
        <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">MAX_BATCH</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="o">;</span>  <span class="c1">// max batch array size;</span>
        <span class="kd">final</span> <span class="nc">LinkedList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">;</span> <span class="c1">// null OK unless traversed</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">current</span><span class="o">;</span>      <span class="c1">// current node; null until initialized</span>
        <span class="kt">int</span> <span class="n">est</span><span class="o">;</span>              <span class="c1">// size estimate; -1 until first needed</span>
        <span class="kt">int</span> <span class="n">expectedModCount</span><span class="o">;</span> <span class="c1">// initialized when est set</span>
        <span class="kt">int</span> <span class="n">batch</span><span class="o">;</span>            <span class="c1">// batch size for splits</span>

        <span class="nc">LLSpliterator</span><span class="o">(</span><span class="nc">LinkedList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">,</span> <span class="kt">int</span> <span class="n">est</span><span class="o">,</span> <span class="kt">int</span> <span class="n">expectedModCount</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">list</span> <span class="o">=</span> <span class="n">list</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">est</span> <span class="o">=</span> <span class="n">est</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">expectedModCount</span> <span class="o">=</span> <span class="n">expectedModCount</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">final</span> <span class="kt">int</span> <span class="nf">getEst</span><span class="o">()</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">s</span><span class="o">;</span> <span class="c1">// force initialization</span>
            <span class="kd">final</span> <span class="nc">LinkedList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">lst</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">s</span> <span class="o">=</span> <span class="n">est</span><span class="o">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">lst</span> <span class="o">=</span> <span class="n">list</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">est</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                <span class="k">else</span> <span class="o">{</span>
                    <span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">lst</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>
                    <span class="n">current</span> <span class="o">=</span> <span class="n">lst</span><span class="o">.</span><span class="na">first</span><span class="o">;</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">est</span> <span class="o">=</span> <span class="n">lst</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">long</span> <span class="nf">estimateSize</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="o">(</span><span class="kt">long</span><span class="o">)</span> <span class="n">getEst</span><span class="o">();</span> <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">trySplit</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">getEst</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">current</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">batch</span> <span class="o">+</span> <span class="no">BATCH_UNIT</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">s</span><span class="o">)</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="no">MAX_BATCH</span><span class="o">)</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="no">MAX_BATCH</span><span class="o">;</span>
                <span class="nc">Object</span><span class="o">[]</span> <span class="n">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="n">n</span><span class="o">];</span>
                <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                <span class="k">do</span> <span class="o">{</span> <span class="n">a</span><span class="o">[</span><span class="n">j</span><span class="o">++]</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">item</span><span class="o">;</span> <span class="o">}</span> <span class="k">while</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="o">);</span>
                <span class="n">current</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                <span class="n">batch</span> <span class="o">=</span> <span class="n">j</span><span class="o">;</span>
                <span class="n">est</span> <span class="o">=</span> <span class="n">s</span> <span class="o">-</span> <span class="n">j</span><span class="o">;</span>
                <span class="k">return</span> <span class="nc">Spliterators</span><span class="o">.</span><span class="na">spliterator</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">j</span><span class="o">,</span> <span class="nc">Spliterator</span><span class="o">.</span><span class="na">ORDERED</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">forEachRemaining</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="kt">int</span> <span class="n">n</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">action</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">n</span> <span class="o">=</span> <span class="n">getEst</span><span class="o">())</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">current</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">current</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="n">est</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                <span class="k">do</span> <span class="o">{</span>
                    <span class="no">E</span> <span class="n">e</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                    <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">list</span><span class="o">.</span><span class="na">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">tryAdvance</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">action</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">getEst</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">current</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="o">--</span><span class="n">est</span><span class="o">;</span>
                <span class="no">E</span> <span class="n">e</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
                <span class="n">current</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">list</span><span class="o">.</span><span class="na">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">characteristics</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">Spliterator</span><span class="o">.</span><span class="na">ORDERED</span> <span class="o">|</span> <span class="nc">Spliterator</span><span class="o">.</span><span class="na">SIZED</span> <span class="o">|</span> <span class="nc">Spliterator</span><span class="o">.</span><span class="na">SUBSIZED</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>LinkedListä¸ArrayListçš„åŒºåˆ«ï¼š
LinkedListä¸ArrayListåœ¨æ€§èƒ½ä¸Šå„æœ‰ä¼˜ç¼ºç‚¹ï¼Œéƒ½æœ‰å„è‡ªé€‚ç”¨çš„åœ°æ–¹ï¼Œæ€»ç»“å¦‚ä¸‹ï¼š</p>
</div>
<div class="paragraph">
<p>ArrayListæ˜¯å®ç°äº†åŸºäºåŠ¨æ€æ•°ç»„çš„æ•°æ®ç»“æ„ï¼ŒLinkedListåŸºäºé“¾è¡¨çš„æ•°æ®ç»“æ„ã€‚<br>
LinkedListä¸æ”¯æŒé«˜æ•ˆçš„éšæœºå…ƒç´ è®¿é—®ã€‚<br>
ArrayListçš„ç©ºé—´æµªè´¹ä¸»è¦ä½“ç°åœ¨åœ¨liståˆ—è¡¨çš„ç»“å°¾é¢„ç•™ä¸€å®šçš„å®¹é‡ç©ºé—´ï¼Œ<br>
è€ŒLinkedListçš„ç©ºé—´èŠ±è´¹åˆ™ä½“ç°åœ¨å®ƒçš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½éœ€è¦æ¶ˆè€—ç›¸å½“çš„ç©ºé—´ï¼ˆéœ€è¦é™„åŠ çš„ç©ºé—´æ¥è¡¨æ˜æ•°æ®å…ƒç´ çš„é€»è¾‘å…³ç³»ï¼‰ï¼Œå°±å­˜å‚¨å¯†åº¦æ¥è¯´ï¼ŒArrayListæ˜¯ä¼˜äºLinkedListçš„ã€‚ +ã€€ã€€
å½“æ“ä½œæ˜¯åœ¨ä¸€åˆ—æ•°æ®çš„åé¢æ·»åŠ æ•°æ®è€Œä¸æ˜¯åœ¨å‰é¢æˆ–ä¸­é—´,å¹¶ä¸”éœ€è¦éšæœºåœ°è®¿é—®å…¶ä¸­çš„å…ƒç´ æ—¶,ä½¿ç”¨ArrayListä¼šæä¾›æ¯”è¾ƒå¥½çš„æ€§èƒ½ï¼Œ<br>
å½“ä½ çš„æ“ä½œæ˜¯åœ¨ä¸€åˆ—æ•°æ®çš„å‰é¢æˆ–ä¸­é—´æ·»åŠ æˆ–åˆ é™¤æ•°æ®,å¹¶ä¸”æŒ‰ç…§é¡ºåºè®¿é—®å…¶ä¸­çš„å…ƒç´ æ—¶,å°±åº”è¯¥ä½¿ç”¨LinkedListäº†ã€‚</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_stack"><a class="anchor" href="#_stack"></a>10. Stack</h2>
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="./diag-16ecc60bc2cad0b74c75de005e41a202.svg" alt="diag 16ecc60bc2cad0b74c75de005e41a202" width="100%" height="627">
</div>
</div>
<div class="paragraph">
<p><code>Stack</code> çš„å®ç°æå…¶ç®€å•ã€‚å¯ä»¥ç”¨å‡ å¥è¯æ¦‚æ‹¬å®Œï¼š</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>Stack</code> ç›´æ¥ç»§æ‰¿è‡³ <code>Vector</code>ï¼Œåœ¨å…¶åŸºç¡€ä¹‹ä¸Šï¼Œåªæ˜¯å¢åŠ äº†æ ˆç›¸å…³çš„æ“ä½œï¼›</p>
</li>
<li>
<p>åœ¨æ–¹æ³•ä¸Šä½¿ç”¨ <code>synchronized</code> æ¥å®ç°çº¿ç¨‹å®‰å…¨ï¼›</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_vector"><a class="anchor" href="#_vector"></a>11. Vector</h2>
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="./diag-d8a29637d16e422afe4cfe141c1d9776.svg" alt="diag d8a29637d16e422afe4cfe141c1d9776" width="100%" height="519">
</div>
</div>
<div class="paragraph">
<p><code>Vector</code> å†…éƒ¨å®ç°ä¸ <code>ArrayList</code> ç±»ä¼¼ï¼Œéƒ½æ˜¯ä½¿ç”¨æ•°ç»„æ¥å­˜å‚¨å…ƒç´ ã€‚ä¸åŒçš„æ˜¯ï¼Œ<code>Vector</code> åœ¨æ–¹æ³•ä¸ŠåŠ äº† <code>synchronized</code> ä¿®é¥°è¯ï¼Œæ¥å®ç°çº¿ç¨‹å®‰å…¨ã€‚</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_set"><a class="anchor" href="#_set"></a>12. Set</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_abstractset"><a class="anchor" href="#_abstractset"></a>13. AbstractSet</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_sortedset"><a class="anchor" href="#_sortedset"></a>14. SortedSet</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_redis_çš„_skiplist"><a class="anchor" href="#_redis_çš„_skiplist"></a>14.1. Redis çš„ SkipList</h3>
<div class="paragraph">
<p>è·³è·ƒè¡¨æ˜¯ä¸€ç§æœ‰åºæ•°æ®ç»“æ„ï¼Œæ”¯æŒå¹³å‡ O(logN)ã€æœ€å O(N) å¤æ‚åº¦çš„èŠ‚ç‚¹æŸ¥æ‰¾ï¼›å¤§éƒ¨åˆ†æƒ…å†µæ•ˆç‡å¯ä»¥å’Œå¹³è¡¡æ ‘ç›¸åª²ç¾ï¼Œå®ç°å´æ¯”å¹³è¡¡æ ‘ç®€å•ã€‚</p>
</div>
<div class="paragraph">
<p>è·³è·ƒè¡¨å°±æ˜¯ Redis ä¸­æœ‰åºé›†åˆé”®çš„åº•å±‚å®ç°ä¹‹ä¸€ã€‚</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>è¿˜æœ‰å…¶ä»–ä»€ä¹ˆå®ç°ï¼Ÿ</p>
</div>
</div>
</div>
<div class="listingblock">
<div class="title">server.h</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="n">zskiplistNode</span> <span class="p">{</span>
    <span class="n">sds</span> <span class="n">ele</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">score</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">zskiplistNode</span> <span class="o">*</span><span class="n">backward</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">zskiplistLevel</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="n">zskiplistNode</span> <span class="o">*</span><span class="n">forward</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">span</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">level</span><span class="p">[];</span>
<span class="p">}</span> <span class="n">zskiplistNode</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">zskiplist</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">zskiplistNode</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span> <span class="o">*</span><span class="n">tail</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">length</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">level</span><span class="p">;</span>
<span class="p">}</span> <span class="n">zskiplist</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">zset</span> <span class="p">{</span>
    <span class="n">dict</span> <span class="o">*</span><span class="n">dict</span><span class="p">;</span>
    <span class="n">zskiplist</span> <span class="o">*</span><span class="n">zsl</span><span class="p">;</span>
<span class="p">}</span> <span class="n">zset</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>skiplistï¼Œé¡¾åæ€ä¹‰ï¼Œé¦–å…ˆå®ƒæ˜¯ä¸€ä¸ªlistã€‚å®é™…ä¸Šï¼Œå®ƒæ˜¯åœ¨æœ‰åºé“¾è¡¨çš„åŸºç¡€ä¸Šå‘å±•èµ·æ¥çš„ã€‚</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/skiplist.png" alt="skiplist">
</div>
</div>
<div class="paragraph">
<p>å½“æˆ‘ä»¬æƒ³æŸ¥æ‰¾æ•°æ®çš„æ—¶å€™ï¼Œå¯ä»¥å…ˆæ²¿ç€è·¨åº¦å¤§çš„é“¾è¿›è¡ŒæŸ¥æ‰¾ã€‚å½“ç¢°åˆ°æ¯”å¾…æŸ¥æ•°æ®å¤§çš„èŠ‚ç‚¹æ—¶ï¼Œå†å›åˆ°è·¨åº¦å°çš„é“¾è¡¨ä¸­è¿›è¡ŒæŸ¥æ‰¾ã€‚</p>
</div>
<div class="paragraph">
<p>skiplistæ­£æ˜¯å—è¿™ç§å¤šå±‚é“¾è¡¨çš„æƒ³æ³•çš„å¯å‘è€Œè®¾è®¡å‡ºæ¥çš„ã€‚æŒ‰ç…§ä¸Šé¢ç”Ÿæˆé“¾è¡¨çš„æ–¹å¼ï¼Œä¸Šé¢æ¯ä¸€å±‚é“¾è¡¨çš„èŠ‚ç‚¹ä¸ªæ•°ï¼Œæ˜¯ä¸‹é¢ä¸€å±‚çš„èŠ‚ç‚¹ä¸ªæ•°çš„ä¸€åŠï¼Œè¿™æ ·æŸ¥æ‰¾è¿‡ç¨‹å°±éå¸¸ç±»ä¼¼äºä¸€ä¸ªäºŒåˆ†æŸ¥æ‰¾ï¼Œä½¿å¾—æŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦å¯ä»¥é™ä½åˆ° O(logN)ã€‚ä½†æ˜¯ï¼Œå­˜åœ¨çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼šå¦‚æœæ’å…¥æ–°èŠ‚ç‚¹åå°±ä¼šæ‰“ä¹±ä¸Šä¸‹ç›¸é‚»ä¸¤å±‚èŠ‚ç‚¹æ˜¯ 2:1 çš„å¯¹åº”å…³ç³»ã€‚å¦‚æœè¦ç»´æŒï¼Œåˆ™éœ€è¦è°ƒæ•´åé¢æ‰€æœ‰çš„èŠ‚ç‚¹ã€‚</p>
</div>
<div class="paragraph">
<p>skiplistä¸ºäº†é¿å…è¿™ä¸€é—®é¢˜ï¼Œå®ƒä¸è¦æ±‚ä¸Šä¸‹ç›¸é‚»ä¸¤å±‚é“¾è¡¨ä¹‹é—´çš„èŠ‚ç‚¹ä¸ªæ•°æœ‰ä¸¥æ ¼çš„å¯¹åº”å…³ç³»ï¼Œè€Œæ˜¯ä¸ºæ¯ä¸ªèŠ‚ç‚¹éšæœºå‡ºä¸€ä¸ªå±‚æ•°(level)ã€‚</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/redis-skiplist-insertions.png" alt="redis skiplist insertions">
</div>
</div>
<div class="paragraph">
<p>æ’å…¥æ“ä½œåªéœ€è¦ä¿®æ”¹æ’å…¥èŠ‚ç‚¹å‰åçš„æŒ‡é’ˆï¼Œè€Œä¸éœ€è¦å¯¹å¾ˆå¤šèŠ‚ç‚¹éƒ½è¿›è¡Œè°ƒæ•´ã€‚è¿™å°±é™ä½äº†æ’å…¥æ“ä½œçš„å¤æ‚åº¦ã€‚å®é™…ä¸Šï¼Œè¿™æ˜¯ skiplist çš„ä¸€ä¸ªå¾ˆé‡è¦çš„ç‰¹æ€§ï¼Œè¿™è®©å®ƒåœ¨æ’å…¥æ€§èƒ½ä¸Šæ˜æ˜¾ä¼˜äºå¹³è¡¡æ ‘çš„æ–¹æ¡ˆã€‚</p>
</div>
<div class="paragraph">
<p>skiplistï¼Œç¿»è¯‘æˆä¸­æ–‡ï¼Œå¯ä»¥ç¿»è¯‘æˆâ€œè·³è¡¨â€æˆ–â€œè·³è·ƒè¡¨â€ï¼ŒæŒ‡çš„å°±æ˜¯é™¤äº†æœ€ä¸‹é¢ç¬¬1å±‚é“¾è¡¨ä¹‹å¤–ï¼Œå®ƒä¼šäº§ç”Ÿè‹¥å¹²å±‚ç¨€ç–çš„é“¾è¡¨ï¼Œè¿™äº›é“¾è¡¨é‡Œé¢çš„æŒ‡é’ˆæ•…æ„è·³è¿‡äº†ä¸€äº›èŠ‚ç‚¹ï¼ˆè€Œä¸”è¶Šé«˜å±‚çš„é“¾è¡¨è·³è¿‡çš„èŠ‚ç‚¹è¶Šå¤šï¼‰ã€‚è¿™å°±ä½¿å¾—æˆ‘ä»¬åœ¨æŸ¥æ‰¾æ•°æ®çš„æ—¶å€™èƒ½å¤Ÿå…ˆåœ¨é«˜å±‚çš„é“¾è¡¨ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œç„¶åé€å±‚é™ä½ï¼Œæœ€ç»ˆé™åˆ°ç¬¬1å±‚é“¾è¡¨æ¥ç²¾ç¡®åœ°ç¡®å®šæ•°æ®ä½ç½®ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è·³è¿‡äº†ä¸€äº›èŠ‚ç‚¹ï¼Œä»è€Œä¹Ÿå°±åŠ å¿«äº†æŸ¥æ‰¾é€Ÿåº¦ã€‚</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>åœ¨ä¸­é—´æ’å…¥ä¸€ä¸ªæœ‰æ¯”è¾ƒé«˜ Level çš„èŠ‚ç‚¹ï¼Œå¦‚ä½•ç»´æŠ¤å‰é¢èŠ‚ç‚¹åˆ°è¿™ä¸ªèŠ‚ç‚¹çš„è¿™äº›é“¾æ¥ï¼Ÿ</p>
</li>
<li>
<p>åœ¨å¹³è¡¡æ ‘ç§ï¼Œå¦‚ä½•åšèŒƒå›´æŸ¥æ‰¾ï¼Ÿå…ˆç¡®å®šè¾¹ç•Œï¼Œç„¶åå…¶ä»–èŠ‚ç‚¹æ€ä¹ˆæŸ¥æ‰¾ï¼Ÿ</p>
</li>
</ol>
</div>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/redis_skiplist_example.png" alt="redis skiplist example">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>skiplist ä¸­ key å…è®¸é‡å¤ã€‚</p>
</li>
<li>
<p>åœ¨æ¯”è¾ƒæ—¶ï¼Œä¸ä»…æ¯”è¾ƒåˆ†æ•°ï¼ˆå³keyï¼‰ï¼Œè¿˜è¦æ¯”è¾ƒæ•°æ®è‡ªèº«ã€‚</p>
</li>
<li>
<p>ç¬¬ä¸€å±‚é“¾è¡¨æ˜¯åŒå‘é“¾è¡¨ï¼Œå¹¶ä¸”åå‘æŒ‡é’ˆåªæœ‰ä¸€ä¸ªã€‚</p>
</li>
<li>
<p>åœ¨ skiplist ä¸­å¯ä»¥å¾ˆæ–¹ä¾¿è®¡ç®—æ¯ä¸ªå…ƒç´ çš„æ’åã€‚</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Redis ä¸­çš„æœ‰åºé›†åˆï¼ˆsorted setï¼‰ï¼Œæ˜¯åœ¨ skiplist, dict å’Œ ziplist åŸºç¡€ä¸Šæ„å»ºèµ·æ¥çš„:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>å½“æ•°æ®è¾ƒå°‘æ—¶ï¼Œsorted setæ˜¯ç”±ä¸€ä¸ª ziplist æ¥å®ç°çš„ã€‚å…¶ä¸­é›†åˆå…ƒç´ æŒ‰ç…§åˆ†å€¼ä»å°åˆ°å¤§æ’åºã€‚</p>
</li>
<li>
<p>å½“æ•°æ®å¤šçš„æ—¶å€™ï¼Œsorted set æ˜¯ç”±ä¸€ä¸ªå« zset çš„æ•°æ®ç»“æ„æ¥å®ç°çš„ï¼Œè¿™ä¸ª zset åŒ…å«ä¸€ä¸ª dict + ä¸€ä¸ª skiplistã€‚dict ç”¨æ¥æŸ¥è¯¢æ•°æ®åˆ°åˆ†æ•°(score)çš„å¯¹åº”å…³ç³»ï¼Œè€Œ skiplist ç”¨æ¥æ ¹æ®åˆ†æ•°æŸ¥è¯¢æ•°æ®ï¼ˆå¯èƒ½æ˜¯èŒƒå›´æŸ¥æ‰¾ï¼‰ã€‚</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>è½¬æ¢çš„æ¡ä»¶æ˜¯ï¼š</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>æœ‰åºé›†åˆä¿å­˜çš„å…ƒç´ æ•°é‡å°äº 128 ä¸ªï¼›ï¼ˆé€šè¿‡å‚æ•° <code>zset-max-ziplist-entries</code> æ¥è°ƒèŠ‚ï¼Œé»˜è®¤ä¸º 128ã€‚ï¼‰</p>
</li>
<li>
<p>æœ‰åºé›†åˆä¿å­˜çš„æ‰€æœ‰å…ƒç´ æˆå‘˜çš„é•¿åº¦éƒ½è¦å°äº 64 ä¸ªå­—èŠ‚ï¼›ï¼ˆé€šè¿‡å‚æ•° <code>zset-max-ziplist-value</code> æ¥è°ƒèŠ‚ï¼Œé»˜è®¤ä¸º 64ã€‚ï¼‰</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>åœ¨ <code>t_zset.c/zsetConvert</code> ä¸­æ‰§è¡Œè½¬æ¢æ“ä½œã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="code"><pre>127.0.0.1:6379&gt; ZADD myzset 1 <span class="s2">"one"</span>
<span class="o">(</span>integer<span class="o">)</span> 1
127.0.0.1:6379&gt; ZADD myzset 1 <span class="s2">"uno"</span>
<span class="o">(</span>integer<span class="o">)</span> 1
127.0.0.1:6379&gt; ZADD myzset 2 <span class="s2">"two"</span> 3 <span class="s2">"three"</span>
<span class="o">(</span>integer<span class="o">)</span> 2
127.0.0.1:6379&gt; ZRANGE myzset 0 <span class="nt">-1</span> WITHSCORES
1<span class="o">)</span> <span class="s2">"one"</span>
2<span class="o">)</span> <span class="s2">"1"</span>
3<span class="o">)</span> <span class="s2">"uno"</span>
4<span class="o">)</span> <span class="s2">"1"</span>
5<span class="o">)</span> <span class="s2">"two"</span>
6<span class="o">)</span> <span class="s2">"2"</span>
7<span class="o">)</span> <span class="s2">"three"</span>
8<span class="o">)</span> <span class="s2">"3"</span>
127.0.0.1:6379&gt; OBJECT encoding myzset
<span class="s2">"ziplist"</span>

127.0.0.1:6379&gt; ZADD myzset 4 <span class="s2">"1234567890123456789012345678901234567890123456789012345678901234S"</span>
<span class="o">(</span>integer<span class="o">)</span> 1
127.0.0.1:6379&gt; OBJECT encoding myzset
<span class="s2">"skiplist"</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>åœ¨ JDK ä¸­ï¼Œä¹Ÿæœ‰ SkipList çš„å®ç°ï¼Œåœ¨ <code>ConcurrentSkipListMap</code> ä¸­ã€‚ä¸è¿‡ï¼Œå®ƒä¸æ˜¯ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„ Collection æ¥å®ç°çš„ï¼Œè€Œæ˜¯ä½œä¸º <code>Map</code> çš„ä¸€éƒ¨åˆ†æ¥å®ç°çš„ã€‚</p>
</div>
</div>
<div class="sect2">
<h3 id="_å‚è€ƒèµ„æ–™_4"><a class="anchor" href="#_å‚è€ƒèµ„æ–™_4"></a>14.2. å‚è€ƒèµ„æ–™</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="ftp://ftp.cs.umd.edu/pub/skipLists/skiplists.pdf">William Pughã€ŠSkip Lists: A Probabilistic Alternative to Balanced Treesã€‹</a></p>
</li>
<li>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzA4NTg1MjM0Mg==&amp;mid=2657261425&amp;idx=1&amp;sn=d840079ea35875a8c8e02d9b3e44cf95&amp;scene=21#wechat_redirect">Redisä¸ºä»€ä¹ˆç”¨è·³è¡¨è€Œä¸ç”¨å¹³è¡¡æ ‘ï¼Ÿ- å¼ é“è•¾</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_navigableset"><a class="anchor" href="#_navigableset"></a>15. NavigableSet</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_hashset"><a class="anchor" href="#_hashset"></a>16. HashSet</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_redis_ä¸­çš„_set"><a class="anchor" href="#_redis_ä¸­çš„_set"></a>16.1. Redis ä¸­çš„ Set</h3>
<div class="paragraph">
<p>Redis ä¸­çš„é›†åˆå¯¹è±¡ç¼–ç å¯ä»¥æ˜¯ï¼š</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>intset</p>
</li>
<li>
<p>hashtable</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>è½¬æ¢çš„æ¡ä»¶æ˜¯ï¼š</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>é›†åˆå¯¹è±¡ä¿å­˜çš„æ‰€æœ‰å…ƒç´ éƒ½æ˜¯æ•´æ•°å€¼ï¼›</p>
</li>
<li>
<p>é›†åˆå¯¹è±¡ä¿å­˜çš„å…ƒç´ ä¸ªæ•°ä¸è¶…è¿‡ 512 ä¸ªï¼›ï¼ˆé€šè¿‡å‚æ•° <code>set-max-intset-entries</code> æ¥è°ƒæ•´ï¼Œé»˜è®¤æ˜¯ 512ï¼‰</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre>127.0.0.1:6379&gt; SADD num 1 3 5
<span class="o">(</span>integer<span class="o">)</span> 3
127.0.0.1:6379&gt; OBJECT encoding num
<span class="s2">"intset"</span>

127.0.0.1:6379&gt; sadd num <span class="s2">"seven"</span>
<span class="o">(</span>integer<span class="o">)</span> 1
127.0.0.1:6379&gt; OBJECT encoding num
<span class="s2">"hashtable"</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>åœ¨ <code>t_set.c/setTypeConvert</code> ä¸­æ‰§è¡Œè½¬æ¢æ“ä½œã€‚</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_treeset"><a class="anchor" href="#_treeset"></a>17. TreeSet</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_linkedhashset"><a class="anchor" href="#_linkedhashset"></a>18. LinkedHashSet</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_bitset"><a class="anchor" href="#_bitset"></a>19. BitSet</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_enumset"><a class="anchor" href="#_enumset"></a>20. EnumSet</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_map"><a class="anchor" href="#_map"></a>21. Map</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_sortedmap"><a class="anchor" href="#_sortedmap"></a>22. SortedMap</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_navigablemap"><a class="anchor" href="#_navigablemap"></a>23. NavigableMap</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_abstractmap"><a class="anchor" href="#_abstractmap"></a>24. AbstractMap</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_hashmap"><a class="anchor" href="#_hashmap"></a>25. HashMap</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_hashmap_é—®é¢˜é›†"><a class="anchor" href="#_hashmap_é—®é¢˜é›†"></a>25.1. HashMap é—®é¢˜é›†</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>å¦‚æœåˆ¤æ–­æ˜¯å¦åˆ°è¾¾å®¹é‡é˜ˆå€¼ï¼Ÿ</p>
</li>
<li>
<p>ä¸ºä»€ä¹ˆ</p>
</li>
<li>
<p>éå†æŸ¥æ‰¾æ—¶ï¼Œå¦‚æœä¿è¯å¯ä»¥è®©çº¢é»‘æ ‘çš„èŠ‚ç‚¹ä¹Ÿå¯ä»¥ä½¿ç”¨nextæ–¹æ³•æ¥æŸ¥æ‰¾ï¼Ÿ</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_redis_ä¸­çš„å­—å…¸"><a class="anchor" href="#_redis_ä¸­çš„å­—å…¸"></a>25.2. Redis ä¸­çš„å­—å…¸</h3>
<div class="paragraph">
<p>Redis åº•å±‚ä¸­çš„å­—å…¸å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„ Hash å®ç°ã€‚</p>
</div>
<div class="listingblock">
<div class="title">dict.h</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="code"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="n">dictEntry</span> <span class="p">{</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
    <span class="k">union</span> <span class="p">{</span>
        <span class="kt">void</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>
        <span class="kt">uint64_t</span> <span class="n">u64</span><span class="p">;</span>
        <span class="kt">int64_t</span> <span class="n">s64</span><span class="p">;</span>
        <span class="kt">double</span> <span class="n">d</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">v</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">dictEntry</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="p">}</span> <span class="n">dictEntry</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">dictType</span> <span class="p">{</span>
    <span class="kt">uint64_t</span> <span class="p">(</span><span class="o">*</span><span class="n">hashFunction</span><span class="p">)(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">);</span>
    <span class="kt">void</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">keyDup</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">);</span>
    <span class="kt">void</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">valDup</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">obj</span><span class="p">);</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">keyCompare</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key1</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key2</span><span class="p">);</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">keyDestructor</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">);</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">valDestructor</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">obj</span><span class="p">);</span>
<span class="p">}</span> <span class="n">dictType</span><span class="p">;</span>

<span class="cm">/* This is our hash table structure. Every dictionary has two of this as we
 * implement incremental rehashing, for the old to the new table. */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">dictht</span> <span class="p">{</span>
    <span class="n">dictEntry</span> <span class="o">**</span><span class="n">table</span><span class="p">;</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sizemask</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">used</span><span class="p">;</span>
<span class="p">}</span> <span class="n">dictht</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">dict</span> <span class="p">{</span>
    <span class="n">dictType</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">;</span>
    <span class="n">dictht</span> <span class="n">ht</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="kt">long</span> <span class="n">rehashidx</span><span class="p">;</span> <span class="cm">/* rehashing not in progress if rehashidx == -1 */</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iterators</span><span class="p">;</span> <span class="cm">/* number of iterators currently running */</span>
<span class="p">}</span> <span class="n">dict</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>table</code> å±æ€§æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªæŒ‡å‘ <code>dictEntry</code> ç»“æ„çš„æŒ‡é’ˆã€‚</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>dictEntry</code> ä¿å­˜ä¸€ä¸ªé”®å€¼å¯¹ã€‚</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>é€šå¸¸ä½¿ç”¨ <code>ht[0]</code>ï¼Œ<code>ht[1]</code> åœ¨ Rehash æ—¶æ‰ä¼šç”¨åˆ°ã€‚</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>æ·»åŠ æ–°å…ƒç´ æ—¶ï¼Œå’Œ Java ä¸€æ ·ï¼Œè®¡ç®— Key çš„å“ˆå¸Œå€¼ï¼Œç„¶åå†æ ¹æ®å“ˆå¸Œå€¼ä¸é•¿åº¦æ©ç ï¼ˆ<code>sizemask</code>ï¼‰ç›¸ä¸å¾—åˆ°æ•°ç»„ä¸‹æ ‡ã€‚</p>
</div>
<div class="paragraph">
<p>Redis åº•å±‚ä½¿ç”¨ MurmurHash2 ç®—æ³•æ¥è®¡ç®—é”®çš„å“ˆå¸Œå€¼ã€‚</p>
</div>
<div class="sect3">
<h4 id="_rehash_æ“ä½œ"><a class="anchor" href="#_rehash_æ“ä½œ"></a>25.2.1. Rehash æ“ä½œ</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>è®¡ç®—æ–°çš„æ•°ç»„é•¿åº¦</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>å¦‚æœæ˜¯æ‰©å®¹ï¼Œåˆ™ <code>used * 2</code>ï¼›</p>
</li>
<li>
<p>å¦‚æœæ˜¯ç¼©å®¹ï¼Œåˆ™æ˜¯ç¬¬ä¸€ä¸ªå¤§äºç­‰äº <code>used</code> çš„ 2<sup>n</sup>ã€‚&#8201;&#8212;&#8201;è¿™ç‚¹å’Œ Java ä¸åŒï¼Œ<code>HashMap</code> ä¸­æ²¡æœ‰è‡ªåŠ¨ç¼©å®¹çš„æœºåˆ¶ã€‚</p>
</li>
</ol>
</div>
</li>
<li>
<p>å°† <code>ht[0]</code> ä¸­çš„æ‰€æœ‰é”®å€¼å¯¹é‡æ–° Rehashï¼Œé‡æ–°è®¡ç®—å“ˆå¸Œå€¼å’Œç´¢å¼•å€¼ï¼Œæ”¾ç½®åˆ° <code>ht[1]</code> ä¸Šï¼›</p>
</li>
<li>
<p>è¿ç§»å®Œæˆåï¼Œå°† <code>ht[1]</code> è®¾ç½®ä¸º <code>ht[0]</code>ï¼Œä¸º <code>ht[1]</code> åˆ›å»ºä¸€ä¸ªç©ºç™½å“ˆå¸Œè¡¨ã€‚</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>è¿˜æœ‰å‡ ç‚¹éœ€è¦ç‰¹åˆ«æ³¨æ„ï¼š</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>æ ¹æ®æ˜¯å¦æ­£åœ¨æ‰§è¡Œ BGSAVE æˆ– BGREADWRITEAOF å‘½ä»¤ï¼Œä½¿ç”¨ä¸åŒçš„è´Ÿè½½é˜ˆå€¼æ¥å†³å®šæ˜¯å¦å¼€å¯å¯¹å“ˆå¸Œè¡¨çš„è‡ªåŠ¨æ‰©å±•å·¥ä½œï¼›</p>
</li>
<li>
<p>å½“å“ˆå¸Œè¡¨è´Ÿè½½å› å­å°äº 0.1 æ—¶ï¼Œä¼šè‡ªåŠ¨å¼€å§‹å¯¹å“ˆå¸Œè¡¨ç¼©å®¹ï¼›</p>
</li>
<li>
<p>Rehash è¿‡ç¨‹æ˜¯æ¸è¿›å¼çš„ï¼š</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>å¼€å§‹ Rehash åï¼Œæ¯æ¬¡å¯¹è‡ªåŠ¨è¿›è¡Œçš„æ·»åŠ ã€åˆ é™¤ã€æŸ¥æ‰¾æˆ–æ›´æ–°æ—¶ï¼Œç¨‹åºä¼šè‡ªåŠ¨å°†å¯¹åº”çš„é”®å€¼å¯¹ä» <code>ht[0]</code> Rehash åˆ° <code>ht[1]</code> ä¸Šï¼›rehashidx å±æ€§å€¼å¢ä¸€ã€‚</p>
</li>
<li>
<p>è®°å¾—æœ‰åå°å®šæ—¶ä»»åŠ¡æ¥è‡ªåŠ¨æ‰©å±•çš„ï¼Œæ€ä¹ˆæ²¡æœ‰çœ‹åˆ°è¯´æ˜æ–‡æ¡£ï¼Ÿ</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Redis åœ¨å“ˆå¸Œå¯¹è±¡ä¸Šçš„ç¼–ç æœ‰å¯èƒ½æ˜¯ï¼š</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ziplist</p>
</li>
<li>
<p>hashtable</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>è½¬æ¢æ¡ä»¶æ˜¯ï¼š</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>å“ˆå¸Œå¯¹è±¡ä¿å­˜çš„æ‰€æœ‰å‰‘æŒ‡å¯¹è±¡å­—ç¬¦ä¸²é•¿åº¦éƒ½å°äº 64 ä¸ªå­—èŠ‚ï¼›ï¼ˆé€šè¿‡å‚æ•° <code>hash-max-ziplist-value</code> æ¥è°ƒèŠ‚ï¼Œé»˜è®¤ä¸º 64ï¼‰</p>
</li>
<li>
<p>å“ˆå¸Œå¯¹è±¡ä¿å­˜çš„å‰‘æŒ‡å¯¹æ•°é‡å°äº 512 ä¸ªï¼›ï¼ˆé€šè¿‡å‚æ•° <code>hash-max-ziplist-entries</code> æ¥è°ƒèŠ‚ï¼Œé»˜è®¤ä¸º 512ï¼‰</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
</pre></td><td class="code"><pre>127.0.0.1:6379&gt; HMSET profie <span class="s2">"name"</span> <span class="s2">"diguage"</span> <span class="s2">"age"</span> 20 <span class="s2">"job"</span> <span class="s2">"Developer"</span>
OK
127.0.0.1:6379&gt; OBJECT encoding profie
<span class="s2">"ziplist"</span>
127.0.0.1:6379&gt; HMSET profile address 1234567890123456789012345678901234567890123456789012345678901234
OK
127.0.0.1:6379&gt; OBJECT encoding profile
<span class="s2">"ziplist"</span>
127.0.0.1:6379&gt; HMSET profile address 1234567890123456789012345678901234567890123456789012345678901234S
OK
127.0.0.1:6379&gt; OBJECT encoding profile
<span class="s2">"hashtable"</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>é€šè¿‡ <code>t_hash.c/hashTypeConvertZiplist</code> æ–¹æ³•æ¥è½¬æ¢ã€‚</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_å‚è€ƒèµ„æ–™_5"><a class="anchor" href="#_å‚è€ƒèµ„æ–™_5"></a>25.3. å‚è€ƒèµ„æ–™</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzA4NTg1MjM0Mg==&amp;mid=2657261203&amp;idx=1&amp;sn=f7ff61ce42e29b874a8026683875bbb1&amp;scene=21#wechat_redirect">Rediså†…éƒ¨æ•°æ®ç»“æ„è¯¦è§£(1)â€”â€”dict</a></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_ç®€ä»‹"><a class="anchor" href="#_ç®€ä»‹"></a>25.4. ç®€ä»‹</h3>
<div class="paragraph">
<p>HashMapæ˜¯åŸºäºå“ˆå¸Œè¡¨å®ç°çš„ï¼Œç”¨æ¥å­˜å‚¨key-valueå½¢å¼çš„é”®å€¼å¯¹ï¼Œå…è®¸keyå’Œvalueéƒ½ä¸ºnullå€¼ï¼›
HashMapæ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼Œåªæ˜¯ç”¨äºå•çº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¯ä»¥é‡‡ç”¨concurrentå¹¶å‘åŒ…ä¸‹çš„concurrentHashMapï¼›
HashMapå®ç°äº†Serializableæ¥å£ï¼Œæ”¯æŒåºåˆ—åŒ–ï¼Œå®ç°äº†Cloneableæ¥å£ï¼Œèƒ½è¢«å…‹éš†ã€‚</p>
</div>
</div>
<div class="sect2">
<h3 id="_ç­¾å"><a class="anchor" href="#_ç­¾å"></a>25.5. ç­¾å</h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span>
    <span class="kd">extends</span> <span class="nc">AbstractMap</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span>
    <span class="kd">implements</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;,</span> <span class="nc">Cloneable</span><span class="o">,</span> <span class="nc">Serializable</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>å¯ä»¥çœ‹åˆ°HashMap å®ç°äº†Cloneableå’ŒSerializableæ ‡è®°æ¥å£ï¼š</p>
</div>
<div class="ulist">
<ul>
<li>
<p>æ ‡è®°æ¥å£Cloneableï¼Œç”¨äºè¡¨æ˜HashMapå¯¹è±¡ä¼šé‡å†™java.lang.Object#clone()æ–¹æ³•ï¼ŒHashMapå®ç°çš„æ˜¯æµ…æ‹·è´ï¼ˆshallow copyï¼‰ã€‚</p>
</li>
<li>
<p>æ ‡è®°æ¥å£Serializableï¼Œç”¨äºè¡¨æ˜HashMapå¯¹è±¡å¯ä»¥è¢«åºåˆ—åŒ–ã€‚</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>HashMapç»§æ‰¿äº†AbstractMapæŠ½è±¡ç±»ï¼ŒåŒæ—¶ä¹Ÿå®ç°äº†Mapæ¥å£ã€‚</strong></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
åœ¨è¯­æ³•å±‚é¢ç»§æ‰¿æ¥å£Mapæ˜¯å¤šä½™çš„ï¼Œè¿™ä¹ˆåšä»…ä»…æ˜¯ä¸ºäº†è®©é˜…è¯»ä»£ç çš„äººæ˜ç¡®çŸ¥é“HashMapæ˜¯å±äºMapä½“ç³»çš„ï¼Œèµ·åˆ°äº†æ–‡æ¡£çš„ä½œç”¨ã€‚
AbstractMapç›¸å½“äºä¸ªè¾…åŠ©ç±»ï¼ŒMapçš„ä¸€äº›æ“ä½œè¿™é‡Œé¢å·²ç»æä¾›äº†é»˜è®¤å®ç°ï¼Œåé¢å…·ä½“çš„å­ç±»å¦‚æœæ²¡æœ‰ç‰¹æ®Šè¡Œä¸ºï¼Œå¯ç›´æ¥ä½¿ç”¨AbstractMapæä¾›çš„å®ç°ã€‚
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>AbstractMapç›¸å½“äºä¸ªè¾…åŠ©ç±»ï¼ŒMapçš„ä¸€äº›æ“ä½œè¿™é‡Œé¢å·²ç»æä¾›äº†é»˜è®¤å®ç°ï¼Œåé¢å…·ä½“çš„å­ç±»å¦‚æœæ²¡æœ‰ç‰¹æ®Šè¡Œä¸ºï¼Œå¯ç›´æ¥ä½¿ç”¨AbstractMapæä¾›çš„å®ç°ã€‚</p>
</div>
<div class="paragraph">
<p>æ¥å£java.util.Map,ä¸»è¦æœ‰å››ä¸ªå¸¸ç”¨çš„å®ç°ç±»ï¼Œåˆ†åˆ«æ˜¯HashMapã€Hashtableã€LinkedHashMapå’ŒTreeMapï¼Œç±»ç»§æ‰¿å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/map_structure.png" alt="map structure">
</div>
</div>
<div class="paragraph">
<p>ä¸‹é¢é’ˆå¯¹å„ä¸ªå®ç°ç±»çš„ç‰¹ç‚¹åšä¸€äº›è¯´æ˜ï¼š</p>
</div>
<div class="paragraph">
<p>(1) HashMapï¼šå®ƒæ ¹æ®é”®çš„hashCodeå€¼å­˜å‚¨æ•°æ®ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹å¯ä»¥ç›´æ¥å®šä½åˆ°å®ƒçš„å€¼ï¼Œå› è€Œå…·æœ‰å¾ˆå¿«çš„è®¿é—®é€Ÿåº¦ï¼Œä½†éå†é¡ºåºå´æ˜¯ä¸ç¡®å®šçš„ã€‚<br>
HashMapæœ€å¤šåªå…è®¸ä¸€æ¡è®°å½•çš„é”®ä¸ºnullï¼Œå…è®¸å¤šæ¡è®°å½•çš„å€¼ä¸ºnullã€‚HashMapéçº¿ç¨‹å®‰å…¨ï¼Œå³ä»»ä¸€æ—¶åˆ»å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶å†™HashMapï¼Œ<br>
å¯èƒ½ä¼šå¯¼è‡´æ•°æ®çš„ä¸ä¸€è‡´ã€‚å¦‚æœéœ€è¦æ»¡è¶³çº¿ç¨‹å®‰å…¨ï¼Œå¯ä»¥ç”¨ Collectionsçš„synchronizedMapæ–¹æ³•ä½¿HashMapå…·æœ‰çº¿ç¨‹å®‰å…¨çš„èƒ½åŠ›ï¼Œ<br>
æˆ–è€…ä½¿ç”¨ConcurrentHashMapã€‚</p>
</div>
<div class="paragraph">
<p>(2) Hashtableï¼šHashtableæ˜¯é—ç•™ç±»ï¼Œå¾ˆå¤šæ˜ å°„çš„å¸¸ç”¨åŠŸèƒ½ä¸HashMapç±»ä¼¼ï¼Œä¸åŒçš„æ˜¯å®ƒæ‰¿è‡ªDictionaryç±»ï¼Œå¹¶ä¸”æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œ<br>
ä»»ä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å†™Hashtableï¼Œå¹¶å‘æ€§ä¸å¦‚ConcurrentHashMapï¼Œå› ä¸ºConcurrentHashMapå¼•å…¥äº†åˆ†æ®µé”ã€‚<br>
Hashtableä¸å»ºè®®åœ¨æ–°ä»£ç ä¸­ä½¿ç”¨ï¼Œä¸éœ€è¦çº¿ç¨‹å®‰å…¨çš„åœºåˆå¯ä»¥ç”¨HashMapæ›¿æ¢ï¼Œéœ€è¦çº¿ç¨‹å®‰å…¨çš„åœºåˆå¯ä»¥ç”¨ConcurrentHashMapæ›¿æ¢ã€‚<br></p>
</div>
<div class="paragraph">
<p>(3) LinkedHashMapï¼šLinkedHashMapæ˜¯HashMapçš„ä¸€ä¸ªå­ç±»ï¼Œä¿å­˜äº†è®°å½•çš„æ’å…¥é¡ºåºï¼Œåœ¨ç”¨Iteratoréå†LinkedHashMapæ—¶ï¼Œå…ˆå¾—åˆ°çš„è®°å½•è‚¯å®šæ˜¯å…ˆæ’å…¥çš„ï¼Œä¹Ÿå¯ä»¥åœ¨æ„é€ æ—¶å¸¦å‚æ•°ï¼ŒæŒ‰ç…§è®¿é—®æ¬¡åºæ’åºã€‚</p>
</div>
<div class="paragraph">
<p>(4) TreeMapï¼šTreeMapå®ç°SortedMapæ¥å£ï¼Œèƒ½å¤ŸæŠŠå®ƒä¿å­˜çš„è®°å½•æ ¹æ®é”®æ’åºï¼Œé»˜è®¤æ˜¯æŒ‰é”®å€¼çš„å‡åºæ’åºï¼Œä¹Ÿå¯ä»¥æŒ‡å®šæ’åºçš„æ¯”è¾ƒå™¨ï¼Œå½“ç”¨Iteratoréå†TreeMapæ—¶ï¼Œå¾—åˆ°çš„è®°å½•æ˜¯æ’è¿‡åºçš„ã€‚å¦‚æœä½¿ç”¨æ’åºçš„æ˜ å°„ï¼Œå»ºè®®ä½¿ç”¨TreeMapã€‚åœ¨ä½¿ç”¨TreeMapæ—¶ï¼Œkeyå¿…é¡»å®ç°Comparableæ¥å£æˆ–è€…åœ¨æ„é€ TreeMapä¼ å…¥è‡ªå®šä¹‰çš„Comparatorï¼Œå¦åˆ™ä¼šåœ¨è¿è¡Œæ—¶æŠ›å‡ºjava.lang.ClassCastExceptionç±»å‹çš„å¼‚å¸¸ã€‚</p>
</div>
<div class="paragraph">
<p>å¯¹äºä¸Šè¿°å››ç§Mapç±»å‹çš„ç±»ï¼Œè¦æ±‚æ˜ å°„ä¸­çš„keyæ˜¯ä¸å¯å˜å¯¹è±¡ã€‚ä¸å¯å˜å¯¹è±¡æ˜¯è¯¥å¯¹è±¡åœ¨åˆ›å»ºåå®ƒçš„å“ˆå¸Œå€¼ä¸ä¼šè¢«æ”¹å˜ã€‚å¦‚æœå¯¹è±¡çš„å“ˆå¸Œå€¼å‘ç”Ÿå˜åŒ–ï¼ŒMapå¯¹è±¡å¾ˆå¯èƒ½å°±å®šä½ä¸åˆ°æ˜ å°„çš„ä½ç½®äº†ã€‚</p>
</div>
<div class="paragraph">
<p>é€šè¿‡ä¸Šé¢çš„æ¯”è¾ƒï¼Œæˆ‘ä»¬çŸ¥é“äº†HashMapæ˜¯Javaçš„Mapå®¶æ—ä¸­ä¸€ä¸ªæ™®é€šæˆå‘˜ï¼Œé‰´äºå®ƒå¯ä»¥æ»¡è¶³å¤§å¤šæ•°åœºæ™¯çš„ä½¿ç”¨æ¡ä»¶ï¼Œæ‰€ä»¥æ˜¯ä½¿ç”¨é¢‘åº¦æœ€é«˜çš„ä¸€ä¸ªã€‚ä¸‹æ–‡æˆ‘ä»¬ä¸»è¦ç»“åˆæºç ï¼Œä»å­˜å‚¨ç»“æ„ã€å¸¸ç”¨æ–¹æ³•åˆ†æã€æ‰©å®¹ç­‰æ–¹é¢äº†è§£ä¸€ä¸‹HashMapçš„å·¥ä½œåŸç†ã€‚</p>
</div>
</div>
<div class="sect2">
<h3 id="_å­˜å‚¨ç»“æ„"><a class="anchor" href="#_å­˜å‚¨ç»“æ„"></a>25.6. å­˜å‚¨ç»“æ„</h3>
<div class="paragraph">
<p>HashMapæ˜¯åŸºäºå“ˆå¸Œè¡¨å­˜å‚¨çš„ï¼Œåœ¨JDK1.6ï¼ŒJDK1.7ç‰ˆæœ¬é‡‡ç”¨æ•°ç»„(æ¡¶ä½) + é“¾è¡¨å®ç°å­˜å‚¨å…ƒç´ å’Œè§£å†³å†²çªï¼ŒåŒä¸€hashå€¼çš„é“¾è¡¨éƒ½å­˜å‚¨åœ¨ä¸€ä¸ªé“¾è¡¨é‡Œã€‚
ä½†æ˜¯å½“ä½äºä¸€ä¸ªæ¡¶ä¸­çš„å…ƒç´ è¾ƒå¤šï¼Œå³hashå€¼ç›¸ç­‰çš„å…ƒç´ è¾ƒå¤šæ—¶ï¼Œé€šè¿‡keyå€¼ä¾æ¬¡æŸ¥æ‰¾çš„æ•ˆç‡è¾ƒä½ã€‚ä½†æ˜¯åˆ°JDK1.8ç‰ˆæœ¬æ—¶HashMapé‡‡ç”¨ä½æ¡¶ + é“¾è¡¨ + çº¢é»‘æ ‘å®ç°ï¼Œ
å½“é“¾è¡¨é•¿åº¦è¶…è¿‡é˜ˆå€¼ï¼ˆ8ï¼‰æ—¶ï¼Œå°†é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼Œè¿™æ ·å¤§å¤§å‡å°‘äº†æŸ¥æ‰¾æ—¶é—´ã€‚</p>
</div>
</div>
<div class="sect2">
<h3 id="_å®ç°åŸç†"><a class="anchor" href="#_å®ç°åŸç†"></a>25.7. å®ç°åŸç†</h3>
<div class="paragraph">
<p>é¦–å…ˆæœ‰ä¸€ä¸ªå…ƒç´ æ˜¯é“¾è¡¨çš„æ•°ç»„ï¼Œå½“æ·»åŠ ä¸€ä¸ªå…ƒç´ ï¼ˆkey-valueï¼‰æ—¶ï¼Œå°±é¦–å…ˆè®¡ç®—å…ƒç´ keyçš„hashå€¼ï¼Œä»¥æ­¤ç¡®å®šå…ƒç´ åœ¨æ•°ç»„ä¸­çš„ä½ç½®ï¼Œä½†æ˜¯å¯èƒ½å­˜åœ¨åŒä¸€hashå€¼çš„å…ƒç´ 
å·²ç»è¢«æ”¾åœ¨æ•°ç»„åŒä¸€ä½ç½®äº†ï¼ˆä¹Ÿå°±å‡ºç°äº†Hashå†²çªï¼‰ï¼Œè¿™æ—¶å°±æ·»åŠ åˆ°åŒä¸€hashå€¼çš„å…ƒç´ çš„åé¢ï¼Œä»–ä»¬åœ¨æ•°ç»„çš„åŒä¸€ä½ç½®ï¼Œä½†æ˜¯å½¢æˆäº†é“¾è¡¨ï¼ŒåŒä¸€ä¸ªé“¾è¡¨ä¸Šçš„Hashå€¼æ˜¯
ç›¸åŒçš„ï¼Œæ‰€ä»¥è¯´æ•°ç»„å­˜æ”¾çš„æ˜¯é“¾è¡¨ã€‚è€Œå½“é“¾è¡¨é•¿åº¦å¤ªé•¿æ—¶ï¼Œé“¾è¡¨å°±è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼Œè¿™æ ·å¤§å¤§æé«˜äº†æŸ¥æ‰¾çš„æ•ˆç‡ã€‚<br>
å½“é“¾è¡¨æ•°ç»„çš„å®¹é‡è¶…è¿‡åˆå§‹å®¹é‡çš„0.75ï¼ˆé˜€å€¼ï¼‰æ—¶ï¼Œå°†é“¾è¡¨æ•°ç»„æ‰©å¤§2å€ï¼Œç„¶åæŠŠåŸæ¥æ•°ç»„ä¸­çš„é“¾è¡¨é‡æ–°æ•£åˆ—ï¼ŒæŠŠåŸé“¾è¡¨æ•°ç»„ä¸­çš„å…ƒç´ è¿ç§»åˆ°æ–°çš„æ•°ç»„ä¸­ã€‚</p>
</div>
<div class="paragraph">
<p>HashMapåŸç†å›¾ï¼š</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/jdk1.8HashMap.png" alt="jdk1.8HashMap">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_æºç å‰–æ"><a class="anchor" href="#_æºç å‰–æ"></a>25.8. æºç å‰–æ</h3>
<div class="sect3">
<h4 id="_é‡è¦å±æ€§"><a class="anchor" href="#_é‡è¦å±æ€§"></a>25.8.1. é‡è¦å±æ€§</h4>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="cm">/**
 *  åºåˆ—å·
 */</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">362498820763181265L</span><span class="o">;</span>

<span class="cm">/**
 *  é»˜è®¤åˆå§‹å®¹é‡ï¼ˆå®¹é‡ä¸ºHashMapä¸­æ§½çš„æ•°ç›®ï¼‰æ˜¯16ï¼Œä¸”å¿…é¡»æ˜¯2çš„æ•´æ•°æ¬¡å¹‚ã€‚
 */</span>
<span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">DEFAULT_INITIAL_CAPACITY</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="o">;</span> <span class="c1">// aka 16</span>

<span class="cm">/**
 * æœ€å¤§å®¹é‡ï¼ˆå¿…é¡»æ˜¯2çš„å¹‚ä¸”å°äº2çš„30æ¬¡æ–¹ï¼Œä¼ å…¥å®¹é‡è¿‡å¤§å°†è¢«è¿™ä¸ªå€¼æ›¿æ¢ï¼‰
 */</span>
<span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">MAXIMUM_CAPACITY</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="o">;</span>

<span class="cm">/**
 * é»˜è®¤è£…è½½å› å­ä¸º0.75
 */</span>
<span class="kd">static</span> <span class="kd">final</span> <span class="kt">float</span> <span class="no">DEFAULT_LOAD_FACTOR</span> <span class="o">=</span> <span class="mf">0.75f</span><span class="o">;</span>

<span class="cm">/**
 * å½“putä¸€ä¸ªå…ƒç´ åˆ°æŸä¸ªæ¡¶ä½ï¼Œå…¶é“¾è¡¨é•¿åº¦è¾¾åˆ°8æ—¶å°†é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘
 */</span>
<span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">TREEIFY_THRESHOLD</span> <span class="o">=</span> <span class="mi">8</span><span class="o">;</span>

<span class="cm">/**
 * ä¸€ä¸ªæ¡¶ä½ä¸Šçš„é“¾è¡¨é•¿åº¦å°äºè¿™ä¸ªå€¼æ—¶å°†çº¢é»‘æ ‘è½¬é“¾è¡¨
 */</span>
<span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">UNTREEIFY_THRESHOLD</span> <span class="o">=</span> <span class="mi">6</span><span class="o">;</span>

<span class="cm">/**
 * æ ‘çš„æœ€å°çš„å®¹é‡ï¼Œè‡³å°‘æ˜¯ 4 x TREEIFY_THRESHOLD = 32
 * ç„¶åä¸ºäº†é¿å…(resizing å’Œ treeification thresholds) è®¾ç½®æˆ64
 */</span>
<span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">MIN_TREEIFY_CAPACITY</span> <span class="o">=</span> <span class="mi">64</span><span class="o">;</span>

<span class="cm">/**
 * å®é™…å­˜æ”¾å…ƒç´ çš„ä¸ªæ•°ï¼Œä¸ç­‰äºæ•°ç»„çš„é•¿åº¦
 */</span>
<span class="kd">transient</span> <span class="kt">int</span> <span class="n">size</span><span class="o">;</span>

<span class="cm">/**
 * è¾¾åˆ°è¿™ä¸ªé˜ˆå€¼å°±è¦è¿›è¡Œæ‰©å®¹ï¼Œå…¶ç­‰äºå®¹é‡ * è£…è½½å› å­
 */</span>
<span class="kt">int</span> <span class="n">threshold</span><span class="o">;</span>

<span class="cm">/**
 * å®é™…è£…è½½å› å­
 */</span>
<span class="kd">final</span> <span class="kt">float</span> <span class="n">loadFactor</span><span class="o">;</span>

<span class="cm">/**
 * æ¯æ¬¡æ‰©å®¹å’Œæ›´æ”¹mapç»“æ„çš„è®¡æ•°å™¨
 * å¦‚æœåœ¨ä½¿ç”¨è¿­ä»£å™¨çš„è¿‡ç¨‹ä¸­æœ‰å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†mapï¼Œå°†æŠ›å‡ºConcurrentModificationExceptionï¼Œ
 * è¿™å°±æ˜¯æ‰€è°“fail-fastç­–ç•¥ï¼ˆé€Ÿé”™ï¼‰ï¼Œè¿™ä¸€ç­–ç•¥çš„å®ç°å°±æ˜¯é€šè¿‡modCount
 */</span>
<span class="kd">transient</span> <span class="kt">int</span> <span class="n">modCount</span><span class="o">;</span>

<span class="cm">/*
 * å­˜æ”¾å…·ä½“key-valueå¯¹å…ƒç´ çš„é›†å’Œ
 */</span>
<span class="kd">transient</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">entrySet</span><span class="o">;</span>

<span class="cm">/*
 * å­˜å‚¨å…ƒç´ çš„æ•°ç»„ï¼Œæ€»æ˜¯2çš„å¹‚æ¬¡å€
 */</span>
<span class="kd">transient</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;[]</span> <span class="n">table</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">åŠ è½½å› å­</div>
<div class="paragraph">
<p>åŠ è½½å› å­ï¼ˆé»˜è®¤0.75ï¼‰ï¼šä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨åŠ è½½å› å­ï¼Œä¸ºä»€ä¹ˆéœ€è¦æ‰©å®¹å‘¢ï¼Ÿå› ä¸ºå¦‚æœåŠ è½½å› å­å¾ˆå¤§ï¼Œ
è¯´æ˜åˆ©ç”¨çš„ç©ºé—´å¾ˆå¤šï¼Œå¦‚æœä¸€ç›´ä¸è¿›è¡Œæ‰©å®¹çš„è¯ï¼Œé“¾è¡¨å°±ä¼šè¶Šæ¥è¶Šé•¿ï¼Œè¿™æ ·æŸ¥æ‰¾çš„æ•ˆç‡å¾ˆä½ï¼Œ
å› ä¸ºé“¾è¡¨çš„é•¿åº¦å¾ˆå¤§ï¼ˆå½“ç„¶æœ€æ–°ç‰ˆæœ¬ä½¿ç”¨äº†çº¢é»‘æ ‘åä¼šæ”¹è¿›å¾ˆå¤šï¼‰ï¼Œæ‰©å®¹ä¹‹åï¼Œå°†åŸæ¥é“¾è¡¨æ•°
ç»„çš„æ¯ä¸€ä¸ªé“¾è¡¨åˆ†æˆå¥‡å¶ä¸¤ä¸ªå­é“¾è¡¨åˆ†åˆ«æŒ‚åœ¨æ–°é“¾è¡¨æ•°ç»„çš„æ•£åˆ—ä½ç½®ï¼Œè¿™æ ·å°±å‡å°‘äº†æ¯ä¸ªé“¾è¡¨
çš„é•¿åº¦ï¼Œå¢åŠ æŸ¥æ‰¾æ•ˆç‡ã€‚HashMapæœ¬æ¥æ˜¯ä»¥ç©ºé—´æ¢æ—¶é—´ï¼Œæ‰€ä»¥è£…è½½å› å­æ²¡å¿…è¦å¤ªå¤§ã€‚ä½†æ˜¯è£…è½½å› å­å¤ªå°
åˆä¼šå¯¼è‡´ç©ºé—´æµªè´¹ã€‚å¦‚æœå…³æ³¨å†…å­˜ï¼Œè£…è½½å› å­å¯ä»¥ç¨å¤§ï¼Œå¦‚æœä¸»è¦å…³æ³¨æŸ¥æ‰¾æ€§èƒ½ï¼Œè£…è½½å› å­å¯ä»¥ç¨å°ã€‚</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_æ•°æ®ç»“æ„"><a class="anchor" href="#_æ•°æ®ç»“æ„"></a>25.8.2. æ•°æ®ç»“æ„</h4>
<div class="ulist">
<ul>
<li>
<p>æ¡¶ä½æ•°ç»„</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="cm">/**
 * 1.å­˜å‚¨å…ƒç´ ï¼ˆæ¡¶ä½ï¼‰çš„æ•°ç»„
 */</span>
<span class="kd">transient</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="n">k</span><span class="o">,</span><span class="n">v</span><span class="o">&gt;[]</span> <span class="n">table</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>æ•°ç»„å…ƒç´ Node&lt;K,V&gt;</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="c1">//Nodeæ˜¯å•å‘é“¾è¡¨ï¼Œå®ƒå®ç°äº†Map.Entryæ¥å£</span>
<span class="kd">static</span> <span class="kd">class</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">hash</span><span class="o">;</span>
    <span class="kd">final</span> <span class="no">K</span> <span class="n">key</span><span class="o">;</span>
    <span class="no">V</span> <span class="n">value</span><span class="o">;</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">;</span>  <span class="c1">//ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span>

    <span class="nc">Node</span><span class="o">(</span><span class="kt">int</span> <span class="n">hash</span><span class="o">,</span> <span class="no">K</span> <span class="n">key</span><span class="o">,</span> <span class="no">V</span> <span class="n">value</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">hash</span> <span class="o">=</span> <span class="n">hash</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="no">K</span> <span class="nf">getKey</span><span class="o">()</span>        <span class="o">{</span> <span class="k">return</span> <span class="n">key</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="no">V</span> <span class="nf">getValue</span><span class="o">()</span>      <span class="o">{</span> <span class="k">return</span> <span class="n">value</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">key</span> <span class="o">+</span> <span class="s">"="</span> <span class="o">+</span> <span class="n">value</span><span class="o">;</span> <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Objects</span><span class="o">.</span><span class="na">hashCode</span><span class="o">(</span><span class="n">key</span><span class="o">)</span> <span class="o">^</span> <span class="nc">Objects</span><span class="o">.</span><span class="na">hashCode</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="no">V</span> <span class="nf">setValue</span><span class="o">(</span><span class="no">V</span> <span class="n">newValue</span><span class="o">)</span> <span class="o">{</span>
        <span class="no">V</span> <span class="n">oldValue</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">newValue</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">oldValue</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="k">this</span><span class="o">)</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;?,?&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;?,?&gt;)</span><span class="n">o</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getKey</span><span class="o">())</span> <span class="o">&amp;&amp;</span>
                    <span class="nc">Objects</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getValue</span><span class="o">()))</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
å…¶å®Nodeå°±æ˜¯ä¸€ä¸ªåŸºäºå•å‘é“¾è¡¨æ•°æ®ç»“æ„çš„å­˜å‚¨keyå’Œvalueçš„ä¸€ä¸ªå¯¹è±¡ã€‚nextæŒ‡å‘ä¸‹ä¸€ä¸ªNode.å®ç°äº†Map.Entryæ¥å£
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>çº¢é»‘æ ‘</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">LinkedHashMap</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="n">k</span><span class="o">,</span><span class="n">v</span><span class="o">&gt;</span> <span class="n">parent</span><span class="o">;</span>  <span class="c1">//çˆ¶èŠ‚ç‚¹</span>
    <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="n">k</span><span class="o">,</span><span class="n">v</span><span class="o">&gt;</span> <span class="n">left</span><span class="o">;</span>    <span class="c1">//å·¦å­æ ‘</span>
    <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="n">k</span><span class="o">,</span><span class="n">v</span><span class="o">&gt;</span> <span class="n">right</span><span class="o">;</span>   <span class="c1">//å³å­æ ‘</span>
    <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="n">k</span><span class="o">,</span><span class="n">v</span><span class="o">&gt;</span> <span class="n">prev</span><span class="o">;</span>    <span class="c1">// needed to unlink next upon deletion</span>
    <span class="kt">boolean</span> <span class="n">red</span><span class="o">;</span>           <span class="c1">//é¢œè‰²å±æ€§</span>
    <span class="nc">TreeNode</span><span class="o">(</span><span class="kt">int</span> <span class="n">hash</span><span class="o">,</span> <span class="no">K</span> <span class="n">key</span><span class="o">,</span> <span class="no">V</span> <span class="n">val</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">hash</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">val</span><span class="o">,</span> <span class="n">next</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * è¿”å›å½“å‰èŠ‚ç‚¹çš„æ ¹èŠ‚ç‚¹
     */</span>
    <span class="kd">final</span> <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="nf">root</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="k">this</span><span class="o">,</span> <span class="n">p</span><span class="o">;;)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">parent</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">return</span> <span class="n">r</span><span class="o">;</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">transient å…³é”®å­—</div>
<div class="paragraph">
<p>Javaåºåˆ—åŒ–ä¼šæŠŠæŸä¸€ä¸ªç±»å­˜å‚¨ä»¥æ–‡ä»¶å½¢å¼å­˜å‚¨åœ¨ç‰©ç†ç©ºé—´ï¼Œä½†æ˜¯ä»¥æ–‡ä»¶å½¢å¼å­˜å‚¨æŸäº›ä¿¡æ¯æ—¶ï¼Œå®¹æ˜“æ¶‰åŠåˆ°å®‰å…¨é—®é¢˜ï¼Œå› ä¸ºæ•°æ®ä½äºJavaè¿è¡Œç¯å¢ƒä¹‹å¤–ï¼Œ
ä¸åœ¨Javaå®‰å…¨æœºåˆ¶çš„æ§åˆ¶ä¹‹ä¸­ã€‚å¯¹äºè¿™äº›éœ€è¦ä¿å¯†çš„å­—æ®µï¼Œä¸åº”ä¿å­˜åœ¨æ°¸ä¹…ä»‹è´¨ä¸­ ï¼Œæˆ–è€…ä¸åº”ç®€å•åœ°ä¸åŠ å¤„ç†åœ°ä¿å­˜ä¸‹æ¥ ï¼Œä¸ºäº†ä¿è¯å®‰å…¨æ€§ã€‚
åº”è¯¥åœ¨è¿™äº›å­—æ®µå‰åŠ ä¸Štransientå…³é”®å­—ã€‚å®ƒçš„æ„æ€æ˜¯ä¸´æ—¶çš„ï¼Œå³ä¸ä¼šéšç±»ä¸€èµ·åºåˆ—åŒ–åˆ°æœ¬åœ°ï¼Œæ‰€ä»¥å½“è¿˜åŸåï¼Œè¿™ä¸ªå…³é”®å­—å®šä¹‰çš„å˜é‡ä¹Ÿå°±ä¸å†å­˜åœ¨ã€‚</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_æ„é€ å‡½æ•°"><a class="anchor" href="#_æ„é€ å‡½æ•°"></a>25.8.3. æ„é€ å‡½æ•°</h4>
<div class="ulist">
<ul>
<li>
<p>é»˜è®¤æ„é€ å‡½æ•°HashMap()</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="nf">HashMap</span><span class="o">()</span> <span class="o">{</span>
  <span class="c1">//åˆå§‹è¯åŠ è½½å› å­ä¸ºé»˜è®¤0.75ï¼›å…¶ä»–å±æ€§å‡ä¸ºé»˜è®¤</span>
  <span class="k">this</span><span class="o">.</span><span class="na">loadFactor</span> <span class="o">=</span> <span class="no">DEFAULT_LOAD_FACTOR</span><span class="o">;</span> <span class="c1">// all other fields defaulted</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
è¿™æ˜¯ä¸€ä¸ªé»˜è®¤æ„é€ å™¨ï¼Œæ½œåœ¨çš„é—®é¢˜æ˜¯åˆå§‹å®¹é‡16å¤ªå°äº†ï¼Œå¯èƒ½ä¸­é—´éœ€è¦ä¸æ–­æ‰©å®¹çš„é—®é¢˜ï¼Œä¼šå½±å“æ’å…¥çš„æ•ˆç‡ã€‚
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>æŒ‡å®šåˆå§‹å®¹é‡å’ŒåŠ è½½å› å­çš„æ„é€ å‡½æ•°HashMap(int, float)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="nf">HashMap</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="kt">float</span> <span class="n">loadFactor</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//åˆå§‹å®¹é‡ä¸èƒ½å°äº0</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">initialCapacity</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Illegal initial capacity: "</span> <span class="o">+</span>
                <span class="n">initialCapacity</span><span class="o">);</span>
    <span class="c1">// åˆå§‹å®¹é‡ä¸èƒ½å¤§äºæœ€å¤§å€¼ï¼Œå¦åˆ™ä¸ºæœ€å¤§å€¼</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">initialCapacity</span> <span class="o">&gt;</span> <span class="no">MAXIMUM_CAPACITY</span><span class="o">)</span>
        <span class="n">initialCapacity</span> <span class="o">=</span> <span class="no">MAXIMUM_CAPACITY</span><span class="o">;</span>
    <span class="c1">// å¡«å……å› å­ä¸èƒ½å°äºæˆ–ç­‰äº0ï¼Œä¸èƒ½ä¸ºéæ•°å­—</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">loadFactor</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="nc">Float</span><span class="o">.</span><span class="na">isNaN</span><span class="o">(</span><span class="n">loadFactor</span><span class="o">))</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Illegal load factor: "</span> <span class="o">+</span>
                <span class="n">loadFactor</span><span class="o">);</span>
    <span class="c1">//åˆå§‹è¯åŠ è½½å› å­</span>
    <span class="k">this</span><span class="o">.</span><span class="na">loadFactor</span> <span class="o">=</span> <span class="n">loadFactor</span><span class="o">;</span>
    <span class="c1">//åˆå§‹åŒ–(é˜€å€¼)thresholdï¼Œæ•°ç»„å…ƒç´ æ•°é‡è¾¾åˆ°è¯¥å€¼æ—¶ä¼šæ‰©å®¹</span>
    <span class="k">this</span><span class="o">.</span><span class="na">threshold</span> <span class="o">=</span> <span class="n">tableSizeFor</span><span class="o">(</span><span class="n">initialCapacity</span><span class="o">);</span>
<span class="o">}</span>

<span class="cm">/**
 * tableSizeForçš„åŠŸèƒ½ä¸»è¦æ˜¯ç”¨æ¥ä¿è¯å®¹é‡åº”è¯¥å¤§äºcap,ä¸”ä¸º2çš„æ•´æ•°
 */</span>
<span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">tableSizeFor</span><span class="o">(</span><span class="kt">int</span> <span class="n">cap</span><span class="o">)</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">cap</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
      <span class="n">n</span> <span class="o">|=</span> <span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">;</span>
      <span class="n">n</span> <span class="o">|=</span> <span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">2</span><span class="o">;</span>
      <span class="n">n</span> <span class="o">|=</span> <span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">4</span><span class="o">;</span>
      <span class="n">n</span> <span class="o">|=</span> <span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">8</span><span class="o">;</span>
      <span class="n">n</span> <span class="o">|=</span> <span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">16</span><span class="o">;</span>
      <span class="k">return</span> <span class="o">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="no">MAXIMUM_CAPACITY</span><span class="o">)</span> <span class="o">?</span> <span class="no">MAXIMUM_CAPACITY</span> <span class="o">:</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="qlist qanda">
<ol>
<li>
<p><em>è¿™é‡Œå¯èƒ½è¿˜æœ‰ä¸€ä¸ªç–‘é—®ï¼Œæ˜æ˜ç»™çš„æ˜¯åˆå§‹å®¹é‡ï¼Œä¸ºä»€ä¹ˆè¦è®¡ç®—é˜€å€¼ï¼Œè€Œä¸æ˜¯å®¹é‡å‘¢ï¼Ÿ</em></p>
<p>å…¶å®è¿™ä¹Ÿæ˜¯jdk1.8çš„æ”¹å˜ï¼Œå®ƒå°†tableçš„åˆå§‹åŒ–æ”¾å…¥äº†resize()ä¸­ï¼Œè€Œä¸”å‹æ ¹å°±æ²¡æœ‰capacityè¿™ä¸ªå±æ€§ï¼Œ
æ‰€ä»¥è¿™é‡Œåªèƒ½é‡æ–°è®¡ç®—thresholdï¼Œè€Œresize()åé¢å°±ä¼šæ ¹æ®thresholdæ¥é‡æ–°è®¡ç®—capacityï¼Œæ¥è¿›è¡Œ
tableæ•°ç»„çš„åˆå§‹åŒ–ï¼Œç„¶ååœ¨é‡æ–°æŒ‰ç…§è£…è½½å› å­è®¡ç®—thresholdã€‚</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
å¯ä»¥æŒ‡å®šåˆå§‹å®¹é‡ï¼Œä»¥åŠè£…è½½å› å­ï¼Œä½†æ˜¯ä¸€èˆ¬æƒ…å†µä¸‹æŒ‡å®šè£…è½½å› å­æ„ä¹‰ä¸å¤§ï¼Œé‡‡ç”¨é»˜è®¤0.75å°±å¯ä»¥ã€‚
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>æŒ‡å®šåˆå§‹å®¹é‡çš„æ„é€ å‡½æ•°HashMap(int initialCapacity)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="nf">HashMap</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(</span><span class="n">initialCapacity</span><span class="o">,</span> <span class="no">DEFAULT_LOAD_FACTOR</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
ç”¨è¿™ç§æ„é€ å‡½æ•°åˆ›å»ºHashMapçš„å¯¹è±¡ï¼Œå¦‚æœçŸ¥é“mapè¦å­˜æ”¾çš„å…ƒç´ ä¸ªæ•°ï¼Œå¯ä»¥ç›´æ¥æŒ‡å®šå®¹é‡çš„å¤§å°ï¼Œ
å‡é™¤ä¸åœçš„æ‰©å®¹ï¼Œæé«˜æ•ˆç‡
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>å°†å·²æœ‰Mapæ”¾å…¥å½“å‰mapçš„æ„é€ å‡½æ•°HashMap(Map&lt;? extends K, ? extends V&gt; m)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="nf">HashMap</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">m</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">this</span><span class="o">.</span><span class="na">loadFactor</span> <span class="o">=</span> <span class="no">DEFAULT_LOAD_FACTOR</span><span class="o">;</span>  <span class="c1">//åˆå§‹åŒ–åŠ è½½å› å­</span>
   <span class="n">putMapEntries</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">// å…¶å®å°±æ˜¯ä¸€ä¸ªä¸€ä¸ªå–å‡ºmä¸­çš„å…ƒç´ è°ƒç”¨putVal,ä¸€ä¸ªä¸ªæ”¾å…¥tableä¸­çš„è¿‡ç¨‹ã€‚</span>
<span class="kd">final</span> <span class="kt">void</span> <span class="nf">putMapEntries</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">m</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">evict</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">table</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// pre-size</span>
            <span class="kt">float</span> <span class="n">ft</span> <span class="o">=</span> <span class="o">((</span><span class="kt">float</span><span class="o">)</span><span class="n">s</span> <span class="o">/</span> <span class="n">loadFactor</span><span class="o">)</span> <span class="o">+</span> <span class="mf">1.0</span><span class="no">F</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">t</span> <span class="o">=</span> <span class="o">((</span><span class="n">ft</span> <span class="o">&lt;</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span><span class="no">MAXIMUM_CAPACITY</span><span class="o">)</span> <span class="o">?</span>
                    <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="n">ft</span> <span class="o">:</span> <span class="no">MAXIMUM_CAPACITY</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="o">)</span>
                <span class="n">threshold</span> <span class="o">=</span> <span class="n">tableSizeFor</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="o">)</span>   <span class="c1">//å¦‚æœmä¸­çš„å…ƒç´ ä¸ªæ•°å¤§äºé˜€å€¼ï¼Œè°ƒç”¨resizeè¿›è¡Œæ‰©å®¹</span>
            <span class="n">resize</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">:</span> <span class="n">m</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="no">K</span> <span class="n">key</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
            <span class="no">V</span> <span class="n">value</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
            <span class="n">putVal</span><span class="o">(</span><span class="n">hash</span><span class="o">(</span><span class="n">key</span><span class="o">),</span> <span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">evict</span><span class="o">);</span>  <span class="c1">//è°ƒç”¨putValå‘mapä¸­æ·»åŠ å…ƒç´ </span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_hashmapå­˜å–æœºåˆ¶"><a class="anchor" href="#_hashmapå­˜å–æœºåˆ¶"></a>25.8.4. HashMapå­˜å–æœºåˆ¶</h4>
<div class="sect4">
<h5 id="_1_æ·»åŠ å…ƒç´ "><a class="anchor" href="#_1_æ·»åŠ å…ƒç´ "></a>1.æ·»åŠ å…ƒç´ </h5>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="no">V</span> <span class="nf">put</span><span class="o">(</span><span class="no">K</span> <span class="n">key</span><span class="o">,</span> <span class="no">V</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">putVal</span><span class="o">(</span><span class="n">hash</span><span class="o">(</span><span class="n">key</span><span class="o">),</span> <span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>    <span class="c1">//è°ƒç”¨putVal()æ–¹æ³•</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>JDK1.8è®¡ç®—hashå€¼</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">hash</span><span class="o">(</span><span class="nc">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">h</span><span class="o">;</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">key</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="na">hashCode</span><span class="o">())</span> <span class="o">^</span> <span class="o">(</span><span class="n">h</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">16</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>JDK1.7è®¡ç®—hashå€¼</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">final</span> <span class="kt">int</span> <span class="nf">hash</span><span class="o">(</span><span class="nc">Object</span> <span class="n">k</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="n">hashSeed</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">h</span> <span class="o">&amp;&amp;</span> <span class="n">k</span> <span class="k">instanceof</span> <span class="nc">String</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">sun</span><span class="o">.</span><span class="na">misc</span><span class="o">.</span><span class="na">Hashing</span><span class="o">.</span><span class="na">stringHash32</span><span class="o">((</span><span class="nc">String</span><span class="o">)</span> <span class="n">k</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">h</span> <span class="o">^=</span> <span class="n">k</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
    <span class="n">h</span> <span class="o">^=</span> <span class="o">(</span><span class="n">h</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">20</span><span class="o">)</span> <span class="o">^</span> <span class="o">(</span><span class="n">h</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">12</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">h</span> <span class="o">^</span> <span class="o">(</span><span class="n">h</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">7</span><span class="o">)</span> <span class="o">^</span> <span class="o">(</span><span class="n">h</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">4</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
JDK1.8è®¡ç®—hashå€¼çš„æ–¹æ³•è¿›è¡Œäº†æ”¹è¿›ï¼Œå–å¾—keyçš„hashcodeåï¼Œé«˜16ä½ä¸ä½16ä½å¼‚æˆ–è¿ç®—é‡æ–°è®¡ç®—hashå€¼ã€‚
keyæœ‰å¯èƒ½æ˜¯nullï¼Œkeyä¸ºnullæ—¶ï¼Œhashå€¼ä¸º0ï¼Œæ”¾åœ¨æ•°ç»„çš„0ä½ç½®ã€‚
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">putVal()æ–¹æ³•</dt>
<dd>
<p>æ‰§è¡Œè¿‡ç¨‹å¦‚å›¾ï¼š</p>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/hashmap_put.png" alt="hashmap put">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">final</span> <span class="no">V</span> <span class="nf">putVal</span><span class="o">(</span><span class="kt">int</span> <span class="n">hash</span><span class="o">,</span> <span class="no">K</span> <span class="n">key</span><span class="o">,</span> <span class="no">V</span> <span class="n">value</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">onlyIfAbsent</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">evict</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">;</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="kt">int</span> <span class="n">n</span><span class="o">,</span> <span class="n">i</span><span class="o">;</span>
    <span class="c1">//tableæœªåˆå§‹åŒ–æˆ–è€…é•¿åº¦ä¸º0ï¼Œè¿›è¡Œæ‰©å®¹</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
        <span class="c1">//å¯ä»¥çœ‹åˆ°putå…ƒç´ æ—¶ï¼Œå¦‚æœæ•°ç»„æ²¡æœ‰åˆå§‹åŒ–ï¼Œä¼šè°ƒç”¨resize()æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ã€‚åé¢åˆ†æresize()æ–¹æ³•</span>
        <span class="n">n</span> <span class="o">=</span> <span class="o">(</span><span class="n">tab</span> <span class="o">=</span> <span class="n">resize</span><span class="o">()).</span><span class="na">length</span><span class="o">;</span>

    <span class="cm">/*
     * è¿™é‡Œå°±æ˜¯HASHç®—æ³•äº†ï¼Œç”¨æ¥å®šä½æ¡¶ä½çš„æ–¹å¼ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯é‡‡ç”¨å®¹é‡-1å’Œé”®çš„hashå€¼è¿›è¡Œä¸è¿ç®—
     * n-1,çš„åŸå› å°±æ˜¯nä¸€å®šæ˜¯ä¸€ä¸ª2çš„æ•´æ•°å¹‚ï¼Œè€Œ(n - 1) &amp; hashå…¶å®è´¨å°±æ˜¯n%hash,ä½†æ˜¯å–ä½™è¿ç®—
     * çš„æ•ˆç‡æ˜æ˜¾ä¸å¦‚ä½è¿ç®—ä¸ï¼Œå¹¶ä¸”(n - 1) &amp; hashä¹Ÿèƒ½ä¿è¯æ•£åˆ—å‡åŒ€ï¼Œä¸ä¼šäº§ç”Ÿåªæœ‰å¶æ•°ä½æœ‰å€¼çš„ç°è±¡
     */</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">tab</span><span class="o">[</span><span class="n">i</span> <span class="o">=</span> <span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">hash</span><span class="o">])</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
        <span class="cm">/*
         * å½“è¿™é‡Œæ˜¯ç©ºæ¡¶ä½æ—¶ï¼Œå°±ç›´æ¥æ„é€ æ–°çš„NodeèŠ‚ç‚¹ï¼Œå°†å…¶æ”¾å…¥æ¡¶ä½ä¸­(æ­¤æ—¶ï¼Œè¿™ä¸ªç»“ç‚¹æ˜¯æ”¾åœ¨æ•°ç»„ä¸­)
         * newNode()æ–¹æ³•ï¼Œå°±æ˜¯å¯¹new Node(,,,)çš„åŒ…è£…,åŒæ—¶ä¹Ÿå¯ä»¥çœ‹åˆ°Nodeä¸­çš„hashå€¼å°±æ˜¯é‡æ–°è®¡ç®—çš„hash(key)
         */</span>
        <span class="n">tab</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">(</span><span class="n">hash</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="k">else</span> <span class="o">{</span>
        <span class="c1">//æ¡¶ä¸­å·²ç»å­˜åœ¨å…ƒç´ </span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span><span class="o">;</span> <span class="no">K</span> <span class="n">k</span><span class="o">;</span>
        <span class="c1">// æ¯”è¾ƒæ¡¶ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ (æ•°ç»„ä¸­çš„ç»“ç‚¹)çš„hashå€¼ç›¸ç­‰ï¼Œkeyç›¸ç­‰</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">hash</span> <span class="o">&amp;&amp;</span> <span class="o">((</span><span class="n">k</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">key</span> <span class="o">||</span> <span class="o">(</span><span class="n">key</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">k</span><span class="o">))))</span>
            <span class="c1">//æ¯”è¾ƒæ¡¶ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ (æ•°ç»„ä¸­çš„ç»“ç‚¹)çš„hashå€¼ç›¸ç­‰ï¼Œkeyç›¸ç­‰</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">p</span> <span class="k">instanceof</span> <span class="nc">TreeNode</span><span class="o">)</span>
            <span class="c1">// hashå€¼ä¸ç›¸ç­‰ï¼Œå³keyä¸ç›¸ç­‰ï¼›ä¸ºçº¢é»‘æ ‘ç»“ç‚¹</span>
            <span class="n">e</span> <span class="o">=</span> <span class="o">((</span><span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;)</span><span class="n">p</span><span class="o">).</span><span class="na">putTreeVal</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span> <span class="n">hash</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>  <span class="c1">// æ”¾å…¥æ ‘ä¸­</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// ä¸ºé“¾è¡¨ç»“ç‚¹</span>
            <span class="c1">// åœ¨é“¾è¡¨æœ€æœ«æ’å…¥ç»“ç‚¹</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">binCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="o">;</span> <span class="o">++</span><span class="n">binCount</span><span class="o">)</span> <span class="o">{</span>
              <span class="c1">// åˆ°è¾¾é“¾è¡¨çš„å°¾éƒ¨</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// åœ¨å°¾éƒ¨æ’å…¥æ–°ç»“ç‚¹</span>
                    <span class="n">p</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">(</span><span class="n">hash</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                    <span class="c1">// ç»“ç‚¹æ•°é‡è¾¾åˆ°é˜ˆå€¼ï¼Œè½¬åŒ–ä¸ºçº¢é»‘æ ‘</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">binCount</span> <span class="o">&gt;=</span> <span class="no">TREEIFY_THRESHOLD</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="c1">// -1 for 1st</span>
                        <span class="n">treeifyBin</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">hash</span><span class="o">);</span>
                    <span class="k">break</span><span class="o">;</span> <span class="c1">// è·³å‡ºå¾ªç¯</span>
                <span class="o">}</span>
                <span class="c1">// åˆ¤æ–­é“¾è¡¨ä¸­ç»“ç‚¹çš„keyå€¼ä¸æ’å…¥çš„å…ƒç´ çš„keyå€¼æ˜¯å¦ç›¸ç­‰</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">hash</span> <span class="o">&amp;&amp;</span> <span class="o">((</span><span class="n">k</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">key</span> <span class="o">||</span> <span class="o">(</span><span class="n">key</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">k</span><span class="o">))))</span>
                    <span class="k">break</span><span class="o">;</span>   <span class="c1">// ç›¸ç­‰ï¼Œè·³å‡ºå¾ªç¯</span>
                <span class="c1">// ç”¨äºéå†æ¡¶ä¸­çš„é“¾è¡¨ï¼Œä¸å‰é¢çš„e = p.nextç»„åˆï¼Œå¯ä»¥éå†é“¾è¡¨</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">// è¡¨ç¤ºåœ¨æ¡¶ä¸­æ‰¾åˆ°keyå€¼ã€hashå€¼ä¸æ’å…¥å…ƒç´ ç›¸ç­‰çš„ç»“ç‚¹</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// existing mapping for key</span>
            <span class="no">V</span> <span class="n">oldValue</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>  <span class="c1">// è®°å½•eçš„value</span>
            <span class="c1">// onlyIfAbsentä¸ºfalseæˆ–è€…æ—§å€¼ä¸ºnull</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">onlyIfAbsent</span> <span class="o">||</span> <span class="n">oldValue</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="n">e</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>  <span class="c1">//ç”¨æ–°å€¼æ›¿æ¢æ—§å€¼</span>
            <span class="n">afterNodeAccess</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>   <span class="c1">// è®¿é—®åå›è°ƒ</span>
            <span class="k">return</span> <span class="n">oldValue</span><span class="o">;</span>      <span class="c1">// è¿”å›æ—§å€¼</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">// ç»“æ„æ€§ä¿®æ”¹</span>
    <span class="o">++</span><span class="n">modCount</span><span class="o">;</span>
    <span class="c1">// å®é™…å¤§å°å¤§äºé˜ˆå€¼åˆ™æ‰©å®¹</span>
    <span class="k">if</span> <span class="o">(++</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="o">)</span>
        <span class="n">resize</span><span class="o">();</span>
    <span class="n">afterNodeInsertion</span><span class="o">(</span><span class="n">evict</span><span class="o">);</span>  <span class="c1">// æ’å…¥åå›è°ƒ</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>  <span class="c1">// è¿”å›null</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">resize()æ–¹æ³•</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;[]</span> <span class="nf">resize</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// å½“å‰tableä¿å­˜</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;[]</span> <span class="n">oldTab</span> <span class="o">=</span> <span class="n">table</span><span class="o">;</span>
    <span class="c1">// ä¿å­˜tableå¤§å°</span>
    <span class="kt">int</span> <span class="n">oldCap</span> <span class="o">=</span> <span class="o">(</span><span class="n">oldTab</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">oldTab</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
    <span class="c1">// ä¿å­˜å½“å‰é˜ˆå€¼</span>
    <span class="kt">int</span> <span class="n">oldThr</span> <span class="o">=</span> <span class="n">threshold</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">newCap</span><span class="o">,</span> <span class="n">newThr</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="c1">// ä¹‹å‰tableå¤§å°å¤§äº0</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">oldCap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// ä¹‹å‰tableå¤§äºæœ€å¤§å®¹é‡</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">oldCap</span> <span class="o">&gt;=</span> <span class="no">MAXIMUM_CAPACITY</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// é˜ˆå€¼ä¸ºæœ€å¤§æ•´å½¢</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">;</span>
            <span class="k">return</span> <span class="n">oldTab</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// å®¹é‡ç¿»å€ï¼Œä½¿ç”¨å·¦ç§»ï¼Œæ•ˆç‡æ›´é«˜</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">((</span><span class="n">newCap</span> <span class="o">=</span> <span class="n">oldCap</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&lt;</span> <span class="no">MAXIMUM_CAPACITY</span> <span class="o">&amp;&amp;</span>
            <span class="n">oldCap</span> <span class="o">&gt;=</span> <span class="no">DEFAULT_INITIAL_CAPACITY</span><span class="o">)</span>
            <span class="c1">// é˜ˆå€¼ç¿»å€</span>
            <span class="n">newThr</span> <span class="o">=</span> <span class="n">oldThr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="o">;</span> <span class="c1">// double threshold</span>
    <span class="o">}</span>
    <span class="c1">// ä¹‹å‰é˜ˆå€¼å¤§äº0</span>
    <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">oldThr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span>
        <span class="n">newCap</span> <span class="o">=</span> <span class="n">oldThr</span><span class="o">;</span>
    <span class="c1">// oldCap = 0å¹¶ä¸”oldThr = 0ï¼Œä½¿ç”¨ç¼ºçœå€¼ï¼ˆå¦‚ä½¿ç”¨HashMap()æ„é€ å‡½æ•°ï¼Œä¹‹åå†æ’å…¥ä¸€ä¸ªå…ƒç´ ä¼šè°ƒç”¨resizeå‡½æ•°ï¼Œä¼šè¿›å…¥è¿™ä¸€æ­¥ï¼‰</span>
    <span class="k">else</span> <span class="o">{</span>
        <span class="n">newCap</span> <span class="o">=</span> <span class="no">DEFAULT_INITIAL_CAPACITY</span><span class="o">;</span>
        <span class="n">newThr</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)(</span><span class="no">DEFAULT_LOAD_FACTOR</span> <span class="o">*</span> <span class="no">DEFAULT_INITIAL_CAPACITY</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// æ–°é˜ˆå€¼ä¸º0</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">newThr</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">float</span> <span class="n">ft</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span><span class="n">newCap</span> <span class="o">*</span> <span class="n">loadFactor</span><span class="o">;</span>
        <span class="n">newThr</span> <span class="o">=</span> <span class="o">(</span><span class="n">newCap</span> <span class="o">&lt;</span> <span class="no">MAXIMUM_CAPACITY</span> <span class="o">&amp;&amp;</span> <span class="n">ft</span> <span class="o">&lt;</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span><span class="no">MAXIMUM_CAPACITY</span> <span class="o">?</span>
                  <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="n">ft</span> <span class="o">:</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">newThr</span><span class="o">;</span>
    <span class="nd">@SuppressWarnings</span><span class="o">({</span><span class="s">"rawtypes"</span><span class="o">,</span><span class="s">"unchecked"</span><span class="o">})</span>
    <span class="c1">// åˆå§‹åŒ–table</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;[]</span> <span class="n">newTab</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;[])</span><span class="k">new</span> <span class="nc">Node</span><span class="o">[</span><span class="n">newCap</span><span class="o">];</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">newTab</span><span class="o">;</span>
    <span class="c1">// ä¹‹å‰çš„tableå·²ç»åˆå§‹åŒ–è¿‡</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">oldTab</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// å¤åˆ¶å…ƒç´ ï¼Œé‡æ–°è¿›è¡Œhash</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">oldCap</span><span class="o">;</span> <span class="o">++</span><span class="n">j</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">oldTab</span><span class="o">[</span><span class="n">j</span><span class="o">])</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">oldTab</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">next</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="n">newTab</span><span class="o">[</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">newCap</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)]</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">e</span> <span class="k">instanceof</span> <span class="nc">TreeNode</span><span class="o">)</span>
                    <span class="o">((</span><span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;)</span><span class="n">e</span><span class="o">).</span><span class="na">split</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">newTab</span><span class="o">,</span> <span class="n">j</span><span class="o">,</span> <span class="n">oldCap</span><span class="o">);</span>
                <span class="k">else</span> <span class="o">{</span> <span class="c1">// preserve order</span>
                    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">loHead</span> <span class="o">=</span> <span class="kc">null</span><span class="o">,</span> <span class="n">loTail</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">hiHead</span> <span class="o">=</span> <span class="kc">null</span><span class="o">,</span> <span class="n">hiTail</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">;</span>
                    <span class="c1">// å°†åŒä¸€æ¡¶ä¸­çš„å…ƒç´ æ ¹æ®(e.hash &amp; oldCap)æ˜¯å¦ä¸º0è¿›è¡Œåˆ†å‰²ï¼Œåˆ†æˆä¸¤ä¸ªä¸åŒçš„é“¾è¡¨ï¼Œå®Œæˆrehash</span>
                    <span class="k">do</span> <span class="o">{</span>
                        <span class="n">next</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">((</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">&amp;</span> <span class="n">oldCap</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">loTail</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                                <span class="n">loHead</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                            <span class="k">else</span>
                                <span class="n">loTail</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                            <span class="n">loTail</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                        <span class="o">}</span>
                        <span class="k">else</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">hiTail</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                                <span class="n">hiHead</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                            <span class="k">else</span>
                                <span class="n">hiTail</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                            <span class="n">hiTail</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span> <span class="k">while</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">next</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">loTail</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">loTail</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                        <span class="n">newTab</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="n">loHead</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">hiTail</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">hiTail</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                        <span class="n">newTab</span><span class="o">[</span><span class="n">j</span> <span class="o">+</span> <span class="n">oldCap</span><span class="o">]</span> <span class="o">=</span> <span class="n">hiHead</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">newTab</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
æ‰©å®¹å®é™…ä¸Šå°±æ˜¯åˆ›å»ºä¸€ä¸ªå®¹é‡æ˜¯åŸæ¥å®¹é‡ä¸¤å€çš„æ•°ç»„ï¼Œ
æŠŠåŸæ¥æ•°ç»„ä¸­çš„å…ƒç´ ç»è¿‡é‡æ–°æ•£åˆ—ï¼Œç„¶åæ·»åŠ åˆ°æ–°çš„æ•°ç»„ä¸­ã€‚
æ‰©å®¹ä¼šä¼´éšç€ä¸€æ¬¡é‡æ–°hashåˆ†é…ï¼Œå¹¶ä¸”ä¼šéå†hashè¡¨ä¸­æ‰€æœ‰
çš„å…ƒç´ ï¼Œæ˜¯éå¸¸è€—æ—¶çš„ã€‚åœ¨ç¼–å†™ç¨‹åºä¸­ï¼Œè¦å°½é‡é¿å…resizeã€‚
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">putAll()æ–¹æ³•</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">putAll</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">m</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">//å†…éƒ¨ä¹Ÿæ˜¯è°ƒç”¨putVal()æ–¹æ³•ï¼Œå°†mä¸­çš„å…ƒç´ å¾ªç¯æ”¾å…¥tableä¸­</span>
  <span class="n">putMapEntries</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_è·å–å…ƒç´ "><a class="anchor" href="#_è·å–å…ƒç´ "></a>è·å–å…ƒç´ </h5>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="cm">/**
 * é€šè¿‡keyè·å–value
 */</span>
<span class="kd">public</span> <span class="no">V</span> <span class="nf">get</span><span class="o">(</span><span class="nc">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span><span class="o">;</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">e</span> <span class="o">=</span> <span class="n">getNode</span><span class="o">(</span><span class="n">hash</span><span class="o">(</span><span class="n">key</span><span class="o">),</span> <span class="n">key</span><span class="o">))</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">e</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="nf">getNode</span><span class="o">(</span><span class="kt">int</span> <span class="n">hash</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">;</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">first</span><span class="o">,</span> <span class="n">e</span><span class="o">;</span> <span class="kt">int</span> <span class="n">n</span><span class="o">;</span> <span class="no">K</span> <span class="n">k</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
        <span class="o">(</span><span class="n">first</span> <span class="o">=</span> <span class="n">tab</span><span class="o">[(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">hash</span><span class="o">])</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//å¦‚æœNodeé“¾è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ ç›¸ç­‰</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">first</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">hash</span> <span class="o">&amp;&amp;</span> <span class="c1">// always check first node</span>
            <span class="o">((</span><span class="n">k</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">key</span> <span class="o">||</span> <span class="o">(</span><span class="n">key</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">k</span><span class="o">))))</span>
            <span class="k">return</span> <span class="n">first</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//çº¢é»‘æ ‘æŸ¥æ‰¾</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">first</span> <span class="k">instanceof</span> <span class="nc">TreeNode</span><span class="o">)</span>
                <span class="k">return</span> <span class="o">((</span><span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;)</span><span class="n">first</span><span class="o">).</span><span class="na">getTreeNode</span><span class="o">(</span><span class="n">hash</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>
            <span class="c1">//é“¾è¡¨æŸ¥æ‰¾</span>
            <span class="k">do</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">hash</span> <span class="o">&amp;&amp;</span>
                    <span class="o">((</span><span class="n">k</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">key</span> <span class="o">||</span> <span class="o">(</span><span class="n">key</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">k</span><span class="o">))))</span>
                    <span class="k">return</span> <span class="n">e</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">while</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">//æ‰¾ä¸åˆ°è¿”å›null</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * åˆ¤æ–­æ˜¯å¦åŒ…å«æŒ‡å®škey
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">containsKey</span><span class="o">(</span><span class="nc">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">getNode</span><span class="o">(</span><span class="n">hash</span><span class="o">(</span><span class="n">key</span><span class="o">),</span> <span class="n">key</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>  <span class="c1">//è¿”å›nodeæ˜¯å¦ä¸ºnull</span>
<span class="o">}</span>

<span class="cm">/**
 * åˆ¤æ–­æ˜¯å¦åŒ…å«æŒ‡å®švalue
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">containsValue</span><span class="o">(</span><span class="nc">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">;</span> <span class="no">V</span> <span class="n">v</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//æŒ‰ç…§å•é“¾è¡¨çš„æ–¹å¼è¿›è¡Œéå†ï¼Œ</span>
            <span class="c1">//å› ä¸ºHashMapä¸­ TreeNode èŠ‚ç‚¹ä¹Ÿå­˜åœ¨nextæˆå‘˜ï¼Œå¯ä»¥ç”¨é“¾è¡¨çš„æ–¹å¼è¿›è¡Œéå†</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">tab</span><span class="o">[</span><span class="n">i</span><span class="o">];</span> <span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">v</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">value</span><span class="o">)</span> <span class="o">==</span> <span class="n">value</span> <span class="o">||</span>
                        <span class="o">(</span><span class="n">value</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">value</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">v</span><span class="o">)))</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
getæ–¹æ³•ç›¸å¯¹putè¦ç®€å•çš„å¤šï¼Œåˆ†ææºç å¯ä»¥çœ‹å‡ºhashç®—æ³•çš„ç²¾é«“ï¼Œä¸ç”¨éå†å°±å¯ä»¥ç›´æ¥é€šè¿‡
è®¡ç®—keyçš„hashå€¼ï¼Œå¾—åˆ°æŸ¥æ‰¾å…ƒç´ åœ¨æ•°ç»„ä¸­çš„æ¡¶ä½ï¼Œç„¶åæ¯”è¾ƒhashå€¼ã€keyæ˜¯å¦ç›¸ç­‰æ¥è·å–nodeã€‚
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_ç§»é™¤å…ƒç´ "><a class="anchor" href="#_ç§»é™¤å…ƒç´ "></a>ç§»é™¤å…ƒç´ </h5>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="no">V</span> <span class="nf">remove</span><span class="o">(</span><span class="nc">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span><span class="o">;</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">e</span> <span class="o">=</span> <span class="n">removeNode</span><span class="o">(</span><span class="n">hash</span><span class="o">(</span><span class="n">key</span><span class="o">),</span> <span class="n">key</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">))</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">e</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="nf">removeNode</span><span class="o">(</span><span class="kt">int</span> <span class="n">hash</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">key</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">value</span><span class="o">,</span>
                           <span class="kt">boolean</span> <span class="n">matchValue</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">movable</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">;</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="kt">int</span> <span class="n">n</span><span class="o">,</span> <span class="n">index</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
        <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">tab</span><span class="o">[</span><span class="n">index</span> <span class="o">=</span> <span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">hash</span><span class="o">])</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//nodeå°±æ˜¯è¦æŸ¥æ‰¾çš„ç»“ç‚¹</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">node</span> <span class="o">=</span> <span class="kc">null</span><span class="o">,</span> <span class="n">e</span><span class="o">;</span> <span class="no">K</span> <span class="n">k</span><span class="o">;</span> <span class="no">V</span> <span class="n">v</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">hash</span> <span class="o">&amp;&amp;</span>
            <span class="o">((</span><span class="n">k</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">key</span> <span class="o">||</span> <span class="o">(</span><span class="n">key</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">k</span><span class="o">))))</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="k">instanceof</span> <span class="nc">TreeNode</span><span class="o">)</span>
                <span class="n">node</span> <span class="o">=</span> <span class="o">((</span><span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;)</span><span class="n">p</span><span class="o">).</span><span class="na">getTreeNode</span><span class="o">(</span><span class="n">hash</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>
            <span class="k">else</span> <span class="o">{</span>
                <span class="k">do</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">hash</span> <span class="o">&amp;&amp;</span>
                        <span class="o">((</span><span class="n">k</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">key</span> <span class="o">||</span>
                         <span class="o">(</span><span class="n">key</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">k</span><span class="o">))))</span> <span class="o">{</span>
                        <span class="n">node</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="c1">//è¿™é‡Œpä¿å­˜çš„æ˜¯çˆ¶èŠ‚ç‚¹ï¼Œå› ä¸ºè¿™é‡Œæ¶‰åŠåˆ°é“¾è¡¨åˆ é™¤çš„æ“ä½œ</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">while</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="cm">/*
         * å½“matchValueä¸ºfalseæ—¶ï¼Œç›´æ¥çŸ­è·¯åé¢çš„è¿ç®—ï¼Œ
         * è¿›è¡Œåˆ é™¤æ“ä½œï¼Œè€Œä¸ç”¨å…³æ³¨valueå€¼æ˜¯å¦ç›¸ç­‰æˆ–è€…equals
         */</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">node</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(!</span><span class="n">matchValue</span> <span class="o">||</span> <span class="o">(</span><span class="n">v</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">value</span><span class="o">)</span> <span class="o">==</span> <span class="n">value</span> <span class="o">||</span>
                             <span class="o">(</span><span class="n">value</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">value</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">v</span><span class="o">))))</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">node</span> <span class="k">instanceof</span> <span class="nc">TreeNode</span><span class="o">)</span>
                <span class="c1">//movableç”¨åœ¨æ ‘çš„åˆ é™¤ä¸Š</span>
                <span class="o">((</span><span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;)</span><span class="n">node</span><span class="o">).</span><span class="na">removeTreeNode</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span> <span class="n">movable</span><span class="o">);</span>
            <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">node</span> <span class="o">==</span> <span class="n">p</span><span class="o">)</span>
                 <span class="c1">//è¦åˆ é™¤èŠ‚ç‚¹å°±æ˜¯é“¾è¡¨çš„å¤´èŠ‚ç‚¹ï¼Œåˆ™å°†å­èŠ‚ç‚¹æ”¾è¿›æ¡¶ä½</span>
                <span class="n">tab</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
            <span class="k">else</span>
                <span class="c1">//åˆ é™¤èŠ‚ç‚¹åèŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹çš„nexté‡æ–°è¿æ¥</span>
                <span class="n">p</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
            <span class="o">++</span><span class="n">modCount</span><span class="o">;</span> <span class="c1">//åˆ é™¤æ“ä½œä¹Ÿæ˜¯è¦è®°å½•è¿›modCount</span>
            <span class="o">--</span><span class="n">size</span><span class="o">;</span>
            <span class="n">afterNodeRemoval</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">node</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * jdk1.8æ–°å¢çš„é‡è½½æ–¹æ³•ï¼ŒmatchValueä¸ºtrueæ—¶ï¼Œ
 * åªæœ‰å½“keyå’Œvalueéƒ½ç›¸ç­‰æ—¶ï¼Œæ‰ä¼šåˆ é™¤
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">remove</span><span class="o">(</span><span class="nc">Object</span> <span class="n">key</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">removeNode</span><span class="o">(</span><span class="n">hash</span><span class="o">(</span><span class="n">key</span><span class="o">),</span> <span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_å°ç»“"><a class="anchor" href="#_å°ç»“"></a>25.9. å°ç»“</h3>
<div class="paragraph">
<p>æœ¬æ–‡å¯¹JDK1.8 HashMapçš„åŸä»£ç è¿›è¡Œäº†ç®€è¦çš„åˆ†æï¼Œä¸»è¦ç›®çš„æ˜¯äº†è§£å…¶å†…éƒ¨çš„
å­˜å‚¨æœºåˆ¶å’Œå®ç°åŸç†ï¼Œä»è€Œè¾¾åˆ°åœ¨ç¼–ç¨‹ä¸­æ›´é«˜æ•ˆçš„ä½¿ç”¨HashMapã€‚<br></p>
</div>
<div class="paragraph">
<p>HashMap å†…éƒ¨æ˜¯åŸºäºä¸€ä¸ªæ•°ç»„æ¥å®ç°çš„ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ ç§°ä¸ºä¸€ä¸ªæ¡¶(bucket)ã€‚
å½“æ•°ç»„ä¸­è¢«å ç”¨çš„æ¡¶çš„æ•°é‡è¶…è¿‡äº†è£…è½½å› å­å’Œæ•°ç»„å®¹é‡è®¾å®šçš„é˜ˆå€¼åï¼Œä¼šå¯¹æ•°ç»„è¿›è¡Œæ‰©å®¹ï¼Œ
å®¹é‡å°†æ‰©å±•ä¸ºåŸæ¥çš„2å€ã€‚å“ˆå¸Œè¡¨ä¸­æ‰€æœ‰çš„ Entry ä¼šè¢«é‡æ–°æ•£åˆ—åˆ°æ–°çš„ä½ç½®ä¸­ã€‚<br></p>
</div>
<div class="paragraph">
<p>å› ä¸ºä¸¤ä¸ªä¸åŒçš„keyåœ¨æ•£åˆ—æ—¶æœ‰å¯èƒ½å‘ç”Ÿå†²çªï¼ŒHashMapä¸ºäº†é¿å…å“ˆå¸Œå†²çªå¸¦æ¥çš„å½±å“
åšäº†å‡ ç‚¹ä¼˜åŒ–ã€‚åœ¨è¿›è¡Œæ•£åˆ—å¤„ç†æ—¶ï¼Œå°†é«˜ä½ä¸ä½ä½è¿›è¡Œå¼‚æˆ–ï¼Œä»è€Œå‡å°å†²çªçš„æ¦‚ç‡ã€‚
å½“ä¸åŒçš„nodeè¢«æ•£åˆ—åˆ°åŒä¸€ä¸ªæ¡¶ä¸­æ—¶ï¼Œæ¯ä¸ªæ¡¶ä¸­ä½¿ç”¨å•å‘é“¾è¡¨çš„æ–¹å¼æ¥ä¿å­˜æ•°æ®ã€‚
åœ¨Java 8 çš„å®ç°ä¸­ï¼Œå¦‚æœä¸€ä¸ªæ¡¶ä¸­çš„Nodeæ•°é‡è¶…è¿‡äº†é˜ˆå€¼(TREEIFY_THRESHOLD = 8)ï¼Œ
å°±ä¼šå°†å•é“¾è¡¨è½¬åŒ–ä¸ºçº¢é»‘æ ‘ï¼Œå½“ä½äºé˜ˆå€¼(UNTREEIFY_THRESHOLD = 6)æ—¶é‡æ–°è½¬åŒ–ä¸º
å•é“¾è¡¨ã€‚<br></p>
</div>
<div class="paragraph">
<p>åˆ†æäº†HashMapçš„resizeæ–¹æ³•å¯ä»¥çŸ¥é“ï¼ŒHashMapåœ¨è¿›è¡Œæ‰©å®¹æ—¶æ˜¯éå¸¸è€—æ€§èƒ½çš„æ“ä½œï¼Œ
æ‰€ä»¥åœ¨ä½¿ç”¨HashMapçš„æ—¶å€™ï¼Œåº”è¯¥å…ˆä¼°ç®—ä¸€ä¸‹mapçš„å¤§å°ï¼Œåˆå§‹åŒ–çš„æ—¶å€™ç»™ä¸€ä¸ªå¤§è‡´çš„æ•°å€¼ï¼Œ
é¿å…mapè¿›è¡Œé¢‘ç¹çš„æ‰©å®¹ã€‚</p>
</div>
</div>
<div class="sect2">
<h3 id="_å‚è€ƒ"><a class="anchor" href="#_å‚è€ƒ"></a>25.10. å‚è€ƒ</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://blog.jrwang.me/2016/java-collections-hashmap/">Java å®¹å™¨æºç åˆ†æä¹‹ HashMap</a><br></p>
</li>
<li>
<p><a href="http://www.tuicode.com/article/56da289f8e6d72823e30a024">JDK1.8æºç åˆ†æä¹‹HashMapï¼ˆä¸€ï¼‰</a><br></p>
</li>
<li>
<p><a href="http://blog.csdn.net/tuke_tuke/article/details/51588156"> Javaä¸­HashMapåº•å±‚å®ç°åŸç†(JDK1.8)æºç åˆ†æ</a></p>
</li>
<li>
<p><a href="http://www.cnblogs.com/ToBeAProgrammer/p/4787761.html">åŸºäºjdk1.8çš„HashMapæºç å­¦ä¹ ç¬”è®°</a><br></p>
</li>
<li>
<p><a href="http://tech.meituan.com/java-hashmap.html">Java 8ç³»åˆ—ä¹‹é‡æ–°è®¤è¯†HashMap</a></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_jdk_1_8_çš„å®ç°"><a class="anchor" href="#_jdk_1_8_çš„å®ç°"></a>25.11. JDK 1.8 çš„å®ç°</h3>
<div class="paragraph">
<p><strong>ç»§ä¸Šä¸€ç« ä»‹ç»äº†HashMapçš„ç­¾åã€æ•°æ®ç»“æ„ä»¥åŠå­˜å‚¨åŸç†ä¹‹åï¼Œç›¸ä¿¡å¤§å®¶å¯¹HashMapæœ‰äº†æ›´åŠ æ·±å…¥çš„ç†è§£ï¼Œåœ¨ä½¿ç”¨æ—¶ä¹Ÿä¼šå¾—å¿ƒåº”æ‰‹ã€‚</strong><br>
<strong>æœ¬ç« å°†ç»§ç»­ä»‹ç»HashMapçš„ä½¿ç”¨ï¼Œä¸»è¦æ˜¯åˆ†æHashMapçš„ä¸‰ç§éå†æ–¹å¼ã€‚</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="_hashmapéå†"><a class="anchor" href="#_hashmapéå†"></a>25.12. HashMapéå†</h3>
<hr>
<div class="ulist">
<ul>
<li>
<p><strong>HashMapæä¾›äº†ä¸‰ç§éå†æ–¹å¼ï¼š</strong></p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>éå†æ‰€æœ‰çš„Keyï¼šSet&lt;K&gt; keySet()</p>
</li>
<li>
<p>éå†æ‰€æœ‰çš„Entryï¼šSet&lt;Map.Entry&lt;K,V&gt;&gt; entrySet()</p>
</li>
<li>
<p>éå†æ‰€æœ‰çš„Valueï¼ˆä¸å¸¸ç”¨ï¼‰ï¼šCollection&lt;V&gt; values()</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>è¿™ä¸‰ä¸ªæ–¹æ³•çš„åŸºæœ¬ç”¨æ³•å°†ä¸åœ¨è¯¦ç»†ä»‹ç»ï¼Œå®ƒä»¬éƒ½æ˜¯è¿”å›å¯è¿­ä»£çš„Setæˆ–è€…Collectionã€‚è¦å¼„æ¸…æ¥šè¿™ä¸‰ä¸ªæ–¹æ³•
çš„å†…éƒ¨å®ç°æœºåˆ¶ï¼Œé¦–å…ˆä¸»è¦æ¥çœ‹ä¸€ä¸‹å†…éƒ¨æŠ½è±¡ç±»#HashIterator#ã€‚<br></p>
</div>
<div class="ulist">
<ul>
<li>
<p>HashIteratorå†…éƒ¨ç±»ï¼š</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">HashIterator</span> <span class="o">{</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">;</span>        <span class="c1">// next entry to return</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">current</span><span class="o">;</span>     <span class="c1">// current entry</span>
    <span class="kt">int</span> <span class="n">expectedModCount</span><span class="o">;</span>  <span class="c1">// for fast-fail</span>
    <span class="kt">int</span> <span class="n">index</span><span class="o">;</span>             <span class="c1">// current slot</span>

    <span class="nc">HashIterator</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//ç”¨expectedModCountä¿å­˜åˆšåˆ›å»ºè¿­ä»£å™¨æ—¶çš„modCountï¼Œ</span>
        <span class="c1">//å®ç°fail-fastæœºåˆ¶éœ€è¦å¯¹æ¯”è¯¥å€¼å’Œä½¿ç”¨æ—¶çš„modCount</span>
        <span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span> <span class="o">=</span> <span class="n">table</span><span class="o">;</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="c1">//æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœ‰æ•ˆçš„æ§½</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">t</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// advance to first entry</span>
            <span class="k">do</span> <span class="o">{}</span> <span class="k">while</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">next</span> <span class="o">=</span> <span class="n">t</span><span class="o">[</span><span class="n">index</span><span class="o">++])</span> <span class="o">==</span> <span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">hasNext</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">next</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="nf">nextNode</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">;</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
        <span class="cm">/*
         * fail-fast æ£€æŸ¥
         * å½“å¦å¤–ä¸€ä¸ªçº¿ç¨‹å¯¹å½“å‰Mapä¿®æ”¹æ—¶ï¼Œä¼šä¿®æ”¹modCountï¼Œ
         * å½“å‰çº¿ç¨‹éå†æ­£åœ¨ï¼Œå¦‚æœexpectedModCountå’ŒmodCount
         * ä¸ç›¸ç­‰ï¼Œå°±ä¼šæŠ›å‡ºConcurrentModificationExceptionå¼‚å¸¸
         */</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
        <span class="c1">// tableæ•°ç»„ä¸­æ²¡æœ‰å…ƒç´ ï¼ŒæŠ›å‡ºNoSuchElementExceptionå¼‚å¸¸</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>
        <span class="c1">//next = e.next</span>
        <span class="c1">//éå†æ˜¯é€šè¿‡å•é“¾è¡¨çš„æ–¹å¼æ¥è®¿é—®çš„ï¼Œå³ä¾¿æ˜¯çº¢é»‘æ ‘ä¹Ÿå¯ä»¥è¿™æ ·æ¥éå†</span>
        <span class="c1">//TreeNodeä¸­ä¹Ÿå­˜åœ¨nextå¼•ç”¨ï¼Œä¹Ÿå¯ä»¥çœ‹åšå•é“¾è¡¨</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">next</span> <span class="o">=</span> <span class="o">(</span><span class="n">current</span> <span class="o">=</span> <span class="n">e</span><span class="o">).</span><span class="na">next</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">table</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//å¦‚æœåˆ°è¾¾å½“å‰é“¾è¡¨æœ«å°¾next == null</span>
            <span class="c1">//å¯»æ‰¾ä¸‹ä¸€ä¸ªæœ‰æ•ˆçš„æ§½</span>
            <span class="k">do</span> <span class="o">{}</span> <span class="k">while</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">next</span> <span class="o">=</span> <span class="n">t</span><span class="o">[</span><span class="n">index</span><span class="o">++])</span> <span class="o">==</span> <span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">e</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">current</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">();</span>
        <span class="c1">//fail-fast æ£€æŸ¥</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
        <span class="n">current</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="no">K</span> <span class="n">key</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">;</span>
        <span class="c1">//è°ƒç”¨removeNodeç§»é™¤Entry</span>
        <span class="n">removeNode</span><span class="o">(</span><span class="n">hash</span><span class="o">(</span><span class="n">key</span><span class="o">),</span> <span class="n">key</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="c1">//æ›´æ–°expectedModCount</span>
        <span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">final</span> <span class="kd">class</span> <span class="nc">KeyIterator</span> <span class="kd">extends</span> <span class="nc">HashIterator</span>
    <span class="kd">implements</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">K</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="no">K</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">nextNode</span><span class="o">().</span><span class="na">key</span><span class="o">;</span> <span class="o">}</span>  <span class="c1">//è¿”å›Key</span>
<span class="o">}</span>

<span class="kd">final</span> <span class="kd">class</span> <span class="nc">ValueIterator</span> <span class="kd">extends</span> <span class="nc">HashIterator</span>
    <span class="kd">implements</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">V</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="no">V</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">nextNode</span><span class="o">().</span><span class="na">value</span><span class="o">;</span> <span class="o">}</span> <span class="c1">// è¿”å›Value</span>
<span class="o">}</span>

<span class="kd">final</span> <span class="kd">class</span> <span class="nc">EntryIterator</span> <span class="kd">extends</span> <span class="nc">HashIterator</span>
    <span class="kd">implements</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;&gt;</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">nextNode</span><span class="o">();</span> <span class="o">}</span> <span class="c1">// è¿”å›Entry</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>KeyIteratorã€ValueIterator å’Œ EntryIterator éƒ½ç»§æ‰¿äº† HashIteratorï¼ŒåŒºåˆ«åªåœ¨äº next() æ–¹æ³•è¿”å›çš„æ˜¯ Keyã€Value è¿˜æ˜¯ Entryã€‚</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set&lt;Map.Entry&lt;K,V&gt;&gt; entrySet()</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;&gt;</span> <span class="nf">entrySet</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">es</span><span class="o">;</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">es</span> <span class="o">=</span> <span class="n">entrySet</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="o">(</span><span class="n">entrySet</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">EntrySet</span><span class="o">())</span> <span class="o">:</span> <span class="n">es</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">final</span> <span class="kd">class</span> <span class="nc">EntrySet</span> <span class="kd">extends</span> <span class="nc">AbstractSet</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;&gt;</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">size</span><span class="o">()</span>                 <span class="o">{</span> <span class="k">return</span> <span class="n">size</span><span class="o">;</span> <span class="o">}</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">clear</span><span class="o">()</span>               <span class="o">{</span> <span class="nc">HashMap</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span> <span class="o">}</span>
  <span class="c1">//è¿”å›ä¸€ä¸ªè¿­ä»£å™¨</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;&gt;</span> <span class="nf">iterator</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">EntryIterator</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">contains</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">))</span>
      <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;?,?&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;?,?&gt;)</span> <span class="n">o</span><span class="o">;</span>
    <span class="nc">Object</span> <span class="n">key</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">candidate</span> <span class="o">=</span> <span class="n">getNode</span><span class="o">(</span><span class="n">hash</span><span class="o">(</span><span class="n">key</span><span class="o">),</span> <span class="n">key</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">candidate</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">candidate</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">remove</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;?,?&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;?,?&gt;)</span> <span class="n">o</span><span class="o">;</span>
      <span class="nc">Object</span> <span class="n">key</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
      <span class="nc">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
      <span class="k">return</span> <span class="nf">removeNode</span><span class="o">(</span><span class="n">hash</span><span class="o">(</span><span class="n">key</span><span class="o">),</span> <span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;&gt;</span> <span class="nf">spliterator</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">EntrySpliterator</span><span class="o">&lt;&gt;(</span><span class="nc">HashMap</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">forEach</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">action</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">mc</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">tab</span><span class="o">[</span><span class="n">i</span><span class="o">];</span> <span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">)</span>
          <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">!=</span> <span class="n">mc</span><span class="o">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>ç†è§£äº† HashIterator åå†çœ‹ entrySet() å’Œ EntrySet ç±»å°±æ¯”è¾ƒå®¹æ˜“ç†è§£äº†ï¼Œæ³¨æ„åˆ° HashMap çš„å®ç°ä¸­ä½¿ç”¨äº†ä¸€ä¸ª entrySet æˆå‘˜æ¥ç¼“å­˜ç»“æœã€‚ keySet() å’Œ values() çš„å®ç°ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œåªæ˜¯ values() è¿”å›çš„æ˜¯ Collection ï¼Œå› ä¸ºå€¼ä¸èƒ½ä¿è¯å”¯ä¸€æ€§ï¼Œè€Œé”®æ˜¯å¯ä»¥çš„ã€‚</p>
</div>
</div>
<div class="sect2">
<h3 id="_æ³¨æ„"><a class="anchor" href="#_æ³¨æ„"></a>25.13. æ³¨æ„</h3>
<div class="paragraph">
<p><strong>å¯¹äºMapä¸­çš„Keyæ˜¯åŒ…è£…ç±»å‹æ—¶ï¼Œä»mapæ€»getå…ƒç´ æ—¶è¦ç‰¹åˆ«æ³¨æ„ï¼Œgetå…ƒç´ çš„keyä¹Ÿå¿…é¡»æ˜¯å¯¹åº”çš„åŒ…è£…ç±»å‹ï¼Œå¦è€…ä¸èƒ½è·å¾—åˆ°å¯¹åº”çš„valueã€‚
å› ä¸ºgetæ–¹æ³•å†…éƒ¨é€šè¿‡keyæŸ¥æ‰¾å¯¹åº”çš„valueæ—¶ï¼Œkeyç”¨çš„æ˜¯equalsæ–¹æ³•æ¯”è¾ƒï¼Œæ‰€ä»¥keyçš„æ•°æ®ç±»å‹ä¹Ÿå¿…é¡»ç›¸åŒã€‚<br>
ä¾‹å¦‚ï¼š</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">long</span> <span class="n">key</span> <span class="o">=</span> <span class="mi">123</span><span class="o">;</span>
<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">,</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="nc">Maps</span><span class="o">.</span><span class="na">newHashMap</span><span class="o">();</span>
<span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="mi">123L</span><span class="o">,</span><span class="s">"java"</span><span class="o">);</span>
<span class="nc">String</span> <span class="n">value</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>  <span class="c1">// valueæ˜¯nullï¼Ÿè¿˜æ˜¯javaï¼Ÿ</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_å°ç»“_2"><a class="anchor" href="#_å°ç»“_2"></a>25.13.1. å°ç»“</h4>
<div class="paragraph">
<p>æœ‰å…³HashMapçš„éå†å°±ä»‹ç»è¿™å†™ï¼Œéå†HashMapä¸€å…±æœ‰ä¸‰ç§æ–¹å¼ï¼Œä¸€èˆ¬éå†keyå’Œéå†Entryç”¨çš„æ¯”è¾ƒå¤šï¼Œè€Œä¸”éå†Entryè¦æ¯”éå†
keyæ•ˆç‡è¦æ›´å¿«äº›ã€‚å¯¹äºHashMapçš„æºç æš‚æ—¶å°±åˆ†æè¿™ä¹ˆå¤šï¼Œç”±äºæœ¬äººè¿˜æ˜¯ä¸€ä¸ªèœé¸Ÿï¼Œæ°´å¹³æœ‰é™ï¼Œæœ‰äº›åœ°æ–¹ä¹Ÿè®¸æ²¡æœ‰åˆ†æçš„é€å½»ï¼Œå¸Œæœ›
å¤§å®¶å¯ä»¥è§è°…ï¼ŒåŒæ—¶ï¼Œæœ¬æ¬¡HashMapçš„æºç åˆ†æä¹Ÿæœ‰å¾ˆå¤šåœ°æ–¹æ²¡æœ‰è®²åˆ°ï¼Œæ¯”å¦‚ï¼šHashMapçš„å­˜å‚¨ç»“æ„çº¢é»‘æ ‘ï¼Œä»¥åæœ‰æ—¶é—´å†æ¥ç ”ç©¶ä¸€ä¸‹çº¢é»‘æ ‘
çš„å®ç°åŸç†ï¼Œè¿™é‡Œå…ˆæ¨èä¸€ç¯‡è®²è§£çº¢é»‘æ ‘çš„æ–‡ç« <a href="http://tech.meituan.com/redblack-tree.html">çº¢é»‘æ ‘æ·±å…¥å‰–æåŠJavaå®ç°</a>ã€‚</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_å‚è€ƒ_2"><a class="anchor" href="#_å‚è€ƒ_2"></a>25.14. å‚è€ƒ</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://blog.jrwang.me/2016/java-collections-hashmap/">Java å®¹å™¨æºç åˆ†æä¹‹ HashMap - JR&#8217;s Blog</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_treemap"><a class="anchor" href="#_treemap"></a>26. TreeMap</h2>
<div class="sectionbody">
<div class="paragraph">
<p>å…ˆçœ‹ä¸€ä¸ªé—®é¢˜ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre></td><td class="code"><pre>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testQuestion</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">TreeMap</span><span class="o">&lt;</span><span class="nc">Pair</span><span class="o">,</span> <span class="nc">Pair</span><span class="o">&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TreeMap</span><span class="o">&lt;&gt;();</span>
        <span class="nc">Pair</span> <span class="n">pair</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Pair</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>

        <span class="n">data</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">pair</span><span class="o">,</span> <span class="n">pair</span><span class="o">);</span>
        <span class="nc">Pair</span> <span class="n">value</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="k">new</span> <span class="nc">Pair</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
        <span class="c1">// è¯·é—®ï¼Œè¿™é‡Œä¼šè¾“å‡º true ï¼Ÿè¿˜æ˜¯ false ï¼Ÿ</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">pair</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">class</span> <span class="nc">Pair</span> <span class="kd">implements</span> <span class="nc">Comparable</span><span class="o">&lt;</span><span class="nc">Pair</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">key</span><span class="o">;</span>
        <span class="kt">long</span> <span class="n">time</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Pair</span><span class="o">(</span><span class="kt">int</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nf">Pair</span><span class="o">(</span><span class="kt">int</span> <span class="n">key</span><span class="o">,</span> <span class="kt">long</span> <span class="n">time</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">time</span> <span class="o">=</span> <span class="n">time</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">compareTo</span><span class="o">(</span><span class="nc">Pair</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">Long</span><span class="o">.</span><span class="na">compare</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">time</span><span class="o">,</span> <span class="n">o</span><span class="o">.</span><span class="na">time</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">getClass</span><span class="o">()</span> <span class="o">!=</span> <span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="nc">Pair</span> <span class="n">pair</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Pair</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>
            <span class="k">return</span> <span class="n">key</span> <span class="o">==</span> <span class="n">pair</span><span class="o">.</span><span class="na">key</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">Objects</span><span class="o">.</span><span class="na">hash</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>TreeMap</code> åº•å±‚æ˜¯ä¸€ä¸ªçº¢é»‘æ ‘ã€‚</p>
</div>
<div class="paragraph">
<p>å…ˆå®šä¹‰ä¸€ä¸ªæµ‹è¯•å®ä½“ç±»ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="code"><pre>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">sortFactor</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Person</span><span class="o">(</span><span class="kt">long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">id</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nf">Person</span><span class="o">(</span><span class="kt">long</span> <span class="n">id</span><span class="o">,</span> <span class="kt">int</span> <span class="n">sortFactor</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">sortFactor</span> <span class="o">=</span> <span class="n">sortFactor</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">getClass</span><span class="o">()</span> <span class="o">!=</span> <span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="nc">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Person</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>
            <span class="k">return</span> <span class="n">id</span> <span class="o">==</span> <span class="n">person</span><span class="o">.</span><span class="na">id</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">Objects</span><span class="o">.</span><span class="na">hash</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"Person{"</span> <span class="o">+</span>
                    <span class="s">"id="</span> <span class="o">+</span> <span class="n">id</span> <span class="o">+</span>
                    <span class="s">", age="</span> <span class="o">+</span> <span class="n">sortFactor</span> <span class="o">+</span>
                    <span class="sc">'}'</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="code"><pre>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSort</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Comparator</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">&gt;</span> <span class="n">comparator</span>
                <span class="o">=</span> <span class="nc">Comparator</span><span class="o">.</span><span class="na">comparingInt</span><span class="o">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="na">sortFactor</span><span class="o">);</span>
        <span class="nc">TreeMap</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">,</span> <span class="nc">Person</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TreeMap</span><span class="o">&lt;&gt;(</span><span class="n">comparator</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Person</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">person</span><span class="o">,</span> <span class="n">person</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="nc">Person</span> <span class="n">param</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Person</span><span class="o">(</span><span class="n">i</span> <span class="o">/</span> <span class="mi">2</span><span class="o">);</span>
                <span class="nc">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">param</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">nonNull</span><span class="o">(</span><span class="n">person</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">person</span><span class="o">.</span><span class="na">sortFactor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">//</span>
        <span class="n">map</span><span class="o">.</span><span class="na">forEach</span><span class="o">((</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">k</span><span class="o">);</span>
        <span class="o">});</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-------------"</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Person</span> <span class="n">person</span> <span class="o">:</span> <span class="n">map</span><span class="o">.</span><span class="na">navigableKeySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">person</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-------------"</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Person</span> <span class="n">person</span> <span class="o">:</span> <span class="n">map</span><span class="o">.</span><span class="na">descendingKeySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">person</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ä¿®æ”¹æ’åºå­—æ®µï¼Œæ‰“å°æ—¶ï¼Œä¾ç„¶å¯ä»¥ä¿æŒæœ‰åºæ€§ã€‚<em>è¿™ä¸ªå®ç°æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="code"><pre>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testDuplicateSortFactor</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Comparator</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">&gt;</span> <span class="n">comparator</span>
                <span class="o">=</span> <span class="nc">Comparator</span><span class="o">.</span><span class="na">comparingInt</span><span class="o">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="na">sortFactor</span><span class="o">);</span>
        <span class="nc">TreeMap</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">,</span> <span class="nc">Person</span><span class="o">&gt;</span> <span class="n">treeMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TreeMap</span><span class="o">&lt;&gt;(</span><span class="n">comparator</span><span class="o">);</span>
        <span class="nc">Person</span> <span class="n">p1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Person</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="nc">Person</span> <span class="n">p2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Person</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="k">assert</span> <span class="o">!</span><span class="n">p1</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">p2</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">p1</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">p2</span><span class="o">));</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Person</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
            <span class="n">treeMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">person</span><span class="o">,</span> <span class="n">person</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">assert</span> <span class="o">(</span><span class="n">treeMap</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">1</span><span class="o">);</span>
        <span class="n">treeMap</span><span class="o">.</span><span class="na">forEach</span><span class="o">((</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-----------------------"</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"kid= %-4d kfactor= %-8d%n"</span><span class="o">,</span> <span class="n">k</span><span class="o">.</span><span class="na">id</span><span class="o">,</span> <span class="n">k</span><span class="o">.</span><span class="na">sortFactor</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"vid= %-4d vfactor= %-8d%n"</span><span class="o">,</span> <span class="n">v</span><span class="o">.</span><span class="na">id</span><span class="o">,</span> <span class="n">v</span><span class="o">.</span><span class="na">sortFactor</span><span class="o">);</span>
        <span class="o">});</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ç”±æ­¤çœ‹å‡ºï¼Œ<code>TreeMap</code> ä¸èƒ½æ¥å—æ’åºå› å­ç›¸åŒçš„å€¼ã€‚å¦‚æœå­˜åœ¨ï¼Œåˆ™åæ¥è€…æŠŠå‰è€…çš„ <code>Value</code> è¦†ç›–æ‰ã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testPut</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">TreeMap</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">treeMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TreeMap</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">treeMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">100</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_linkedhashmap"><a class="anchor" href="#_linkedhashmap"></a>27. LinkedHashMap</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="./images/LinkedHashMap.png" alt="LinkedHashMap">
</div>
</div>
<div class="paragraph">
<p>é—®é¢˜ï¼š</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>new LinkedHashMap&lt;&gt;(10, 0.75F, true)</code> å’Œ <code>new LinkedHashMap&lt;&gt;()</code> é™¤äº†å®¹é‡ä¹‹å¤–ï¼Œè¿˜æœ‰ä»€ä¹ˆå·®åˆ«å—ï¼Ÿ</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dictionary"><a class="anchor" href="#_dictionary"></a>28. Dictionary</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_hashtable"><a class="anchor" href="#_hashtable"></a>29. Hashtable</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="./images/Hashtable-lock.png" alt="Hashtable lock">
</div>
</div>
<div class="sect2">
<h3 id="_å‚è€ƒèµ„æ–™_6"><a class="anchor" href="#_å‚è€ƒèµ„æ–™_6"></a>29.1. å‚è€ƒèµ„æ–™</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.cnblogs.com/chengxiao/p/6842045.html">ConcurrentHashMapå®ç°åŸç†åŠæºç åˆ†æ - dreamcatcher-cx - åšå®¢å›­</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_enummap"><a class="anchor" href="#_enummap"></a>30. EnumMap</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_weakhashmap"><a class="anchor" href="#_weakhashmap"></a>31. WeakHashMap</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_identityhashmap"><a class="anchor" href="#_identityhashmap"></a>32. IdentityHashMap</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_queue"><a class="anchor" href="#_queue"></a>33. Queue</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_deque"><a class="anchor" href="#_deque"></a>34. Deque</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_abstractqueue"><a class="anchor" href="#_abstractqueue"></a>35. AbstractQueue</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_arraydeque"><a class="anchor" href="#_arraydeque"></a>36. ArrayDeque</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_priorityqueue"><a class="anchor" href="#_priorityqueue"></a>37. PriorityQueue</h2>
<div class="sectionbody">
<div class="paragraph">
<p>å¯¹äº <code>PriorityQueue</code> æ¥è¯´ï¼Œæœ€é‡è¦çš„ä¸€ç‚¹å°±æ˜¯è¦æ¸…æ¥šä»–æ˜¯åŸºäºå †ç»“æ„å®ç°ï¼Œå¯ä»¥ç”¨å®ƒæ¥å®ç°ä¼˜å…ˆé˜Ÿåˆ—ã€‚</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/PriorityQueue-offer.png" alt="PriorityQueue offer">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/PriorityQueue-poll.png" alt="PriorityQueue poll">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/PriorityQueue-remove2.png" alt="PriorityQueue remove2">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="code"><pre>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSize</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">PriorityQueue</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PriorityQueue</span><span class="o">&lt;&gt;(</span><span class="mi">5</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">queue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">queue</span><span class="o">).</span><span class="na">hasSize</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">capacity</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>
        <span class="nc">PriorityQueue</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PriorityQueue</span><span class="o">&lt;&gt;(</span><span class="n">capacity</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">queue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">queue</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">capacity</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Integer</span> <span class="n">num</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">num</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">queue</span><span class="o">).</span><span class="na">hasSize</span><span class="o">(</span><span class="n">capacity</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">queue</span><span class="o">).</span><span class="na">contains</span><span class="o">(</span><span class="mi">9</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">queue</span><span class="o">).</span><span class="na">doesNotContain</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="nc">Integer</span> <span class="n">num</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
        <span class="c1">// å¯è§ï¼Œé»˜è®¤å°±æ˜¯æœ€å°å †ã€‚</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">num</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ä»ä¸Šè¿°ä¾‹å­ä¸­å¯ä»¥çœ‹å‡ºï¼Œ<code>PriorityQueue</code> çš„é•¿åº¦æ˜¯å›å¢é•¿çš„ã€‚æ‰€ä»¥ï¼Œå¦‚æœéœ€è¦å®šé•¿çš„ä¼˜å…ˆé˜Ÿåˆ—ï¼Œåˆ™éœ€è¦å°†å¤šä½™æ•°æ®"å¼¹å‡º"ã€‚</p>
</div>
<div class="sect2">
<h3 id="_å‚è€ƒèµ„æ–™_7"><a class="anchor" href="#_å‚è€ƒèµ„æ–™_7"></a>37.1. å‚è€ƒèµ„æ–™</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://www.pdai.tech/md/java/collection/java-collection-PriorityQueue.html">Collection - PriorityQueueæºç è§£æ | Java å…¨æ ˆçŸ¥è¯†ä½“ç³»</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_å·¥å…·ç±»_arrays"><a class="anchor" href="#_å·¥å…·ç±»_arrays"></a>38. å·¥å…·ç±» <code>Arrays</code></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_å·¥å…·ç±»_collections"><a class="anchor" href="#_å·¥å…·ç±»_collections"></a>39. å·¥å…·ç±» <code>Collections</code></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_å¹¶å‘åº“æ¦‚è¿°"><a class="anchor" href="#_å¹¶å‘åº“æ¦‚è¿°"></a>40. å¹¶å‘åº“æ¦‚è¿°</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="./images/java-concurrent-overview.png" alt="java concurrent overview">
</div>
</div>
<div class="sect2">
<h3 id="_happy_before_åŸåˆ™"><a class="anchor" href="#_happy_before_åŸåˆ™"></a>40.1. Happy-Before åŸåˆ™</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Single Thread Rule å•ä¸€çº¿ç¨‹åŸåˆ™</p>
</li>
<li>
<p>Monitor Lock Rule ç®¡ç¨‹é”å®šè§„åˆ™</p>
</li>
<li>
<p>Volatile Variable Rule <code>volatile</code> å˜é‡è§„åˆ™</p>
</li>
<li>
<p>Thread Start Rule çº¿ç¨‹å¯åŠ¨è§„åˆ™</p>
</li>
<li>
<p>Thread Join Rule çº¿ç¨‹åŠ å…¥è§„åˆ™</p>
</li>
<li>
<p>Thread Interruption Rule çº¿ç¨‹ä¸­æ–­è§„åˆ™</p>
</li>
<li>
<p>Finalizer Rule å¯¹è±¡ç»ˆç»“è§„åˆ™</p>
</li>
<li>
<p>Transitivity ä¼ é€’æ€§</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_thread"><a class="anchor" href="#_thread"></a>41. Thread</h2>
<div class="sectionbody">
<div class="paragraph">
<p>åœ¨JDK1.2ä¹‹åï¼ŒJavaçº¿ç¨‹æ¨¡å‹å·²ç»ç¡®å®šäº†åŸºäºæ“ä½œç³»ç»ŸåŸç”Ÿçº¿ç¨‹æ¨¡å‹å®ç°ã€‚</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/jvm-thread-to-os-thread.jpeg" alt="jvm thread to os thread">
</div>
</div>
<div class="paragraph">
<p>Javaçº¿ç¨‹æœ€ç»ˆä¼šæ˜ å°„ä¸ºç³»ç»Ÿå†…æ ¸åŸç”Ÿçº¿ç¨‹ï¼Œæ‰€ä»¥Javaçº¿ç¨‹è°ƒåº¦æœ€ç»ˆå–å†³äºç³»æ“ä½œç³»ç»Ÿï¼Œè€Œç›®å‰ä¸»æµçš„æ“ä½œç³»ç»Ÿå†…æ ¸çº¿ç¨‹è°ƒåº¦åŸºæœ¬éƒ½æ˜¯ä½¿ç”¨æŠ¢å å¼çº¿ç¨‹è°ƒåº¦ã€‚ä¹Ÿå°±æ˜¯å¯ä»¥æ­»è®°ç¡¬èƒŒä¸€ä¸‹ï¼š<strong>Javaçº¿ç¨‹æ˜¯ä½¿ç”¨æŠ¢å å¼çº¿ç¨‹è°ƒåº¦æ–¹å¼è¿›è¡Œçº¿ç¨‹è°ƒåº¦çš„ã€‚</strong></p>
</div>
<div class="paragraph">
<p>çº¿ç¨‹çŠ¶æ€åœ¨ <code>Thread</code> ç±»å·²ç»é€šè¿‡ä¸€ä¸ªæšä¸¾ç»™å‡ºäº†æ‰€æœ‰å¯èƒ½ï¼š</p>
</div>
<div class="listingblock">
<div class="title">Thread</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Thread</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
    <span class="c1">// â€¦â€¦</span>
    <span class="cm">/**
     * A thread state.  A thread can be in one of the following states:
     * &lt;ul&gt;
     * &lt;li&gt;{@link #NEW}&lt;br&gt;
     *     A thread that has not yet started is in this state.
     *     &lt;/li&gt;
     * &lt;li&gt;{@link #RUNNABLE}&lt;br&gt;
     *     A thread executing in the Java virtual machine is in this state.
     *     &lt;/li&gt;
     * &lt;li&gt;{@link #BLOCKED}&lt;br&gt;
     *     A thread that is blocked waiting for a monitor lock
     *     is in this state.
     *     &lt;/li&gt;
     * &lt;li&gt;{@link #WAITING}&lt;br&gt;
     *     A thread that is waiting indefinitely for another thread to
     *     perform a particular action is in this state.
     *     &lt;/li&gt;
     * &lt;li&gt;{@link #TIMED_WAITING}&lt;br&gt;
     *     A thread that is waiting for another thread to perform an action
     *     for up to a specified waiting time is in this state.
     *     &lt;/li&gt;
     * &lt;li&gt;{@link #TERMINATED}&lt;br&gt;
     *     A thread that has exited is in this state.
     *     &lt;/li&gt;
     * &lt;/ul&gt;
     *
     * &lt;p&gt;
     * A thread can be in only one state at a given point in time.
     * These states are virtual machine states which do not reflect
     * any operating system thread states.
     *
     * @since   1.5
     * @see #getState
     */</span>
    <span class="kd">public</span> <span class="kd">enum</span> <span class="nc">State</span> <span class="o">{</span>
        <span class="cm">/**
         * Thread state for a thread which has not yet started.
         */</span>
        <span class="no">NEW</span><span class="o">,</span>

        <span class="cm">/**
         * Thread state for a runnable thread.  A thread in the runnable
         * state is executing in the Java virtual machine but it may
         * be waiting for other resources from the operating system
         * such as processor.
         */</span>
        <span class="no">RUNNABLE</span><span class="o">,</span>

        <span class="cm">/**
         * Thread state for a thread blocked waiting for a monitor lock.
         * A thread in the blocked state is waiting for a monitor lock
         * to enter a synchronized block/method or
         * reenter a synchronized block/method after calling
         * {@link Object#wait() Object.wait}.
         */</span>
        <span class="no">BLOCKED</span><span class="o">,</span>

        <span class="cm">/**
         * Thread state for a waiting thread.
         * A thread is in the waiting state due to calling one of the
         * following methods:
         * &lt;ul&gt;
         *   &lt;li&gt;{@link Object#wait() Object.wait} with no timeout&lt;/li&gt;
         *   &lt;li&gt;{@link #join() Thread.join} with no timeout&lt;/li&gt;
         *   &lt;li&gt;{@link LockSupport#park() LockSupport.park}&lt;/li&gt;
         * &lt;/ul&gt;
         *
         * &lt;p&gt;A thread in the waiting state is waiting for another thread to
         * perform a particular action.
         *
         * For example, a thread that has called {@code Object.wait()}
         * on an object is waiting for another thread to call
         * {@code Object.notify()} or {@code Object.notifyAll()} on
         * that object. A thread that has called {@code Thread.join()}
         * is waiting for a specified thread to terminate.
         */</span>
        <span class="no">WAITING</span><span class="o">,</span>

        <span class="cm">/**
         * Thread state for a waiting thread with a specified waiting time.
         * A thread is in the timed waiting state due to calling one of
         * the following methods with a specified positive waiting time:
         * &lt;ul&gt;
         *   &lt;li&gt;{@link #sleep Thread.sleep}&lt;/li&gt;
         *   &lt;li&gt;{@link Object#wait(long) Object.wait} with timeout&lt;/li&gt;
         *   &lt;li&gt;{@link #join(long) Thread.join} with timeout&lt;/li&gt;
         *   &lt;li&gt;{@link LockSupport#parkNanos LockSupport.parkNanos}&lt;/li&gt;
         *   &lt;li&gt;{@link LockSupport#parkUntil LockSupport.parkUntil}&lt;/li&gt;
         * &lt;/ul&gt;
         */</span>
        <span class="no">TIMED_WAITING</span><span class="o">,</span>

        <span class="cm">/**
         * Thread state for a terminated thread.
         * The thread has completed execution.
         */</span>
        <span class="no">TERMINATED</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// â€¦â€¦</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/thread-lifecycle.jpeg" alt="thread lifecycle">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/thread-states.jpeg" alt="thread states">
</div>
</div>
<div class="paragraph">
<p>Java å¯¹è±¡å†…å­˜å ç”¨å¤§å°ï¼š</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>å¯¹è±¡å¤´åœ¨32ä½ç³»ç»Ÿä¸Šå ç”¨8bytesï¼Œ64ä½ç³»ç»Ÿä¸Šå ç”¨16bytesã€‚å¼€å¯ï¼ˆ-XX:+UseCompressedOopsï¼‰å¯¹è±¡å¤´å¤§å°ä¸º12bytesï¼ˆ64ä½æœºå™¨ï¼‰ã€‚</p>
</li>
<li>
<p>64ä½æœºå™¨ä¸Šï¼Œæ•°ç»„å¯¹è±¡çš„å¯¹è±¡å¤´å ç”¨24ä¸ªå­—èŠ‚ï¼Œå¯ç”¨å‹ç¼©ä¹‹åå ç”¨16ä¸ªå­—èŠ‚ã€‚ä¹‹æ‰€ä»¥æ¯”æ™®é€šå¯¹è±¡å ç”¨å†…å­˜å¤šæ˜¯å› ä¸ºéœ€è¦é¢å¤–çš„ç©ºé—´å­˜å‚¨æ•°ç»„çš„é•¿åº¦ã€‚</p>
</li>
<li>
<p>64ä½æœºå™¨ä¸Šreferenceç±»å‹å ç”¨8ä¸ªå­—èŠ‚ï¼Œå¼€å¯æŒ‡é’ˆå‹ç¼©åå ç”¨4ä¸ªå­—èŠ‚ã€‚</p>
</li>
<li>
<p>å¤åˆå¯¹è±¡ï¼Œç›´æ¥è®¡ç®—å½“å‰å¯¹è±¡å ç”¨ç©ºé—´å¤§å°ï¼ŒåŒ…æ‹¬å½“å‰ç±»åŠè¶…ç±»çš„åŸºæœ¬ç±»å‹å®ä¾‹å­—æ®µå¤§å°ã€å¼•ç”¨ç±»å‹å®ä¾‹å­—æ®µå¼•ç”¨å¤§å°ã€å®ä¾‹åŸºæœ¬ç±»å‹æ•°ç»„æ€»å ç”¨ç©ºé—´ã€å®ä¾‹å¼•ç”¨ç±»å‹æ•°ç»„å¼•ç”¨æœ¬èº«å ç”¨ç©ºé—´å¤§å°; ä½†æ˜¯ä¸åŒ…æ‹¬è¶…ç±»ç»§æ‰¿ä¸‹æ¥çš„å’Œå½“å‰ç±»å£°æ˜çš„å®ä¾‹å¼•ç”¨å­—æ®µçš„å¯¹è±¡æœ¬èº«çš„å¤§å°ã€å®ä¾‹å¼•ç”¨æ•°ç»„å¼•ç”¨çš„å¯¹è±¡æœ¬èº«çš„å¤§å°ã€‚</p>
</li>
<li>
<p>å¯¹é½å¡«å……æ˜¯ä»¥æ¯ä¸ªå¯¹è±¡ä¸ºå•ä½è¿›è¡Œçš„ã€‚</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>HotSpotçš„å¯¹é½æ–¹å¼ä¸º8å­—èŠ‚å¯¹é½ï¼š <code>ï¼ˆå¯¹è±¡å¤´ + å®ä¾‹æ•°æ® + paddingï¼‰ % 8ç­‰äº0ä¸”0 &#8656; padding &lt; 8</code>ã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.openjdk.jol.info.ClassLayout</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.openjdk.jol.vm.VM</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-04-08 16:10
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JolTest</span> <span class="o">{</span>
    <span class="cm">/**
     * Java Object Layout
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="no">VM</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">details</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--o = 12--------------"</span><span class="o">);</span>
        <span class="nc">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">()</span> <span class="o">{};</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ClassLayout</span><span class="o">.</span><span class="na">parseInstance</span><span class="o">(</span><span class="n">o</span><span class="o">).</span><span class="na">toPrintable</span><span class="o">());</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--o2 = 12--------------"</span><span class="o">);</span>
        <span class="nc">Object</span> <span class="n">o2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
            <span class="kd">private</span> <span class="kt">long</span> <span class="n">age</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">};</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ClassLayout</span><span class="o">.</span><span class="na">parseInstance</span><span class="o">(</span><span class="n">o2</span><span class="o">).</span><span class="na">toPrintable</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--\"119\"--------------"</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">s</span> <span class="o">=</span> <span class="s">"119"</span><span class="o">;</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ClassLayout</span><span class="o">.</span><span class="na">parseInstance</span><span class="o">(</span><span class="n">s</span><span class="o">).</span><span class="na">toPrintable</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--119L--------------"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ClassLayout</span><span class="o">.</span><span class="na">parseInstance</span><span class="o">(</span><span class="mi">119L</span><span class="o">).</span><span class="na">toPrintable</span><span class="o">());</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--o[] = 16--------------"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ClassLayout</span><span class="o">.</span><span class="na">parseInstance</span><span class="o">(</span><span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="mi">0</span><span class="o">]).</span><span class="na">toPrintable</span><span class="o">());</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--o[1]--------------"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ClassLayout</span><span class="o">.</span><span class="na">parseInstance</span><span class="o">(</span><span class="k">new</span> <span class="nc">Object</span><span class="o">[]{</span><span class="k">new</span> <span class="nc">Object</span><span class="o">()}).</span><span class="na">toPrintable</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>join()</code> æ–¹æ³•çš„æœ¬è´¨æ˜¯å½“å‰çº¿ç¨‹å¯¹è±¡å®ä¾‹è°ƒç”¨çº¿ç¨‹ <code>wait()</code> æ–¹æ³•ã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.time.LocalDateTime</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.DelayQueue</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Delayed</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.LockSupport</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-03-12 18:07
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testState</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"StartTime: "</span> <span class="o">+</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
            <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">);</span>
                <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">i</span><span class="o">++;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"testState: is interrupted at "</span>
                        <span class="o">+</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"  EndTime: "</span> <span class="o">+</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
        <span class="o">});</span>
        <span class="c1">// NEW</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">thread</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="c1">// RUNNABLE</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">thread</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
        <span class="c1">// TIMED_WAITING</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">thread</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">9200</span><span class="o">);</span>
        <span class="c1">// RUNNABLE ??</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">thread</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">);</span>
        <span class="c1">// TERMINATED</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">thread</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testBlockState</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Object</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>
        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"thread2 got monitor lock..."</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">50</span><span class="o">);</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">50</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">t2</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInterrupt</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="kd">class</span> <span class="nc">InterruptTask</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">();</span>
                <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
                <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">thread</span><span class="o">.</span><span class="na">isInterrupted</span><span class="o">())</span> <span class="o">{</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"InterruptTask was interrupted at "</span>
                                <span class="o">+</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
                    <span class="o">}</span>
<span class="c1">//                    try {</span>
<span class="c1">//                        Thread.sleep(5 * 1000);</span>
<span class="c1">//                    } catch (InterruptedException e) {</span>
<span class="c1">//                        e.printStackTrace();</span>
<span class="c1">//                    }</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">InterruptTask</span><span class="o">());</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">20</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">);</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// TODO</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInterruptStatus1</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="kd">class</span> <span class="nc">InterruptTask</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">i</span><span class="o">++;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">InterruptTask</span><span class="o">());</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"thread.isInterrupted() = "</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="na">isInterrupted</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"thread.isInterrupted() = "</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="na">isInterrupted</span><span class="o">());</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">parkNanos</span><span class="o">(</span><span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="mi">2</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="c1">// TODO</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInterruptStatus2</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="kd">class</span> <span class="nc">IntDelay</span> <span class="kd">implements</span> <span class="nc">Delayed</span> <span class="o">{</span>

            <span class="kd">private</span> <span class="kt">int</span> <span class="n">num</span><span class="o">;</span>
            <span class="kd">private</span> <span class="kt">long</span> <span class="n">deadline</span><span class="o">;</span>

            <span class="kd">public</span> <span class="nf">IntDelay</span><span class="o">(</span><span class="kt">int</span> <span class="n">num</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">num</span> <span class="o">=</span> <span class="n">num</span><span class="o">;</span>
                <span class="n">deadline</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">+</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">toMillis</span><span class="o">(</span><span class="n">num</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getDelay</span><span class="o">(</span><span class="nc">TimeUnit</span> <span class="n">unit</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">deadline</span> <span class="o">-</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">int</span> <span class="nf">compareTo</span><span class="o">(</span><span class="nc">Delayed</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">IntDelay</span> <span class="n">param</span> <span class="o">=</span> <span class="o">(</span><span class="nc">IntDelay</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>
                <span class="k">return</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">compare</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">num</span><span class="o">,</span> <span class="n">param</span><span class="o">.</span><span class="na">num</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="kd">class</span> <span class="nc">InterruptTask</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="nc">Thread</span> <span class="n">current</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
                <span class="nc">DelayQueue</span><span class="o">&lt;</span><span class="nc">IntDelay</span><span class="o">&gt;</span> <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DelayQueue</span><span class="o">&lt;&gt;();</span>
                <span class="n">queue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">IntDelay</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Wait  "</span> <span class="o">+</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
                    <span class="n">queue</span><span class="o">.</span><span class="na">take</span><span class="o">();</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Taken "</span> <span class="o">+</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"current.isInterrupted() = "</span> <span class="o">+</span> <span class="n">current</span><span class="o">.</span><span class="na">isInterrupted</span><span class="o">());</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"current.isInterrupted() = "</span> <span class="o">+</span> <span class="n">current</span><span class="o">.</span><span class="na">isInterrupted</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">InterruptTask</span><span class="o">());</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">500</span><span class="o">);</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"thread.isInterrupted() = "</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="na">isInterrupted</span><span class="o">());</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">parkNanos</span><span class="o">(</span><span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="mi">2</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testWaitLock</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="c1">// æµ‹è¯• wait æ˜¯å¦é‡Šæ”¾é”</span>
        <span class="c1">// æ ¹æ®è¿è¡Œç»“æœæ¥çœ‹ï¼Œthread1 å’Œ thread2 æ˜¯äº¤å‰æ‰§è¡Œçš„ï¼Œ</span>
        <span class="c1">// åˆ™ï¼šçº¿ç¨‹åœ¨ wait æ—¶ï¼Œæ˜¯é‡Šæ”¾äº†é”çš„ï¼Œ</span>
        <span class="c1">// å†æ¬¡è·å–é”åï¼Œä¼šæ¥ç€ä¸Šæ¬¡æ‰§è¡Œç‚¹ç»§ç»­æ‰§è¡Œã€‚</span>
        <span class="c1">//</span>
        <span class="c1">// è¿™é‡Œè¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼šwait éœ€è¦åœ¨é”å¯¹è±¡ä¸Šæ‰§è¡Œï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚</span>
        <span class="nc">Object</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>
        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"thread1 start to wait..."</span><span class="o">);</span>
                    <span class="n">lock</span><span class="o">.</span><span class="na">wait</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"thread1 weak up..."</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"thread2 got monitor lock..."</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">50</span><span class="o">);</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSleepLock</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="c1">// æµ‹è¯• sleep æ˜¯å¦é‡Šæ”¾é”</span>
        <span class="c1">// æ ¹æ®è¾“å‡ºæ¥çœ‹ï¼Œthread1 æ‰§è¡Œå®Œåå†æ¬¡æ‰§è¡Œçš„ thread2</span>
        <span class="c1">// åˆ™ï¼šçº¿ç¨‹åœ¨ sleep æ—¶ï¼Œä¸é‡Šæ”¾é”ã€‚</span>
        <span class="nc">Object</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>
        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"thread1 start to wait..."</span><span class="o">);</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"thread1 weak up..."</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"thread2 got monitor lock..."</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">50</span><span class="o">);</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">3000</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testJoin</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">JoinMain</span><span class="o">.</span><span class="na">AddThread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JoinMain</span><span class="o">.</span><span class="na">AddThread</span><span class="o">();</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="c1">// æ‰§è¡Œè¿™å¥è¯ï¼Œåˆ™ä¸‹é¢çš„è¾“å‡ºä¼šç­‰ thread æ‰§è¡Œå®Œæˆåï¼Œiå€¼ç­‰äº100000ï¼›</span>
        <span class="c1">// å¦‚æœæ³¨é‡Šæ‰ï¼Œåˆ™ç¬é—´å‘ä¸‹æ‰§è¡Œï¼Œiå€¼å¾ˆå°ã€‚</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">JoinMain</span><span class="o">.</span><span class="na">i</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">JoinMain</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">volatile</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

        <span class="kd">static</span> <span class="kd">class</span> <span class="nc">AddThread</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testYield</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="nc">Integer</span> <span class="n">key</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="nc">Integer</span> <span class="n">key2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">yield</span><span class="o">();</span>
                <span class="nc">Integer</span> <span class="n">num</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">getOrDefault</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="o">++</span><span class="n">num</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="nc">Thread</span> <span class="n">thread2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Integer</span> <span class="n">num</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">getOrDefault</span><span class="o">(</span><span class="n">key2</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key2</span><span class="o">,</span> <span class="o">++</span><span class="n">num</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">thread2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
        <span class="c1">// å¦‚æœ Thread.yield() æ²¡æœ‰è®©å‡º CPUï¼Œåˆ™ä¸¤ä¸ªå€¼ç›¸å·®ä¸å¤šï¼›å¦åˆ™ç›¸å·®å¾ˆå¤§ã€‚</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">replace</span><span class="o">(</span><span class="s">","</span><span class="o">,</span> <span class="s">"\n"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">thread</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testChildThread</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// TODO å¦‚ä½•æ©é¥°çˆ¶å­çº¿ç¨‹ï¼Ÿå¦‚ä½•åœ¨çˆ¶å­çº¿ç¨‹ä¹‹é—´ä¼ é€’æ•°æ®ï¼Ÿ</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Thread</span><span class="o">&gt;</span> <span class="n">threads</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="nc">Thread</span> <span class="n">thread1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
            <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">threadLocal</span> <span class="o">=</span> <span class="nc">ThreadLocal</span><span class="o">.</span><span class="na">withInitial</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="mi">119</span><span class="o">);</span>

            <span class="nc">Thread</span> <span class="n">child</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="o">});</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"id=%d, parentId=%d %n"</span><span class="o">,</span> <span class="n">thread</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="mi">123</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">threads</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">thread1</span><span class="o">);</span>
        <span class="n">thread1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInterruptNoAction</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// è™½ç„¶ç»™çº¿ç¨‹å‘å‡ºäº†ä¸­æ–­ä¿¡å·ï¼Œä½†ç¨‹åºä¸­å¹¶æ²¡æœ‰å“åº”ä¸­æ–­ä¿¡å·çš„é€»è¾‘ï¼Œæ‰€ä»¥ç¨‹åºä¸ä¼šæœ‰ä»»ä½•ååº”ã€‚</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">yield</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInterruptAction</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">yield</span><span class="o">();</span>
                <span class="c1">// å“åº”ä¸­æ–­</span>
                <span class="k">if</span> <span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">isInterrupted</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"JavaæŠ€æœ¯æ ˆçº¿ç¨‹è¢«ä¸­æ–­ï¼Œç¨‹åºé€€å‡ºã€‚"</span><span class="o">);</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">parkNanos</span><span class="o">(</span><span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInterruptFailure</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// å“åº”ä¸­æ–­</span>
                <span class="k">if</span> <span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">isInterrupted</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"JavaæŠ€æœ¯æ ˆçº¿ç¨‹è¢«ä¸­æ–­ï¼Œç¨‹åºé€€å‡ºã€‚"</span><span class="o">);</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>

                <span class="k">try</span> <span class="o">{</span>
                    <span class="c1">// sleep() æ–¹æ³•è¢«ä¸­æ–­åä¼šæ¸…é™¤ä¸­æ–­æ ‡è®°ï¼Œæ‰€ä»¥å¾ªç¯ä¼šç»§ç»­è¿è¡Œã€‚ã€‚</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"JavaæŠ€æœ¯æ ˆçº¿ç¨‹ä¼‘çœ è¢«ä¸­æ–­ï¼Œç¨‹åºé€€å‡ºã€‚"</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getState</span><span class="o">()</span> <span class="o">+</span> <span class="s">" çº¿ç¨‹è‹é†’ï¼Œç»§ç»­æ‰§è¡Œâ€¦â€¦"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span> <span class="c1">// æ³¨æ„åŠ ä¸Šè¿™å¥è¯ï¼å¦åˆ™çº¿ç¨‹è¿˜æ²¡å¯åŠ¨å°±è¢«ç»ˆç«¯äº†</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">parkNanos</span><span class="o">(</span><span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">thread</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInterruptSleep</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// å“åº”ä¸­æ–­</span>
                <span class="k">if</span> <span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">isInterrupted</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"JavaæŠ€æœ¯æ ˆçº¿ç¨‹è¢«ä¸­æ–­ï¼Œç¨‹åºé€€å‡ºã€‚"</span><span class="o">);</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>

                <span class="k">try</span> <span class="o">{</span>
                    <span class="c1">// sleep() æ–¹æ³•è¢«ä¸­æ–­åä¼šæ¸…é™¤ä¸­æ–­æ ‡è®°ï¼Œæ‰€ä»¥å¾ªç¯ä¼šç»§ç»­è¿è¡Œã€‚ã€‚</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"JavaæŠ€æœ¯æ ˆ çº¿ç¨‹ ä¼‘çœ è¢«ä¸­æ–­ï¼Œç¨‹åºé€€å‡ºã€‚"</span><span class="o">);</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getState</span><span class="o">()</span> <span class="o">+</span> <span class="s">" çº¿ç¨‹è‹é†’ï¼Œç»§ç»­æ‰§è¡Œâ€¦â€¦"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span> <span class="c1">// æ³¨æ„åŠ ä¸Šè¿™å¥è¯ï¼å¦åˆ™çº¿ç¨‹è¿˜æ²¡å¯åŠ¨å°±è¢«ç»ˆç«¯äº†</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">parkNanos</span><span class="o">(</span><span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">thread</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSynchronized</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="kd">class</span> <span class="nc">Account</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">money</span> <span class="o">=</span> <span class="mi">100</span><span class="o">;</span>

            <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">increase</span><span class="o">()</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"start to increase"</span><span class="o">);</span>
                <span class="n">money</span> <span class="o">-=</span> <span class="mi">10</span><span class="o">;</span>
                <span class="kt">double</span> <span class="kt">var</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="kt">var</span> <span class="o">=</span> <span class="nc">Math</span><span class="o">.</span><span class="na">PI</span> <span class="o">*</span> <span class="nc">Math</span><span class="o">.</span><span class="na">E</span> <span class="o">*</span> <span class="n">i</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2000000</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"fire"</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"finish increasing."</span> <span class="o">+</span> <span class="kt">var</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">decrease</span><span class="o">()</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"start to decrease"</span><span class="o">);</span>
                <span class="n">money</span> <span class="o">+=</span> <span class="mi">20</span><span class="o">;</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"finish decreasing."</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="nc">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Account</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="nl">account:</span><span class="o">:</span><span class="n">increase</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="nl">account:</span><span class="o">:</span><span class="n">decrease</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">parkNanos</span><span class="o">(</span><span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="mi">30</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">money</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>çº¿ç¨‹ä¼‘çœ è‹é†’åï¼Œä¸­æ–­ä¿¡å·å°±ä¼šè¢«æ¸…é™¤ï¼æ‰€ä»¥ï¼Œå¦‚æœè¦å“åº”è¿™ç§ä¸­æ–­ï¼Œè¿˜éœ€è¦å†å¼‚å¸¸æ•è·ä»£ç æ®µå†æ¬¡ä¸­æ–­æ‰è¡Œï¼</p>
</div>
<div class="paragraph">
<p>çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢(<code>Context Switch</code>)ï¼Œéƒ½ä¿å­˜äº†å“ªäº›ä¿¡æ¯ï¼Ÿæ€ä¹ˆä¿å­˜çš„ï¼Ÿ</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Windows ç³»ç»Ÿä¸­ï¼Œhttps://docs.microsoft.com/zh-cn/sysinternals/downloads/process-explorer[Process Explorer] å¯ä»¥æŸ¥çœ‹ä¸Šä¸‹æ–‡åˆ‡æ¢ä¿¡æ¯ã€‚</p>
</li>
<li>
<p>é˜¿é‡Œå·´å·´æ¨å‡ºçš„ <a href="https://github.com/alibaba/arthas">Alibaba Arthas</a> ä¹Ÿæ˜¯ä¸€ä¸ªè¯Šæ–­åˆ©å™¨ã€‚</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_å‚è€ƒèµ„æ–™_8"><a class="anchor" href="#_å‚è€ƒèµ„æ–™_8"></a>41.1. å‚è€ƒèµ„æ–™</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://www.throwable.club/2019/06/23/java-concurrency-thread-state/">Javaçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸä¸çŠ¶æ€åˆ‡æ¢ - Throwable&#8217;s Blog</a></p>
</li>
<li>
<p><a href="https://www.iteye.com/blog/yueyemaitian-2033046">ä¸€ä¸ªå¯¹è±¡å ç”¨å¤šå°‘å­—èŠ‚ï¼Ÿ - ç”°éº¦ - ITeyeåšå®¢</a></p>
</li>
<li>
<p><a href="https://www.cnblogs.com/zhanjindong/p/3757767.html">ä¸€ä¸ªJavaå¯¹è±¡åˆ°åº•å ç”¨å¤šå¤§å†…å­˜ï¼Ÿ - zhanjindong - åšå®¢å›­</a></p>
</li>
<li>
<p><a href="https://zhuanlan.zhihu.com/p/45667127">ä¸€æ–‡ææ‡‚ Java çº¿ç¨‹ä¸­æ–­ - çŸ¥ä¹</a></p>
</li>
<li>
<p><a href="https://blog.csdn.net/justloveyou_/article/details/54929949">Java å¹¶å‘ï¼šçº¿ç¨‹é—´é€šä¿¡ä¸åä½œ_Java_Rico&#8217;s Blogs-CSDNåšå®¢</a></p>
</li>
<li>
<p><a href="https://blog.csdn.net/zheng548/article/details/54426947">synchronizedå’Œé”(ReentrantLock) åŒºåˆ«_Java_å°é£ç­-CSDNåšå®¢</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_locksupport"><a class="anchor" href="#_locksupport"></a>42. LockSupport</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.LockSupport</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-03-16 19:16
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LockSupportTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Task</span><span class="o">(</span><span class="s">"t1"</span><span class="o">));</span>
        <span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Task</span><span class="o">(</span><span class="s">"t2"</span><span class="o">));</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">unpark</span><span class="o">(</span><span class="n">t1</span><span class="o">);</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">unpark</span><span class="o">(</span><span class="n">t2</span><span class="o">);</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"finish..."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Task</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Task</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="nc">LockSupportTest</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"in "</span> <span class="o">+</span> <span class="n">name</span><span class="o">);</span>
                <span class="nc">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testParkAndUnpark</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--m1------"</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--t1------"</span><span class="o">);</span>
            <span class="nc">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--t2------"</span><span class="o">);</span>
        <span class="o">});</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">unpark</span><span class="o">(</span><span class="n">thread</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--m2------"</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>synchronized</code> å…³é”®å­—åœ¨æ–¹æ³•ä¸Šä½¿ç”¨æ—¶ï¼Œåœ¨æ–¹æ³•ä¿®é¥°ç¬¦ä¸Šå¢åŠ äº†ä¸€ä¸ªæ ‡å¿—ä½ <code>flags: (0x0021) ACC_PUBLIC, ACC_SYNCHRONIZED</code>ã€‚è€Œç”¨åœ¨ä»£ç å—æ—¶ï¼Œåˆ™æ˜¯ç”Ÿæˆäº† <code>monitorenter</code> å’Œ <code>monitorexit</code> æŒ‡ä»¤ã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-04-08 19:26
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SynchronizedTest</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">lockMethod</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"lock method"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">lockObject</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"lock object"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>å¯ä»¥åˆ©ç”¨ jclasslib Bytecode viewer å·¥å…·ï¼Œæˆ–è€… <code>javap -c -v XXX.class</code> æ¥æŸ¥çœ‹ã€‚</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_abstractqueuedsynchronizer"><a class="anchor" href="#_abstractqueuedsynchronizer"></a>43. AbstractQueuedSynchronizer</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Doug Lea</p>
</div>
<div class="paragraph">
<p>åœ¨ Java 5 ä¹‹åï¼ŒJDK å†…ç½®äº†å¤§é‡çš„å¹¶å‘å·¥å…·ç±»ã€‚ç²—ç•¥å»çœ‹è¿™äº›å·¥å…·ç±»çš„æºç ï¼Œä½ ä¼šå‘ç°ï¼Œå¤§å¤šæ•°éƒ½åœ¨å†…éƒ¨ç»§æ‰¿äº† <code>AbstractQueuedSynchronizer</code>ã€‚ç”±æ­¤å¯è§ï¼Œ<code>AbstractQueuedSynchronizer</code> çš„æ ¸å¿ƒåœ°ä½ã€‚æƒ³ææ¸…æ¥šè¿™äº›å¹¶å‘å·¥å…·ç±»çš„åŸç†ï¼Œ<code>AbstractQueuedSynchronizer</code> çš„æºç å¯ä»¥è¯´æ˜¯ä¸å¯ä¸çœ‹ã€‚</p>
</div>
<div class="sect2">
<h3 id="_clh_lock_queue_ä»‹ç»"><a class="anchor" href="#_clh_lock_queue_ä»‹ç»"></a>43.1. CLH lock queue ä»‹ç»</h3>
<div class="imageblock">
<div class="content">
<img src="./images/AbstractQueuedSynchronizer-CLH-queue.png" alt="AbstractQueuedSynchronizer CLH queue">
</div>
</div>
<div class="paragraph">
<p>ç»ˆäºçœ‹æ˜ç™½äº† CLH lock queueã€‚CLH é€šè¿‡è‡ªæ—‹æ¥é”å®šå½“å‰èŠ‚ç‚¹ã€‚è‡ªæ—‹çš„å¥½å¤„æ˜¯çº¿ç¨‹ä¸éœ€è¦ç¡çœ å’Œå”¤é†’ï¼Œå‡å°äº†ç³»ç»Ÿè°ƒç”¨çš„å¼€é”€ã€‚</p>
</div>
<div class="paragraph">
<p>AQS ä¸­çº¿ç¨‹ä¸æ˜¯ä¸€ç›´åœ¨è‡ªæ—‹çš„ï¼Œè€Œå¯èƒ½ä¼šåå¤çš„ç¡çœ å’Œå”¤é†’ï¼Œè¿™å°±éœ€è¦å‰ç»§é‡Šæ”¾é”çš„æ—¶å€™é€šè¿‡ next æŒ‡é’ˆæ‰¾åˆ°å…¶åç»§å°†å…¶å”¤é†’ï¼Œä¹Ÿå°±æ˜¯ AQS çš„ç­‰å¾…é˜Ÿåˆ—ä¸­åç»§æ˜¯è¢«å‰ç»§å”¤é†’çš„ã€‚AQS ç»“åˆäº†è‡ªæ—‹å’Œç¡çœ /å”¤é†’ä¸¤ç§æ–¹æ³•çš„ä¼˜ç‚¹ã€‚</p>
</div>
<div class="paragraph">
<p><em>AQS ç»“åˆäº†è‡ªæ—‹å’Œç¡çœ /å”¤é†’ä¸¤ç§æ–¹æ³•çš„ä¼˜ç‚¹ã€‚</em> è¿™å¥è¯è¯¥å¦‚ä½•ç†è§£ï¼Ÿåˆšåˆšæƒ³åˆ°çš„ä¸€ç‚¹ï¼š AQS ä¸­ä¼šå…ˆè‡ªæ—‹ä¸¤æ¬¡ï¼Œå¦‚æœä¸æˆåŠŸåˆ™ä¼‘çœ ã€‚åº”è¯¥æ˜¯è¿™æ ·æ¥ä½¿ç”¨ä¸¤è€…çš„å¥½å¤„ï¼</p>
</div>
<div class="paragraph">
<p>è‡ªå·±å®ç°ä¸€ä¸ª CLH é”ï¼</p>
</div>
</div>
<div class="sect2">
<h3 id="_æ ¸å¿ƒç‚¹"><a class="anchor" href="#_æ ¸å¿ƒç‚¹"></a>43.2. æ ¸å¿ƒç‚¹</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>æ¨¡æ¿æ–¹æ³•æ¨¡å¼</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>boolean tryAcquire(int arg)</code></p>
</li>
<li>
<p><code>boolean tryRelease(int arg)</code></p>
</li>
<li>
<p><code>int tryAcquireShared(int arg)</code></p>
</li>
<li>
<p><code>boolean tryReleaseShared(int arg)</code></p>
</li>
<li>
<p><code>boolean isHeldExclusively()</code></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>åŸºäº <code>AbstractQueuedSynchronizer</code>ï¼Œæˆ‘ä»¬å®ç°ä¸€ä¸ªäº’æ–¥é”ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.AbstractQueuedSynchronizer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.Condition</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.Lock</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-03-31 10:27
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Mutex</span> <span class="kd">implements</span> <span class="nc">Lock</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Sync</span> <span class="kd">extends</span> <span class="nc">AbstractQueuedSynchronizer</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">tryAcquire</span><span class="o">(</span><span class="kt">int</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">compareAndSetState</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">setExclusiveOwnerThread</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">());</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">tryRelease</span><span class="o">(</span><span class="kt">int</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">getState</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalMonitorStateException</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">setExclusiveOwnerThread</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
            <span class="n">setState</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">isHeldExclusively</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nf">getState</span><span class="o">()</span> <span class="o">==</span> <span class="mi">1</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nc">Condition</span> <span class="nf">newCodition</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">ConditionObject</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Sync</span> <span class="n">sync</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Sync</span><span class="o">();</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">lock</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">sync</span><span class="o">.</span><span class="na">acquire</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">lockInterruptibly</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="n">sync</span><span class="o">.</span><span class="na">acquireInterruptibly</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">tryLock</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">sync</span><span class="o">.</span><span class="na">tryAcquire</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">tryLock</span><span class="o">(</span><span class="kt">long</span> <span class="n">time</span><span class="o">,</span> <span class="nc">TimeUnit</span> <span class="n">unit</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">sync</span><span class="o">.</span><span class="na">tryAcquireSharedNanos</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">unit</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="n">time</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">unlock</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">sync</span><span class="o">.</span><span class="na">release</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Condition</span> <span class="nf">newCondition</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">sync</span><span class="o">.</span><span class="na">newCodition</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isLocked</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">sync</span><span class="o">.</span><span class="na">isHeldExclusively</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasQueuedThreads</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">sync</span><span class="o">.</span><span class="na">hasQueuedThreads</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>äº’æ–¥é”ï¼Œä¹Ÿå¯ä»¥ç§°ä¸ºç‹¬å é”ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯åŒä¸€ä¸ªæ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è·å–åˆ°é”ï¼Œè€Œå…¶ä»–è·å–é”çš„çº¿ç¨‹åªèƒ½åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œåªæœ‰è·å–é”çš„çº¿ç¨‹é‡Šæ”¾äº†é”ï¼Œåç»§çš„çº¿ç¨‹æ‰èƒ½è·å–é”ã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.invoke.MethodHandles</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.invoke.VarHandle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutorService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Executors</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-03-31 11:41
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AbstractQueuedSynchronizerTest</span> <span class="o">{</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testNode</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">AqsNode</span> <span class="n">head</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AqsNode</span><span class="o">();</span>
        <span class="nc">AqsNode</span> <span class="n">next</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AqsNode</span><span class="o">(</span><span class="nc">AqsNode</span><span class="o">.</span><span class="na">EXCLUSIVE</span><span class="o">);</span>
        <span class="n">head</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
        <span class="n">next</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span>
        <span class="nc">AqsNode</span> <span class="n">tail</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AqsNode</span><span class="o">(</span><span class="nc">AqsNode</span><span class="o">.</span><span class="na">EXCLUSIVE</span><span class="o">);</span>
        <span class="n">next</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">tail</span><span class="o">;</span>
        <span class="n">tail</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Thread</span><span class="o">&gt;</span> <span class="n">threads</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">AqsNode</span> <span class="n">node</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span> <span class="n">node</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">threads</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">node</span><span class="o">.</span><span class="na">thread</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">threads</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">AqsNode</span> <span class="o">{</span>

        <span class="kd">static</span> <span class="kd">final</span> <span class="nc">AqsNode</span> <span class="no">SHARED</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AqsNode</span><span class="o">();</span>
        <span class="kd">static</span> <span class="kd">final</span> <span class="nc">AqsNode</span> <span class="no">EXCLUSIVE</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">CANCELLED</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">SIGNAL</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
        <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">CONDITION</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">;</span>
        <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">PROPAGATE</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="o">;</span>

        <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">waitStatus</span><span class="o">;</span>

        <span class="kd">volatile</span> <span class="nc">AqsNode</span> <span class="n">prev</span><span class="o">;</span>

        <span class="kd">volatile</span> <span class="nc">AqsNode</span> <span class="n">next</span><span class="o">;</span>

        <span class="kd">volatile</span> <span class="nc">Thread</span> <span class="n">thread</span><span class="o">;</span>

        <span class="nc">AqsNode</span> <span class="n">nextWaiter</span><span class="o">;</span>

        <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">isShared</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">nextWaiter</span> <span class="o">==</span> <span class="no">SHARED</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">final</span> <span class="nc">AqsNode</span> <span class="nf">predecessor</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">AqsNode</span> <span class="n">p</span> <span class="o">=</span> <span class="n">prev</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
            <span class="k">else</span>
                <span class="k">return</span> <span class="n">p</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nc">AqsNode</span><span class="o">()</span> <span class="o">{</span>
        <span class="o">}</span>

        <span class="nc">AqsNode</span><span class="o">(</span><span class="nc">AqsNode</span> <span class="n">nextWaiter</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">nextWaiter</span> <span class="o">=</span> <span class="n">nextWaiter</span><span class="o">;</span>
            <span class="no">THREAD</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="nc">AqsNode</span><span class="o">(</span><span class="kt">int</span> <span class="n">waitStatus</span><span class="o">)</span> <span class="o">{</span>
            <span class="no">WAITSTATUS</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">waitStatus</span><span class="o">);</span>
            <span class="no">THREAD</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">compareAndSetWaitStatus</span><span class="o">(</span><span class="kt">int</span> <span class="n">expect</span><span class="o">,</span> <span class="kt">int</span> <span class="n">update</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="no">WAITSTATUS</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">expect</span><span class="o">,</span> <span class="n">update</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">compareAndSetNext</span><span class="o">(</span><span class="nc">AqsNode</span> <span class="n">expect</span><span class="o">,</span> <span class="nc">AqsNode</span> <span class="n">update</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="no">NEXT</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">expect</span><span class="o">,</span> <span class="n">update</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">final</span> <span class="kt">void</span> <span class="nf">setPrevRelaxed</span><span class="o">(</span><span class="nc">AqsNode</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
            <span class="no">PREV</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">p</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">VarHandle</span> <span class="no">NEXT</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">VarHandle</span> <span class="no">PREV</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">VarHandle</span> <span class="no">THREAD</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">VarHandle</span> <span class="no">WAITSTATUS</span><span class="o">;</span>

        <span class="kd">static</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">MethodHandles</span><span class="o">.</span><span class="na">Lookup</span> <span class="n">l</span> <span class="o">=</span> <span class="nc">MethodHandles</span><span class="o">.</span><span class="na">lookup</span><span class="o">();</span>
                <span class="no">NEXT</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="na">findVarHandle</span><span class="o">(</span><span class="nc">AqsNode</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"next"</span><span class="o">,</span> <span class="nc">AqsNode</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                <span class="no">PREV</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="na">findVarHandle</span><span class="o">(</span><span class="nc">AqsNode</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"prev"</span><span class="o">,</span> <span class="nc">AqsNode</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                <span class="no">THREAD</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="na">findVarHandle</span><span class="o">(</span><span class="nc">AqsNode</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"thread"</span><span class="o">,</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                <span class="no">WAITSTATUS</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="na">findVarHandle</span><span class="o">(</span><span class="nc">AqsNode</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"waitStatus"</span><span class="o">,</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ReflectiveOperationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ExceptionInInitializerError</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testCustomLock</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Mutex</span> <span class="n">mutex</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Mutex</span><span class="o">();</span>
        <span class="nc">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">executorService</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="kt">int</span> <span class="n">time</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
                    <span class="n">mutex</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"thread=%d running time=%d%n"</span><span class="o">,</span>
                            <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">(),</span> <span class="n">time</span><span class="o">);</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">time</span><span class="o">);</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"thread=%d finished%n"</span><span class="o">,</span>
                            <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">());</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">mutex</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>

                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
        <span class="n">executorService</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">executorService</span><span class="o">.</span><span class="na">isTerminated</span><span class="o">())</span> <span class="o">{</span>
        <span class="o">}</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">50000</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"All task were finished."</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>è¿è¡Œç»“æœæ˜¾ç¤ºï¼ŒæŒ‡å®šæ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¿è¡Œã€‚</p>
</div>
<div class="paragraph">
<p>æŸ¥çœ‹ <code>AbstractQueuedSynchronizer</code> ç»§æ‰¿å…³ç³»å¯ä»¥çœ‹å‡ºï¼Œåœ¨ <code>ReentrantLock</code>ï¼Œ<code>ReentrantReadWriteLock</code> å’Œ <code>Semaphore</code> ä¸‰ä¸ªç±»ä¸­å®ç°äº†å…¬å¹³é”å’Œéå…¬å¹³é”ã€‚</p>
</div>
</div>
<div class="sect2">
<h3 id="_node_è¯¦è§£"><a class="anchor" href="#_node_è¯¦è§£"></a>43.3. <code>Node</code> è¯¦è§£</h3>
<div class="ulist">
<ul>
<li>
<p><code>waitStatus</code>ï¼šå½“å‰ <code>Node</code> çš„ç­‰å¾…çŠ¶æ€ï¼Œæœ‰äº”ä¸ªå¯é€‰å€¼ã€‚</p>
</li>
<li>
<p><code>prev</code>ï¼šå½“å‰ <code>Node</code> å®ä¾‹çš„å‰é©±èŠ‚ç‚¹å¼•ç”¨ã€‚</p>
</li>
<li>
<p><code>next</code>ï¼šå½“å‰ <code>Node</code> å®ä¾‹çš„åç»§èŠ‚ç‚¹å¼•ç”¨ã€‚</p>
</li>
<li>
<p><code>thread</code>ï¼šå½“å‰ <code>Node</code> å®ä¾‹æŒæœ‰çš„çº¿ç¨‹å®ä¾‹å¼•ç”¨ã€‚</p>
</li>
<li>
<p><code>nextWaiter</code>ï¼šè¿™ä¸ªå€¼æ˜¯ä¸€ä¸ªæ¯”è¾ƒå®¹æ˜“ä»¤äººç”Ÿç–‘çš„å€¼ï¼Œè™½ç„¶è¡¨é¢ä¸Šå®ƒç§°ä¸º"ä¸‹ä¸€ä¸ªç­‰å¾…çš„èŠ‚ç‚¹"ï¼Œä½†æ˜¯å®é™…ä¸Šå®ƒæœ‰ä¸‰ç§å–å€¼çš„æƒ…å†µã€‚</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>å€¼ä¸ºé™æ€å®ä¾‹ <code>Node.EXCLUSIVE</code>(ä¹Ÿå°±æ˜¯ <code>null</code>)ï¼Œä»£è¡¨å½“å‰çš„ <code>Node</code> å®ä¾‹æ˜¯ç‹¬å æ¨¡å¼ã€‚</p>
</li>
<li>
<p>å€¼ä¸ºé™æ€å®ä¾‹ <code>Node.SHARED</code>ï¼Œä»£è¡¨å½“å‰çš„ <code>Node</code> å®ä¾‹æ˜¯å…±äº«æ¨¡å¼ã€‚</p>
</li>
<li>
<p>å€¼ä¸ºé <code>Node.EXCLUSIVE</code> å’Œ <code>Node.SHARED</code> çš„å…¶ä»–èŠ‚ç‚¹å®ä¾‹ï¼Œä»£è¡¨ <code>Condition</code> ç­‰å¾…é˜Ÿåˆ—ä¸­å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªç­‰å¾…èŠ‚ç‚¹ã€‚</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_node_ä¸­ä¸€äº›å¸¸é‡å®šä¹‰"><a class="anchor" href="#_node_ä¸­ä¸€äº›å¸¸é‡å®šä¹‰"></a>43.3.1. <code>Node</code> ä¸­ä¸€äº›å¸¸é‡å®šä¹‰</h4>
<div class="paragraph">
<p>åŒºåˆ†å…±äº«é”è¿˜æ˜¯ç‹¬å å¼é”çš„å¸¸é‡ï¼Œæ˜¯å¦‚ä½•è¢«ä½¿ç”¨çš„ï¼Ÿç‹¬å é”ä¸ºä½•æ²¡æœ‰åˆå§‹åŒ–ï¼Ÿ</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>static final Node SHARED = new Node();</code></p>
</li>
<li>
<p><code>static final Node EXCLUSIVE = null;</code>&#8201;&#8212;&#8201;ä¸ºä½•æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Ÿ</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>å…±äº«é”çš„è¯ï¼Œå¤§å®¶ä½¿ç”¨åŒä¸€ä¸ª <code>Node</code> å®ä¾‹ï¼Œè€Œç‹¬è‡ªé”åˆ™æ˜¯æ¯ä¸ªä»»åŠ¡ä½¿ç”¨ä¸€ä¸ª <code>Node</code> å®ä¾‹ã€‚å¯ä»¥è¿™æ ·ç†è§£å—ï¼Ÿ</p>
</div>
<div class="paragraph">
<p>èŠ‚ç‚¹çš„çŠ¶æ€</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>static final int CANCELLED =  1;</code>&#8201;&#8212;&#8201;è¡¨ç¤ºå½“å‰çš„çº¿ç¨‹è¢«å–æ¶ˆï¼›</p>
</li>
<li>
<p><code>static final int SIGNAL    = -1;</code>&#8201;&#8212;&#8201;è¡¨ç¤ºå½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹åŒ…å«çš„çº¿ç¨‹éœ€è¦è¿è¡Œï¼Œä¹Ÿå°±æ˜¯unparkï¼›</p>
</li>
<li>
<p><code>static final int CONDITION = -2;</code>&#8201;&#8212;&#8201;è¡¨ç¤ºå½“å‰èŠ‚ç‚¹åœ¨ç­‰å¾…conditionï¼Œä¹Ÿå°±æ˜¯åœ¨conditioné˜Ÿåˆ—ä¸­ï¼›</p>
</li>
<li>
<p><code>static final int PROPAGATE = -3;</code>&#8201;&#8212;&#8201;è¡¨ç¤ºå½“å‰åœºæ™¯ä¸‹åç»­çš„acquireSharedèƒ½å¤Ÿå¾—ä»¥æ‰§è¡Œï¼›</p>
</li>
<li>
<p><code>0</code>&#8201;&#8212;&#8201;è¡¨ç¤ºå½“å‰èŠ‚ç‚¹åœ¨syncé˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…ç€è·å–é”ã€‚</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>æ¨¡æ¿æ–¹æ³•ï¼š</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>isHeldExclusively()</code>&#8201;&#8212;&#8201;è¯¥çº¿ç¨‹æ˜¯å¦æ­£åœ¨ç‹¬å èµ„æºã€‚åªæœ‰ç”¨åˆ°conditionæ‰éœ€è¦å»å®ç°å®ƒã€‚</p>
</li>
<li>
<p><code>tryAcquire(int)</code>&#8201;&#8212;&#8201;ç‹¬å æ–¹å¼ã€‚å°è¯•è·å–èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›falseã€‚</p>
</li>
<li>
<p><code>tryRelease(int)</code>&#8201;&#8212;&#8201;ç‹¬å æ–¹å¼ã€‚å°è¯•é‡Šæ”¾èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›falseã€‚</p>
</li>
<li>
<p><code>tryAcquireShared(int)</code>&#8201;&#8212;&#8201;å…±äº«æ–¹å¼ã€‚å°è¯•è·å–èµ„æºã€‚è´Ÿæ•°è¡¨ç¤ºå¤±è´¥ï¼›0è¡¨ç¤ºæˆåŠŸï¼Œä½†æ²¡æœ‰å‰©ä½™å¯ç”¨èµ„æºï¼›æ­£æ•°è¡¨ç¤ºæˆåŠŸï¼Œä¸”æœ‰å‰©ä½™èµ„æºã€‚</p>
</li>
<li>
<p><code>tryReleaseShared(int)</code>&#8201;&#8212;&#8201;å…±äº«æ–¹å¼ã€‚å°è¯•é‡Šæ”¾èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›falseã€‚</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ç‹¬å æ¨¡å¼"><a class="anchor" href="#_ç‹¬å æ¨¡å¼"></a>43.4. ç‹¬å æ¨¡å¼</h3>
<div class="paragraph">
<p>ç‹¬å æ¨¡å¼çš„åŒæ­¥å™¨çš„ä¸€ä¸ªæ˜¾è‘—ç‰¹ç‚¹å°±æ˜¯ï¼šå¤´èŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ªæœ‰æ•ˆ(éå–æ¶ˆ)çš„åç»§èŠ‚ç‚¹ï¼Œæ€»æ˜¯å°è¯•è·å–èµ„æºï¼Œä¸€æ—¦è·å–èµ„æºæˆåŠŸå°±ä¼šè§£é™¤é˜»å¡å¹¶ä¸”æ™‹å‡ä¸ºå¤´èŠ‚ç‚¹ï¼ŒåŸæ¥æ‰€åœ¨èŠ‚ç‚¹ä¼šç§»é™¤å‡ºåŒæ­¥ç­‰å¾…é˜Ÿåˆ—ï¼ŒåŸæ¥çš„é˜Ÿåˆ—é•¿åº¦å°±ä¼šå‡å°‘1ï¼Œç„¶åå¤´ç»“ç‚¹çš„ç¬¬ä¸€ä¸ªæœ‰æ•ˆçš„åç»§èŠ‚ç‚¹ç»§ç»­å¼€å§‹ç«äº‰èµ„æºã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
</pre></td><td class="code"><pre>    <span class="cm">/**
     * Checks and updates status for a node that failed to acquire.
     * Returns true if thread should block. This is the main signal
     * control in all acquire loops.  Requires that pred == node.prev.
     *
     * @param pred node's predecessor holding status
     * @param node the node
     * @return {@code true} if thread should block
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">shouldParkAfterFailedAcquire</span><span class="o">(</span><span class="nc">Node</span> <span class="n">pred</span><span class="o">,</span> <span class="nc">Node</span> <span class="n">node</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹å·²ç»åœ¨æ’é˜Ÿï¼Œåˆ™æ–°åŠ å…¥çš„èŠ‚ç‚¹å°±åº”è¯¥ park</span>
        <span class="kt">int</span> <span class="n">ws</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="na">waitStatus</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">ws</span> <span class="o">==</span> <span class="nc">Node</span><span class="o">.</span><span class="na">SIGNAL</span><span class="o">)</span>
            <span class="cm">/*
             * This node has already set status asking a release
             * to signal it, so it can safely park.
             */</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="c1">// å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹å·²ç»å–æ¶ˆï¼Œåˆ™åˆ é™¤å–æ¶ˆèŠ‚ç‚¹</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">ws</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="cm">/*
             * Predecessor was cancelled. Skip over predecessors and
             * indicate retry.
             */</span>
            <span class="c1">// è·³è¿‡å·²ç»å–æ¶ˆçš„èŠ‚ç‚¹</span>
            <span class="k">do</span> <span class="o">{</span>
                <span class="n">node</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="na">prev</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">pred</span><span class="o">.</span><span class="na">waitStatus</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">);</span>
            <span class="c1">// åŠ å…¥é˜Ÿåˆ—</span>
            <span class="n">pred</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">node</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="cm">/*
             * waitStatus must be 0 or PROPAGATE.  Indicate that we
             * need a signal, but don't park yet.  Caller will need to
             * retry to make sure it cannot acquire before parking.
             */</span>
            <span class="c1">// å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹æ²¡æœ‰å–æ¶ˆï¼Œåˆ™å°è¯•å°†å‰ä¸€ä¸ªèŠ‚ç‚¹è®¾ç½®ä¸º Node.SIGNAL</span>
            <span class="n">pred</span><span class="o">.</span><span class="na">compareAndSetWaitStatus</span><span class="o">(</span><span class="n">ws</span><span class="o">,</span> <span class="nc">Node</span><span class="o">.</span><span class="na">SIGNAL</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Convenience method to interrupt current thread.
     */</span>
    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">selfInterrupt</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Convenience method to park and then check if interrupted.
     *
     * @return {@code true} if interrupted
     */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">parkAndCheckInterrupt</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="k">return</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/*
     * Various flavors of acquire, varying in exclusive/shared and
     * control modes.  Each is mostly the same, but annoyingly
     * different.  Only a little bit of factoring is possible due to
     * interactions of exception mechanics (including ensuring that we
     * cancel if tryAcquire throws exception) and other control, at
     * least not without hurting performance too much.
     */</span>

    <span class="cm">/**
     * Acquires in exclusive uninterruptible mode for thread already in
     * queue. Used by condition wait methods as well as acquire.
     *
     * @param node the node
     * @param arg the acquire argument
     * @return {@code true} if interrupted while waiting
     */</span>
    <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">acquireQueued</span><span class="o">(</span><span class="kd">final</span> <span class="nc">Node</span> <span class="n">node</span><span class="o">,</span> <span class="kt">int</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">interrupted</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="nc">Node</span> <span class="n">p</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">predecessor</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">head</span> <span class="o">&amp;&amp;</span> <span class="n">tryAcquire</span><span class="o">(</span><span class="n">arg</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">setHead</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
                    <span class="n">p</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// help GC</span>
                    <span class="k">return</span> <span class="n">interrupted</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="c1">// æ­¤æ—¶ node èŠ‚ç‚¹å·²ç»é€šè¿‡ addWaiter æ–¹æ³•åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­</span>
                <span class="c1">// 1ã€å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯ SIGNALï¼Œåˆ™è¿”å› trueï¼Œpark è¯¥çº¿ç¨‹</span>
                <span class="c1">// 2.1 å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹å–æ¶ˆï¼Œåˆ™é€šè¿‡éå†å°†ä¹‹å‰çš„è¿ç»­çš„å–æ¶ˆèŠ‚ç‚¹å…¨éƒ¨åˆ é™¤ï¼Œ</span>
                <span class="c1">//     è¿”å› falseï¼Œå†æ¬¡è‡ªæ—‹å°è¯•è·å–é”</span>
                <span class="c1">// 2.2 å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹æ²¡æœ‰å–æ¶ˆï¼Œåˆ™å°†å‰ä¸€ä¸ªèŠ‚ç‚¹å°è¯•ä¿®æ”¹ä¸º SIGNALã€‚</span>
                <span class="c1">//     é‚£ä¹ˆä¸‹ä¸€æ¬¡å¾ªç¯æ—¶ï¼Œèµ°ç¬¬ä¸€ä¸ªåˆ¤æ–­ï¼Œè¿”å› trueï¼Œpark è¯¥çº¿ç¨‹ã€‚</span>
                <span class="c1">//     æˆ–è€…å‰é©±èŠ‚ç‚¹å·²ç»å¼¹å‡ºé˜Ÿåˆ—ï¼Œåˆ™è¯¥çº¿ç¨‹å°è¯•è·å–é”ã€‚</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">shouldParkAfterFailedAcquire</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">node</span><span class="o">))</span>
                    <span class="n">interrupted</span> <span class="o">|=</span> <span class="n">parkAndCheckInterrupt</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">cancelAcquire</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">interrupted</span><span class="o">)</span>
                <span class="n">selfInterrupt</span><span class="o">();</span>
            <span class="k">throw</span> <span class="n">t</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>å¯ä»¥ç”»ä¸€ä¸‹æµç¨‹å›¾ï¼š</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ä»¥ <code>ReentrantLock</code> ä¸ºä¾‹ï¼Œåœ¨ç‹¬å æ¨¡å¼ä¸‹ï¼Œè·å–é”çš„è¿‡ç¨‹</p>
</li>
<li>
<p>ä»¥ <code>ReentrantLock</code> ä¸ºä¾‹ï¼Œåœ¨ç‹¬å æ¨¡å¼ä¸‹ï¼Œé‡Šæ”¾é”çš„è¿‡ç¨‹</p>
</li>
<li>
<p>ä½¿ç”¨ <code>Condition</code> å¯¹è±¡ï¼Œ<code>await()</code> çš„è¿‡ç¨‹</p>
</li>
<li>
<p>ä½¿ç”¨ <code>Condition</code> å¯¹è±¡ï¼Œ<code>signal()</code> çš„è¿‡ç¨‹</p>
</li>
<li>
<p>ä»¥ <code>Semaphore</code> ä¸ºä¾‹ï¼Œåœ¨å…±äº«æ¨¡å¼ä¸‹ï¼Œè·å–é”çš„è¿‡ç¨‹</p>
</li>
<li>
<p>ä»¥ <code>Semaphore</code> ä¸ºä¾‹ï¼Œåœ¨å…±äº«æ¨¡å¼ä¸‹ï¼Œé‡Šæ”¾é”çš„è¿‡ç¨‹</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_å…±äº«æ¨¡å¼"><a class="anchor" href="#_å…±äº«æ¨¡å¼"></a>43.5. å…±äº«æ¨¡å¼</h3>
<div class="paragraph">
<p>å…±äº«æ¨¡å¼çš„åŒæ­¥å™¨çš„ä¸€ä¸ªæ˜¾è‘—ç‰¹ç‚¹å°±æ˜¯ï¼šå¤´èŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ªæœ‰æ•ˆ(éå–æ¶ˆ)çš„åç»§èŠ‚ç‚¹ï¼Œæ€»æ˜¯å°è¯•è·å–èµ„æºï¼Œä¸€æ—¦è·å–èµ„æºæˆåŠŸå°±ä¼šè§£é™¤é˜»å¡å¹¶ä¸”æ™‹å‡ä¸ºå¤´èŠ‚ç‚¹ï¼ŒåŸæ¥æ‰€åœ¨èŠ‚ç‚¹ä¼šç§»é™¤å‡ºåŒæ­¥ç­‰å¾…é˜Ÿåˆ—ï¼ŒåŸæ¥çš„é˜Ÿåˆ—é•¿åº¦å°±ä¼šå‡å°‘1ï¼Œé‡æ–°è®¾ç½®å¤´èŠ‚ç‚¹çš„è¿‡ç¨‹ä¼šä¼ æ’­å”¤é†’çš„çŠ¶æ€ï¼Œç®€å•æ¥è¯´å°±æ˜¯å”¤é†’ä¸€ä¸ªæœ‰æ•ˆçš„åç»§èŠ‚ç‚¹ï¼Œåªè¦ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥æ™‹å‡ä¸ºå¤´èŠ‚ç‚¹ï¼Œå®ƒçš„åç»§èŠ‚ç‚¹å°±èƒ½è¢«å”¤é†’ã€‚èŠ‚ç‚¹çš„å”¤é†’é¡ºåºéµå¾ªç±»ä¼¼äºFIFOçš„åŸåˆ™ï¼Œé€šä¿—è¯´å°±æ˜¯å…ˆé˜»å¡æˆ–è€…é˜»å¡æ—¶é—´æœ€é•¿åˆ™å…ˆè¢«å”¤é†’ã€‚</p>
</div>
</div>
<div class="sect2">
<h3 id="_conditionobject"><a class="anchor" href="#_conditionobject"></a>43.6. <code>ConditionObject</code></h3>
<div class="paragraph">
<p>å…³äºè¿™æ®µä»£ç çš„ç ”ç©¶ï¼Œå¯ä»¥å‚çœ‹ <a href="#"><code>java.util.concurrent.ArrayBlockingQueue</code></a>ã€‚<code>ArrayBlockingQueue</code> åœ¨å®ç° <code>poll(long, java.util.concurrent.TimeUnit)</code> æ–¹æ³•æ—¶ï¼Œä½¿ç”¨äº† <code>Condition notEmpty</code> å¯¹è±¡æ¥è°ƒç”¨ <code>ConditionObject.awaitNanos(long)</code> æ–¹æ³•ã€‚</p>
</div>
</div>
<div class="sect2">
<h3 id="_å‚è€ƒèµ„æ–™_9"><a class="anchor" href="#_å‚è€ƒèµ„æ–™_9"></a>43.7. å‚è€ƒèµ„æ–™</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
è®¿é—®ä¸€äº›é¡µé¢æ—¶å‘ç°ä¸€äº›é¡µé¢å·²ç»ä¸èƒ½è®¿é—®äº†ï¼Œåç»­å†æœç´¢è¡¥ä¸Šå§ã€‚
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://www.throwable.club/2019/04/07/java-juc-aqs-source-code/">JUCåŒæ­¥å™¨æ¡†æ¶AbstractQueuedSynchronizeræºç å›¾æ–‡åˆ†æ - Throwable&#8217;s Blog</a></p>
</li>
<li>
<p><a href="https://www.cnblogs.com/dennyzhangdd/p/7218510.html">ã€ŠThe java.util.concurrent Synchronizer Frameworkã€‹ JUCåŒæ­¥å™¨æ¡†æ¶ï¼ˆAQSæ¡†æ¶ï¼‰åŸæ–‡ç¿»è¯‘ - åªä¼šä¸€ç‚¹java - åšå®¢å›­</a></p>
</li>
<li>
<p><a href="https://www.cnblogs.com/waterystone/p/4920797.html">Javaå¹¶å‘ä¹‹AQSè¯¦è§£ - waterystone - åšå®¢å›­</a></p>
</li>
<li>
<p><a href="https://www.cnblogs.com/chengxiao/archive/2017/07/24/7141160.html">Javaå¹¶å‘åŒ…åŸºçŸ³-AQSè¯¦è§£ - dreamcatcher-cx - åšå®¢å›­</a></p>
</li>
<li>
<p><a href="http://www.cnblogs.com/leesf456/p/5350186.html">ã€JUCã€‘JDK1.8æºç åˆ†æä¹‹AbstractQueuedSynchronizerï¼ˆäºŒï¼‰ - leesf - åšå®¢å›­</a></p>
</li>
<li>
<p><a href="http://www.infoq.com/cn/articles/jdk1.8-abstractqueuedsynchronizer">æ·±åº¦è§£æJava 8ï¼šJDK1.8 AbstractQueuedSynchronizerçš„å®ç°åˆ†æï¼ˆä¸Šï¼‰</a></p>
</li>
<li>
<p><a href="http://www.infoq.com/cn/articles/java8-abstractqueuedsynchronizer">æ·±åº¦è§£æJava 8ï¼šAbstractQueuedSynchronizerçš„å®ç°åˆ†æï¼ˆä¸‹ï¼‰</a></p>
</li>
<li>
<p><a href="http://www.molotang.com/articles/480.html">Lockã€ReentrantLockå’ŒAbstractQueuedSynchronizerçš„æºç è¦ç‚¹åˆ†ææ•´ç† | ä¸‰çŸ³Â·é“</a></p>
</li>
<li>
<p><a href="http://zhanjindong.com/2015/03/10/java-concurrent-package-aqs-overview">Javaå¹¶å‘åŒ…æºç å­¦ä¹ ä¹‹AQSæ¡†æ¶ï¼ˆä¸€ï¼‰æ¦‚è¿° - Jindong Zhan</a></p>
</li>
<li>
<p><a href="http://zhanjindong.com/2015/03/11/java-concurrent-package-aqs-clh-and-spin-lock">Javaå¹¶å‘åŒ…æºç å­¦ä¹ ä¹‹AQSæ¡†æ¶ï¼ˆäºŒï¼‰CLH lock queueå’Œè‡ªæ—‹é” - Jindong Zhan</a></p>
</li>
<li>
<p><a href="http://zhanjindong.com/2015/03/14/java-concurrent-package-aqs-locksupport-and-thread-interrupt">Javaå¹¶å‘åŒ…æºç å­¦ä¹ ä¹‹AQSæ¡†æ¶ï¼ˆä¸‰ï¼‰LockSupportå’Œinterrupt - Jindong Zhan</a></p>
</li>
<li>
<p><a href="http://zhanjindong.com/2015/03/15/java-concurrent-package-aqs-AbstractQueuedSynchronizer">Javaå¹¶å‘åŒ…æºç å­¦ä¹ ä¹‹AQSæ¡†æ¶ï¼ˆå››ï¼‰AbstractQueuedSynchronizeræºç åˆ†æ - Jindong Zhan</a></p>
</li>
<li>
<p><a href="http://ifeve.com/introduce-abstractqueuedsynchronizer/">AbstractQueuedSynchronizerçš„ä»‹ç»å’ŒåŸç†åˆ†æ | å¹¶å‘ç¼–ç¨‹ç½‘ - ifeve.com</a></p>
</li>
<li>
<p><a href="http://coderbee.net/index.php/concurrent/20131209/614">JUC æºç åˆ†æ ä¸€ AbstractQueuedSynchronizer | ç èœ‚ç¬”è®°</a></p>
</li>
<li>
<p><a href="http://www.hiyangqi.com/java%20concurrency/java-concurrency-AQS.html">Java å¤šçº¿ç¨‹åŸºæœ¬å·¥å…·çš„åŸç†AQS</a></p>
</li>
<li>
<p><a href="http://www.tqcto.com/article/internet/5807.html">JUC æºç åˆ†æ 3 AbstractQueuedSynchronizer å…±äº«æ¨¡å¼ ä¸ CountDownLatch - äº’è”ç½‘ - çˆ±ä¸Šç¼–ç¨‹æŠ€æœ¯åšå®¢</a></p>
</li>
<li>
<p><a href="http://jiangwenfeng762.iteye.com/blog/1293814">é€šè¿‡CountDownLatchæ¥åˆ†æAbstractQueuedSynchronizerçš„æºç  - - ITeyeæŠ€æœ¯ç½‘ç«™</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reentrantlock"><a class="anchor" href="#_reentrantlock"></a>44. ReentrantLock</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>ReentrantLock</code> æ˜¯é‡å…¥é”ï¼Œä¹Ÿæ˜¯æ’ä»–é”ã€‚</p>
</div>
<div class="sect2">
<h3 id="_è°ˆè°ˆ_synchronized_å’Œ_reentrantlock_çš„åŒºåˆ«"><a class="anchor" href="#_è°ˆè°ˆ_synchronized_å’Œ_reentrantlock_çš„åŒºåˆ«"></a>44.1. è°ˆè°ˆ synchronized å’Œ ReentrantLock çš„åŒºåˆ«</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ä¸¤è€…éƒ½æ˜¯å¯é‡å…¥é”</p>
<div class="paragraph">
<p>ä¸¤è€…éƒ½æ˜¯å¯é‡å…¥é”ã€‚â€œå¯é‡å…¥é”â€æ¦‚å¿µæ˜¯ï¼šè‡ªå·±å¯ä»¥å†æ¬¡è·å–è‡ªå·±çš„å†…éƒ¨é”ã€‚æ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹è·å¾—äº†æŸä¸ªå¯¹è±¡çš„é”ï¼Œæ­¤æ—¶è¿™ä¸ªå¯¹è±¡é”è¿˜æ²¡æœ‰é‡Šæ”¾ï¼Œå½“å…¶å†æ¬¡æƒ³è¦è·å–è¿™ä¸ªå¯¹è±¡çš„é”çš„æ—¶å€™è¿˜æ˜¯å¯ä»¥è·å–çš„ï¼Œå¦‚æœä¸å¯é”é‡å…¥çš„è¯ï¼Œå°±ä¼šé€ æˆæ­»é”ã€‚åŒä¸€ä¸ªçº¿ç¨‹æ¯æ¬¡è·å–é”ï¼Œé”çš„è®¡æ•°å™¨éƒ½è‡ªå¢1ï¼Œæ‰€ä»¥è¦ç­‰åˆ°é”çš„è®¡æ•°å™¨ä¸‹é™ä¸º0æ—¶æ‰èƒ½é‡Šæ”¾é”ã€‚</p>
</div>
</li>
<li>
<p>synchronized ä¾èµ–äº JVM è€Œ ReentrantLock ä¾èµ–äº API</p>
<div class="paragraph">
<p>synchronized æ˜¯ä¾èµ–äº JVM å®ç°çš„ï¼Œå‰é¢æˆ‘ä»¬ä¹Ÿè®²åˆ°äº† è™šæ‹Ÿæœºå›¢é˜Ÿåœ¨ JDK1.6 ä¸º synchronized å…³é”®å­—è¿›è¡Œäº†å¾ˆå¤šä¼˜åŒ–ï¼Œä½†æ˜¯è¿™äº›ä¼˜åŒ–éƒ½æ˜¯åœ¨è™šæ‹Ÿæœºå±‚é¢å®ç°çš„ï¼Œå¹¶æ²¡æœ‰ç›´æ¥æš´éœ²ç»™æˆ‘ä»¬ã€‚ReentrantLock æ˜¯ JDK å±‚é¢å®ç°çš„ï¼ˆä¹Ÿå°±æ˜¯ API å±‚é¢ï¼Œéœ€è¦ lock() å’Œ unlock() æ–¹æ³•é…åˆ try/finally è¯­å¥å—æ¥å®Œæˆï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥çœ‹å®ƒçš„æºä»£ç ï¼Œæ¥çœ‹å®ƒæ˜¯å¦‚ä½•å®ç°çš„ã€‚</p>
</div>
</li>
<li>
<p>ReentrantLock æ¯” synchronized å¢åŠ äº†ä¸€äº›é«˜çº§åŠŸèƒ½</p>
<div class="paragraph">
<p>ç›¸æ¯”synchronizedï¼ŒReentrantLockå¢åŠ äº†ä¸€äº›é«˜çº§åŠŸèƒ½ã€‚ä¸»è¦æ¥è¯´ä¸»è¦æœ‰ä¸‰ç‚¹ï¼š<strong>â‘ ç­‰å¾…å¯ä¸­æ–­ï¼›â‘¡å¯å®ç°å…¬å¹³é”ï¼›â‘¢å¯å®ç°é€‰æ‹©æ€§é€šçŸ¥ï¼ˆé”å¯ä»¥ç»‘å®šå¤šä¸ªæ¡ä»¶ï¼‰</strong></p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><strong>ReentrantLockæä¾›äº†ä¸€ç§èƒ½å¤Ÿä¸­æ–­ç­‰å¾…é”çš„çº¿ç¨‹çš„æœºåˆ¶</strong>ï¼Œé€šè¿‡lock.lockInterruptibly()æ¥å®ç°è¿™ä¸ªæœºåˆ¶ã€‚ä¹Ÿå°±æ˜¯è¯´æ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹å¯ä»¥é€‰æ‹©æ”¾å¼ƒç­‰å¾…ï¼Œæ”¹ä¸ºå¤„ç†å…¶ä»–äº‹æƒ…ã€‚</p>
</li>
<li>
<p><strong>ReentrantLockå¯ä»¥æŒ‡å®šæ˜¯å…¬å¹³é”è¿˜æ˜¯éå…¬å¹³é”ã€‚</strong>*è€Œsynchronizedåªèƒ½æ˜¯éå…¬å¹³é”ã€‚æ‰€è°“çš„å…¬å¹³é”å°±æ˜¯å…ˆç­‰å¾…çš„çº¿ç¨‹å…ˆè·å¾—é”ã€‚ ReentrantLocké»˜è®¤æƒ…å†µæ˜¯éå…¬å¹³çš„ï¼Œå¯ä»¥é€šè¿‡ ReentrantLockç±»çš„ReentrantLock(boolean fair)æ„é€ æ–¹æ³•æ¥åˆ¶å®šæ˜¯å¦æ˜¯å…¬å¹³çš„ã€‚</p>
</li>
<li>
<p>synchronizedå…³é”®å­—ä¸wait()å’Œnotify()/notifyAll()æ–¹æ³•ç›¸ç»“åˆå¯ä»¥å®ç°ç­‰å¾…/é€šçŸ¥æœºåˆ¶ï¼ŒReentrantLockç±»å½“ç„¶ä¹Ÿå¯ä»¥å®ç°ï¼Œä½†æ˜¯éœ€è¦å€ŸåŠ©äºConditionæ¥å£ä¸newCondition() æ–¹æ³•ã€‚Conditionæ˜¯JDK1.5ä¹‹åæ‰æœ‰çš„ï¼Œå®ƒå…·æœ‰å¾ˆå¥½çš„çµæ´»æ€§ï¼Œæ¯”å¦‚å¯ä»¥å®ç°å¤šè·¯é€šçŸ¥åŠŸèƒ½ä¹Ÿå°±æ˜¯åœ¨ä¸€ä¸ªLockå¯¹è±¡ä¸­å¯ä»¥åˆ›å»ºå¤šä¸ªConditionå®ä¾‹ï¼ˆå³å¯¹è±¡ç›‘è§†å™¨ï¼‰ï¼Œ<strong>çº¿ç¨‹å¯¹è±¡å¯ä»¥æ³¨å†Œåœ¨æŒ‡å®šçš„Conditionä¸­ï¼Œä»è€Œå¯ä»¥æœ‰é€‰æ‹©æ€§çš„è¿›è¡Œçº¿ç¨‹é€šçŸ¥ï¼Œåœ¨è°ƒåº¦çº¿ç¨‹ä¸Šæ›´åŠ çµæ´»ã€‚ åœ¨ä½¿ç”¨notify()/notifyAll()æ–¹æ³•è¿›è¡Œé€šçŸ¥æ—¶ï¼Œè¢«é€šçŸ¥çš„çº¿ç¨‹æ˜¯ç”± JVM é€‰æ‹©çš„ï¼Œç”¨ReentrantLockç±»ç»“åˆConditionå®ä¾‹å¯ä»¥å®ç°â€œé€‰æ‹©æ€§é€šçŸ¥â€</strong>ï¼Œè¿™ä¸ªåŠŸèƒ½éå¸¸é‡è¦ï¼Œè€Œä¸”æ˜¯Conditionæ¥å£é»˜è®¤æä¾›çš„ã€‚è€Œsynchronizedå…³é”®å­—å°±ç›¸å½“äºæ•´ä¸ªLockå¯¹è±¡ä¸­åªæœ‰ä¸€ä¸ªConditionå®ä¾‹ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½æ³¨å†Œåœ¨å®ƒä¸€ä¸ªèº«ä¸Šã€‚å¦‚æœæ‰§è¡ŒnotifyAll()æ–¹æ³•çš„è¯å°±ä¼šé€šçŸ¥æ‰€æœ‰å¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹è¿™æ ·ä¼šé€ æˆå¾ˆå¤§çš„æ•ˆç‡é—®é¢˜ï¼Œè€ŒConditionå®ä¾‹çš„signalAll()æ–¹æ³• åªä¼šå”¤é†’æ³¨å†Œåœ¨è¯¥Conditionå®ä¾‹ä¸­çš„æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ã€‚</p>
<div class="paragraph">
<p>å¦‚æœä½ æƒ³ä½¿ç”¨ä¸Šè¿°åŠŸèƒ½ï¼Œé‚£ä¹ˆé€‰æ‹©ReentrantLockæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>æ€§èƒ½å·²ä¸æ˜¯é€‰æ‹©æ ‡å‡†</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.time.LocalDateTime</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.Condition</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.Lock</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.ReentrantLock</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-03-13 17:10
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReentrantLockTest</span> <span class="o">{</span>
    <span class="cm">/**
     * æµ‹è¯•å¯é‡å…¥æ€§
     */</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testReentrant</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">SumTask</span> <span class="n">task</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SumTask</span><span class="o">();</span>
        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">SumTask</span><span class="o">.</span><span class="na">i</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SumTask</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Lock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">1_000_000</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
                <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">i</span><span class="o">++;</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
                    <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testExtraUnlock</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Lock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Locking..."</span><span class="o">);</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">});</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Finished..."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInterrupt</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">InterruptTask</span><span class="o">());</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
<span class="c1">//        Thread.sleep(2);</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Finished..."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">InterruptTask</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="kd">public</span> <span class="nc">ReentrantLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">lock</span><span class="o">.</span><span class="na">lockInterruptibly</span><span class="o">();</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">100_000</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="n">j</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"InterruptTask was interrupted."</span><span class="o">);</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"i="</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">lock</span><span class="o">.</span><span class="na">isHeldByCurrentThread</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"i="</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
                    <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testCondition</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">ReentrantLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>
        <span class="nc">Condition</span> <span class="n">condition</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">ConditionTask</span><span class="o">(</span><span class="n">lock</span><span class="o">,</span> <span class="n">condition</span><span class="o">));</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="n">condition</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ConditionTask</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Lock</span> <span class="n">lock</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Condition</span> <span class="n">condition</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">ConditionTask</span><span class="o">(</span><span class="nc">Lock</span> <span class="n">lock</span><span class="o">,</span> <span class="nc">Condition</span> <span class="n">condition</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">lock</span> <span class="o">=</span> <span class="n">lock</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">condition</span> <span class="o">=</span> <span class="n">condition</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
                <span class="n">condition</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Thread is going on..."</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testExclusive</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">ReentrantLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="s">"t1"</span><span class="o">)</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"t1 : "</span> <span class="o">+</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">throwable</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">};</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>

        <span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="s">"t2"</span><span class="o">)</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"t2 : "</span> <span class="o">+</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">throwable</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">};</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">15000</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"DONE"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="code"><pre>    <span class="cm">/**
     * Acquires in exclusive mode, aborting if interrupted.
     * Implemented by first checking interrupt status, then invoking
     * at least once {@link #tryAcquire}, returning on
     * success.  Otherwise the thread is queued, possibly repeatedly
     * blocking and unblocking, invoking {@link #tryAcquire}
     * until success or the thread is interrupted.  This method can be
     * used to implement method {@link Lock#lockInterruptibly}.
     *
     * @param arg the acquire argument.  This value is conveyed to
     *        {@link #tryAcquire} but is otherwise uninterpreted and
     *        can represent anything you like.
     * @throws InterruptedException if the current thread is interrupted
     */</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">acquireInterruptibly</span><span class="o">(</span><span class="kt">int</span> <span class="n">arg</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">())</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">InterruptedException</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">tryAcquire</span><span class="o">(</span><span class="n">arg</span><span class="o">))</span>
            <span class="n">doAcquireInterruptibly</span><span class="o">(</span><span class="n">arg</span><span class="o">);</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>å…ˆåˆ¤æ–­æ˜¯å¦æœ‰ä¸­æ–­ï¼Œæœ‰åˆ™å“åº”ã€‚ä»è¿™é‡Œå°±å¯ä»¥çœ‹å‡ºï¼Œåœ¨åŠ é”ä¹‹å‰ä¹Ÿå¯ä»¥è¢«ä¸­æ–­ã€‚</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reentrantreadwritelock"><a class="anchor" href="#_reentrantreadwritelock"></a>45. ReentrantReadWriteLock</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.Lock</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.ReentrantReadWriteLock</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-03-16 17:07
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReentrantReadWriteLockTest</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">value</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">handleRead</span><span class="o">(</span><span class="nc">Lock</span> <span class="n">lock</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">" : read done!"</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleWrite</span><span class="o">(</span><span class="nc">Lock</span> <span class="n">lock</span><span class="o">,</span> <span class="kt">int</span> <span class="n">value</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">" : write done!"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">ReentrantReadWriteLock</span> <span class="n">readWriteLock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantReadWriteLock</span><span class="o">();</span>
        <span class="nc">ReentrantReadWriteLock</span><span class="o">.</span><span class="na">ReadLock</span> <span class="n">readLock</span> <span class="o">=</span> <span class="n">readWriteLock</span><span class="o">.</span><span class="na">readLock</span><span class="o">();</span>
        <span class="nc">ReentrantReadWriteLock</span><span class="o">.</span><span class="na">WriteLock</span> <span class="n">writeLock</span> <span class="o">=</span> <span class="n">readWriteLock</span><span class="o">.</span><span class="na">writeLock</span><span class="o">();</span>

        <span class="nc">Runnable</span> <span class="n">readTask</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">handleRead</span><span class="o">(</span><span class="n">readLock</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">};</span>

        <span class="nc">Runnable</span> <span class="n">writeTask</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">handleWrite</span><span class="o">(</span><span class="n">writeLock</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">};</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">5</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">writeTask</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">readTask</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">20</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_stampedlock"><a class="anchor" href="#_stampedlock"></a>46. StampedLock</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutorService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Executors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ThreadLocalRandom</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.StampedLock</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-03-16 23:15
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">StampedLockTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">StampedLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StampedLock</span><span class="o">();</span>
        <span class="nc">Point</span> <span class="n">point</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Point</span><span class="o">(</span><span class="n">lock</span><span class="o">);</span>
        <span class="nc">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">executorService</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="nc">ThreadLocalRandom</span> <span class="n">random</span> <span class="o">=</span> <span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">();</span>
                <span class="n">point</span><span class="o">.</span><span class="na">move</span><span class="o">(</span><span class="n">random</span><span class="o">.</span><span class="na">nextDouble</span><span class="o">(</span><span class="mi">100</span><span class="o">),</span> <span class="n">random</span><span class="o">.</span><span class="na">nextDouble</span><span class="o">(</span><span class="mi">100</span><span class="o">));</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"move point..."</span><span class="o">);</span>
            <span class="o">});</span>

            <span class="n">executorService</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="kt">double</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="na">distanceFromOrigin</span><span class="o">();</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"current distance = "</span> <span class="o">+</span> <span class="n">distance</span><span class="o">);</span>
            <span class="o">});</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Point</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">double</span> <span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">StampedLock</span> <span class="n">lock</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Point</span><span class="o">(</span><span class="nc">StampedLock</span> <span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">lock</span> <span class="o">=</span> <span class="n">lock</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kt">void</span> <span class="nf">move</span><span class="o">(</span><span class="kt">double</span> <span class="n">deltaX</span><span class="o">,</span> <span class="kt">double</span> <span class="n">deltaxY</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">long</span> <span class="n">stamp</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">writeLock</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">x</span> <span class="o">+=</span> <span class="n">deltaX</span><span class="o">;</span>
                <span class="n">y</span> <span class="o">+=</span> <span class="n">deltaxY</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">(</span><span class="n">stamp</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="kt">double</span> <span class="nf">distanceFromOrigin</span><span class="o">()</span> <span class="o">{</span>
            <span class="kt">long</span> <span class="n">stamp</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">tryOptimisticRead</span><span class="o">();</span>
            <span class="kt">double</span> <span class="n">currentX</span> <span class="o">=</span> <span class="n">x</span><span class="o">,</span> <span class="n">currentY</span> <span class="o">=</span> <span class="n">y</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">lock</span><span class="o">.</span><span class="na">validate</span><span class="o">(</span><span class="n">stamp</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">stamp</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">readLock</span><span class="o">();</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">currentX</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span>
                    <span class="n">currentY</span> <span class="o">=</span> <span class="n">y</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">(</span><span class="n">stamp</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="nc">Math</span><span class="o">.</span><span class="na">sqrt</span><span class="o">(</span><span class="n">currentX</span> <span class="o">*</span> <span class="n">currentX</span> <span class="o">+</span> <span class="n">currentY</span> <span class="o">*</span> <span class="n">currentY</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_semaphore"><a class="anchor" href="#_semaphore"></a>47. Semaphore</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ä¿¡å·é‡</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutorService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Executors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Semaphore</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.LockSupport</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-03-16 16:51
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SemaphoreTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">20</span><span class="o">);</span>
        <span class="nc">Semaphore</span> <span class="n">semaphore</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Semaphore</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">executorService</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nc">Task</span><span class="o">(</span><span class="n">semaphore</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">executorService</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">executorService</span><span class="o">.</span><span class="na">isTerminated</span><span class="o">())</span> <span class="o">{</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Ok..."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Task</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Semaphore</span> <span class="n">semaphore</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Task</span><span class="o">(</span><span class="nc">Semaphore</span> <span class="n">semaphore</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">semaphore</span> <span class="o">=</span> <span class="n">semaphore</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">semaphore</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">" :done!"</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">semaphore</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testReentrant</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// å°† Semaphore çš„å‚æ•°åˆ†åˆ«è®¾ç½®æˆ 1 å’Œ 5 è¿è¡Œçœ‹ç»“æœ</span>
        <span class="c1">// é€’å½’è°ƒç”¨çš„æ¬¡æ•°è·Ÿ Semaphore çš„å‚æ•°ä¸€è‡´</span>
        <span class="c1">// è¯´æ˜ï¼Œå¦‚æœ Semaphore å‚æ•°ä¸º 1 æ—¶ï¼Œå®ƒä¸æ”¯æŒé‡å…¥ã€‚</span>
        <span class="nc">Semaphore</span> <span class="n">semaphore</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Semaphore</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
        <span class="kd">class</span> <span class="nc">Task</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
            <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Semaphore</span> <span class="n">semaphore</span><span class="o">;</span>
            <span class="kd">private</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>

            <span class="kd">public</span> <span class="nf">Task</span><span class="o">(</span><span class="nc">Semaphore</span> <span class="n">semaphore</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">semaphore</span> <span class="o">=</span> <span class="n">semaphore</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">semaphore</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">len</span><span class="o">++);</span>
                    <span class="n">run</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">semaphore</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Task</span><span class="o">(</span><span class="n">semaphore</span><span class="o">)).</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">parkNanos</span><span class="o">(</span><span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_countdownlatch"><a class="anchor" href="#_countdownlatch"></a>48. CountDownLatch</h2>
<div class="sectionbody">
<div class="paragraph">
<p>"Count Down" åœ¨è‹±è¯­ä¸­æ„ä¸ºå€’è®¡æ•°ï¼Œä¸€ä¸ªå…¸å‹åœºæ™¯å°±æ˜¯ç«ç®­ğŸš€å‘å°„æ—¶çš„å€’è®¡æ—¶ã€‚å®ƒå…è®¸ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ç­‰å¾…å…¶ä»–çº¿ç¨‹å®Œæˆæ“ä½œã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.time.LocalDateTime</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.CountDownLatch</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutorService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Executors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.LockSupport</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-03-16 17:23
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CountDownLatchTest</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">CountDownLatch</span> <span class="n">latch</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CountDownLatch</span><span class="o">(</span><span class="n">count</span><span class="o">);</span>
        <span class="nc">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="n">count</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">executorService</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nc">Task</span><span class="o">(</span><span class="n">latch</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">latch</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Fire..."</span><span class="o">);</span>
        <span class="n">executorService</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">executorService</span><span class="o">.</span><span class="na">isTerminated</span><span class="o">())</span> <span class="o">{</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"All task were done."</span><span class="o">);</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">parkNanos</span><span class="o">(</span><span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="mi">5</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Terminal at "</span> <span class="o">+</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Task</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">CountDownLatch</span> <span class="n">latch</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Task</span><span class="o">(</span><span class="nc">CountDownLatch</span> <span class="n">latch</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">latch</span> <span class="o">=</span> <span class="n">latch</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">time</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
                <span class="n">latch</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">" time = "</span> <span class="o">+</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">time</span><span class="o">);</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">" sleep = "</span> <span class="o">+</span> <span class="n">time</span> <span class="o">+</span> <span class="s">": check finished."</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬å¼€å§‹çœ‹ <code>CountDownLatch</code> æºç ï¼š</p>
</div>
<div class="paragraph">
<p><code>CountDownLatch</code> ç±»ä¸­å­˜åœ¨ä¸€ä¸ªå†…éƒ¨ç±» <code>Sync</code>ï¼Œç»§æ‰¿è‡ª <code>AbstractQueuedSynchronizer</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="code"><pre><span class="cm">/**
 * Synchronization control For CountDownLatch.
 * Uses AQS state to represent count.
 */</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Sync</span> <span class="kd">extends</span> <span class="nc">AbstractQueuedSynchronizer</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">4982264981922014374L</span><span class="o">;</span>

    <span class="nc">Sync</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">setState</span><span class="o">(</span><span class="n">count</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kt">int</span> <span class="nf">getCount</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getState</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kt">int</span> <span class="nf">tryAcquireShared</span><span class="o">(</span><span class="kt">int</span> <span class="n">acquires</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">getState</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">tryReleaseShared</span><span class="o">(</span><span class="kt">int</span> <span class="n">releases</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Decrement count; signal when transition to zero</span>
        <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">getState</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">nextc</span> <span class="o">=</span> <span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">compareAndSetState</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">nextc</span><span class="o">))</span>
                <span class="k">return</span> <span class="n">nextc</span> <span class="o">==</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">final</span> <span class="nc">Sync</span> <span class="n">sync</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ç®¡ä¸­çª¥è±¹ï¼Œä»è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡º <code>CountDownLatch</code> ä¸­çš„ç­‰å¾…æ§åˆ¶å‡ ä¹éƒ½æ˜¯ä¾èµ– <code>AbstractQueuedSynchronizer</code> æ¥å®ç°çš„ã€‚</p>
</div>
<div class="sect2">
<h3 id="_await"><a class="anchor" href="#_await"></a>48.1. <code>await()</code></h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="code"><pre><span class="cm">/**
 * Causes the current thread to wait until the latch has counted down to
 * zero, unless the thread is {@linkplain Thread#interrupt interrupted}.
 *
 * &lt;p&gt;If the current count is zero then this method returns immediately.
 *
 * &lt;p&gt;If the current count is greater than zero then the current
 * thread becomes disabled for thread scheduling purposes and lies
 * dormant until one of two things happen:
 * &lt;ul&gt;
 * &lt;li&gt;The count reaches zero due to invocations of the
 * {@link #countDown} method; or
 * &lt;li&gt;Some other thread {@linkplain Thread#interrupt interrupts}
 * the current thread.
 * &lt;/ul&gt;
 *
 * &lt;p&gt;If the current thread:
 * &lt;ul&gt;
 * &lt;li&gt;has its interrupted status set on entry to this method; or
 * &lt;li&gt;is {@linkplain Thread#interrupt interrupted} while waiting,
 * &lt;/ul&gt;
 * then {@link InterruptedException} is thrown and the current thread's
 * interrupted status is cleared.
 *
 * @throws InterruptedException if the current thread is interrupted
 *         while waiting
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">await</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="n">sync</span><span class="o">.</span><span class="na">acquireSharedInterruptibly</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>å¯¹ <code>await()</code> çš„å¤„ç†ç›´æ¥å§”æ‰˜ç»™äº† <code>sync</code> çš„ <code>acquireSharedInterruptibly(1)</code> æ–¹æ³•ï¼Œå½“ç„¶è¿™ä¸ªæ–¹æ³•æ˜¯ä» <code>AbstractQueuedSynchronizer</code> ç»§æ‰¿è€Œæ¥çš„ã€‚æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•ï¼š</p>
</div>
<div class="listingblock">
<div class="title">AbstractQueuedSynchronizer</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre>    <span class="cm">/**
     * Acquires in shared mode, aborting if interrupted.  Implemented
     * by first checking interrupt status, then invoking at least once
     * {@link #tryAcquireShared}, returning on success.  Otherwise the
     * thread is queued, possibly repeatedly blocking and unblocking,
     * invoking {@link #tryAcquireShared} until success or the thread
     * is interrupted.
     * @param arg the acquire argument.
     * This value is conveyed to {@link #tryAcquireShared} but is
     * otherwise uninterpreted and can represent anything
     * you like.
     * @throws InterruptedException if the current thread is interrupted
     */</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">acquireSharedInterruptibly</span><span class="o">(</span><span class="kt">int</span> <span class="n">arg</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">())</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">InterruptedException</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">tryAcquireShared</span><span class="o">(</span><span class="n">arg</span><span class="o">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
            <span class="n">doAcquireSharedInterruptibly</span><span class="o">(</span><span class="n">arg</span><span class="o">);</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ç»“åˆä¸Šé¢æåˆ°çš„ <code>Sync</code> ä¸­çš„ <code>tryAcquireShared(int acquires)</code> æ–¹æ³•ï¼Œå¯ä»¥çœ‹å‡ºï¼Œå½“ <code>getState()</code> ä¸ä¸ºé›¶æ—¶ï¼Œå°±ä¼šå¯¼è‡´ <code>tryAcquireShared(arg)</code> ç»“æœè¿”å›å°äºé›¶ï¼Œè¿›è€Œè°ƒç”¨ <code>doAcquireSharedInterruptibly(arg)</code>ï¼Œå°†çº¿ç¨‹è¿›å…¥æ’é˜Ÿï¼Œç„¶åæŒ‚èµ·çº¿ç¨‹ã€‚</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/CountDownLatch-await-park.png" alt="CountDownLatch await park">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/CountDownLatch-await-unpark.png" alt="CountDownLatch await unpark">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_countdown"><a class="anchor" href="#_countdown"></a>48.2. <code>countDown()</code></h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
</pre></td><td class="code"><pre><span class="cm">/**
 * Decrements the count of the latch, releasing all waiting threads if
 * the count reaches zero.
 *
 * &lt;p&gt;If the current count is greater than zero then it is decremented.
 * If the new count is zero then all waiting threads are re-enabled for
 * thread scheduling purposes.
 *
 * &lt;p&gt;If the current count equals zero then nothing happens.
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">countDown</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">sync</span><span class="o">.</span><span class="na">releaseShared</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>è¿™é‡Œçš„ <code>releaseShared(1)</code> æ–¹æ³•æ˜¯ä» <code>AbstractQueuedSynchronizer</code> ç»§æ‰¿è¿‡æ¥çš„ï¼Œæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„å®ç°ï¼š</p>
</div>
<div class="listingblock">
<div class="title">AbstractQueuedSynchronizer</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
</pre></td><td class="code"><pre>    <span class="cm">/**
     * Releases in shared mode.  Implemented by unblocking one or more
     * threads if {@link #tryReleaseShared} returns true.
     *
     * @param arg the release argument.  This value is conveyed to
     *        {@link #tryReleaseShared} but is otherwise uninterpreted
     *        and can represent anything you like.
     * @return the value returned from {@link #tryReleaseShared}
     */</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">releaseShared</span><span class="o">(</span><span class="kt">int</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">tryReleaseShared</span><span class="o">(</span><span class="n">arg</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">doReleaseShared</span><span class="o">();</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ç»“åˆä¸Šé¢æåˆ°çš„ <code>Sync</code> ä¸­çš„ <code>tryReleaseShared(int releases)</code> æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼š<code>countDown()</code> æ–¹æ³•ç›´æ¥å‡å°‘é”å­˜å™¨è®¡æ•°ï¼Œå¦‚æœä¸ä¸ºé›¶ï¼Œåˆ™æ— æ‰€ä½œä¸ºï¼›å‡å°‘åˆ°é›¶ï¼Œåˆ™é‡Šæ”¾æ‰€æœ‰ä¸Šè¿°é€šè¿‡ <code>await()</code> æ–¹æ³•æŒ‚èµ·çš„æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ã€‚</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/CountDownLatch-countDown-1.png" alt="CountDownLatch countDown 1">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/CountDownLatch-countDown-2.png" alt="CountDownLatch countDown 2">
</div>
</div>
<div class="qlist qanda">
<ol>
<li>
<p><em><code>CountDownLatch</code> ä¸ºä»€ä¹ˆä½¿ç”¨å…±äº«é”ï¼Ÿ</em></p>
<p>ç­”ï¼šå‰é¢æˆ‘ä»¬åˆ†æ <code>ReentrantReadWriteLock</code> çš„æ—¶å€™å­¦ä¹ è¿‡AQSçš„å…±äº«é”æ¨¡å¼ï¼Œæ¯”å¦‚å½“å‰é”æ˜¯ç”±ä¸€ä¸ªçº¿ç¨‹è·å–ä¸ºäº’æ–¥é”ï¼Œé‚£ä¹ˆè¿™æ—¶å€™æ‰€æœ‰éœ€è¦è·å–å…±äº«é”çš„çº¿ç¨‹éƒ½è¦è¿›å…¥AQSé˜Ÿåˆ—ä¸­è¿›è¡Œæ’é˜Ÿï¼Œå½“è¿™ä¸ªäº’æ–¥é”é‡Šæ”¾çš„æ—¶å€™ï¼Œä¼šä¸€ä¸ªæ¥ç€ä¸€ä¸ªåœ°å”¤é†’è¿™äº›è¿ç»­çš„æ’é˜Ÿçš„ç­‰å¾…è·å–å…±äº«é”çš„çº¿ç¨‹ï¼Œæ³¨æ„ï¼Œè¿™é‡Œçš„ç”¨è¯­æ˜¯â€œä¸€ä¸ªæ¥ç€ä¸€ä¸ªåœ°å”¤é†’â€ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™äº›ç­‰å¾…è·å–å…±äº«é”çš„çº¿ç¨‹ä¸æ˜¯ä¸€æ¬¡æ€§å”¤é†’çš„ã€‚</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_å‚è€ƒèµ„æ–™_10"><a class="anchor" href="#_å‚è€ƒèµ„æ–™_10"></a>48.3. å‚è€ƒèµ„æ–™</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://www.cnblogs.com/leesf456/p/5406191.html">ã€JUCã€‘JDK1.8æºç åˆ†æä¹‹CountDownLatchï¼ˆäº”ï¼‰ - leesf - åšå®¢å›­</a></p>
</li>
<li>
<p><a href="https://juejin.im/post/5d0660f2518825092c7170dd">æ­»ç£• javaåŒæ­¥ç³»åˆ—ä¹‹CountDownLatchæºç è§£æ - æ˜é‡‘</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cyclicbarrier"><a class="anchor" href="#_cyclicbarrier"></a>49. CyclicBarrier</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.BrokenBarrierException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.CyclicBarrier</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutorService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Executors</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-03-16 17:24
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CyclicBarrierTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">CyclicBarrier</span> <span class="n">barrier</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CyclicBarrier</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span>
                <span class="o">()</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"é›†åˆå®Œæ¯•ï¼Œå‡ºå‘â€¦â€¦"</span><span class="o">));</span>
        <span class="nc">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">executorService</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nc">Task</span><span class="o">(</span><span class="n">barrier</span><span class="o">,</span> <span class="s">"Task-"</span> <span class="o">+</span> <span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)));</span>
        <span class="o">}</span>
        <span class="n">executorService</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">executorService</span><span class="o">.</span><span class="na">isTerminated</span><span class="o">())</span> <span class="o">{</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Finished."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Task</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">CyclicBarrier</span> <span class="n">barrier</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Task</span><span class="o">(</span><span class="nc">CyclicBarrier</span> <span class="n">barrier</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">barrier</span> <span class="o">=</span> <span class="n">barrier</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">" start..."</span><span class="o">);</span>
                <span class="n">barrier</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="k">new</span> <span class="nc">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">1000</span><span class="o">));</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">" running..."</span><span class="o">);</span>
                <span class="n">barrier</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="o">|</span> <span class="nc">BrokenBarrierException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_phaser"><a class="anchor" href="#_phaser"></a>50. Phaser</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_exchanger"><a class="anchor" href="#_exchanger"></a>51. Exchanger</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_threadlocal"><a class="anchor" href="#_threadlocal"></a>52. ThreadLocal</h2>
<div class="sectionbody">
<div class="paragraph">
<p>åŸä»¥ä¸ºç¥ç§˜å…®å…®çš„ <code>ThreadLocal</code> æ˜¯ä½•æ–¹ç¥åœ£ï¼Ÿæ²¡æƒ³åˆ°ï¼Œç‚¹å¼€ä»£ç ï¼Œç«Ÿç„¶å¦‚æ­¤ç®€å•æ˜äº†ï¼Œç›´æ¥ä¸Šä»£ç ï¼š</p>
</div>
<div class="listingblock">
<div class="title">Thread</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="cm">/* ThreadLocal values pertaining to this thread. This map is maintained
 * by the ThreadLocal class. */</span>
<span class="nc">ThreadLocal</span><span class="o">.</span><span class="na">ThreadLocalMap</span> <span class="n">threadLocals</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">ThreadLocal</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
</pre></td><td class="code"><pre><span class="cm">/**
 * Get the map associated with a ThreadLocal. Overridden in
 * InheritableThreadLocal.
 *
 * @param  t the current thread
 * @return the map
 */</span>
<span class="nc">ThreadLocalMap</span> <span class="nf">getMap</span><span class="o">(</span><span class="nc">Thread</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="na">threadLocals</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * Returns the value in the current thread's copy of this
 * thread-local variable.  If the variable has no value for the
 * current thread, it is first initialized to the value returned
 * by an invocation of the {@link #initialValue} method.
 *
 * @return the current thread's value of this thread-local
 */</span>
<span class="kd">public</span> <span class="no">T</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
    <span class="nc">ThreadLocalMap</span> <span class="n">map</span> <span class="o">=</span> <span class="n">getMap</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">map</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ThreadLocalMap</span><span class="o">.</span><span class="na">Entry</span> <span class="n">e</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">getEntry</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
            <span class="no">T</span> <span class="n">result</span> <span class="o">=</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span><span class="n">e</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="nf">setInitialValue</span><span class="o">();</span>
<span class="o">}</span>

<span class="cm">/**
 * Sets the current thread's copy of this thread-local variable
 * to the specified value.  Most subclasses will have no need to
 * override this method, relying solely on the {@link #initialValue}
 * method to set the values of thread-locals.
 *
 * @param value the value to be stored in the current thread's copy of
 *        this thread-local.
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="no">T</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
    <span class="nc">ThreadLocalMap</span> <span class="n">map</span> <span class="o">=</span> <span class="n">getMap</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">map</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">map</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">createMap</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">static</span> <span class="kd">class</span> <span class="nc">ThreadLocalMap</span> <span class="o">{</span>

    <span class="cm">/**
     * The entries in this hash map extend WeakReference, using
     * its main ref field as the key (which is always a
     * ThreadLocal object).  Note that null keys (i.e. entry.get()
     * == null) mean that the key is no longer referenced, so the
     * entry can be expunged from table.  Such entries are referred to
     * as "stale entries" in the code that follows.
     */</span>
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Entry</span> <span class="kd">extends</span> <span class="nc">WeakReference</span><span class="o">&lt;</span><span class="nc">ThreadLocal</span><span class="o">&lt;?&gt;&gt;</span> <span class="o">{</span>
        <span class="cm">/** The value associated with this ThreadLocal. */</span>
        <span class="nc">Object</span> <span class="n">value</span><span class="o">;</span>

        <span class="nc">Entry</span><span class="o">(</span><span class="nc">ThreadLocal</span><span class="o">&lt;?&gt;</span> <span class="n">k</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">k</span><span class="o">);</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">// â€¦â€¦</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ç®€å•è§£é‡Šä¸€ä¸‹ï¼š</p>
</div>
<div class="paragraph">
<p>å½“å‰çº¿ç¨‹è°ƒç”¨ <code>ThreadLocal</code> ç±»çš„ <code>set</code> æˆ– <code>get</code> æ–¹æ³•æ—¶ï¼Œå…¶å®æ˜¯è°ƒç”¨çš„å½“å‰çº¿ç¨‹çš„ <code>ThreadLocal.ThreadLocalMap threadLocals</code> å˜é‡çš„ <code>set(ThreadLocal&lt;?&gt; key, Object value)</code> å’Œ <code>Entry getEntry(ThreadLocal&lt;?&gt; key)</code>ã€‚è¿˜æœ‰ä¸€ç‚¹éœ€è¦ç¨åŠ æ³¨æ„ï¼šè™½ç„¶ <code>ThreadLocal.ThreadLocalMap</code> åç§°æ˜¯ä»¥ <code>Map</code> ç»“å°¾ï¼Œä½†æ˜¯å®ƒå¹¶æ²¡æœ‰å®ç° <code>Map</code> æ¥å£ï¼Œåªæ˜¯æ“ä½œä¸Šæœ‰äº›ç±»ä¼¼ã€‚</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ThreadLocal-set-get.jpeg" alt="ThreadLocal set get">
</div>
</div>
<div class="paragraph">
<p>æœ‰ä¸€ç‚¹éœ€è¦ç‰¹åˆ«æ³¨æ„ï¼š<code>ThreadLocalMap</code> ä¸­ä½¿ç”¨çš„ <code>key</code> ä¸º <code>ThreadLocal</code> çš„å¼±å¼•ç”¨,è€Œ <code>value</code> æ˜¯å¼ºå¼•ç”¨ã€‚æ‰€ä»¥ï¼Œå¦‚æœ <code>ThreadLocal</code> æ²¡æœ‰è¢«å¤–éƒ¨å¼ºå¼•ç”¨çš„æƒ…å†µä¸‹ï¼Œåœ¨åƒåœ¾å›æ”¶çš„æ—¶å€™ï¼Œ<code>key</code> ä¼šè¢«æ¸…ç†æ‰ï¼Œè€Œ <code>value</code> ä¸ä¼šè¢«æ¸…ç†æ‰ã€‚è¿™æ ·ä¸€æ¥ï¼Œ<code>ThreadLocalMap</code> ä¸­å°±ä¼šå‡ºç° <code>key</code> ä¸º <code>null</code> çš„ <code>Entry</code>ã€‚å‡å¦‚æˆ‘ä»¬ä¸åšä»»ä½•æªæ–½çš„è¯ï¼Œ<code>value</code> æ°¸è¿œæ— æ³•è¢« GC å›æ”¶ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯èƒ½ä¼šäº§ç”Ÿå†…å­˜æ³„éœ²ã€‚<code>ThreadLocalMap</code> å®ç°ä¸­å·²ç»è€ƒè™‘äº†è¿™ç§æƒ…å†µï¼Œåœ¨è°ƒç”¨ <code>set()</code>ã€<code>get()</code>ã€<code>remove()</code> æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šæ¸…ç†æ‰ <code>key</code> ä¸º <code>null</code> çš„è®°å½•ã€‚ä½¿ç”¨å®Œ <code>ThreadLocal</code> æ–¹æ³•å æœ€å¥½æ‰‹åŠ¨è°ƒç”¨ <code>remove()</code> æ–¹æ³•ã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-03-09 20:20
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadLocalTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">FirstApp</span><span class="o">()).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInheritableThreadLocal</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// TODO: InheritableThreadLocal</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">FirstApp</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">threadLocal</span>
                <span class="o">=</span> <span class="nc">ThreadLocal</span><span class="o">.</span><span class="na">withInitial</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="s">"FirstApp-1"</span><span class="o">);</span>

        <span class="kd">private</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">threadLocal2</span>
                <span class="o">=</span> <span class="nc">ThreadLocal</span><span class="o">.</span><span class="na">withInitial</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="s">"FirstApp-2"</span><span class="o">);</span>

        <span class="kd">private</span> <span class="nc">SecondApp</span> <span class="n">secondApp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SecondApp</span><span class="o">();</span>
        <span class="kd">private</span> <span class="nc">ThridApp</span> <span class="n">thridApp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThridApp</span><span class="o">();</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">threadLocal</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">threadLocal2</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
            <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">secondApp</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
            <span class="n">thridApp</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SecondApp</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">threadLocal</span>
                <span class="o">=</span> <span class="nc">ThreadLocal</span><span class="o">.</span><span class="na">withInitial</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="s">"SecondApp"</span><span class="o">);</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">threadLocal</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ThridApp</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">threadLocal</span>
                <span class="o">=</span> <span class="nc">ThreadLocal</span><span class="o">.</span><span class="na">withInitial</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">threadLocal</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">"new-ThridApp-value"</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">threadLocal</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>å…³æ³¨ä¸€ä¸‹ï¼š <code>java.lang.InheritableThreadLocal</code>ã€‚</p>
</div>
<div class="paragraph">
<p>JDK çš„ <code>InheritableThreadLocal</code> ç±»å¯ä»¥å®Œæˆçˆ¶çº¿ç¨‹åˆ°å­çº¿ç¨‹çš„å€¼ä¼ é€’ã€‚ä½†å¯¹äºä½¿ç”¨çº¿ç¨‹æ± ç­‰ä¼šæ± åŒ–å¤ç”¨çº¿ç¨‹çš„æ‰§è¡Œç»„ä»¶çš„æƒ…å†µï¼Œçº¿ç¨‹ç”±çº¿ç¨‹æ± åˆ›å»ºå¥½ï¼Œå¹¶ä¸”çº¿ç¨‹æ˜¯æ± åŒ–èµ·æ¥åå¤ä½¿ç”¨çš„ï¼›è¿™æ—¶çˆ¶å­çº¿ç¨‹å…³ç³»çš„ <code>ThreadLocal</code> å€¼ä¼ é€’å·²ç»æ²¡æœ‰æ„ä¹‰ï¼Œåº”ç”¨éœ€è¦çš„å®é™…ä¸Šæ˜¯æŠŠä»»åŠ¡æäº¤ç»™çº¿ç¨‹æ± æ—¶çš„ <code>ThreadLocal</code> å€¼ä¼ é€’åˆ° ä»»åŠ¡æ‰§è¡Œæ—¶ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œé˜¿é‡Œå·´å·´ç ”å‘äº† <a href="https://github.com/alibaba/transmittable-thread-local">alibaba/transmittable-thread-local</a> åº“ã€‚</p>
</div>
<div class="paragraph">
<p>å“ˆå¸Œå†²çªäº†æ€ä¹ˆè§£å†³ï¼Ÿ</p>
</div>
<div class="sect2">
<h3 id="_å‚è€ƒèµ„æ–™_11"><a class="anchor" href="#_å‚è€ƒèµ„æ–™_11"></a>52.1. å‚è€ƒèµ„æ–™</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://snailclimb.gitee.io/javaguide/#/docs/java/Multithread/JavaConcurrencyAdvancedCommonInterviewQuestions?id=_33-threadlocal%e5%8e%9f%e7%90%86">JavaGuide
ä¹‹ ThreadLocal</a></p>
</li>
<li>
<p><a href="https://www.cnblogs.com/dennyzhangdd/p/7978455.html">ThreadLocalç»ˆææºç å‰–æ-ä¸€ç¯‡è¶³çŸ£ï¼ - åªä¼šä¸€ç‚¹java - åšå®¢å›­</a></p>
</li>
<li>
<p><a href="http://www.throwable.club/2019/02/17/java-concurrency-threadlocal-source-code/">ThreadLocalæºç åˆ†æ-é»„é‡‘åˆ†å‰²æ•°çš„ä½¿ç”¨ - Throwable&#8217;s Blog</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_atomicinteger"><a class="anchor" href="#_atomicinteger"></a>53. AtomicInteger</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>AtomicInteger</code> ç±»ä¸»è¦åˆ©ç”¨ CAS (compare and swap) + volatile å’Œ native æ–¹æ³•æ¥ä¿è¯åŸå­æ“ä½œï¼Œä»è€Œé¿å… <code>synchronized</code> çš„é«˜å¼€é”€ï¼Œæ‰§è¡Œæ•ˆç‡å¤§ä¸ºæå‡ã€‚</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_longadder"><a class="anchor" href="#_longadder"></a>54. LongAdder</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutorService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Executors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.LongAdder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.LockSupport</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-04-09 14:23
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LongAdderTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">LongAdder</span> <span class="n">adder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LongAdder</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">processors</span> <span class="o">=</span> <span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">availableProcessors</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">processors</span><span class="o">);</span>
        <span class="nc">ExecutorService</span> <span class="n">executor</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="n">processors</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">processors</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="n">adder</span><span class="o">.</span><span class="na">increment</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
        <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">adder</span><span class="o">.</span><span class="na">sum</span><span class="o">());</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">executor</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_juc_åŒ…åŸºç¡€ç±»åˆ†æ"><a class="anchor" href="#_juc_åŒ…åŸºç¡€ç±»åˆ†æ"></a>55. JUC åŒ…åŸºç¡€ç±»åˆ†æ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>JUC åŒ…ä¸­æœ‰ä¸€äº›æäº¤æ¯”è¾ƒå°çš„ç±»ï¼Œè¿™ç±»ç±»å•åˆ—å‡ºæ¥é‡é‡å¤ªå°ï¼Œä¸å¤Ÿç¯‡å¹…ã€‚</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_futuretask"><a class="anchor" href="#_futuretask"></a>56. FutureTask</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_ç±»å›¾_4"><a class="anchor" href="#_ç±»å›¾_4"></a>56.1. ç±»å›¾</h3>
<div class="paragraph">
<p>å…ˆæ¥çœ‹ä¸€ä¸‹ <code>ArrayList</code> çš„ç±»å›¾ï¼š</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./diag-a40dc9383585e648d1488def0a02981b.svg" alt="diag a40dc9383585e648d1488def0a02981b" width="100%" height="303">
</div>
</div>
<div class="paragraph">
<p>å®ç°äº† <code>Runnable</code> çš„ <code>run()</code>ï¼Œåœ¨æ–¹æ³•ç»“æŸæ—¶ï¼Œè·å–è¿”å›å€¼ã€‚</p>
</div>
<div class="paragraph">
<p><code>V get()</code> æ–¹æ³•ä¹‹æ‰€ä»¥èƒ½é˜»å¡ç›´åˆ°æ–¹æ³•æ‰§è¡Œï¼Œæ‹¿åˆ°ç»“æœï¼Œæ˜¯å› ä¸ºåœ¨ <code>get()</code> æ–¹æ³•é€šè¿‡ <code>awaitDone(boolean timed, long nanos)</code> æ‰§è¡Œäº†ä¸€ä¸ªæ— é™å¾ªç¯ã€‚åœ¨å¾ªç¯è¿‡ç¨‹ä¸­ï¼Œä¸æ–­è·å–ä»»åŠ¡æ‰§è¡Œçš„çŠ¶æ€ï¼Œè¿›ä¸€æ­¥è·å–ç»“æœæˆ–è€…å“åº”ä¸­æ–­è¯·æ±‚ã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
</pre></td><td class="code"><pre><span class="cm">/**
 * @throws CancellationException {@inheritDoc}
 */</span>
<span class="kd">public</span> <span class="no">V</span> <span class="nf">get</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span><span class="o">,</span> <span class="nc">ExecutionException</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">state</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">&lt;=</span> <span class="no">COMPLETING</span><span class="o">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">awaitDone</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="mi">0L</span><span class="o">);</span>
    <span class="k">return</span> <span class="nf">report</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
<span class="o">}</span>

<span class="cm">/**
 * Awaits completion or aborts on interrupt or timeout.
 *
 * @param timed true if use timed waits
 * @param nanos time to wait, if timed
 * @return state upon completion or at timeout
 */</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="nf">awaitDone</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">timed</span><span class="o">,</span> <span class="kt">long</span> <span class="n">nanos</span><span class="o">)</span>
    <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="c1">// The code below is very delicate, to achieve these goals:</span>
    <span class="c1">// - call nanoTime exactly once for each call to park</span>
    <span class="c1">// - if nanos &lt;= 0L, return promptly without allocation or nanoTime</span>
    <span class="c1">// - if nanos == Long.MIN_VALUE, don't underflow</span>
    <span class="c1">// - if nanos == Long.MAX_VALUE, and nanoTime is non-monotonic</span>
    <span class="c1">//   and we suffer a spurious wakeup, we will do no worse than</span>
    <span class="c1">//   to park-spin for a while</span>
    <span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="mi">0L</span><span class="o">;</span>    <span class="c1">// Special value 0L means not yet parked</span>
    <span class="nc">WaitNode</span> <span class="n">q</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kt">boolean</span> <span class="n">queued</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">state</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="no">COMPLETING</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">q</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="n">q</span><span class="o">.</span><span class="na">thread</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">==</span> <span class="no">COMPLETING</span><span class="o">)</span>
            <span class="c1">// We may have already promised (via isDone) that we are done</span>
            <span class="c1">// so never return empty-handed or throw InterruptedException</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">yield</span><span class="o">();</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">removeWaiter</span><span class="o">(</span><span class="n">q</span><span class="o">);</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">InterruptedException</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">q</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">timed</span> <span class="o">&amp;&amp;</span> <span class="n">nanos</span> <span class="o">&lt;=</span> <span class="mi">0L</span><span class="o">)</span>
                <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
            <span class="n">q</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WaitNode</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(!</span><span class="n">queued</span><span class="o">)</span>
            <span class="n">queued</span> <span class="o">=</span> <span class="no">WAITERS</span><span class="o">.</span><span class="na">weakCompareAndSet</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">q</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">waiters</span><span class="o">,</span> <span class="n">q</span><span class="o">);</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">timed</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="kt">long</span> <span class="n">parkNanos</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">startTime</span> <span class="o">==</span> <span class="mi">0L</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// first time</span>
                <span class="n">startTime</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">startTime</span> <span class="o">==</span> <span class="mi">0L</span><span class="o">)</span>
                    <span class="n">startTime</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>
                <span class="n">parkNanos</span> <span class="o">=</span> <span class="n">nanos</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="kt">long</span> <span class="n">elapsed</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">startTime</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">elapsed</span> <span class="o">&gt;=</span> <span class="n">nanos</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">removeWaiter</span><span class="o">(</span><span class="n">q</span><span class="o">);</span>
                    <span class="k">return</span> <span class="n">state</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="n">parkNanos</span> <span class="o">=</span> <span class="n">nanos</span> <span class="o">-</span> <span class="n">elapsed</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="c1">// nanoTime may be slow; recheck before parking</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">state</span> <span class="o">&lt;</span> <span class="no">COMPLETING</span><span class="o">)</span>
                <span class="nc">LockSupport</span><span class="o">.</span><span class="na">parkNanos</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">parkNanos</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">else</span>
            <span class="nc">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_å‚è€ƒèµ„æ–™_12"><a class="anchor" href="#_å‚è€ƒèµ„æ–™_12"></a>56.2. å‚è€ƒèµ„æ–™</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://www.throwable.club/2019/07/02/java-concurrency-listenable-future/">JUCçº¿ç¨‹æ± æ‰©å±•å¯å›è°ƒçš„Future - Throwable&#8217;s Blog</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_completablefuture"><a class="anchor" href="#_completablefuture"></a>57. CompletableFuture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Java ä¸­çš„ Promiseã€‚</p>
</div>
<div class="paragraph">
<p>é—®é¢˜ï¼šåœ¨ä¸€å¤§å †ä»»åŠ¡ä¸­ï¼Œå¦‚ä½•è·å–ç¬¬ä¸€ä¸ªå®Œæˆçš„è¿”å›å€¼ï¼Ÿ</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.*</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-03-19 16:04
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CompletableFutureTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">ExecutionException</span><span class="o">,</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
        <span class="nc">FutureTask</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">futureTask</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FutureTask</span><span class="o">&lt;&gt;(</span><span class="k">new</span> <span class="nc">Task</span><span class="o">());</span>

        <span class="n">executorService</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">futureTask</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"FutureTask..."</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">futureTask</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"FutureTask done."</span><span class="o">);</span>

        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Future</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;&gt;</span> <span class="n">futures</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">futures</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">executorService</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="k">new</span> <span class="nc">Task</span><span class="o">()));</span>
        <span class="o">}</span>
        <span class="n">executorService</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">executorService</span><span class="o">.</span><span class="na">isTerminated</span><span class="o">())</span> <span class="o">{</span>
        <span class="o">}</span>

        <span class="k">for</span> <span class="o">(</span><span class="nc">Future</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">:</span> <span class="n">futures</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">future</span><span class="o">.</span><span class="na">isDone</span><span class="o">())</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">future</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">runAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">""</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"All tasks were done."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Task</span> <span class="kd">implements</span> <span class="nc">Callable</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">call</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">second</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">ThreadLocalRandom</span> <span class="n">random</span> <span class="o">=</span> <span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">();</span>
                <span class="n">second</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">second</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">second</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_å‚è€ƒèµ„æ–™_13"><a class="anchor" href="#_å‚è€ƒèµ„æ–™_13"></a>57.1. å‚è€ƒèµ„æ–™</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://www.baeldung.com/java-completablefuture">Guide To CompletableFuture | Baeldung</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_threadpoolexecutor_æºç åˆ†æ"><a class="anchor" href="#_threadpoolexecutor_æºç åˆ†æ"></a>58. ThreadPoolExecutor æºç åˆ†æ</h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 10.1123%;">
<col style="width: 37.0786%;">
<col style="width: 10.1123%;">
<col style="width: 42.6968%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">çŠ¶æ€åç§°</th>
<th class="tableblock halign-left valign-top">æ¯”ç‰¹ä½</th>
<th class="tableblock halign-left valign-top">åè¿›åˆ¶</th>
<th class="tableblock halign-left valign-top">æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RUNNING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">111-00000000000000000000000000000</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">-536870912</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">è¿è¡Œä¸­çŠ¶æ€ï¼Œå¯ä»¥æ¥æ”¶æ–°çš„ä»»åŠ¡å’Œæ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SHUTDOWN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">000-00000000000000000000000000000</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shutdownçŠ¶æ€ï¼Œä¸å†æ¥æ”¶æ–°çš„ä»»åŠ¡ï¼Œä½†æ˜¯ä¼šæ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STOP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">001-00000000000000000000000000000</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">536870912</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">åœæ­¢çŠ¶æ€ï¼Œä¸å†æ¥æ”¶æ–°çš„ä»»åŠ¡ï¼Œä¹Ÿä¸ä¼šæ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œä¸­æ–­æ‰€æœ‰æ‰§è¡Œä¸­çš„ä»»åŠ¡</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TIDYING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">010-00000000000000000000000000000</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">1073741824</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">æ•´ç†ä¸­çŠ¶æ€ï¼Œæ‰€æœ‰ä»»åŠ¡å·²ç»ç»ˆç»“ï¼Œå·¥ä½œçº¿ç¨‹æ•°ä¸º0ï¼Œè¿‡æ¸¡åˆ°æ­¤çŠ¶æ€çš„å·¥ä½œçº¿ç¨‹ä¼šè°ƒç”¨é’©å­æ–¹æ³• <code>terminated()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TERMINATED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">011-00000000000000000000000000000</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">1610612736</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ç»ˆç»“çŠ¶æ€ï¼Œé’©å­æ–¹æ³• <code>terminated()</code> æ‰§è¡Œå®Œæ¯•</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>ç”±äºè¿è¡ŒçŠ¶æ€å€¼å­˜æ”¾åœ¨é«˜3ä½ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥é€šè¿‡åè¿›åˆ¶å€¼ï¼ˆç”šè‡³å¯ä»¥å¿½ç•¥ä½29ä½ï¼Œç›´æ¥ç”¨ctlè¿›è¡Œæ¯”è¾ƒï¼Œæˆ–è€…ä½¿ç”¨ctlå’Œçº¿ç¨‹æ± çŠ¶æ€å¸¸é‡è¿›è¡Œæ¯”è¾ƒï¼‰æ¥æ¯”è¾ƒå’Œåˆ¤æ–­çº¿ç¨‹æ± çš„çŠ¶æ€ï¼šå·¥ä½œçº¿ç¨‹æ•°ä¸º0çš„å‰æä¸‹ï¼š<code>RUNNING(-536870912)</code> &lt; <code>SHUTDOWN(0)</code> &lt; <code>STOP(536870912)</code> &lt; <code>TIDYING(1073741824)</code> &lt; <code>TERMINATED(1610612736)</code>ã€‚</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ThreadPoolExecutor-states.jpeg" alt="ThreadPoolExecutor states">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
</pre></td><td class="code"><pre>    <span class="cm">/**
     * Executes the given task sometime in the future.  The task
     * may execute in a new thread or in an existing pooled thread.
     *
     * If the task cannot be submitted for execution, either because this
     * executor has been shutdown or because its capacity has been reached,
     * the task is handled by the current {@link RejectedExecutionHandler}.
     *
     * @param command the task to execute
     * @throws RejectedExecutionException at discretion of
     *         {@code RejectedExecutionHandler}, if the task
     *         cannot be accepted for execution
     * @throws NullPointerException if {@code command} is null
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">command</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">command</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="cm">/*
         * Proceed in 3 steps:
         *
         * 1. If fewer than corePoolSize threads are running, try to
         * start a new thread with the given command as its first
         * task.  The call to addWorker atomically checks runState and
         * workerCount, and so prevents false alarms that would add
         * threads when it shouldn't, by returning false.
         *
         * 2. If a task can be successfully queued, then we still need
         * to double-check whether we should have added a thread
         * (because existing ones died since last checking) or that
         * the pool shut down since entry into this method. So we
         * recheck state and if necessary roll back the enqueuing if
         * stopped, or start a new thread if there are none.
         *
         * 3. If we cannot queue task, then we try to add a new
         * thread.  If it fails, we know we are shut down or saturated
         * and so reject the task.
         */</span>
        <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="c1">// å¦‚æœå½“å‰å·¥ä½œçº¿ç¨‹æ•°å°äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œåˆ™åˆ›å»ºæ–°çš„çº¿ç¨‹å¹¶æ‰§è¡Œä¼ å…¥çš„ä»»åŠ¡</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">workerCountOf</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">corePoolSize</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">addWorker</span><span class="o">(</span><span class="n">command</span><span class="o">,</span> <span class="kc">true</span><span class="o">))</span>
                <span class="c1">// åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹æˆåŠŸåˆ™ç›´æ¥è¿”å›</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="c1">// åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹å¤±è´¥ï¼Œåˆ™åœ¨å…¶ä»–ä»»åŠ¡æäº¤æ—¶ï¼Œå·²ç»åˆ›å»ºäº†è¶³å¤Ÿå¤šçš„çº¿ç¨‹æ•°</span>
            <span class="c1">// æˆ–è€…çº¿ç¨‹æ± å…³é—­ç­‰ç­‰ï¼Œæ€»ä¹‹çº¿ç¨‹æ± çŠ¶æ€å·²ç»å‘ç”Ÿå˜åŒ–ï¼Œ</span>
            <span class="c1">// åˆ™æ›´æ–° ctl çš„ä¸´æ—¶å˜é‡</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="c1">// è¿è¡Œåˆ°è¿™é‡Œè¯´æ˜åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹å¤±è´¥ï¼Œåˆ™å½“å‰å·¥ä½œçº¿ç¨‹å·²ç»å¤§äºç­‰äº corePoolSize</span>
        <span class="c1">// åˆ¤æ–­çº¿ç¨‹æ± æ˜¯å¦è¿è¡Œå¹¶ä¸”å°è¯•ç”¨éé˜»å¡æ–¹æ³•å‘ä»»åŠ¡é˜Ÿåˆ—ä¸­æ·»åŠ ä»»åŠ¡ï¼ˆå¤±è´¥åˆ™è¿”å› falseï¼‰</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isRunning</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">workQueue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="n">command</span><span class="o">))</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">recheck</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="c1">// å‘ä»»åŠ¡é˜Ÿåˆ—æŠ•æ”¾ä»»åŠ¡æˆåŠŸï¼Œå¯¹çº¿ç¨‹æ± çŠ¶æ€åšäºŒæ¬¡æ£€æŸ¥</span>
            <span class="c1">// å¦‚æœçº¿ç¨‹æ± çŠ¶æ€ä¸æ˜¯è¿è¡Œä¸­ï¼Œåˆ™ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­ç§»é™¤ä»»åŠ¡å¹¶æ‰§è¡Œæ‹’ç»ç­–ç•¥</span>
            <span class="k">if</span> <span class="o">(!</span> <span class="n">isRunning</span><span class="o">(</span><span class="n">recheck</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">remove</span><span class="o">(</span><span class="n">command</span><span class="o">))</span>
                <span class="c1">// æ‰§è¡Œæ‹’ç»ç­–ç•¥ -- ç»“æŸ</span>
                <span class="n">reject</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>
            <span class="c1">// èµ°åˆ°ä¸‹é¢çš„ else if åˆ†æ”¯ï¼Œåˆ™è¯´æ˜</span>
            <span class="c1">// 0ã€çº¿ç¨‹æ± å¯èƒ½æ˜¯ RUNNING çŠ¶æ€</span>
            <span class="c1">// 1ã€ä»»åŠ¡ç§»é™¤å¤±è´¥ï¼ˆå¤±è´¥åŸå› å¯èƒ½æ˜¯ä»»åŠ¡å·²ç»è¢«æ‰§è¡Œï¼‰</span>
            <span class="c1">// å¦‚æœå½“å‰çº¿ç¨‹æ•°ä¸º0ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªéæ ¸å¿ƒçº¿ç¨‹å¹¶ä¼ å…¥ä»»åŠ¡ä¸º null -- ç»“æŸ</span>
            <span class="c1">// åˆ›å»ºçš„çº¿ç¨‹ä¸ä¼šé©¬ä¸Šæ‰§è¡Œä»»åŠ¡ï¼Œè€Œæ˜¯ç­‰å¾…è·å–ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡å»æ‰§è¡Œ</span>
            <span class="c1">// å¦‚æœå½“å‰çº¿ç¨‹æ•°ä¸ä¸º0ï¼Œåˆ™ä»€ä¹ˆä¹Ÿä¸åšã€‚å› ä¸ºä»»åŠ¡å·²ç»æˆåŠŸåŠ å…¥é˜Ÿåˆ—ï¼Œæ€»ä¼šæ‰§è¡Œã€‚</span>
            <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">workerCountOf</span><span class="o">(</span><span class="n">recheck</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
                <span class="n">addWorker</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜ï¼š</span>
        <span class="c1">// 0ã€çº¿ç¨‹æ± ä¸­çš„å·¥ä½œçº¿ç¨‹æ€»æ•°å·²ç»å¤§äºç­‰äº corePoolSize</span>
        <span class="c1">// 1ã€çº¿ç¨‹æ± å¯èƒ½ä¸æ˜¯ RUNNING çŠ¶æ€</span>
        <span class="c1">// 2ã€çº¿ç¨‹æ± å¯èƒ½æ˜¯ RUNNING çŠ¶æ€åŒæ—¶ä»»åŠ¡é˜Ÿåˆ—å·²ç»æ»¡äº†</span>
        <span class="c1">// å¦‚æœå‘ä»»åŠ¡é˜Ÿåˆ—æŠ•æ”¾ä»»åŠ¡å¤±è´¥ï¼Œåˆ™ä¼šå°è¯•åˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹ä¼ å…¥ä»»åŠ¡æ‰§è¡Œ</span>
        <span class="c1">// åˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹å¤±è´¥ï¼Œæ­¤æ—¶éœ€è¦æ‹’ç»æ‰§è¡Œä»»åŠ¡</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(!</span><span class="n">addWorker</span><span class="o">(</span><span class="n">command</span><span class="o">,</span> <span class="kc">false</span><span class="o">))</span>
            <span class="c1">// æ‰§è¡Œæ‹’ç»ç­–ç•¥ -- ç»“æŸ</span>
            <span class="n">reject</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ä¸ºä»€ä¹ˆéœ€è¦äºŒæ¬¡æ£€æŸ¥çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€ï¼Œå½“å‰å·¥ä½œçº¿ç¨‹æ•°é‡ä¸º <code>0</code>ï¼Œå°è¯•åˆ›å»ºä¸€ä¸ªéæ ¸å¿ƒçº¿ç¨‹å¹¶ä¸”ä¼ å…¥çš„ä»»åŠ¡å¯¹è±¡ä¸º <code>null</code>ï¼Ÿè¿™ä¸ªå¯ä»¥çœ‹APIæ³¨é‡Šï¼š</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>å¦‚æœä¸€ä¸ªä»»åŠ¡æˆåŠŸåŠ å…¥ä»»åŠ¡é˜Ÿåˆ—ï¼Œæˆ‘ä»¬ä¾ç„¶éœ€è¦äºŒæ¬¡æ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼ˆå› ä¸ºæ‰€æœ‰å­˜æ´»çš„å·¥ä½œçº¿ç¨‹æœ‰å¯èƒ½åœ¨æœ€åä¸€æ¬¡æ£€æŸ¥ä¹‹åå·²ç»ç»ˆç»“ï¼‰æˆ–è€…æ‰§è¡Œå½“å‰æ–¹æ³•çš„æ—¶å€™çº¿ç¨‹æ± æ˜¯å¦å·²ç» <code>shutdown</code> äº†ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦äºŒæ¬¡æ£€æŸ¥çº¿ç¨‹æ± çš„çŠ¶æ€ï¼Œå¿…è¦æ—¶æŠŠä»»åŠ¡ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­ç§»é™¤æˆ–è€…åœ¨æ²¡æœ‰å¯ç”¨çš„å·¥ä½œçº¿ç¨‹çš„å‰æä¸‹æ–°å»ºä¸€ä¸ªå·¥ä½œçº¿ç¨‹ã€‚</p>
</div>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ThreadPoolExecutor-process.jpeg" alt="ThreadPoolExecutor process">
</div>
</div>
<div class="paragraph">
<p><code>runWorker()</code> æ–¹æ³•çš„æ ¸å¿ƒæµç¨‹ï¼š</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ThreadPoolExecutor-runWorker.jpeg" alt="ThreadPoolExecutor runWorker">
</div>
</div>
<div class="sect2">
<h3 id="_å¤§çº²"><a class="anchor" href="#_å¤§çº²"></a>58.1. å¤§çº²</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>åŸºæœ¬ä½¿ç”¨</p>
</li>
<li>
<p>ä½¿ç”¨ <code>Executors</code> åˆ›å»ºçº¿ç¨‹æ± </p>
</li>
<li>
<p>è‡ªå®šä¹‰ä»»åŠ¡ï¼Œå¹¶æäº¤ä»»åŠ¡</p>
</li>
<li>
<p>è·å–è¿”å›ç»“æœ</p>
</li>
<li>
<p>çº¿ç¨‹æ± çš„ç±»å›¾ç»“æ„</p>
</li>
<li>
<p>åˆ›å»ºæ‰§è¡Œçº¿ç¨‹</p>
</li>
<li>
<p>å–å‡ºä»»åŠ¡æ‰§è¡Œ</p>
</li>
<li>
<p>å¦‚ä½•å®ç° <code>invokeAny(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</code> ï¼Ÿ</p>
</li>
<li>
<p>å¦‚ä½•å®ç° <code>invokeAny(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks, long timeout, TimeUnit unit)</code> ?</p>
</li>
<li>
<p>å¦‚ä½•å®ç° <code>invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</code> ?</p>
</li>
<li>
<p>å¦‚ä½•å®ç° <code>invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks, long timeout, TimeUnit unit)</code> ï¼Ÿ</p>
</li>
<li>
<p>å¦‚ä½•åˆ¤æ–­çº¿ç¨‹è¶…æ—¶ï¼Ÿä»¥åŠè¶…æ—¶åå¦‚ä½•æ€æ‰çº¿ç¨‹ï¼Ÿ</p>
</li>
<li>
<p>å¦‚ä½•ç»ˆæ­¢ä»»åŠ¡ï¼Ÿæ¸©æŸ”ç»ˆæ­¢ï¼Ÿæˆ–è€…é‡è›®ç»ˆæ­¢ï¼Ÿ</p>
</li>
<li>
<p>çº¿ç¨‹æ± åœ¨jDK5ã€6ã€7ä¸­æœ‰å“ªäº›å‡çº§å˜åŒ–ï¼Ÿ</p>
</li>
<li>
<p>æ‹’ç»ç­–ç•¥</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_æ ¸å¿ƒç‚¹_2"><a class="anchor" href="#_æ ¸å¿ƒç‚¹_2"></a>58.2. æ ¸å¿ƒç‚¹</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>å…³é”®å‚æ•°</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>corePoolSize</code></p>
</li>
<li>
<p><code>maximumPoolSize</code></p>
</li>
<li>
<p><code>BlockingQueue</code></p>
</li>
<li>
<p><code>RejectedExecutionHandler</code></p>
</li>
<li>
<p><code>keepAliveTime</code></p>
</li>
<li>
<p><code>threadFactory</code></p>
</li>
</ol>
</div>
</li>
<li>
<p><code>RejectedExecutionHandler</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>AbortPolicy</code></p>
</li>
<li>
<p><code>CallerRunsPolicy</code></p>
</li>
<li>
<p><code>DiscardPolicy</code></p>
</li>
<li>
<p><code>DiscardOldestPolicy</code></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>åœ¨ç”Ÿäº§ç¯å¢ƒï¼Œä¸ºäº†é¿å…é¦–æ¬¡è°ƒç”¨è¶…æ—¶ï¼Œå¯ä»¥è°ƒç”¨ <code>executor.prestartAllCoreThreads()</code> é¢„åˆ›å»ºæ‰€æœ‰ <code>core</code> çº¿ç¨‹ï¼Œé¿å…æ¥ä¸€ä¸ªåˆ›ä¸€ä¸ªå¸¦æ¥é¦–æ¬¡è°ƒç”¨æ…¢çš„é—®é¢˜ã€‚</p>
</div>
</div>
<div class="sect2">
<h3 id="_é—®é¢˜_2"><a class="anchor" href="#_é—®é¢˜_2"></a>58.3. é—®é¢˜</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ä»»åŠ¡æ·»åŠ åï¼Œå¦‚ä½•æ‰§è¡Œï¼Ÿ</p>
</li>
<li>
<p>ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œå¦‚ä½•åœ¨åŒä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ï¼Ÿ</p>
</li>
<li>
<p>åœ¨ <code>corePoolSize</code> æ¯” <code>maximumPoolSize</code> å°çš„æƒ…å†µä¸‹ï¼Œå¦‚ä½•åˆ¤å®šä¸€ä¸ªçº¿ç¨‹æ˜¯å¦è¶…æ—¶ï¼Ÿå¹¶ä¸”å¦‚ä½•åˆ é™¤ä¸€ä¸ªçº¿ç¨‹ï¼Ÿ</p>
</li>
<li>
<p>ä»»åŠ¡æ·»åŠ åï¼Œ</p>
</li>
<li>
<p>å¦‚ä½•è¿”å›ä»»åŠ¡æ‰§è¡Œçš„ç»“æœï¼Ÿ</p>
</li>
<li>
<p>è¿™ä¸ªçº¿ç¨‹æ± è¿˜æœ‰å“ªäº›å¯ä»¥æ”¹è¿›çš„åœ°æ–¹ï¼Ÿæ¯”å¦‚ Guava ä¸­æä¾›äº†å“ªäº›çº¿ç¨‹æ± ï¼Ÿ</p>
</li>
<li>
<p>å¦‚ä½•æ”¹é€ æˆæ·»åŠ ä»»åŠ¡ï¼Œå¦‚æœæ²¡æœ‰è¾¾åˆ° <code>maxPoolSize</code> åˆ™å…ˆåˆ›å»ºçº¿ç¨‹ï¼Ÿ</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_tomcat_æ”¹è¿›"><a class="anchor" href="#_tomcat_æ”¹è¿›"></a>58.3.1. Tomcat æ”¹è¿›</h4>
<div class="paragraph">
<p>å¯ä¸å¯ä»¥è‡ªå·±å°è£…ä¸€ä¸ªQueueï¼Œåœ¨æ’å…¥æ—¶å¢åŠ ä»¥ä¸‹é€»è¾‘å‘¢ï¼Ÿ</p>
</div>
<div class="ulist">
<ul>
<li>
<p>å¦‚æœå½“å‰æœ‰ç©ºé—²çº¿ç¨‹ç­‰å¾…æ¥å®¢ï¼Œåˆ™æŠŠä»»åŠ¡åŠ å…¥é˜Ÿåˆ—è®©å­©å„¿ä»¬å»æŠ¢ã€‚</p>
</li>
<li>
<p>å¦‚æœæ²¡æœ‰ç©ºé—²çš„äº†ï¼Œæ€»çº¿ç¨‹æ•°åˆæ²¡åˆ°è¾¾maxï¼Œé‚£å°±è¿”å›falseï¼Œè®©Executorå»åˆ›å»ºçº¿ç¨‹ã€‚</p>
</li>
<li>
<p>å¦‚æœæ€»çº¿ç¨‹æ•°å·²è¾¾åˆ°maxï¼Œåˆ™ç»§ç»­æŠŠä»»åŠ¡åŠ å…¥é˜Ÿåˆ—ç¼“å†²ä¸€ä¸‹ã€‚</p>
</li>
<li>
<p>å¦‚æœç¼“å†²é˜Ÿåˆ—ä¹Ÿæ»¡äº†ï¼ŒæŠ›å‡ºæ‹’ç»å¼‚å¸¸ã€‚</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/apache/tomcat/blob/master/java/org/apache/tomcat/util/threads/TaskQueue.java" class="bare">https://github.com/apache/tomcat/blob/master/java/org/apache/tomcat/util/threads/TaskQueue.java</a></div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TaskQueue</span> <span class="kd">extends</span> <span class="nc">LinkedBlockingQueue</span><span class="o">&lt;</span><span class="nc">Runnable</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">transient</span> <span class="kd">volatile</span> <span class="nc">ThreadPoolExecutor</span> <span class="n">parent</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">offer</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">//we can't do any checks</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">parent</span><span class="o">==</span><span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
        <span class="c1">//we are maxed out on threads, simply queue the object</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">parent</span><span class="o">.</span><span class="na">getPoolSize</span><span class="o">()</span> <span class="o">==</span> <span class="n">parent</span><span class="o">.</span><span class="na">getMaximumPoolSize</span><span class="o">())</span> <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
        <span class="c1">//we have idle threads, just add it to the queue</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">parent</span><span class="o">.</span><span class="na">getSubmittedCount</span><span class="o">()&lt;=(</span><span class="n">parent</span><span class="o">.</span><span class="na">getPoolSize</span><span class="o">()))</span> <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
        <span class="c1">//if we have less threads than maximum force creation of a new thread</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">parent</span><span class="o">.</span><span class="na">getPoolSize</span><span class="o">()&lt;</span><span class="n">parent</span><span class="o">.</span><span class="na">getMaximumPoolSize</span><span class="o">())</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="c1">//if we reached here, we need to add it to the queue</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>å¦‚ä½•åˆ¤æ–­å½“å‰æœ‰æ²¡æœ‰ç©ºé—²çš„çº¿ç¨‹ç­‰å¾…æ¥å®¢ï¼ŸTomcat åˆ™é æ‰©å±• <code>Executor</code>ï¼Œå¢åŠ ä¸€ä¸ªå½“å‰è¯·æ±‚æ•°çš„è®¡æ•°å™¨ï¼Œåœ¨ <code>execute()</code> æ–¹æ³•å‰åŠ 1ï¼Œå†é‡è½½ <code>afterExecute()</code> æ–¹æ³•å‡1ï¼Œç„¶ååˆ¤æ–­å½“å‰çº¿ç¨‹æ€»æ•°æ˜¯å¦å¤§äºå½“å‰è¯·æ±‚æ€»æ•°å°±çŸ¥é“æœ‰å’©æœ‰å›´è§‚ç¾¤ä¼—ã€‚</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_éœ€è¦æ³¨æ„çš„ç‚¹"><a class="anchor" href="#_éœ€è¦æ³¨æ„çš„ç‚¹"></a>58.4. éœ€è¦æ³¨æ„çš„ç‚¹</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>çº¿ç¨‹æ± å¦‚ä½•åˆå§‹åŒ–ï¼Ÿ</p>
</li>
<li>
<p>ä»»åŠ¡å¦‚ä½•æ·»åŠ ï¼Ÿ</p>
</li>
<li>
<p>ä»»åŠ¡å¦‚ä½•æ‰§è¡Œï¼Ÿ</p>
</li>
<li>
<p>ä»»åŠ¡å¦‚ä½•ç»ˆæ­¢ï¼Ÿ</p>
</li>
<li>
<p>é‡åˆ°å¼‚å¸¸å¦‚ä½•å¤„ç†ï¼Ÿ</p>
</li>
<li>
<p>çº¿ç¨‹æ± é˜Ÿåˆ—å·²æ»¡ï¼Œå¦‚ä½•æ‹’ç»ï¼Ÿ</p>
</li>
<li>
<p>ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸ï¼Œå¦‚ä½•å¤„ç†ï¼Ÿå…³é—­è¯¥çº¿ç¨‹ï¼Œé‡å¯ä¸€ä¸ªå—ï¼Ÿ</p>
</li>
<li>
<p>ï¼Ÿï¼Ÿ</p>
</li>
<li>
<p>ä»»åŠ¡å¦‚ä½•å­˜æ”¾ï¼Ÿ</p>
</li>
<li>
<p>ä»»åŠ¡å­˜æ”¾åï¼Œå¦‚ä½•å–å‡ºæ¥ï¼Ÿ</p>
</li>
<li>
<p>å¦‚ä½•åšåˆ°ä¸æ–­åœ°ä¸€ä¸ªä¸€ä¸ªæ‰§è¡Œä¸‹å»ï¼Ÿ</p>
</li>
<li>
<p>ä¸ºä»€ä¹ˆ <code>Worker</code> ç»§æ‰¿ <code>AbstractQueuedSynchronizer</code> ï¼ŸAQSèµ·ä»€ä¹ˆä½œç”¨ï¼Ÿæ˜¯å¦éœ€è¦å…ˆç ”ç©¶ä¸€ä¸‹ï¼Ÿ</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_æ”¶è·"><a class="anchor" href="#_æ”¶è·"></a>58.5. æ”¶è·</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>å¯ä»¥ç»§æ‰¿ <code>ThreadPoolExecutor</code>ï¼Œå®ç° <code>beforeExecute()</code> å’Œ <code>afterExecute()</code> ç­‰æ–¹æ³•ï¼Œæ¥åŠ å…¥æ‰§è¡Œæ—¶çš„å›è°ƒã€‚ç±»ä¼¼çš„å›è°ƒï¼Œè¿˜æœ‰ <code>terminated()</code></p>
</li>
<li>
<p>æ·»åŠ ä»»åŠ¡æ—¶ï¼Œ <code>execute()</code> æ–¹æ³•çš„ç¬¬äºŒç§æƒ…å†µï¼Œä¸ºä»€ä¹ˆè¿˜æœ‰å†æ¬¡æ£€æŸ¥ï¼Ÿ</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.time.LocalDateTime</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Callable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutionException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Future</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.LinkedBlockingQueue</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ThreadPoolExecutor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-03-10 10:50
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadPoolExecutorTest</span> <span class="o">{</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testStatus</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="no">COUNT_BITS</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">SIZE</span> <span class="o">-</span> <span class="mi">3</span><span class="o">;</span>
        <span class="kt">int</span> <span class="no">COUNT_MASK</span> <span class="o">=</span> <span class="o">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="no">COUNT_BITS</span><span class="o">)</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>

        <span class="c1">// runState is stored in the high-order bits</span>
        <span class="kt">int</span> <span class="no">RUNNING</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="no">COUNT_BITS</span><span class="o">;</span>
        <span class="kt">int</span> <span class="no">SHUTDOWN</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="no">COUNT_BITS</span><span class="o">;</span>
        <span class="kt">int</span> <span class="no">STOP</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="no">COUNT_BITS</span><span class="o">;</span>
        <span class="kt">int</span> <span class="no">TIDYING</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="no">COUNT_BITS</span><span class="o">;</span>
        <span class="kt">int</span> <span class="no">TERMINATED</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="no">COUNT_BITS</span><span class="o">;</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%32s // %d%n"</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">toBinaryString</span><span class="o">(</span><span class="no">RUNNING</span><span class="o">),</span> <span class="no">RUNNING</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%32s // %d%n"</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">toBinaryString</span><span class="o">(</span><span class="no">SHUTDOWN</span><span class="o">),</span> <span class="no">SHUTDOWN</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%32s // %d%n"</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">toBinaryString</span><span class="o">(</span><span class="no">STOP</span><span class="o">),</span> <span class="no">STOP</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%32s // %d%n"</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">toBinaryString</span><span class="o">(</span><span class="no">TIDYING</span><span class="o">),</span> <span class="no">TIDYING</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%32s // %d%n"</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">toBinaryString</span><span class="o">(</span><span class="no">TERMINATED</span><span class="o">),</span> <span class="no">TERMINATED</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testPoolSize</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">ThreadPoolExecutor</span> <span class="n">executorService</span>
                <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadPoolExecutor</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">1L</span><span class="o">,</span>
                <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">,</span> <span class="k">new</span> <span class="nc">LinkedBlockingQueue</span><span class="o">&lt;&gt;(</span><span class="mi">6</span><span class="o">));</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">executorService</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nc">Task</span><span class="o">(</span><span class="s">"Task-"</span> <span class="o">+</span> <span class="n">i</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">executorService</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">executorService</span><span class="o">.</span><span class="na">isTerminated</span><span class="o">())</span> <span class="o">{</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Finish all thread..."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testCallable</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">ThreadPoolExecutor</span> <span class="n">executorService</span>
                <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadPoolExecutor</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">1L</span><span class="o">,</span>
                <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">,</span> <span class="k">new</span> <span class="nc">LinkedBlockingQueue</span><span class="o">&lt;&gt;(</span><span class="mi">6</span><span class="o">));</span>

        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Future</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">futures</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="mi">10</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">Future</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">executorService</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span>
                    <span class="k">new</span> <span class="nf">CallableTask</span><span class="o">(</span><span class="s">"CallableTask-"</span> <span class="o">+</span> <span class="n">i</span><span class="o">));</span>

            <span class="n">futures</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">future</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Future</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">:</span> <span class="n">futures</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">()</span> <span class="o">+</span> <span class="s">"::"</span> <span class="o">+</span> <span class="n">future</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="o">|</span> <span class="nc">ExecutionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">executorService</span><span class="o">.</span><span class="na">isTerminated</span><span class="o">())</span> <span class="o">{</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Finish all thread..."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testComplete</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">ThreadPoolExecutor</span> <span class="n">executorService</span>
                <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadPoolExecutor</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">1L</span><span class="o">,</span>
                <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">,</span> <span class="k">new</span> <span class="nc">LinkedBlockingQueue</span><span class="o">&lt;&gt;(</span><span class="mi">6</span><span class="o">));</span>

        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Future</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">futures</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="mi">10</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">Future</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">executorService</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span>
                    <span class="k">new</span> <span class="nf">CallableTask</span><span class="o">(</span><span class="s">"CallableTask-"</span> <span class="o">+</span> <span class="n">i</span><span class="o">));</span>
            <span class="n">futures</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">future</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Future</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">:</span> <span class="n">futures</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">()</span> <span class="o">+</span> <span class="s">"::"</span> <span class="o">+</span> <span class="n">future</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="o">|</span> <span class="nc">ExecutionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">executorService</span><span class="o">.</span><span class="na">isTerminated</span><span class="o">())</span> <span class="o">{</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Finish all thread..."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">CallableTask</span> <span class="kd">implements</span> <span class="nc">Callable</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">CallableTask</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">String</span> <span class="nf">call</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
            <span class="c1">//è¿”å›æ‰§è¡Œå½“å‰ Callable çš„çº¿ç¨‹åå­—</span>
            <span class="k">return</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Task</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Task</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span>
                    <span class="o">+</span> <span class="s">" Start. Time = "</span> <span class="o">+</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>

            <span class="n">processCommand</span><span class="o">();</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span>
                    <span class="o">+</span> <span class="s">" End. Time = "</span> <span class="o">+</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">processCommand</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">name</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_æ€è€ƒé¢˜"><a class="anchor" href="#_æ€è€ƒé¢˜"></a>58.6. æ€è€ƒé¢˜</h3>
<div class="paragraph">
<p>è‡ªå·±å®ç°ä¸€ä¸ªçº¿ç¨‹æ± ã€‚</p>
</div>
</div>
<div class="sect2">
<h3 id="_å‚è€ƒèµ„æ–™_14"><a class="anchor" href="#_å‚è€ƒèµ„æ–™_14"></a>58.7. å‚è€ƒèµ„æ–™</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://www.throwable.club/2019/07/15/java-concurrency-thread-pool-executor/">JUCçº¿ç¨‹æ± ThreadPoolExecutoræºç åˆ†æ - Throwable&#8217;s Blog</a></p>
</li>
<li>
<p><a href="https://www.cnblogs.com/leesf456/p/5585627.html">ã€JUCã€‘JDK1.8æºç åˆ†æä¹‹ThreadPoolExecutorï¼ˆä¸€ï¼‰ - leesf - åšå®¢å›­</a></p>
</li>
<li>
<p><a href="https://mp.weixin.qq.com/s/baYuX8aCwQ9PP6k7TDl2Ww">Javaçº¿ç¨‹æ± å®ç°åŸç†åŠå…¶åœ¨ç¾å›¢ä¸šåŠ¡ä¸­çš„å®è·µ</a></p>
</li>
<li>
<p><a href="http://calvin1978.blogcn.com/articles/java-threadpool.html">Java ThreadPoolçš„æ­£ç¡®æ‰“å¼€æ–¹å¼ | æ±Ÿå—ç™½è¡£</a></p>
</li>
<li>
<p><a href="http://calvin1978.blogcn.com/articles/tomcat-threadpool.html">Tomcatçº¿ç¨‹æ± ï¼Œæ›´ç¬¦åˆå¤§å®¶æƒ³è±¡çš„å¯æ‰©å±•çº¿ç¨‹æ±  | æ±Ÿå—ç™½è¡£</a></p>
</li>
<li>
<p><a href="https://mp.weixin.qq.com/s/YAeneN-x_En55FlC2mVcaA">æ¯å¤©éƒ½åœ¨ç”¨ï¼Œä½†ä½ çŸ¥é“ Tomcat çš„çº¿ç¨‹æ± æœ‰å¤šåŠªåŠ›å—ï¼Ÿ</a></p>
</li>
<li>
<p><a href="http://www.throwable.club/2019/07/15/java-concurrency-thread-pool-executor/" class="bare">http://www.throwable.club/2019/07/15/java-concurrency-thread-pool-executor/</a>[JUCçº¿ç¨‹æ± ThreadPoolExecutoræºç åˆ†æ - Throwable&#8217;s Blog</p>
</li>
<li>
<p><a href="http://jindong.io/2015/03/30/java-concurrent-package-ThreadPoolExecutor/">Javaå¹¶å‘åŒ…æºç å­¦ä¹ ä¹‹çº¿ç¨‹æ± ï¼ˆä¸€ï¼‰ThreadPoolExecutoræºç åˆ†æ - Jindong</a></p>
</li>
<li>
<p><a href="http://my.oschina.net/zouqun/blog/407149">ThreadPoolExecutorç®€ä»‹ä¸æºç åˆ†æ - é‚¹èƒœç¾¤çš„ä¸ªäººé¡µé¢ - å¼€æºä¸­å›½ç¤¾åŒº</a></p>
</li>
<li>
<p><a href="http://onlychoice.github.io/blog/2013/09/13/java-concurrent-source-code-reading-2/">Javaå¹¶å‘æºç åˆ†æ - ThreadPoolExecutor - SHOW ME THE CODE</a></p>
</li>
<li>
<p><a href="http://blog.csdn.net/xieyuooo/article/details/8718741">Javaçº¿ç¨‹æ± æ¶æ„åŸç†å’Œæºç è§£æ(ThreadPoolExecutor) - xieyuoooçš„ä¸“æ  - åšå®¢é¢‘é“ - CSDN.NET</a></p>
</li>
<li>
<p><a href="http://www.cnblogs.com/skywang12345/p/java_threads_category.html">Javaå¤šçº¿ç¨‹ç³»åˆ—ç›®å½•(å…±43ç¯‡) - å¦‚æœå¤©ç©ºä¸æ­» - åšå®¢å›­</a></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>ææ¸…æ¥šäº† <code>ctl</code> çš„å«ä¹‰ï¼Œé«˜ä¸‰ä½æ˜¯çŠ¶æ€ï¼Œä½29ä½æ˜¯çº¿ç¨‹æ•°</p>
</li>
<li>
<p>ä¸»è¦å±æ€§çš„å«ä¹‰ï¼Œä¸»è¦æ–¹æ³•çš„å®ç°ï¼Œä»»åŠ¡æ·»åŠ åï¼Œä¸‰ç§ä¸åŒçš„å¤„ç†æ–¹å¼</p>
</li>
<li>
<p>çº¿ç¨‹æ± çŠ¶æ€å˜æ¢</p>
</li>
<li>
<p>çº¿ç¨‹æ± æ‹’ç»ç­–ç•¥çš„å®ç°</p>
</li>
<li>
<p>å¸¦è¿”å›å€¼çš„ä»»åŠ¡çš„å®ç°æ–¹å¼ï¼Œ<code>Callable</code>ï¼Œ<code>Future</code></p>
</li>
</ol>
</div>
</li>
<li>
<p><a href="http://www.molotang.com/articles/514.html">ThreadPoolExecutorçš„åŸºæœ¬ä½¿ç”¨ | ä¸‰çŸ³Â·é“</a></p>
</li>
<li>
<p><a href="http://www.molotang.com/articles/522.html">ThreadPoolExecutorçš„ä»»åŠ¡æäº¤ã€ä»»åŠ¡å¤„ç†ã€çº¿ç¨‹å¤ç”¨å’Œç»´æŠ¤ç›¸å…³æºç åˆ†æ | ä¸‰çŸ³Â·é“</a></p>
</li>
<li>
<p><a href="http://www.molotang.com/articles/526.html">ThreadPoolExecutorçš„ç”Ÿå‘½å‘¨æœŸç›¸å…³æºç åˆ†æ | ä¸‰çŸ³Â·é“</a></p>
</li>
<li>
<p><a href="http://www.molotang.com/articles/553.html">ThreadPoolExecutorçš„ä»»åŠ¡é¥±å’Œä¸¢å¼ƒç­–ç•¥åŠæºç å®ç° | ä¸‰çŸ³Â·é“</a></p>
</li>
<li>
<p><a href="http://ifeve.com/java-threadpool/">èŠèŠå¹¶å‘ï¼ˆä¸‰ï¼‰Javaçº¿ç¨‹æ± çš„åˆ†æå’Œä½¿ç”¨ | å¹¶å‘ç¼–ç¨‹ç½‘ - ifeve.com</a></p>
</li>
<li>
<p><a href="http://www.infoq.com/cn/articles/executor-framework-thread-pool-task-execution-part-01?utm_campaign=rightbar_v2&amp;utm_source=infoq&amp;utm_medium=articles_link&amp;utm_content=link_text">æˆï¼ˆç»†ï¼‰è¯´Executoræ¡†æ¶çº¿ç¨‹æ± ä»»åŠ¡æ‰§è¡Œå…¨è¿‡ç¨‹ï¼ˆä¸Šï¼‰</a></p>
</li>
<li>
<p><a href="http://www.infoq.com/cn/articles/executor-framework-thread-pool-task-execution-part-02?utm_campaign=rightbar_v2&amp;utm_source=infoq&amp;utm_medium=articles_link&amp;utm_content=link_text">æˆï¼ˆç»†ï¼‰è¯´Executoræ¡†æ¶çº¿ç¨‹æ± ä»»åŠ¡æ‰§è¡Œå…¨è¿‡ç¨‹ï¼ˆä¸‹ï¼‰</a></p>
</li>
<li>
<p><a href="http://blog.csdn.net/techq/article/details/6818201">ThreadPoolExecutor æºç åˆ†æ - techqâ€™s blog - åšå®¢é¢‘é“ - CSDN.NET</a></p>
</li>
<li>
<p><a href="http://blog.sina.com.cn/s/blog_753035050100wbtm.html">JAVAçº¿ç¨‹æ± (ThreadPoolExecutor)æºç åˆ†æ_journeylin_æ–°æµªåšå®¢</a></p>
</li>
<li>
<p><a href="http://www.cnblogs.com/rilley/archive/2012/02/07/2341767.html">ThreadPoolExecutoræºç åˆ†æ - rilley - åšå®¢å›­</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_forkjointask"><a class="anchor" href="#_forkjointask"></a>59. ForkJoinTask</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_ç±»å›¾_5"><a class="anchor" href="#_ç±»å›¾_5"></a>59.1. ç±»å›¾</h3>
<div class="paragraph">
<p>å…ˆæ¥çœ‹ä¸€ä¸‹ <code>ForkJoinTask</code> çš„ç±»å›¾ï¼š</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./diag-e7a09ab384223cb3157b367e34b17c5b.svg" alt="diag e7a09ab384223cb3157b367e34b17c5b" width="100%" height="195">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_forkjoinpool"><a class="anchor" href="#_forkjoinpool"></a>60. ForkJoinPool</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="./images/ForkJoinPool-fork-join.webp" alt="ForkJoinPool fork join">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ForkJoinPool-work-stealing.webp" alt="ForkJoinPool work stealing">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ForkJoinPool-invoke-link.png" alt="ForkJoinPool invoke link">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ForkJoinPool-data-structures.png" alt="ForkJoinPool data structures">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ForkJoinPool-ctl.png" alt="ForkJoinPool ctl">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.LinkedList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Objects</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutionException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ForkJoinPool</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ForkJoinTask</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.RecursiveTask</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-03-12 10:54
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ForkJoinPoolTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">ForkJoinPool</span> <span class="n">pool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ForkJoinPool</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">homePath</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"user.home"</span><span class="o">);</span>
        <span class="nc">FileCountTask</span> <span class="n">task</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileCountTask</span><span class="o">(</span><span class="n">homePath</span><span class="o">);</span>
        <span class="nc">ForkJoinTask</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Integer</span> <span class="n">count</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"file count = "</span> <span class="o">+</span> <span class="n">count</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="o">|</span> <span class="nc">ExecutionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">pool</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">pool</span><span class="o">.</span><span class="na">isTerminated</span><span class="o">())</span> <span class="o">{</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"All thread finish..."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">FileCountTask</span> <span class="kd">extends</span> <span class="nc">RecursiveTask</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">File</span> <span class="n">file</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">FileCountTask</span><span class="o">(</span><span class="nc">File</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">file</span> <span class="o">=</span> <span class="n">file</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nf">FileCountTask</span><span class="o">(</span><span class="nc">String</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="nc">Integer</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">isFile</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="nc">File</span><span class="o">[]</span> <span class="n">files</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">listFiles</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">isNull</span><span class="o">(</span><span class="n">files</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">files</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
                <span class="o">}</span>
                <span class="nc">List</span><span class="o">&lt;</span><span class="nc">FileCountTask</span><span class="o">&gt;</span> <span class="n">subTasks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedList</span><span class="o">&lt;&gt;();</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">File</span> <span class="n">f</span> <span class="o">:</span> <span class="n">files</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">())</span> <span class="o">{</span>
                        <span class="nc">FileCountTask</span> <span class="n">task</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileCountTask</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
                        <span class="n">subTasks</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
                        <span class="n">task</span><span class="o">.</span><span class="na">fork</span><span class="o">();</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">FileCountTask</span> <span class="n">subTask</span> <span class="o">:</span> <span class="n">subTasks</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="n">subTask</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%8d     %s %n"</span><span class="o">,</span> <span class="n">count</span><span class="o">,</span> <span class="n">file</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">count</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_å‚è€ƒèµ„æ–™_15"><a class="anchor" href="#_å‚è€ƒèµ„æ–™_15"></a>60.1. å‚è€ƒèµ„æ–™</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://blog.csdn.net/u010841296/article/details/83963637">ForkJoinPoolå®ç°åŸç†å’Œæºç è§£æ_Java_Javaç¨‹åºå‘˜çš„è¿›é˜¶ä¹‹è·¯-CSDNåšå®¢</a></p>
</li>
<li>
<p><a href="https://segmentfault.com/a/1190000016781127">Javaå¤šçº¿ç¨‹è¿›é˜¶ï¼ˆå››ä¸‰ï¼‰â€”â€” J.U.Cä¹‹executorsæ¡†æ¶ï¼šFork/Joinæ¡†æ¶ï¼ˆ1ï¼‰ åŸç† - é€å½»ç†è§£Javaå¹¶å‘ç¼–ç¨‹ - SegmentFault æ€å¦</a></p>
</li>
<li>
<p><a href="https://segmentfault.com/a/1190000016877931">Javaå¤šçº¿ç¨‹è¿›é˜¶ï¼ˆå››å››ï¼‰â€”â€” J.U.Cä¹‹executorsæ¡†æ¶ï¼šFork/Joinæ¡†æ¶ï¼ˆ2ï¼‰å®ç° - é€å½»ç†è§£Javaå¹¶å‘ç¼–ç¨‹ - SegmentFault æ€å¦</a></p>
</li>
<li>
<p><a href="https://liuyehcf.github.io/2017/08/01/Java-concurrent-Fork-Join-%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/">Java-concurrent-Fork-Join-æºç å‰–æ | Liuye Blog</a></p>
</li>
<li>
<p><a href="https://www.jianshu.com/p/32a15ef2f1bf">JUCæºç åˆ†æ-çº¿ç¨‹æ± ç¯‡ï¼ˆå››ï¼‰ï¼šForkJoinPool - 1 - ç®€ä¹¦</a></p>
</li>
<li>
<p><a href="https://www.jianshu.com/p/6a14d0b54b8d">JUCæºç åˆ†æ-çº¿ç¨‹æ± ç¯‡ï¼ˆäº”ï¼‰ï¼šForkJoinPool - 2 - ç®€ä¹¦</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_concurrenthashmap"><a class="anchor" href="#_concurrenthashmap"></a>61. <code>ConcurrentHashMap</code></h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="./images/ConcurrentHashMap-segment-lock.png" alt="ConcurrentHashMap segment lock">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/JDK1.8-ConcurrentHashMap-Structure.jpg" alt="JDK1.8 ConcurrentHashMap Structure">
</div>
</div>
<div class="sect2">
<h3 id="_å‚è€ƒèµ„æ–™_16"><a class="anchor" href="#_å‚è€ƒèµ„æ–™_16"></a>61.1. å‚è€ƒèµ„æ–™</h3>
<div class="ulist">
<ul>
<li>
<p><a href="http://note.youdao.com/share/?spm=5176.100239.blogcont36781.3.nHffVb&amp;id=dde7a10b98aee57676408bc475ab0680&amp;type=note#/">ConcurrentHashMapæºç åˆ†æ&#8212;&#8203;Java8</a></p>
</li>
<li>
<p><a href="http://www.cnblogs.com/huaizuo/p/5413069.html">æ¢ç´¢jdk8ä¹‹ConcurrentHashMap çš„å®ç°æœºåˆ¶ - æ·®å·¦ - åšå®¢å›­</a>&#8201;&#8212;&#8201;å‚è€ƒèµ„æ–™éå¸¸æ£’ï¼Œå»ºè®®éƒ½çœ‹çœ‹ï¼</p>
</li>
<li>
<p><a href="http://blog.csdn.net/u010723709/article/details/48007881">ConcurrentHashMapæºç åˆ†æï¼ˆJDK8ç‰ˆæœ¬ï¼‰ - æƒŸæ„¿æ— äº‹ - åšå®¢é¢‘é“ - CSDN.NET</a></p>
</li>
<li>
<p><a href="https://www.cnblogs.com/chengxiao/p/6842045.html">ConcurrentHashMapå®ç°åŸç†åŠæºç åˆ†æ - dreamcatcher-cx - åšå®¢å›­</a></p>
</li>
<li>
<p><a href="https://www.jianshu.com/p/d10256f0ebea">ConcurrentHashMap åŸç†è§£æï¼ˆJDK1.8ï¼‰ - ç®€ä¹¦</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_concurrentskiplistmap"><a class="anchor" href="#_concurrentskiplistmap"></a>62. <code>ConcurrentSkipListMap</code></h2>
<div class="sectionbody">
<div class="paragraph">
<p>æ²¡æƒ³åˆ° JDK ä¸­ï¼Œå±…ç„¶æœ‰è·³è·ƒè¡¨çš„å®ç°ï¼</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ConcurrentSkipListMap-search.jpg" alt="ConcurrentSkipListMap search">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_copyonwritearraylist"><a class="anchor" href="#_copyonwritearraylist"></a>63. CopyOnWriteArrayList</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="#"><code>ReentrantReadWriteLock</code></a> è¯»å†™é”çš„æ€æƒ³éå¸¸ç±»ä¼¼ï¼Œä¹Ÿå°±æ˜¯è¯»è¯»å…±äº«ã€å†™å†™äº’æ–¥ã€è¯»å†™äº’æ–¥ã€å†™è¯»äº’æ–¥ã€‚JDK ä¸­æä¾›äº† <code>CopyOnWriteArrayList</code> ç±»æ¯”ç›¸æ¯”äºåœ¨è¯»å†™é”çš„æ€æƒ³åˆæ›´è¿›ä¸€æ­¥ã€‚ä¸ºäº†å°†è¯»å–çš„æ€§èƒ½å‘æŒ¥åˆ°æè‡´ï¼Œ<code>CopyOnWriteArrayList</code> è¯»å–æ˜¯å®Œå…¨ä¸ç”¨åŠ é”çš„ï¼Œå¹¶ä¸”æ›´å‰å®³çš„æ˜¯ï¼šå†™å…¥ä¹Ÿä¸ä¼šé˜»å¡è¯»å–æ“ä½œã€‚åªæœ‰å†™å…¥å’Œå†™å…¥ä¹‹é—´éœ€è¦è¿›è¡ŒåŒæ­¥ç­‰å¾…ã€‚è¿™æ ·ä¸€æ¥ï¼Œè¯»æ“ä½œçš„æ€§èƒ½å°±ä¼šå¤§å¹…åº¦æå‡ã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
</pre></td><td class="code"><pre><span class="cm">/** The array, accessed only via getArray/setArray. */</span>
<span class="kd">private</span> <span class="kd">transient</span> <span class="kd">volatile</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">array</span><span class="o">;</span>

<span class="cm">/**
 * Gets the array.  Non-private so as to also be accessible
 * from CopyOnWriteArraySet class.
 */</span>
<span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="nf">getArray</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">array</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * Sets the array.
 */</span>
<span class="kd">final</span> <span class="kt">void</span> <span class="nf">setArray</span><span class="o">(</span><span class="nc">Object</span><span class="o">[]</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">a</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
<span class="kd">static</span> <span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="no">E</span> <span class="nf">elementAt</span><span class="o">(</span><span class="nc">Object</span><span class="o">[]</span> <span class="n">a</span><span class="o">,</span> <span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="o">(</span><span class="no">E</span><span class="o">)</span> <span class="n">a</span><span class="o">[</span><span class="n">index</span><span class="o">];</span>
<span class="o">}</span>

<span class="cm">/**
 * {@inheritDoc}
 *
 * @throws IndexOutOfBoundsException {@inheritDoc}
 */</span>
<span class="kd">public</span> <span class="no">E</span> <span class="nf">get</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">elementAt</span><span class="o">(</span><span class="n">getArray</span><span class="o">(),</span> <span class="n">index</span><span class="o">);</span>
<span class="o">}</span>

<span class="cm">/**
 * Appends the specified element to the end of this list.
 *
 * @param e element to be appended to this list
 * @return {@code true} (as specified by {@link Collection#add})
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">add</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Object</span><span class="o">[]</span> <span class="n">es</span> <span class="o">=</span> <span class="n">getArray</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
        <span class="n">es</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">es</span><span class="o">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
        <span class="n">es</span><span class="o">[</span><span class="n">len</span><span class="o">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
        <span class="n">setArray</span><span class="o">(</span><span class="n">es</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

    <span class="cm">/**
 * Removes the element at the specified position in this list.
 * Shifts any subsequent elements to the left (subtracts one from their
 * indices).  Returns the element that was removed from the list.
 *
 * @throws IndexOutOfBoundsException {@inheritDoc}
 */</span>
<span class="kd">public</span> <span class="no">E</span> <span class="nf">remove</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Object</span><span class="o">[]</span> <span class="n">es</span> <span class="o">=</span> <span class="n">getArray</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
        <span class="no">E</span> <span class="n">oldValue</span> <span class="o">=</span> <span class="n">elementAt</span><span class="o">(</span><span class="n">es</span><span class="o">,</span> <span class="n">index</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">numMoved</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
        <span class="nc">Object</span><span class="o">[]</span> <span class="n">newElements</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">numMoved</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
            <span class="n">newElements</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">es</span><span class="o">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="n">newElements</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="o">];</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">es</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">newElements</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">index</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">es</span><span class="o">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span> <span class="n">newElements</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span>
                             <span class="n">numMoved</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">setArray</span><span class="o">(</span><span class="n">newElements</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">oldValue</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>CopyOnWriteArrayList</code> ç±»çš„æ‰€æœ‰å¯å˜æ“ä½œï¼ˆ<code>add</code>ï¼Œ<code>set</code> ç­‰ç­‰ï¼‰éƒ½æ˜¯é€šè¿‡åˆ›å»ºåº•å±‚æ•°ç»„çš„æ–°å‰¯æœ¬æ¥å®ç°çš„ã€‚å½“ <code>List</code> éœ€è¦è¢«ä¿®æ”¹çš„æ—¶å€™ï¼Œæˆ‘å¹¶ä¸ä¿®æ”¹åŸæœ‰å†…å®¹ï¼Œè€Œæ˜¯å¯¹åŸæœ‰æ•°æ®è¿›è¡Œä¸€æ¬¡å¤åˆ¶ï¼Œå°†ä¿®æ”¹çš„å†…å®¹å†™å…¥å‰¯æœ¬ã€‚å†™å®Œä¹‹åï¼Œå†å°†ä¿®æ”¹å®Œçš„å‰¯æœ¬æ›¿æ¢åŸæ¥çš„æ•°æ®ï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯å†™æ“ä½œä¸ä¼šå½±å“è¯»æ“ä½œäº†ã€‚</p>
</div>
<div class="paragraph">
<p>ä» <code>CopyOnWriteArrayList</code> çš„åå­—å°±èƒ½çœ‹å‡º <code>CopyOnWriteArrayList</code> æ˜¯æ»¡è¶³ <code>CopyOnWrite</code> çš„ <code>ArrayList</code>ï¼Œæ‰€è°“ <code>CopyOnWrite</code> ä¹Ÿå°±æ˜¯è¯´ï¼šåœ¨è®¡ç®—æœºï¼Œå¦‚æœä½ æƒ³è¦å¯¹ä¸€å—å†…å­˜è¿›è¡Œä¿®æ”¹æ—¶ï¼Œæˆ‘ä»¬ä¸åœ¨åŸæœ‰å†…å­˜å—ä¸­è¿›è¡Œå†™æ“ä½œï¼Œè€Œæ˜¯å°†å†…å­˜æ‹·è´ä¸€ä»½ï¼Œåœ¨æ–°çš„å†…å­˜ä¸­è¿›è¡Œå†™æ“ä½œï¼Œå†™å®Œä¹‹åå‘¢ï¼Œå°±å°†æŒ‡å‘åŸæ¥å†…å­˜æŒ‡é’ˆæŒ‡å‘æ–°çš„å†…å­˜ï¼ŒåŸæ¥çš„å†…å­˜å°±å¯ä»¥è¢«å›æ”¶æ‰äº†ã€‚</p>
</div>
<div class="sect2">
<h3 id="_å‚è€ƒèµ„æ–™_17"><a class="anchor" href="#_å‚è€ƒèµ„æ–™_17"></a>63.1. å‚è€ƒèµ„æ–™</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://snailclimb.gitee.io/javaguide/#/docs/java/Multithread/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8%E6%80%BB%E7%BB%93">JavaGuide ä¹‹ å¹¶å‘å®¹å™¨æ€»ç»“</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_concurrentlinkedqueue"><a class="anchor" href="#_concurrentlinkedqueue"></a>64. ConcurrentLinkedQueue</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>ConcurrentLinkedQueue</code> ä¸»è¦ä½¿ç”¨ CAS éé˜»å¡ç®—æ³•æ¥å®ç°çº¿ç¨‹å®‰å…¨ã€‚è¿™æ˜¯ä¸€ä¸ªéé˜»å¡é˜Ÿåˆ—ã€‚å¯¹æ¯”æ¥çœ‹ï¼Œ<code>LinkedBlockingQueue</code> æ˜¯ä¸€ä¸ªå¯ä»¥é˜»å¡çš„é˜Ÿåˆ—ã€‚</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_arrayblockingqueue"><a class="anchor" href="#_arrayblockingqueue"></a>65. ArrayBlockingQueue</h2>
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="./images/BlockingQueue.png" alt="BlockingQueue">
</div>
</div>
<div class="sect2">
<h3 id="_æ–¹æ³•ç»„"><a class="anchor" href="#_æ–¹æ³•ç»„"></a>65.1. æ–¹æ³•ç»„</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 8%;">
<col style="width: 45%;">
<col style="width: 34%;">
<col style="width: 13%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">æ’å…¥</th>
<th class="tableblock halign-left valign-top">ç§»é™¤</th>
<th class="tableblock halign-left valign-top">æ£€æŸ¥</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">æŠ›å¼‚å¸¸</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean add(E e)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean remove(Object o)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>E element()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ç‰¹å®šå€¼</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean offer(E e)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>E poll()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>E peek()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">é˜»å¡</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>void put(E e)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>E take()</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">è¶…æ—¶</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean offer(E e, long timeout, TimeUnit unit)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>E poll(long timeout, TimeUnit unit)</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>å››ç»„æ–¹æ³•ï¼š</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>æŠ›å¼‚å¸¸</strong>ï¼šå¦‚æœè¯•å›¾çš„æ“ä½œæ— æ³•ç«‹å³æ‰§è¡Œï¼ŒæŠ›ä¸€ä¸ªå¼‚å¸¸ã€‚</p>
</li>
<li>
<p><strong>ç‰¹å®šå€¼</strong>ï¼šå¦‚æœè¯•å›¾çš„æ“ä½œæ— æ³•ç«‹å³æ‰§è¡Œï¼Œè¿”å›ä¸€ä¸ªç‰¹å®šçš„å€¼(é€šå¸¸æ˜¯ <code>true</code>, <code>false</code> æˆ– <code>null</code>)ã€‚</p>
</li>
<li>
<p><strong>é˜»å¡</strong>ï¼šå¦‚æœè¯•å›¾çš„æ“ä½œæ— æ³•ç«‹å³æ‰§è¡Œï¼Œè¯¥æ–¹æ³•è°ƒç”¨å°†ä¼šå‘ç”Ÿé˜»å¡ï¼Œç›´åˆ°èƒ½å¤Ÿæ‰§è¡Œã€‚</p>
</li>
<li>
<p><strong>è¶…æ—¶</strong>ï¼šå¦‚æœè¯•å›¾çš„æ“ä½œæ— æ³•ç«‹å³æ‰§è¡Œï¼Œè¯¥æ–¹æ³•è°ƒç”¨å°†ä¼šå‘ç”Ÿé˜»å¡ï¼Œç›´åˆ°èƒ½å¤Ÿæ‰§è¡Œï¼Œä½†ç­‰å¾…æ—¶é—´ä¸ä¼šè¶…è¿‡ç»™å®šå€¼ã€‚è¿”å›ä¸€ä¸ªç‰¹å®šå€¼ä»¥å‘ŠçŸ¥è¯¥æ“ä½œæ˜¯å¦æˆåŠŸ(å…¸å‹çš„æ˜¯ true / false)ã€‚</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>ArrayBlockingQueue</code> æ˜¯ <code>BlockingQueue</code> æ¥å£çš„æœ‰ç•Œé˜Ÿåˆ—å®ç°ç±»ï¼Œåº•å±‚é‡‡ç”¨æ•°ç»„æ¥å®ç°ã€‚<code>ArrayBlockingQueue</code> ä¸€æ—¦åˆ›å»ºï¼Œå®¹é‡ä¸èƒ½æ”¹å˜ã€‚</p>
</div>
<div class="paragraph">
<p><code>ArrayBlockingQueue</code> é»˜è®¤æƒ…å†µä¸‹ä¸èƒ½ä¿è¯çº¿ç¨‹è®¿é—®é˜Ÿåˆ—çš„å…¬å¹³æ€§ï¼Œæ‰€è°“å…¬å¹³æ€§æ˜¯æŒ‡ä¸¥æ ¼æŒ‰ç…§çº¿ç¨‹ç­‰å¾…çš„ç»å¯¹æ—¶é—´é¡ºåºï¼Œå³æœ€å…ˆç­‰å¾…çš„çº¿ç¨‹èƒ½å¤Ÿæœ€å…ˆè®¿é—®åˆ° <code>ArrayBlockingQueue</code>ã€‚è€Œéå…¬å¹³æ€§åˆ™æ˜¯æŒ‡è®¿é—® <code>ArrayBlockingQueue</code> çš„é¡ºåºä¸æ˜¯éµå®ˆä¸¥æ ¼çš„æ—¶é—´é¡ºåºï¼Œæœ‰å¯èƒ½å­˜åœ¨ï¼Œå½“ <code>ArrayBlockingQueue</code> å¯ä»¥è¢«è®¿é—®æ—¶ï¼Œé•¿æ—¶é—´é˜»å¡çš„çº¿ç¨‹ä¾ç„¶æ— æ³•è®¿é—®åˆ° <code>ArrayBlockingQueue</code>ã€‚å¦‚æœä¿è¯å…¬å¹³æ€§ï¼Œé€šå¸¸ä¼šé™ä½ååé‡ã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
</pre></td><td class="code"><pre><span class="cm">/**
 * Inserts element at current put position, advances, and signals.
 * Call only when holding lock.
 */</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">enqueue</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// assert lock.isHeldByCurrentThread();</span>
    <span class="c1">// assert lock.getHoldCount() == 1;</span>
    <span class="c1">// assert items[putIndex] == null;</span>
    <span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">items</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">items</span><span class="o">;</span>
    <span class="n">items</span><span class="o">[</span><span class="n">putIndex</span><span class="o">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(++</span><span class="n">putIndex</span> <span class="o">==</span> <span class="n">items</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="n">putIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="n">count</span><span class="o">++;</span>
    <span class="n">notEmpty</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
<span class="o">}</span>

<span class="cm">/**
 * Extracts element at current take position, advances, and signals.
 * Call only when holding lock.
 */</span>
<span class="kd">private</span> <span class="no">E</span> <span class="nf">dequeue</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// assert lock.isHeldByCurrentThread();</span>
    <span class="c1">// assert lock.getHoldCount() == 1;</span>
    <span class="c1">// assert items[takeIndex] != null;</span>
    <span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">items</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">items</span><span class="o">;</span>
    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
    <span class="no">E</span> <span class="n">e</span> <span class="o">=</span> <span class="o">(</span><span class="no">E</span><span class="o">)</span> <span class="n">items</span><span class="o">[</span><span class="n">takeIndex</span><span class="o">];</span>
    <span class="n">items</span><span class="o">[</span><span class="n">takeIndex</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(++</span><span class="n">takeIndex</span> <span class="o">==</span> <span class="n">items</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="n">takeIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="n">count</span><span class="o">--;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">itrs</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
        <span class="n">itrs</span><span class="o">.</span><span class="na">elementDequeued</span><span class="o">();</span>
    <span class="n">notFull</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">e</span><span class="o">;</span>
<span class="o">}</span>



<span class="cm">/**
 * Inserts the specified element at the tail of this queue if it is
 * possible to do so immediately without exceeding the queue's capacity,
 * returning {@code true} upon success and throwing an
 * {@code IllegalStateException} if this queue is full.
 *
 * @param e the element to add
 * @return {@code true} (as specified by {@link Collection#add})
 * @throws IllegalStateException if this queue is full
 * @throws NullPointerException if the specified element is null
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">add</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
<span class="o">}</span>

<span class="cm">/**
 * Inserts the specified element at the tail of this queue if it is
 * possible to do so immediately without exceeding the queue's capacity,
 * returning {@code true} upon success and {@code false} if this queue
 * is full.  This method is generally preferable to method {@link #add},
 * which can fail to insert an element only by throwing an exception.
 *
 * @throws NullPointerException if the specified element is null
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">offer</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="kd">final</span> <span class="nc">ReentrantLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">lock</span><span class="o">;</span>
    <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">items</span><span class="o">.</span><span class="na">length</span><span class="o">)</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="n">enqueue</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="no">E</span> <span class="nf">poll</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">ReentrantLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">lock</span><span class="o">;</span>
    <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">dequeue</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>åº•å±‚ä½¿ç”¨æ•°ç»„æ¥å®ç°ï¼Œé•¿åº¦ç¡®å®šåå°±ä¸å†å˜åŒ–ï¼Œé€šè¿‡ä¸‹æ ‡å¾ªç¯å¾€å¤åœ°ä½¿ç”¨æ•°ç»„ï¼Œç±»ä¼¼ä¸å°†æ•°ç»„ç»„æˆäº†ä¸€ä¸ªåœ†ã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.ArrayBlockingQueue</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutorService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Executors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.LockSupport</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-04-22 15:11
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ArrayBlockingQueueTest</span> <span class="o">{</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testTimeoutPoll</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
        <span class="nc">ArrayBlockingQueue</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayBlockingQueue</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;(</span><span class="mi">5</span><span class="o">);</span>
        <span class="n">executorService</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">queue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="kt">long</span> <span class="n">time</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
            <span class="n">executorService</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Long</span> <span class="n">num</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="n">time</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">);</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"poll:"</span> <span class="o">+</span> <span class="n">num</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">parkNanos</span><span class="o">(</span><span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="mi">10</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>poll(long, java.util.concurrent.TimeUnit)</code> æ–¹æ³•ï¼Œå…¶å®å°±æ˜¯ä½¿ç”¨ <code>Condition notEmpty</code> å¯¹è±¡æ¥è°ƒç”¨ <code>ConditionObject.awaitNanos(long)</code> æ–¹æ³•ï¼Œåœ¨å…¶ä¸­å†è°ƒç”¨äº† <a href="#"><code>LockSupport.parkNanos(java.lang.Object, long)</code></a> æ–¹æ³•æ¥å®ç°"ä¼‘çœ ç­‰å¾…"ã€‚</p>
</div>
</div>
<div class="sect2">
<h3 id="_å‚è€ƒèµ„æ–™_18"><a class="anchor" href="#_å‚è€ƒèµ„æ–™_18"></a>65.2. å‚è€ƒèµ„æ–™</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.pdai.tech/md/java/thread/java-thread-x-juc-collection-BlockingQueue.html">JUCé›†åˆ: BlockingQueueè¯¦è§£ | Java å…¨æ ˆçŸ¥è¯†ä½“ç³»</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_linkedblockingqueue"><a class="anchor" href="#_linkedblockingqueue"></a>66. LinkedBlockingQueue</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>LinkedBlockingQueue</code> åº•å±‚æ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨ç»“æ„ã€‚å¦‚æœéœ€è¦çš„è¯ï¼Œè¿™ä¸€é“¾å¼ç»“æ„å¯ä»¥é€‰æ‹©ä¸€ä¸ªä¸Šé™ã€‚å¦‚æœæ²¡æœ‰å®šä¹‰ä¸Šé™ï¼Œå°†ä½¿ç”¨ <code>Integer.MAX_VALUE</code> ä½œä¸ºä¸Šé™ã€‚</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_priorityblockingqueue"><a class="anchor" href="#_priorityblockingqueue"></a>67. PriorityBlockingQueue</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>PriorityBlockingQueue</code> æ˜¯ä¸€ä¸ªæ”¯æŒä¼˜å…ˆçº§çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚é»˜è®¤æƒ…å†µä¸‹å…ƒç´ é‡‡ç”¨è‡ªç„¶é¡ºåºè¿›è¡Œæ’åºï¼Œä¹Ÿå¯ä»¥é€šè¿‡è‡ªå®šä¹‰ç±»å®ç° <code>compareTo()</code> æ–¹æ³•æ¥æŒ‡å®šå…ƒç´ æ’åºè§„åˆ™ï¼Œæˆ–è€…åˆå§‹åŒ–æ—¶é€šè¿‡æ„é€ å™¨å‚æ•° <code>Comparator</code> æ¥æŒ‡å®šæ’åºè§„åˆ™ã€‚</p>
</div>
<div class="paragraph">
<p><code>PriorityBlockingQueue</code> å¹¶å‘æ§åˆ¶é‡‡ç”¨çš„æ˜¯ <code>ReentrantLock</code>ï¼Œé˜Ÿåˆ—ä¸ºæ— ç•Œé˜Ÿåˆ—ï¼ˆ<code>ArrayBlockingQueue</code> æ˜¯æœ‰ç•Œé˜Ÿåˆ—ï¼Œ<code>LinkedBlockingQueue</code> ä¹Ÿå¯ä»¥é€šè¿‡åœ¨æ„é€ å‡½æ•°ä¸­ä¼ å…¥ <code>capacity</code> æŒ‡å®šé˜Ÿåˆ—æœ€å¤§çš„å®¹é‡ï¼Œä½†æ˜¯ <code>PriorityBlockingQueue</code> åªèƒ½æŒ‡å®šåˆå§‹çš„é˜Ÿåˆ—å¤§å°ï¼Œåé¢æ’å…¥å…ƒç´ çš„æ—¶å€™ï¼Œå¦‚æœç©ºé—´ä¸å¤Ÿçš„è¯ä¼šè‡ªåŠ¨æ‰©å®¹ï¼‰ã€‚</p>
</div>
<div class="sect2">
<h3 id="_å‚è€ƒèµ„æ–™_19"><a class="anchor" href="#_å‚è€ƒèµ„æ–™_19"></a>67.1. å‚è€ƒèµ„æ–™</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://www.javadoop.com/post/java-concurrent-queue">è§£è¯» java å¹¶å‘é˜Ÿåˆ— BlockingQueue_Javadoop</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_delayqueue"><a class="anchor" href="#_delayqueue"></a>68. DelayQueue</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>DelayQueue</code> å¯¹å…ƒç´ è¿›è¡ŒæŒæœ‰ç›´åˆ°ä¸€ä¸ªç‰¹å®šçš„å»¶è¿Ÿåˆ°æœŸã€‚æ³¨å…¥å…¶ä¸­çš„å…ƒç´ å¿…é¡»å®ç° <code>java.util.concurrent.Delayed</code> æ¥å£ï¼Œè¯¥æ¥å£å®šä¹‰:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">java.util.concurrent</span><span class="o">;</span>

<span class="cm">/**
 * A mix-in style interface for marking objects that should be
 * acted upon after a given delay.
 *
 * &lt;p&gt;An implementation of this interface must define a
 * {@code compareTo} method that provides an ordering consistent with
 * its {@code getDelay} method.
 *
 * @since 1.5
 * @author Doug Lea
 */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Delayed</span> <span class="kd">extends</span> <span class="nc">Comparable</span><span class="o">&lt;</span><span class="nc">Delayed</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="cm">/**
     * Returns the remaining delay associated with this object, in the
     * given time unit.
     *
     * @param unit the time unit
     * @return the remaining delay; zero or negative values indicate
     * that the delay has already elapsed
     */</span>
    <span class="kt">long</span> <span class="nf">getDelay</span><span class="o">(</span><span class="nc">TimeUnit</span> <span class="n">unit</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Objects</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.DelayQueue</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Delayed</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-04-22 16:38
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DelayQueueTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">DelayQueue</span><span class="o">&lt;</span><span class="nc">IntDelay</span><span class="o">&gt;</span> <span class="n">delayQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DelayQueue</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">delayQueue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">IntDelay</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">delayQueue</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">IntDelay</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">delayQueue</span><span class="o">.</span><span class="na">take</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">nonNull</span><span class="o">(</span><span class="n">delay</span><span class="o">))</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">delay</span><span class="o">.</span><span class="na">num</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">IntDelay</span> <span class="kd">implements</span> <span class="nc">Delayed</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="kt">int</span> <span class="n">num</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">long</span> <span class="n">deadline</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">IntDelay</span><span class="o">(</span><span class="kt">int</span> <span class="n">num</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">num</span> <span class="o">=</span> <span class="n">num</span><span class="o">;</span>
            <span class="n">deadline</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">+</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">toMillis</span><span class="o">(</span><span class="n">num</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getDelay</span><span class="o">(</span><span class="nc">TimeUnit</span> <span class="n">unit</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">deadline</span> <span class="o">-</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">compareTo</span><span class="o">(</span><span class="nc">Delayed</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">IntDelay</span> <span class="n">param</span> <span class="o">=</span> <span class="o">(</span><span class="nc">IntDelay</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>
            <span class="k">return</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">compare</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">num</span><span class="o">,</span> <span class="n">param</span><span class="o">.</span><span class="na">num</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_classloader"><a class="anchor" href="#_classloader"></a>69. ClassLoader</h2>
<div class="sectionbody">
<div class="paragraph">
<p>è™½ç„¶å¯¹ <code>ClassLoader</code> çš„åŒäº²å§”æ´¾æµç¨‹æ¯”è¾ƒäº†è§£ï¼Œä½†æ˜¯ä¸€ç›´æ²¡æœ‰ä»”ç»†ä¸“ç ”è¿‡ä»£ç å®ç°ã€‚ä»Šå¤©ç¿»çœ‹ä»£ç ï¼Œä»£ç å†™çš„ç®€å•æ˜äº†ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
</pre></td><td class="code"><pre><span class="cm">/**
 * Loads the class with the specified &lt;a href="#binary-name"&gt;binary name&lt;/a&gt;.  The
 * default implementation of this method searches for classes in the
 * following order:
 *
 * &lt;ol&gt;
 *
 *   &lt;li&gt;&lt;p&gt; Invoke {@link #findLoadedClass(String)} to check if the class
 *   has already been loaded.  &lt;/p&gt;&lt;/li&gt;
 *
 *   &lt;li&gt;&lt;p&gt; Invoke the {@link #loadClass(String) loadClass} method
 *   on the parent class loader.  If the parent is {@code null} the class
 *   loader built into the virtual machine is used, instead.  &lt;/p&gt;&lt;/li&gt;
 *
 *   &lt;li&gt;&lt;p&gt; Invoke the {@link #findClass(String)} method to find the
 *   class.  &lt;/p&gt;&lt;/li&gt;
 *
 * &lt;/ol&gt;
 *
 * &lt;p&gt; If the class was found using the above steps, and the
 * {@code resolve} flag is true, this method will then invoke the {@link
 * #resolveClass(Class)} method on the resulting {@code Class} object.
 *
 * &lt;p&gt; Subclasses of {@code ClassLoader} are encouraged to override {@link
 * #findClass(String)}, rather than this method.  &lt;/p&gt;
 *
 * &lt;p&gt; Unless overridden, this method synchronizes on the result of
 * {@link #getClassLoadingLock getClassLoadingLock} method
 * during the entire class loading process.
 *
 * @param  name
 *         The &lt;a href="#binary-name"&gt;binary name&lt;/a&gt; of the class
 *
 * @param  resolve
 *         If {@code true} then resolve the class
 *
 * @return  The resulting {@code Class} object
 *
 * @throws  ClassNotFoundException
 *          If the class could not be found
 */</span>
<span class="kd">protected</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">loadClass</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">resolve</span><span class="o">)</span>
    <span class="kd">throws</span> <span class="nc">ClassNotFoundException</span>
<span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">getClassLoadingLock</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
        <span class="c1">// First, check if the class has already been loaded</span>
        <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">findLoadedClass</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">long</span> <span class="n">t0</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">parent</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">findBootstrapClassOrNull</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// ClassNotFoundException thrown if class not found</span>
                <span class="c1">// from the non-null parent class loader</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// If still not found, then invoke findClass in order</span>
                <span class="c1">// to find the class.</span>
                <span class="kt">long</span> <span class="n">t1</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">findClass</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>

                <span class="c1">// this is the defining class loader; record the stats</span>
                <span class="nc">PerfCounter</span><span class="o">.</span><span class="na">getParentDelegationTime</span><span class="o">().</span><span class="na">addTime</span><span class="o">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="o">);</span>
                <span class="nc">PerfCounter</span><span class="o">.</span><span class="na">getFindClassTime</span><span class="o">().</span><span class="na">addElapsedTimeFrom</span><span class="o">(</span><span class="n">t1</span><span class="o">);</span>
                <span class="nc">PerfCounter</span><span class="o">.</span><span class="na">getFindClasses</span><span class="o">().</span><span class="na">increment</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">resolve</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">resolveClass</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="cm">/**
 * Finds the class with the specified &lt;a href="#binary-name"&gt;binary name&lt;/a&gt;.
 * This method should be overridden by class loader implementations that
 * follow the delegation model for loading classes, and will be invoked by
 * the {@link #loadClass loadClass} method after checking the
 * parent class loader for the requested class.
 *
 * @implSpec The default implementation throws {@code ClassNotFoundException}.
 *
 * @param  name
 *         The &lt;a href="#binary-name"&gt;binary name&lt;/a&gt; of the class
 *
 * @return  The resulting {@code Class} object
 *
 * @throws  ClassNotFoundException
 *          If the class could not be found
 *
 * @since  1.2
 */</span>
<span class="kd">protected</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">findClass</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ClassNotFoundException</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">ClassNotFoundException</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>å¦‚æœè‡ªå®šä¹‰ <code>ClassLoader</code>ï¼Œæœ€ç®€å•çš„åŠæ³•å°±æ˜¯é‡è½½ <code>Class&lt;?&gt; findClass(String name)</code> æ–¹æ³•å°±å¯ä»¥äº†ã€‚æˆ–è€…ä¸ºäº†é¿å…åŒäº²å§”æ‰˜æœºåˆ¶ï¼Œå¯ä»¥è‡ªå·±å®šä¹‰ä¸€ä¸ªç±»åŠ è½½å™¨ï¼Œç„¶åé‡å†™ <code>loadClass()</code> å³å¯ã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.ByteArrayOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationTargetException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.URL</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Objects</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-03-10 17:23
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ClassLoaderTest</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ClassLodarDemo's ClassLoader is "</span> <span class="o">+</span> <span class="nc">ClassLoaderTest</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"The Parent of ClassLodarDemo's ClassLoader is "</span> <span class="o">+</span> <span class="nc">ClassLoaderTest</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">().</span><span class="na">getParent</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"The GrandParent of ClassLodarDemo's ClassLoader is "</span> <span class="o">+</span> <span class="nc">ClassLoaderTest</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">().</span><span class="na">getParent</span><span class="o">().</span><span class="na">getParent</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">ClassNotFoundException</span><span class="o">,</span> <span class="nc">NoSuchMethodException</span><span class="o">,</span>
            <span class="nc">IllegalAccessException</span><span class="o">,</span> <span class="nc">InvocationTargetException</span><span class="o">,</span>
            <span class="nc">InstantiationException</span> <span class="o">{</span>
        <span class="nc">DiguageClassLoader</span> <span class="n">loader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DiguageClassLoader</span><span class="o">();</span>
        <span class="c1">// å¦‚ä½•è¯†åˆ«å†…éƒ¨ç±»ï¼Ÿ</span>
        <span class="c1">// å¦‚ä½•è·å–å†…éƒ¨ç±»çš„æ­£ç¡®ç±»åï¼Ÿ</span>
        <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span>
                <span class="s">"com.diguage.truman.ClassLoaderTest.HelloWorld"</span><span class="o">);</span>
        <span class="nc">Object</span> <span class="n">instance</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredConstructor</span><span class="o">().</span><span class="na">newInstance</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">instance</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">HelloWorld</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"Hello, https://www.diguage.com/"</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DiguageClassLoader</span> <span class="kd">extends</span> <span class="nc">ClassLoader</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">findClass</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ClassNotFoundException</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">isNull</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"class name is null."</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="nc">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">"\\."</span><span class="o">,</span> <span class="s">"/"</span><span class="o">)</span> <span class="o">+</span> <span class="s">".class"</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">fileName</span><span class="o">.</span><span class="na">lastIndexOf</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="n">fileName</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">index</span><span class="o">)</span> <span class="o">+</span> <span class="s">"$"</span>
                    <span class="o">+</span> <span class="n">fileName</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
            <span class="nc">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">getResourceAsStream</span><span class="o">(</span><span class="n">fileName</span><span class="o">);</span>
            <span class="nc">ByteArrayOutputStream</span> <span class="n">outputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteArrayOutputStream</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">1024</span><span class="o">];</span>
                <span class="k">while</span> <span class="o">((</span><span class="n">size</span> <span class="o">=</span> <span class="n">inputStream</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">bytes</span><span class="o">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">outputStream</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">size</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytecodes</span> <span class="o">=</span> <span class="n">outputStream</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">bytecodes</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ClassNotFoundException</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="na">lastIndexOf</span><span class="o">(</span><span class="s">"."</span><span class="o">);</span>
            <span class="nc">String</span> <span class="n">className</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">i</span><span class="o">)</span> <span class="o">+</span> <span class="s">"$"</span> <span class="o">+</span> <span class="n">name</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
            <span class="k">return</span> <span class="nf">defineClass</span><span class="o">(</span><span class="n">className</span><span class="o">,</span> <span class="n">bytecodes</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">bytecodes</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>jdk.internal.loader.ClassLoaders.PlatformClassLoader</code></p>
</li>
<li>
<p><code>jdk.internal.loader.ClassLoaders.AppClassLoader</code></p>
</li>
</ol>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./diag-ef52046d7364e83d0b5a63f62cc3844a.svg" alt="diag ef52046d7364e83d0b5a63f62cc3844a" width="100%" height="250">
</div>
<div class="title">Figure 1. JDK 8 åŠä»¥å‰çš„åŠ è½½ä½“ç³»</div>
</div>
<div class="paragraph">
<p>åœ¨ JDK 8 åŠä»¥å‰ï¼Œ<code>AppClassLoader</code> å’Œ <code>ExtClassLoader</code> è¿™ä¸¤ä¸ªç±»éƒ½æ˜¯ <code>sun.misc.Launcher</code> ä¸­çš„å†…éƒ¨ç±»ã€‚ <code>BootstrapClassLoader</code> æ˜¯ç”± C++ ä»£ç å®ç°çš„ã€‚æ‰€ä»¥ï¼Œä¸å­˜åœ¨ Java ç±»å®šä¹‰ã€‚</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/load-class-process.png" alt="load class process">
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./diag-591951bddf42ea19b935b551f129c9ee.svg" alt="diag 591951bddf42ea19b935b551f129c9ee" width="100%" height="250">
</div>
<div class="title">Figure 2. JDK 9 ä¹‹åçš„åŠ è½½ä½“ç³»</div>
</div>
<div class="paragraph">
<p>åœ¨ JDK 9 ä»¥åï¼Œ<code>AppClassLoader</code>ï¼Œ<code>PlatformClassLoader</code> å’Œ <code>BootClassLoader</code> ä¸‰ä¸ªç±»éƒ½å®šä¹‰åœ¨ <code>jdk.internal.loader.ClassLoaders</code> ä¸­ã€‚<code>BootClassLoader</code> æ˜¯ç”± Java å’Œ C++ æ··åˆå®ç°ï¼Œæ‰€ä»¥æœ‰ç±»çš„å®šä¹‰ã€‚</p>
</div>
<div class="paragraph">
<p><code>ClassLoader</code> æä¾›çš„èµ„æºåŠ è½½çš„æ–¹æ³•ä¸­çš„æ ¸å¿ƒæ–¹æ³•æ˜¯ <code>ClassLoader#getResource(String name)</code>ï¼Œå®ƒæ˜¯åŸºäºç”¨æˆ·åº”ç”¨ç¨‹åºçš„ ClassPath æœç´¢èµ„æºï¼Œéµå¾ª"èµ„æºåŠ è½½çš„åŒäº²å§”æ´¾æ¨¡å‹"ï¼Œèµ„æºåç§°å¿…é¡»ä½¿ç”¨è·¯å¾„åˆ†éš”ç¬¦ <code>/</code> å»åˆ†éš”ç›®å½•ï¼Œä½†æ˜¯ä¸èƒ½ä»¥ <code>/</code> ä½œä¸ºèµ„æºåçš„èµ·å§‹å­—ç¬¦ï¼Œå…¶ä»–å‡ ä¸ªæ–¹æ³•éƒ½æ˜¯åŸºäºæ­¤æ–¹æ³•è¿›è¡Œè¡ç”Ÿï¼Œæ·»åŠ å¤æ•°æ“ä½œç­‰å…¶ä»–æ“ä½œã€‚<code>getResource(String name)</code> æ–¹æ³•ä¸ä¼šæ˜¾ç¤ºæŠ›å‡ºå¼‚å¸¸ï¼Œå½“èµ„æºæœç´¢å¤±è´¥çš„æ—¶å€™ï¼Œä¼šè¿”å› <code>null</code>ã€‚</p>
</div>
<div class="ulist">
<ul>
<li>
<p>å¦‚ä½•è¯†åˆ«å†…éƒ¨ç±»ï¼Ÿ</p>
</li>
<li>
<p>å¦‚ä½•è·å–å†…éƒ¨ç±»çš„æ­£ç¡®ç±»åï¼Ÿ</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_å‚è€ƒèµ„æ–™_20"><a class="anchor" href="#_å‚è€ƒèµ„æ–™_20"></a>69.1. å‚è€ƒèµ„æ–™</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://www.throwable.club/2018/11/30/java-resource-load/">é€šè¿‡æºç æµ…æJavaä¸­çš„èµ„æºåŠ è½½ - Throwable&#8217;s Blog</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_field"><a class="anchor" href="#_field"></a>70. Field</h2>
<div class="sectionbody">
<div class="paragraph">
<p>å±æ€§æ“ä½œæ–¹æ³• <code>Field#set(Object obj, Object value)</code> å’Œ <code>Field#get(Object obj)</code> åº•å±‚éƒ½æ˜¯å§”æ‰˜åˆ° <code>jdk.internal.reflect.FieldAccessor</code> å®ç°ã€‚</p>
</div>
<div class="paragraph">
<p><code>FieldAccessor</code> æ¥å£æœ‰å¾ˆå¤šçš„å®ç°ï¼Œ<code>FieldAccessor</code> æ¥å£å®ä¾‹æ˜¯é€šè¿‡ <code>jdk.internal.reflect.ReflectionFactory</code> è¿™ä¸ªå·¥å‚æ„é€ çš„ï¼š</p>
</div>
<div class="listingblock">
<div class="title">jdk.internal.reflect.ReflectionFactory</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
</pre></td><td class="code"><pre>    <span class="kd">public</span> <span class="nc">FieldAccessor</span> <span class="nf">newFieldAccessor</span><span class="o">(</span><span class="nc">Field</span> <span class="n">field</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">override</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">checkInitted</span><span class="o">();</span>

        <span class="nc">Field</span> <span class="n">root</span> <span class="o">=</span> <span class="n">langReflectAccess</span><span class="o">.</span><span class="na">getRoot</span><span class="o">(</span><span class="n">field</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">root</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// FieldAccessor will use the root unless the modifiers have</span>
            <span class="c1">// been overrridden</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">root</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">()</span> <span class="o">==</span> <span class="n">field</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">()</span> <span class="o">||</span> <span class="o">!</span><span class="n">override</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">root</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="nc">UnsafeFieldAccessorFactory</span><span class="o">.</span><span class="na">newFieldAccessor</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">override</span><span class="o">);</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>æœ€ç»ˆå§”æ‰˜åˆ° <code>UnsafeFieldAccessorFactory#newFieldAccessor()</code>ã€‚</p>
</div>
<div class="paragraph">
<p><code>UnsafeObjectFieldAccessorImpl</code> ä¸­é™¤äº† <code>get(Object obj)</code> å’Œ <code>set(Object obj, Object value)</code> æ–¹æ³•ï¼Œå…¶ä»–æ–¹æ³•éƒ½æ˜¯ç›´æ¥æŠ›å‡º <code>IllegalArgumentException</code>ã€‚è€Œ <code>get(Object obj)</code> å’Œ <code>set(Object obj, Object value)</code> åº•å±‚åˆ†åˆ«ä¾èµ–äº <code>jdk.internal.misc.Unsafe</code> çš„ <code>putObject(obj, fieldOffset, value)</code> å’Œ <code>getObject(obj, fieldOffset)</code> æ–¹æ³•ã€‚è€Œå±æ€§çš„å†…å­˜åç§»åœ°å€æ˜¯åœ¨ <code>UnsafeObjectFieldAccessorImpl</code> çš„çˆ¶ç±» <code>UnsafeFieldAccessorImpl</code> çš„æ„é€ å‡½æ•°ä¸­è®¡ç®—å‡ºæ¥çš„ã€‚</p>
</div>
<div class="paragraph">
<p>å±æ€§åå°„æ“ä½œ <code>Field</code> çš„ <code>setXX</code> å’Œ <code>getXX</code> æ–¹æ³•æœ€ç»ˆå§”æ‰˜åˆ° <code>jdk.internal.misc.Unsafe</code> çš„ <code>putXX</code> å’Œ <code>getXX</code> æ–¹æ³•ï¼Œè€Œå±æ€§çš„å†…å­˜åç§»åœ°å€æ˜¯é€šè¿‡ <code>jdk.internal.misc.Unsafe</code> çš„ <code>staticFieldBase()</code>ã€<code>staticFieldOffset</code> å’Œ <code>objectFieldOffset</code> å‡ ä¸ªæ–¹æ³•è®¡ç®—çš„ã€‚</p>
</div>
<div class="sect2">
<h3 id="_å‚è€ƒèµ„æ–™_21"><a class="anchor" href="#_å‚è€ƒèµ„æ–™_21"></a>70.1. å‚è€ƒèµ„æ–™</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://www.throwable.club/2018/12/16/java-reflection-implementance/">æ·±å…¥åˆ†æJavaåå°„(ä¸ƒ)-ç®€è¿°åå°„è°ƒç”¨çš„åº•å±‚å®ç° - Throwable&#8217;s Blog</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_proxy"><a class="anchor" href="#_proxy"></a>71. Proxy</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.reflect</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Proxy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-04-02 09:37
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProxyTest</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">LogProxy</span> <span class="kd">implements</span> <span class="nc">InvocationHandler</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">Object</span> <span class="n">realObject</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">LogProxy</span><span class="o">(</span><span class="nc">Object</span> <span class="n">realObject</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">realObject</span> <span class="o">=</span> <span class="n">realObject</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="nc">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
                <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Proxy: "</span> <span class="o">+</span> <span class="n">proxy</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"start to invoke: "</span>
                    <span class="o">+</span> <span class="n">realObject</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"#"</span> <span class="o">+</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span>
                    <span class="o">+</span> <span class="s">" args ="</span> <span class="o">+</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">args</span><span class="o">));</span>
            <span class="k">return</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">realObject</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">UserGetService</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="nf">getById</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">UserPostService</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="nf">postUser</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">UserGetServiceImpl</span> <span class="kd">implements</span> <span class="nc">UserGetService</span><span class="o">,</span> <span class="nc">UserPostService</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getById</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"Dç“œå“¥-"</span> <span class="o">+</span> <span class="n">id</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">String</span> <span class="nf">postUser</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"119-"</span> <span class="o">+</span> <span class="n">name</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// æ³¨æ„ï¼šè¿™é‡Œä¸èƒ½ä½¿ç”¨ JUnit æ¥è¿è¡Œï¼ŒJUnit ä¹Ÿæ˜¯é€šè¿‡ä»£ç†å¯åŠ¨çš„ï¼Œ</span>
        <span class="c1">// å…ˆäºæˆ‘ä»¬çš„æµ‹è¯•è¿è¡Œï¼Œå¯¼è‡´è®¾ç½®æ— æ•ˆã€‚</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">getProperties</span><span class="o">()</span>
                <span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"jdk.proxy.ProxyGenerator.saveGeneratedFiles"</span><span class="o">,</span> <span class="s">"true"</span><span class="o">);</span>

        <span class="nc">UserGetServiceImpl</span> <span class="n">userService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UserGetServiceImpl</span><span class="o">();</span>
        <span class="nc">ClassLoader</span> <span class="n">classLoader</span> <span class="o">=</span> <span class="nc">UserGetService</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">();</span>
        <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">interfaces</span> <span class="o">=</span> <span class="nc">UserGetServiceImpl</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getInterfaces</span><span class="o">();</span>
        <span class="nc">Object</span> <span class="n">proxy</span> <span class="o">=</span> <span class="nc">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">classLoader</span><span class="o">,</span>
                <span class="n">interfaces</span><span class="o">,</span> <span class="k">new</span> <span class="nc">LogProxy</span><span class="o">(</span><span class="n">userService</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"UserName = "</span>
                <span class="o">+</span> <span class="o">((</span><span class="nc">UserGetService</span><span class="o">)</span> <span class="n">proxy</span><span class="o">).</span><span class="na">getById</span><span class="o">(</span><span class="mi">119</span><span class="o">));</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"UserCode = "</span>
                <span class="o">+</span> <span class="o">((</span><span class="nc">UserPostService</span><span class="o">)</span> <span class="n">proxy</span><span class="o">).</span><span class="na">postUser</span><span class="o">(</span><span class="s">"diguage"</span><span class="o">));</span>

        <span class="nc">Object</span> <span class="n">proxy2</span> <span class="o">=</span> <span class="nc">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">classLoader</span><span class="o">,</span>
                <span class="n">interfaces</span><span class="o">,</span> <span class="k">new</span> <span class="nc">LogProxy</span><span class="o">(</span><span class="n">userService</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"UserName = "</span>
                <span class="o">+</span> <span class="o">((</span><span class="nc">UserGetService</span><span class="o">)</span> <span class="n">proxy2</span><span class="o">).</span><span class="na">getById</span><span class="o">(</span><span class="mi">119</span><span class="o">));</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"UserCode = "</span>
                <span class="o">+</span> <span class="o">((</span><span class="nc">UserPostService</span><span class="o">)</span> <span class="n">proxy2</span><span class="o">).</span><span class="na">postUser</span><span class="o">(</span><span class="s">"diguage"</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testGetCallerMethodName</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">getCallerMethod</span><span class="o">());</span>

        <span class="nc">String</span> <span class="n">methodName</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">()</span> <span class="o">{</span>
        <span class="o">}.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getEnclosingMethod</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">methodName</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getCallerMethod</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">methodName</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()</span>
                <span class="o">.</span><span class="na">getStackTrace</span><span class="o">()[</span><span class="mi">2</span><span class="o">]</span> <span class="c1">// æ³¨æ„ä¸‹æ ‡å€¼</span>
                <span class="o">.</span><span class="na">getMethodName</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">methodName</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Proxy-newProxyInstance-sequence-diagram.png" alt="Proxy newProxyInstance sequence diagram">
</div>
</div>
<div class="paragraph">
<p>è·Ÿç€ä»£ç æ•´ä½“èµ°ä¸‹æ¥ï¼Œæ‰€è°“çš„"åŠ¨æ€ä»£ç†"ï¼Œå…¶å®æ˜¯åœ¨ <code>java.lang.reflect.ProxyGenerator.generateProxyClass(java.lang.String, java.lang.Class&lt;?&gt;[], int)</code> ä¸­ç”Ÿæˆäº†ä¸€ä¸ªå®ç°äº†æ¥å£çš„ä»£ç†ç±»ã€‚ç”Ÿæˆå­—èŠ‚ç çš„é€»è¾‘å°è£…åœ¨äº† <code>java.lang.reflect.ProxyGenerator.generateClassFile</code> ä¸­ï¼ŒæŒ‰ç…§å­—èŠ‚ç è§„èŒƒä¸­è§„å®šçš„æ ¼å¼ï¼ˆé­”æ•°ã€ç‰ˆæœ¬å·ã€å¸¸é‡æ± ã€è®¿é—®æ ‡è¯†ç¬¦ã€å½“å‰ç±»ç´¢å¼•ã€çˆ¶ç±»ç´¢å¼•ã€æ¥å£ç´¢å¼•ã€å­—æ®µè¡¨ã€æ–¹æ³•è¡¨ã€é™„åŠ å±æ€§ï¼‰ï¼Œä¸€ç‚¹ä¸€ç‚¹è¿½åŠ å†…å®¹ã€‚</p>
</div>
<div class="paragraph">
<p>ç”Ÿæˆå‡ºæ¥çš„ç±»ï¼Œç»§æ‰¿äº† <code>java.lang.reflect.Proxy</code>ï¼ŒåŒæ—¶å®ç°äº†å‚æ•°ä¸­ä¼ é€’çš„æ¥å£ã€‚åœ¨ç”Ÿæˆçš„ç±»ä¸­ï¼Œ</p>
</div>
<div class="ulist">
<ul>
<li>
<p>åŒ…å«ä¸€ä¸ªå‚æ•°ä¸º <code>InvocationHandler</code> çš„æ„é€ å‡½æ•°ï¼Œç”¨äºä¿å­˜ä»£ç†ä¸šåŠ¡çš„å®ç°ï¼›</p>
</li>
<li>
<p>æ¯ä¸€ä¸ªæ–¹æ³•éƒ½ç”¨ä¸€ä¸ªé™æ€ <code>Method</code> æ¥è¡¨ç¤ºï¼›</p>
</li>
<li>
<p>é™¤äº†æ¥å£ä¸­çš„æ–¹æ³•ï¼Œè¿˜ä¼šç”Ÿæˆ <code>boolean equals(Object obj)</code>ï¼Œ<code>int hashCode()</code> å’Œ <code>String toString()</code> ä¸‰ä¸ªæ–¹æ³•ã€‚</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>è°ƒç”¨æ—¶ï¼Œé€šè¿‡ <code>InvocationHandler</code> å¯¹è±¡çš„ <code>Object invoke(Object proxy, Method method, Object[] args)</code> æ–¹æ³•æ¥è°ƒèµ·ä»£ç†å’Œç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ã€‚å…¶ä¸­ï¼Œè¿™é‡Œçš„ <code>Object proxy</code> å°±æ˜¯ç”Ÿæˆçš„ç±»æœ¬èº«çš„å¯¹è±¡ï¼›<code>Method method</code> å°±æ˜¯ä¸Šè¿°ç”Ÿæˆçš„é™æ€ <code>Method</code> å¯¹è±¡ï¼›<code>Object[] args</code> å°±æ˜¯å®é™…è°ƒç”¨çš„å‚æ•°ã€‚</p>
</div>
<div class="listingblock">
<div class="title">åç¼–è¯‘çš„ç¤ºä¾‹ç±»</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.sun.proxy</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.diguage.proxy.UserService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Proxy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.UndeclaredThrowableException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="err">$</span><span class="nc">Proxy0</span> <span class="kd">extends</span> <span class="nc">Proxy</span> <span class="kd">implements</span> <span class="nc">UserService</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Method</span> <span class="n">m0</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Method</span> <span class="n">m1</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Method</span> <span class="n">m2</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Method</span> <span class="n">m3</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">$Proxy0</span><span class="o">(</span><span class="nc">InvocationHandler</span> <span class="n">var1</span><span class="o">)</span> <span class="kd">throws</span>  <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">var1</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="kd">throws</span>  <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">(</span><span class="nc">Integer</span><span class="o">)</span><span class="kd">super</span><span class="o">.</span><span class="na">h</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">m0</span><span class="o">,</span> <span class="o">(</span><span class="nc">Object</span><span class="o">[])</span><span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RuntimeException</span> <span class="o">|</span> <span class="nc">Error</span> <span class="n">var2</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">var2</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">var3</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">UndeclaredThrowableException</span><span class="o">(</span><span class="n">var3</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="nc">Object</span> <span class="n">var1</span><span class="o">)</span> <span class="kd">throws</span>  <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">(</span><span class="nc">Boolean</span><span class="o">)</span><span class="kd">super</span><span class="o">.</span><span class="na">h</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">m1</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[]{</span><span class="n">var1</span><span class="o">});</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RuntimeException</span> <span class="o">|</span> <span class="nc">Error</span> <span class="n">var3</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">var3</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">var4</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">UndeclaredThrowableException</span><span class="o">(</span><span class="n">var4</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="kd">throws</span>  <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span><span class="kd">super</span><span class="o">.</span><span class="na">h</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">m2</span><span class="o">,</span> <span class="o">(</span><span class="nc">Object</span><span class="o">[])</span><span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RuntimeException</span> <span class="o">|</span> <span class="nc">Error</span> <span class="n">var2</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">var2</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">var3</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">UndeclaredThrowableException</span><span class="o">(</span><span class="n">var3</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="nf">getById</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">var1</span><span class="o">)</span> <span class="kd">throws</span>  <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span><span class="kd">super</span><span class="o">.</span><span class="na">h</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">m3</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[]{</span><span class="n">var1</span><span class="o">});</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RuntimeException</span> <span class="o">|</span> <span class="nc">Error</span> <span class="n">var3</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">var3</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">var4</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">UndeclaredThrowableException</span><span class="o">(</span><span class="n">var4</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">m0</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"java.lang.Object"</span><span class="o">).</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"hashCode"</span><span class="o">);</span><i class="conum" data-value="1"></i><b>(1)</b>
            <span class="n">m1</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"java.lang.Object"</span><span class="o">).</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"equals"</span><span class="o">,</span>
                     <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"java.lang.Object"</span><span class="o">));</span>
            <span class="n">m2</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"java.lang.Object"</span><span class="o">).</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"toString"</span><span class="o">);</span>
            <span class="n">m3</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"com.diguage.proxy.UserService"</span><span class="o">)</span>
                     <span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"getById"</span><span class="o">,</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"java.lang.Integer"</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">NoSuchMethodException</span> <span class="n">var2</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchMethodError</span><span class="o">(</span><span class="n">var2</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ClassNotFoundException</span> <span class="n">var3</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoClassDefFoundError</span><span class="o">(</span><span class="n">var3</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>ä¸ºäº†æ’ç‰ˆï¼Œåšäº†å°è°ƒæ•´ã€‚</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>è¿˜æœ‰ä¸¤ç‚¹å€¼å¾—æ³¨æ„ï¼š</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>è¿è¡Œä»£ç†æ—¶ï¼Œå¦‚æœæƒ³è¦ä¿å­˜ç”Ÿæˆçš„ä»£ç†ç±»å­—èŠ‚ç ï¼Œéœ€è¦ç³»ç»Ÿå±æ€§ <code>jdk.proxy.ProxyGenerator.saveGeneratedFiles</code> è®¾ç½®ä¸º <code>true</code>ã€‚è¿™ä¸ªå±æ€§è¢«è§£æåèµ‹å€¼ç»™äº† <code>java.lang.reflect.ProxyGenerator.saveGeneratedFiles</code> å­—æ®µï¼Œè¿™ä¸ªå­—æ®µæ˜¯ <code>final</code> çš„ã€‚æ‰€ä»¥ï¼Œéœ€è¦åœ¨è¿è¡Œä»£ç ä¹‹åˆå°±è¦è®¾ç½®è¿™ä¸ªå±æ€§ã€‚æ‰€ä»¥ï¼Œæœ€å¥½ä½¿ç”¨ <code>main</code> æ–¹æ³•æ¥è¿è¡Œæµ‹è¯•ã€‚å¦åˆ™ï¼Œæœ‰å¯èƒ½è®¾ç½®å¤±æ•ˆã€‚</p>
</li>
<li>
<p>å¦‚æœä»£ç æ˜¯åœ¨ Maven é¡¹ç›®ä¸­è¿è¡Œï¼Œå¦‚æœæ¥å£éƒ½æ˜¯ <code>public</code> ä¿®é¥°ï¼Œç”Ÿæˆçš„ç±»ä¼šè¢«ä¿å­˜åœ¨ <code>${project.basedir}/com/sun/proxy/</code> ç›®å½•ä¸‹ï¼›å¦‚æœæœ‰æ¥å£æ˜¯åŒ…ç§æœ‰çš„ï¼Œåˆ™ç”Ÿæˆçš„ç±»ä¸ºæ¥å£æ‰€åœ¨çš„åŒ…ã€‚å¦‚æœç›®å½•ä¸å­˜åœ¨ï¼Œåˆ™ä¼šè‡ªåŠ¨åˆ›å»ºã€‚</p>
</li>
<li>
<p>æœ€å¤šå¯ä»¥æœ‰ <code>65535</code> ä¸ªæ¥å£ï¼›æœ‰ä¸¤ä¸ªè§£é‡Šï¼š</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>ä»£ç ä¸­æœ‰æ˜ç¡®é™åˆ¶ï¼šåœ¨ <code>java.lang.reflect.Proxy.ProxyBuilder.ProxyBuilder(java.lang.ClassLoader, java.util.List&lt;java.lang.Class&lt;?&gt;&gt;)</code> ä¸­æœ‰ <code>interfaces.size() &gt; 65535</code> çš„åˆ¤æ–­è¯­å¥ã€‚</p>
</li>
<li>
<p>å­—èŠ‚ç ä¸­ï¼Œå¯¹äºæ¥å£æ•°é‡æ˜¯ç”¨ä¸€ä¸ª <code>u2</code> å˜é‡è¡¨ç¤ºçš„ï¼Œè¯¥å˜é‡çš„æœ€å¤§å€¼æ˜¯ <code>2<sup>16</sup> - 1 = 65535</code>ã€‚</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>æ³¨è§£åº•å±‚ä¹Ÿæ˜¯åŸºäºåŠ¨æ€ä»£ç†å®ç°çš„ã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.reflect</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.annotation.Documented</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.ElementType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.RetentionPolicy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-04-08 23:34
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProxyAnnoTest</span> <span class="o">{</span>
    <span class="nd">@Diguage</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">AnnoTest</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="nd">@Diguage</span><span class="o">(</span><span class="s">"https://github.com/diguage"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">AnnoTest2</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
    <span class="nd">@Documented</span>
    <span class="nd">@Target</span><span class="o">(</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">)</span>
    <span class="kd">static</span> <span class="nd">@interface</span> <span class="nc">Diguage</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="nf">value</span><span class="o">()</span> <span class="k">default</span> <span class="s">"https://www.diguage.com"</span><span class="o">;</span>

        <span class="nc">String</span> <span class="nf">name</span><span class="o">()</span> <span class="k">default</span> <span class="s">"Dç“œå“¥"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">getProperties</span><span class="o">()</span>
                <span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"jdk.proxy.ProxyGenerator.saveGeneratedFiles"</span><span class="o">,</span> <span class="s">"true"</span><span class="o">);</span>

        <span class="nc">Class</span><span class="o">&lt;</span><span class="nc">AnnoTest</span><span class="o">&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="nc">AnnoTest</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
        <span class="nc">Diguage</span> <span class="n">annotation</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="nc">Diguage</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">annotation</span> <span class="o">+</span> <span class="s">" : "</span> <span class="o">+</span> <span class="n">annotation</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Name: "</span> <span class="o">+</span> <span class="n">annotation</span><span class="o">.</span><span class="na">name</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Value: "</span> <span class="o">+</span> <span class="n">annotation</span><span class="o">.</span><span class="na">value</span><span class="o">());</span>

        <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Diguage</span><span class="o">&gt;</span> <span class="n">annoClass</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>


        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\n----Class----"</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">className</span> <span class="o">=</span> <span class="n">annoClass</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\n----SuperClass----"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">annoClass</span><span class="o">.</span><span class="na">getSuperclass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\n----Interfaces----"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">annoClass</span><span class="o">.</span><span class="na">getInterfaces</span><span class="o">()));</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\n----Methods----"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">annoClass</span><span class="o">.</span><span class="na">getDeclaredMethods</span><span class="o">())</span>
                <span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">", p"</span><span class="o">,</span> <span class="s">",\n p"</span><span class="o">));</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\n\n=============="</span><span class="o">);</span>
        <span class="nc">Diguage</span> <span class="n">anno2</span> <span class="o">=</span> <span class="nc">AnnoTest2</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="nc">Diguage</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">anno2</span> <span class="o">+</span> <span class="s">" : "</span> <span class="o">+</span> <span class="n">anno2</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>æ¯ä¸ªæ³¨è§£éƒ½æ˜¯ä¸€ä¸ªæ¥å£å£°æ˜ï¼Œç„¶ååŸºäºè¿™ä¸ªæ¥å£ä½¿ç”¨åŠ¨æ€ä»£ç†ç”Ÿæˆä¸€ä¸ªä»£ç†ç±»ã€‚è€Œè¢«æ ‡æ³¨çš„æ³¨è§£ï¼Œå°±æ˜¯ä¸€ä¸ªä»£ç†ç±»çš„å®ä¾‹å¯¹è±¡ã€‚</p>
</div>
<div class="paragraph">
<p>ä»£ç†ç±»ä¸­çš„ <code>InvocationHandler</code> åˆ™æ˜¯ <code>AnnotationInvocationHandler</code> å®ä¾‹ï¼Œå®ä¾‹å˜é‡ <code>Map&lt;String, Object&gt; memberValues</code> ä¿å­˜ç€æ³¨è§£ä¸­æˆå‘˜å±æ€§çš„åç§°å’Œå€¼çš„æ˜ å°„ï¼Œæ³¨è§£æˆå‘˜å±æ€§çš„åç§°å®é™…ä¸Šå°±å¯¹åº”ç€æ¥å£ä¸­æŠ½è±¡æ–¹æ³•çš„åç§°ã€‚</p>
</div>
<div class="paragraph">
<p>æ€»ç»“</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ç”¨åå°„ + å­—èŠ‚ç ç”ŸæˆæŠ€æœ¯æ¥ç”Ÿæˆå­—èŠ‚ç ï¼Œç„¶ååŠ è½½å‡ºæ¥ä»£ç†å¯¹è±¡ã€‚</p>
</li>
<li>
<p>ä»javaçš„è§’åº¦æ¥çœ‹è¿™æœ¬è¯­è¨€,å°±æ˜¯ä¸€ä¸ªåŠ¨æ€æ€§è¯­è¨€,ä¸€åˆ‡çš„åŠ¨æ€æ€§æ¥æºäºç±»çš„åŠ è½½æ–¹å¼,
åœ¨ç¨‹åºè¿è¡ŒæœŸé—´,å¯ä»¥å¾ˆå¤§ç¨‹åº¦ä¸Šä¿®æ”¹class</p>
</li>
<li>
<p><code>newProxyInstance(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler h)</code> å®é™…ä¸Šä»ç”Ÿæˆçš„ Class æ–‡ä»¶å’Œè¿™ä¸ªä¼ é€’å‚æ•°æ¥çœ‹ jdk Proxy ä»…ä»…å¯¹äºæ¥å£è¿›è¡Œä»£ç†, å³ç”Ÿæˆå®ç°äº†æ¥å£çš„ä¸´æ—¶ç±»å¯¹è±¡.</p>
</li>
<li>
<p>ç”±äºç”Ÿæˆçš„ç±»ï¼Œç»§æ‰¿äº† <code>java.lang.reflect.Proxy</code> ç±»ï¼Œè€Œ Java æ˜¯å•ç»§æ‰¿çš„ã€‚æ‰€ä»¥ï¼ŒåŠ¨æ€ä»£ç†åªèƒ½ä»£ç†ç”Ÿæˆæ¥å£ï¼Œä¸èƒ½ä»£ç†ç±»ã€‚</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>æ—¢ç„¶éƒ½ç”Ÿæˆä»£ç†ç±»äº†ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥ç»§æ‰¿ä»£ç†ç±»å‘¢ï¼Ÿè¿™æ ·å°±å¯ä»¥å¯¹ä»£ç†ç±»æ‰€æœ‰çš„æ–¹æ³•è¿›è¡Œå¢å¼ºäº†ã€‚</p>
</div>
<div class="sect2">
<h3 id="_æ€è€ƒé¢˜_2"><a class="anchor" href="#_æ€è€ƒé¢˜_2"></a>71.1. æ€è€ƒé¢˜</h3>
<div class="paragraph">
<p>å¦‚ä½•è‡ªå·±å†™ä»£ç æ¥å®ç°ä»£ç ç”Ÿæˆã€åŠ è½½ç±»çš„åŠ¨æ€ä»£ç†ï¼Ÿ</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>å¦‚ä½•ç”Ÿæˆä»£ç†ç±»ï¼Ÿ-- å¯ä»¥è€ƒè™‘ç›´æ¥ç”Ÿæˆ Java ä»£ç ï¼Œç„¶åè°ƒç”¨ <code>JavaCompiler compiler = ToolProvider.getSystemJavaCompiler();</code> è·å–ç¼–è¯‘å™¨æ¥ç¼–è¯‘ Java ä»£ç ã€‚</p>
</li>
<li>
<p>å¦‚ä½•åŠ è½½ç±»ï¼Ÿ-- å¯ä»¥ä½¿ç”¨ <code>java.net.URLClassLoader</code> æ¥åŠ è½½å­—èŠ‚ç æ–‡ä»¶ã€‚</p>
</li>
<li>
<p>å¦‚ä½•æŠ½è±¡ä»£ç†åŠ¨ä½œï¼Ÿ</p>
</li>
<li>
<p>å¦‚ä½•åœ¨æ–¹æ³•å†…è·å–å‚æ•°åˆ—è¡¨ï¼Ÿ</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_cglib"><a class="anchor" href="#_cglib"></a>71.2. CGLIB</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>é€šè¿‡ç”Ÿæˆå­ç±»çš„æ–¹å¼æ¥äº§ç”Ÿä»£ç†ï¼ŒæŸäº›æƒ…å†µæ¯”åŠ¨æ€ä»£ç†è¿è¡Œé€Ÿåº¦è¦å¿«ä¸€äº›ã€‚</p>
</li>
<li>
<p>ä¸èƒ½ä»£ç† <code>final</code> ä¿®é¥°çš„ç±»ã€‚</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_å‚è€ƒèµ„æ–™_22"><a class="anchor" href="#_å‚è€ƒèµ„æ–™_22"></a>71.3. å‚è€ƒèµ„æ–™</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://www.cnblogs.com/gonjan-blog/p/6685611.html">javaåŠ¨æ€ä»£ç†å®ç°ä¸åŸç†è¯¦ç»†åˆ†æ - Gonjian - åšå®¢å›­</a></p>
</li>
<li>
<p><a href="https://www.fancylight.top/2019/05/22/java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/#%E4%BB%A3%E7%90%86%E7%B1%BB%E6%96%87%E4%BB%B6">javaåŠ¨æ€ä»£ç† | åšå®¢</a></p>
</li>
<li>
<p><a href="https://tech.meituan.com/2019/09/05/java-bytecode-enhancement.html">å­—èŠ‚ç å¢å¼ºæŠ€æœ¯æ¢ç´¢ - ç¾å›¢æŠ€æœ¯å›¢é˜Ÿ</a></p>
</li>
<li>
<p><a href="https://www.geeksforgeeks.org/get-name-of-current-method-being-executed-in-java/">Get name of current method being executed in Java - GeeksforGeeks</a></p>
</li>
<li>
<p><a href="http://www.throwable.club/2018/12/08/java-reflection-dynamic-proxy/">æ·±å…¥åˆ†æJavaåå°„(å››)-åŠ¨æ€ä»£ç† - Throwable&#8217;s Blog</a></p>
</li>
<li>
<p><a href="http://www.throwable.club/2018/12/16/cglib-dynamic-proxy-analyze/">CGLIBåŠ¨æ€ä»£ç†åŸç†åˆ†æ - Throwable&#8217;s Blog</a></p>
</li>
<li>
<p><a href="http://www.throwable.club/2020/03/16/annotation-implementation/">JDKä¸­æ³¨è§£çš„åº•å±‚å®ç° - Throwable&#8217;s Blog</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_serversocket"><a class="anchor" href="#_serversocket"></a>72. ServerSocket</h2>
<div class="sectionbody">
<div class="paragraph">
<p>åœ¨çº ç»“äº† N ä¹…ä¹‹åï¼Œç»ˆäºåŠ¨æ‰‹å†™ç¨‹åºå®Œæˆäº† Socket å…¨åŒå·¥å®éªŒã€‚å®éªŒè¯å®ï¼ŒSocket åœ¨æ¥å—çš„åŒæ—¶ï¼Œè¿˜å¯ä»¥å‘é€æŠ¥æ–‡ã€‚</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/simplex-half-duplex-full-duplex.jpg" alt="simplex half duplex full duplex">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.net</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.ServerSocket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.Socket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.charset.StandardCharsets</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.LockSupport</span><span class="o">;</span>

<span class="cm">/**
 * Socket å…¨åŒå·¥æ¼”ç¤ºç¤ºä¾‹
 *
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-03-25 23:03
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SocketFullDuplexTest</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">11233</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testServer</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">ServerSocket</span> <span class="n">serverSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerSocket</span><span class="o">(</span><span class="n">port</span><span class="o">);</span>
        <span class="nc">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">serverSocket</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
        <span class="nc">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>

        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">InputStreamReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">BufferedInputStream</span><span class="o">(</span><span class="n">inputStream</span><span class="o">));</span>
            <span class="nc">BufferedReader</span> <span class="n">bufferedReader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="n">reader</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">line</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">while</span> <span class="o">((</span><span class="n">line</span> <span class="o">=</span> <span class="n">bufferedReader</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">line</span><span class="o">);</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>

        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>

        <span class="nc">OutputStream</span> <span class="n">outputStream</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">"S-"</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">;</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"msg = "</span> <span class="o">+</span> <span class="n">msg</span><span class="o">);</span>
                    <span class="n">outputStream</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
                    <span class="n">outputStream</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>

        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>

        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testClient</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Socket</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>

        <span class="nc">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">InputStreamReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">BufferedInputStream</span><span class="o">(</span><span class="n">inputStream</span><span class="o">));</span>
            <span class="nc">BufferedReader</span> <span class="n">bufferedReader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="n">reader</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">line</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">while</span> <span class="o">((</span><span class="n">line</span> <span class="o">=</span> <span class="n">bufferedReader</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">line</span><span class="o">);</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>

        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>

        <span class="nc">OutputStream</span> <span class="n">outputStream</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">"C-"</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">;</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"msg = "</span> <span class="o">+</span> <span class="n">msg</span><span class="o">);</span>
                    <span class="n">outputStream</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
                    <span class="n">outputStream</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>

        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>

        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_å‚è€ƒèµ„æ–™_23"><a class="anchor" href="#_å‚è€ƒèµ„æ–™_23"></a>72.1. å‚è€ƒèµ„æ–™</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://hafizahabdullah.blogspot.com/2013/08/fp303-cn-simplex-half-duplex-and-full.html">P2E for Students: FP303 CN: Simplex, Half-Duplex and Full-Duplex</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_serviceloader"><a class="anchor" href="#_serviceloader"></a>73. <code>ServiceLoader</code></h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-04-08 10:47
 */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ServiceLoaderSay</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">say</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-04-08 10:48
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServiceLoaderSayHello</span> <span class="kd">implements</span> <span class="nc">ServiceLoaderSay</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">say</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Hello, https://www.diguage.com/"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-04-08 10:48
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServiceLoaderSayGoodbye</span> <span class="kd">implements</span> <span class="nc">ServiceLoaderSay</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">say</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Goodbye, https://www.diguage.com/"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Iterator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ServiceLoader</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-04-08 10:40
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServiceLoaderTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">ServiceLoader</span><span class="o">&lt;</span><span class="nc">ServiceLoaderSay</span><span class="o">&gt;</span> <span class="n">loader</span>
                <span class="o">=</span> <span class="nc">ServiceLoader</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="nc">ServiceLoaderSay</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">ServiceLoaderSay</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">iterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">ServiceLoaderSay</span> <span class="n">say</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="n">say</span><span class="o">.</span><span class="na">say</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ç»è¿‡æµ‹è¯•ï¼Œæœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>åªæ”¯æŒ <code>public</code> çš„ç±»ã€‚Dç“œå“¥æµ‹è¯•ï¼Œè¿™æ˜¯å› ä¸ºå†…éƒ¨éœ€è¦åˆ›å»ºå¯¹è±¡ï¼Œå…¶ä»–è®¿é—®æ§åˆ¶ä¸èƒ½åœ¨ <code>ServiceLoader</code> ç±»ä¸­åˆ›å»ºå¯¹è±¡ã€‚</p>
</li>
<li>
<p>ä¸æ”¯æŒ <code>Outter.Inner</code> è¿™æ ·çš„å†…éƒ¨ç±» ï¼Œå³ä½¿æ˜¯ <code>public static class</code>ã€‚</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_å‚è€ƒèµ„æ–™_24"><a class="anchor" href="#_å‚è€ƒèµ„æ–™_24"></a>73.1. å‚è€ƒèµ„æ–™</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://www.throwable.club/2018/11/30/java-service-loader/">æµ…æJDKä¸­ServiceLoaderçš„æºç  - Throwable&#8217;s Blog</a>&#8201;&#8212;&#8201;è¿™é‡Œçš„ä»£ç æ˜¯åŸºäº JDK 8 çš„ï¼Œå’Œ JDK 11 çš„ä»£ç å·²ç»ç›¸å·®å¾ˆå¤§ã€‚</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_netty"><a class="anchor" href="#_netty"></a>74. Netty</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Netty å’Œ <code>ServerSocketChannel</code> å¯ä»¥äº’ç›¸æ“ä½œå—ï¼Ÿ</p>
</div>
<div class="sect2">
<h3 id="_jdk_åŸç”Ÿ_socket_ç¼–ç¨‹"><a class="anchor" href="#_jdk_åŸç”Ÿ_socket_ç¼–ç¨‹"></a>74.1. JDK åŸç”Ÿ Socket ç¼–ç¨‹</h3>
<div class="paragraph">
<p>ä½¿ç”¨ JDK åŸç”Ÿçš„ Socket API è¿›è¡Œç½‘ç»œç¼–ç¨‹ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.ServerSocket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.Socket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.LockSupport</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">charset</span><span class="o">.</span><span class="na">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-04-21 14:31
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServerSocketTest</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">HOST</span> <span class="o">=</span> <span class="s">"127.0.0.1"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">PORT</span> <span class="o">=</span> <span class="mi">11911</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testServer</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Server</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Server</span><span class="o">(</span><span class="no">PORT</span><span class="o">);</span>
        <span class="n">server</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testClient</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Socket</span><span class="o">(</span><span class="no">HOST</span><span class="o">,</span> <span class="no">PORT</span><span class="o">);</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å®¢æˆ·ç«¯å¯åŠ¨æˆåŠŸ"</span><span class="o">);</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">String</span> <span class="n">message</span> <span class="o">=</span> <span class="s">"Hello, Dç“œå“¥ï¼"</span><span class="o">;</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å®¢æˆ·ç«¯å‘é€æ•°æ®ï¼š"</span> <span class="o">+</span> <span class="n">message</span><span class="o">);</span>
                    <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="no">UTF_8</span><span class="o">));</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å†™å…¥æ•°æ®æŠ¥é”™ï¼"</span><span class="o">);</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="n">sleep</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">sleep</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Server</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">ServerSocket</span> <span class="n">serverSocket</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Server</span><span class="o">(</span><span class="kt">int</span> <span class="n">port</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">serverSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerSocket</span><span class="o">(</span><span class="n">port</span><span class="o">);</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æœåŠ¡ç«¯å¯åŠ¨æˆåŠŸï¼Œç«¯å£å·ï¼š"</span> <span class="o">+</span> <span class="n">port</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æœåŠ¡ç«¯å¯åŠ¨å¤±è´¥"</span><span class="o">);</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">doStart</span><span class="o">()).</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">doStart</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">serverSocket</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
                    <span class="k">new</span> <span class="nf">ClientHandler</span><span class="o">(</span><span class="n">socket</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æœåŠ¡ç«¯å¼‚å¸¸"</span><span class="o">);</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ClientHandler</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">MAX_DATA_LEN</span> <span class="o">=</span> <span class="mi">1024</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Socket</span> <span class="n">socket</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">ClientHandler</span><span class="o">(</span><span class="nc">Socket</span> <span class="n">socket</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ–°å®¢æˆ·ç«¯æ¥å…¥"</span><span class="o">);</span>
            <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">doStart</span><span class="o">()).</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">doStart</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
                <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                    <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="no">MAX_DATA_LEN</span><span class="o">];</span>
                    <span class="kt">int</span> <span class="n">len</span><span class="o">;</span>
                    <span class="k">while</span> <span class="o">((</span><span class="n">len</span> <span class="o">=</span> <span class="n">inputStream</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">data</span><span class="o">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                        <span class="nc">String</span> <span class="n">message</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">len</span><span class="o">);</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å®¢æˆ·ç«¯ä¼ æ¥æ¶ˆæ¯ï¼š"</span> <span class="o">+</span> <span class="n">message</span><span class="o">);</span>
                        <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æœåŠ¡ç«¯è¯»å–é”™è¯¯å¤±è´¥"</span><span class="o">);</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>é˜»å¡</p>
</li>
<li>
<p>é«˜æ€§èƒ½</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_server_startup"><a class="anchor" href="#_server_startup"></a>74.2. Server startup</h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.Bootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.bootstrap.ServerBootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.buffer.Unpooled</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.Channel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInboundHandlerAdapter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelOption</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.EventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.SimpleChannelInboundHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioServerSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.util.AttributeKey</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.net.InetSocketAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.charset.StandardCharsets</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.time.LocalDateTime</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.LockSupport</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-04-20 22:19
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test03</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">PORT</span> <span class="o">=</span> <span class="mi">11911</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testServer</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">EventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="nc">EventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">ServerBootstrap</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">();</span>
            <span class="n">b</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">childOption</span><span class="o">(</span><span class="nc">ChannelOption</span><span class="o">.</span><span class="na">TCP_NODELAY</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">childAttr</span><span class="o">(</span><span class="nc">AttributeKey</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="s">"childAttr"</span><span class="o">),</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ServerHandler</span><span class="o">())</span>
                    <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;&gt;()</span> <span class="o">{</span>
                        <span class="nd">@Override</span>
                        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">Channel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

                        <span class="o">}</span>
                    <span class="o">});</span>
            <span class="nc">ChannelFuture</span> <span class="n">f</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="no">PORT</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
            <span class="n">f</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="n">future</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">future</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">()</span> <span class="o">+</span> <span class="s">": ç«¯å£["</span> <span class="o">+</span> <span class="no">PORT</span> <span class="o">+</span> <span class="s">"]ç»‘å®šæˆåŠŸï¼"</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">()</span> <span class="o">+</span> <span class="s">": ç«¯å£["</span> <span class="o">+</span> <span class="no">PORT</span> <span class="o">+</span> <span class="s">"]ç»‘å®šå¤±è´¥ï¼"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="n">f</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">bossGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
            <span class="n">workerGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ServerHandler</span> <span class="kd">extends</span> <span class="nc">ChannelInboundHandlerAdapter</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRegistered</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"channelRegistered"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"channelActive"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handlerAdded</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"handlerAdded"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
<span class="c1">//            ((ByteBuf) msg).release();</span>
<span class="c1">//            ReferenceCountUtil.release(msg);</span>
            <span class="n">ctx</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
            <span class="n">ctx</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="n">cause</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="n">ctx</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testClient</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">NioEventLoopGroup</span> <span class="n">executors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">();</span>
            <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">executors</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">remoteAddress</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="no">PORT</span><span class="o">))</span>
                    <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
                        <span class="nd">@Override</span>
                        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ClientHandler</span><span class="o">());</span>
                        <span class="o">}</span>
                    <span class="o">});</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">executors</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ClientHandler</span> <span class="kd">extends</span> <span class="nc">ChannelInboundHandlerAdapter</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handlerAdded</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Handl"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ä¸¤ä¸ªé—®é¢˜</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>æœåŠ¡ç«¯çš„ Socket åœ¨å“ªé‡Œåˆå§‹åŒ–ï¼Ÿ</p>
</li>
<li>
<p>åœ¨å“ªé‡Œ accept è¿æ¥ï¼Ÿ</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Netty æœåŠ¡ç«¯å¯åŠ¨</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>åˆ›å»ºæœåŠ¡ç«¯ <code>Channel</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>io.netty.bootstrap.AbstractBootstrap.bind(int)</code></p>
</li>
<li>
<p><code>io.netty.bootstrap.AbstractBootstrap.doBind(SocketAddress)</code></p>
</li>
<li>
<p><code>io.netty.bootstrap.AbstractBootstrap.initAndRegister()</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>åˆå§‹åŒ–æœåŠ¡ç«¯ <code>Channel</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>NioServerSocketChannel.NioServerSocketChannel()</code> åœ¨ <code>NioServerSocketChannel</code> é»˜è®¤åˆå§‹åŒ–å‡½æ•°ä¸­ï¼Œä½¿ç”¨äº† JDK å†…ç½®çš„ <code>SelectorProvider.provider()</code> æ–¹æ³•è¿”å›çš„ <code>SelectorProvider</code> å¯¹è±¡ã€‚</p>
</li>
<li>
<p>åœ¨ <code>NioServerSocketChannel.newSocket(SelectorProvider)</code> æ–¹æ³•ä¸­ï¼Œè°ƒç”¨ <code>provider.openServerSocketChannel()</code> æ¥åˆ›å»º <code>ServerSocketChannel</code> å¯¹è±¡ã€‚</p>
</li>
<li>
<p>åœ¨ <code>AbstractNioChannel.AbstractNioChannel(Channel, SelectableChannel, int)</code> æ„é€ å‡½æ•°ä¸­ï¼Œè®¾ç½® <code>selectableChannel.configureBlocking(false)</code>ã€‚</p>
</li>
</ol>
</div>
</li>
<li>
<p>æ³¨å†Œ Selector</p>
</li>
<li>
<p>ç«¯å£ç»‘å®š&#8201;&#8212;&#8201;è°ƒç”¨åº•å±‚ APIï¼Œå®ç°å¯¹ç«¯å£çš„ç»‘å®šã€‚</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>æœåŠ¡ç«¯ <code>Channel</code> åˆå§‹åŒ–è¿‡ç¨‹</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>é€šè¿‡ <code>bind()</code> è¿›å…¥</p>
</li>
<li>
<p><code>initAndRegister()</code></p>
</li>
<li>
<p>åœ¨ <code>AbstractBootstrap.initAndRegister()</code> ä¸­é€šè¿‡ <code>channelFactory.newChannel()</code> åˆ©ç”¨åå°„æœºåˆ¶æ¥åˆ›å»º <code>Channel</code>ã€‚</p>
</li>
<li>
<p>åœ¨ <code>ServerBootstrap.init(Channel)</code> ä¸­ï¼Œåˆå§‹åŒ– <code>Channel</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>setChannelOptions</code></p>
</li>
<li>
<p><code>setAttributes</code></p>
</li>
<li>
<p>é…ç½® <code>ChannelHandler</code>&#8201;&#8212;&#8201;é…ç½®æœåŠ¡ç«¯ pipelineã€‚</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>åˆå§‹åŒ–æ—¶ï¼Œè°ƒç”¨ <code>AbstractBootstrap.handler(io.netty.channel.ChannelHandler)</code>ï¼Œé…ç½® <code>ChannelHandler</code> å¯¹è±¡</p>
</li>
<li>
<p>é€šè¿‡è°ƒç”¨ <code>AbstractBootstrap.initAndRegister()</code> æ–¹æ³•è°ƒç”¨ <code>ServerBootstrap.init(Channel)</code> æ–¹æ³•ï¼Œåœ¨å…¶ä¸­ï¼Œå°† <code>ChannelHandler</code> å¯¹è±¡è¿½åŠ åˆ° <code>Channel</code> å¯¹è±¡çš„ pipeline çš„æœ€åé¢ã€‚</p>
</li>
</ol>
</div>
</li>
<li>
<p>add <code>ServerBootstrapAcceptor</code></p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>ä¸Šä¸€æ­¥æ‰§è¡Œå®Œæ¯•åï¼Œåœ¨ <code>ServerBootstrap.init(Channel)</code> æ–¹æ³•ä¸­ï¼Œä¼šåˆ›å»ºä¸€ä¸ª <code>ServerBootstrapAcceptor</code> å¯¹è±¡æ·»åŠ åˆ° pipeline åé¢ã€‚</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>æ³¨å†Œ selector</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>AbstractChannel.AbstractUnsafe.register(EventLoop, ChannelPromise)</code> å…¥å£</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>AbstractChannel.this.eventLoop = eventLoop;</code> ç»‘å®šçº¿ç¨‹</p>
</li>
<li>
<p><code>AbstractChannel.AbstractUnsafe.register0(ChannelPromise)</code> å®é™…æ³¨å†Œ</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p><code>AbstractChannel.doRegister()</code> è°ƒç”¨åº•å±‚ JDK API æ³¨å†Œ</p>
</li>
<li>
<p><code>pipeline.invokeHandlerAddedIfNeeded()</code></p>
</li>
<li>
<p><code>pipeline.fireChannelRegistered()</code></p>
<div class="paragraph">
<p>ä»ç¤ºä¾‹ä»£ç çš„è¾“å‡ºå¯ä»¥çœ‹å‡ºï¼Œ<code>Test03.ServerHandler</code> ä¸­ä¸‰ä¸ª"äº‹ä»¶"æ–¹æ³•è¢«è°ƒç”¨çš„é¡ºåºæ˜¯ï¼š <code>handlerAdded</code>ï¼Œ<code>channelRegistered</code> å’Œ <code>channelActive</code>ã€‚</p>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>ç«¯å£ç»‘å®š</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>AbstractChannel.AbstractUnsafe.bind(SocketAddress, ChannelPromise)</code> å…¥å£</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>AbstractBootstrap.doBind(SocketAddress)</code></p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p><code>javaChannel().bind()</code> JDK åº•å±‚ç»‘å®š <code>io.netty.channel.AbstractChannel.AbstractUnsafe.bind</code></p>
<div class="olist upperalpha">
<ol class="upperalpha" type="A">
<li>
<p>` pipeline.fireChannelActive()` ä¼ æ’­äº‹ä»¶</p>
</li>
</ol>
</div>
</li>
<li>
<p><code>HeadContext.readIfIsAutoRead()</code></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_nioeventloop"><a class="anchor" href="#_nioeventloop"></a>74.3. <code>NioEventLoop</code></h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒNetty æœåŠ¡ç«¯èµ·å¤šå°‘ä¸ªçº¿ç¨‹ï¼Ÿä½•æ—¶å¯åŠ¨ï¼Ÿ</p>
</li>
<li>
<p>Netty æ˜¯å¦‚ä½•è§£å†³ JDK ç©ºè½®è¯¢ Bug çš„ï¼Ÿ</p>
</li>
<li>
<p>Netty å¦‚ä½•ä¿è¯å¼‚æ­¥ä¸²è¡Œæ— é”åŒ–ï¼Ÿ</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>NioEventLoop</code> åˆ›å»º</p>
</li>
<li>
<p><code>NioEventLoop</code> å¯åŠ¨</p>
</li>
<li>
<p><code>NioEventLoop</code> æ‰§è¡Œé€»è¾‘</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_nioeventloop_åˆ›å»º"><a class="anchor" href="#_nioeventloop_åˆ›å»º"></a>74.3.1. <code>NioEventLoop</code> åˆ›å»º</h4>
<div class="paragraph">
<p><code>NioEventLoop</code> é»˜è®¤æ˜¯åœ¨è°ƒç”¨ <code>NioEventLoopGroup()</code> æ—¶è¢«åˆ›å»ºï¼Œé»˜è®¤æ˜¯ 2 å€çš„ CPU æ•°é‡ï¼ˆç”±å¸¸é‡ <code>MultithreadEventLoopGroup.DEFAULT_EVENT_LOOP_THREADS</code> æ¥å®šä¹‰ï¼‰ã€‚</p>
</div>
<div class="paragraph">
<p>åœ¨ <code>MultithreadEventExecutorGroup.MultithreadEventExecutorGroup(int, Executor, EventExecutorChooserFactory, Object&#8230;&#8203;)</code> æ„é€ å‡½æ•°ä¸­ï¼š</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>åˆ›å»º <code>new ThreadPerTaskExecutor(newDefaultThreadFactory())</code> çº¿ç¨‹æ± ï¼›</p>
<div class="paragraph">
<p>æ¯æ¬¡æ‰§è¡Œä»»åŠ¡éƒ½ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹å®ä½“ã€‚</p>
</div>
<div class="paragraph">
<p><code>NioEventLoop</code> çº¿ç¨‹å‘½åè§„åˆ™ <code>nioEventLoop-1-XX</code>ã€‚åœ¨ <code>io.netty.util.concurrent.DefaultThreadFactory</code> ä¸­å¯ä»¥çœ‹åˆ°ã€‚</p>
</div>
<div class="paragraph">
<p>è¿™é‡Œè¿˜æœ‰ä¸¤ç‚¹éœ€è¦æ³¨æ„ï¼šåˆ›å»ºçš„çº¿ç¨‹å¯¹è±¡å’Œ <code>Runable</code> è¢«åˆ†åˆ«åŒ…è£…æˆäº† <code>FastThreadLocalThread</code> å’Œ <code>FastThreadLocalRunnable</code>ï¼Œä¸»è¦æ˜¯å¯¹ <code>ThreadLocal</code> åšäº†ä¸€äº›ä¼˜åŒ–ã€‚</p>
</div>
</li>
<li>
<p>ä½¿ç”¨ <code>for</code> å¾ªç¯ï¼Œåˆ©ç”¨ <code>MultithreadEventExecutorGroup.newChild(Executor, Object&#8230;&#8203;)</code> æ–¹æ³•åˆ›å»º <code>NioEventLoop</code> å¯¹è±¡ã€‚</p>
<div class="paragraph">
<p>æœ‰ä¸‰ä¸ªä½œç”¨ï¼šâ‘ ä¿å­˜çº¿ç¨‹æ‰§è¡Œå™¨ <code>ThreadPerTaskExecutor</code>ï¼›â‘¡åˆ›å»ºä¸€ä¸ª <code>MpscQueue</code>ï¼›â‘¢åˆ›å»ºä¸€ä¸ª selectorã€‚</p>
</div>
<div class="paragraph">
<p>åœ¨ <code>NioEventLoop.newTaskQueue(int)</code> æ–¹æ³•ï¼Œç„¶åè°ƒç”¨ <code>NioEventLoop.newTaskQueue0(int)</code> æ–¹æ³•ï¼Œåˆ›å»º <code>MpscQueue</code>ã€‚</p>
</div>
</li>
<li>
<p>è°ƒç”¨ <code>DefaultEventExecutorChooserFactory.newChooser(EventExecutor[])</code> æ–¹æ³•ï¼Œåˆ›å»ºçº¿ç¨‹é€‰æ‹©å™¨ã€‚</p>
<div class="paragraph">
<p><code>isPowerOfTwo()</code> åˆ¤æ–­æ˜¯å¦æ˜¯ 2 çš„å¹‚ï¼Œå¦‚æœæ˜¯åˆ™è¿”å› <code>PowerOfTwoEventExecutorChooser</code>ï¼ˆä¼˜åŒ–ï¼‰ï¼Œè¿”å› <code>index &amp; (length - 1)`ï¼›å¦åˆ™è¿”å› `GenericEventExecutorChooser`ï¼ˆæ™®é€šï¼‰ï¼Œè¿”å› `abs(index % length)</code>ã€‚</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_nioeventloop_å¯åŠ¨"><a class="anchor" href="#_nioeventloop_å¯åŠ¨"></a>74.3.2. <code>NioEventLoop</code> å¯åŠ¨</h4>
<div class="ulist">
<ul>
<li>
<p>æœåŠ¡ç«¯å¯åŠ¨ç»‘å®šæ¥å£</p>
</li>
<li>
<p>æ–°è¿æ¥æ¥å…¥ï¼Œé€šè¿‡ choose ç»‘å®šä¸€ä¸ª <code>NioEventLoop</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>åœ¨ <code>AbstractBootstrap.doBind0</code> æ–¹æ³•ä¸­ï¼Œè°ƒç”¨ <code>SingleThreadEventExecutor.execute(java.lang.Runnable)</code> å¼€å§‹å¯åŠ¨ï¼Œå†è°ƒç”¨ <code>SingleThreadEventExecutor.execute(java.lang.Runnable, boolean)</code>ï¼Œæœ€åé€šè¿‡ <code>SingleThreadEventExecutor.startThread</code> æ–¹æ³•æ¥å¯åŠ¨ã€‚å®é™…å¯åŠ¨å·¥ä½œï¼Œæœ€åå§”æ‰˜ç»™äº† <code>SingleThreadEventExecutor.doStartThread</code> æ–¹æ³•æ¥æ‰§è¡Œï¼Œè¿™ä¸ªæ–¹æ³•ä¸­ï¼Œè°ƒç”¨ <code>SingleThreadEventExecutor.this.run();</code> æ¥å¯åŠ¨ <code>NioEventLoop</code>ã€‚</p>
</div>
</div>
<div class="sect3">
<h4 id="_nioeventloop_æ‰§è¡Œé€»è¾‘"><a class="anchor" href="#_nioeventloop_æ‰§è¡Œé€»è¾‘"></a>74.3.3. <code>NioEventLoop</code> æ‰§è¡Œé€»è¾‘</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>run() &#8594; for(;;)</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>select()</code> æ£€æŸ¥æ˜¯å¦æœ‰ I/O äº‹ä»¶</p>
</li>
<li>
<p><code>processSelectedKeys()</code> å¤„ç† I/O äº‹ä»¶</p>
</li>
<li>
<p><code>SingleThreadEventExecutor.runAllTasks(long)</code> å¤„ç†å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>select() æ–¹æ³•</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>deadline ä»¥åŠä»»åŠ¡ç©¿æ’é€»è¾‘å¤„ç†</p>
<div class="paragraph">
<p><code>NioEventLoop.select(long)</code></p>
</div>
</li>
<li>
<p>é˜»å¡å¼select</p>
</li>
<li>
<p>é¿å… JDK ç©ºè½®è¯¢çš„ Bug</p>
<div class="paragraph">
<p>åœ¨ <code>NioEventLoop.run()</code> æ–¹æ³•ä¸­ï¼Œæ¯æ¬¡è½®è¯¢ï¼Œéƒ½ä¼šè®°å½•ä¸€ä¸‹è½®è¯¢æ¬¡æ•° <code>selectCnt</code>ï¼›åœ¨ <code>NioEventLoop.unexpectedSelectorWakeup(selectCnt)`æ–¹æ³•ä¸­ï¼Œå¦‚æœè½®è¯¢æ¬¡æ•°å¤§äº `SELECTOR_AUTO_REBUILD_THRESHOLD</code>(è¯¥å€¼é»˜è®¤æ˜¯ <code>512</code>ï¼Œå¯ä»¥é€šè¿‡ <code>io.netty.selectorAutoRebuildThreshold</code> å‚æ•°æ¥æ”¹)ï¼Œåˆ™é‡å»ºã€‚</p>
</div>
<div class="paragraph">
<p>é‡å»ºå·¥ä½œåœ¨ <code>NioEventLoop.rebuildSelector()</code> æ–¹æ³•ä¸­å®Œæˆï¼Œç„¶ååˆå§”æ‰˜ç»™ <code>NioEventLoop.rebuildSelector0()</code> æ¥å®é™…æ‰§è¡Œã€‚ä¸»è¦å·¥ä½œå°±æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>selector</code>ï¼Œç„¶åæŠŠè€çš„ <code>selector</code> ä¸Šçš„ <code>SelectionKey</code> æ³¨å†Œåˆ°æ–°çš„ <code>selector</code> ä¸Šã€‚</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong><code>processSelectedKeys()</code></strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>selected keySet ä¼˜åŒ–</p>
<div class="paragraph">
<p><code>SelectedSelectionKeySet</code> åº•å±‚æ˜¯ä¸€ä¸ªæ•°ç»„ã€‚åªå®ç°äº†å¢åŠ æ“ä½œï¼Œåˆ é™¤æ“ä½œæ²¡æœ‰å®ç°ã€‚ä¸ºä»€ä¹ˆï¼Ÿ</p>
</div>
</li>
<li>
<p><code>processSelectedKeysOptimized()</code></p>
<div class="paragraph">
<p><code>NioEventLoop.processSelectedKeysOptimized()</code>ï¼Œé‡ç‚¹åœ¨ <code>NioEventLoop.processSelectedKey(SelectionKey, AbstractNioChannel)</code> ã€‚</p>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-06-10 12:38:19 UTC
</div>
</div>
<link rel="stylesheet" href="assets/css/rouge-monokai.css">
</body>
</html>